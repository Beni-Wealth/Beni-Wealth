<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Submissions — Beni-Wealth</title>

  <!-- Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <!-- Favicons & Social preview -->
  <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <meta name="msapplication-TileImage" content="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">

  <meta property="og:type" content="website">
  <meta property="og:title" content="Beni-Wealth — Earn Steadily">
  <meta property="og:description" content="Complete simple micro-tasks, ptcs, blogs and shortlinks and earn instantly. Advertise efficiently with transparent metrics and fast payouts.">
  <meta property="og:image" content="https://res.cloudinary.com/dq7fpxfbc/image/upload/c_fill,w_1200,h_630/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="theme-color" content="#2fe0b8">

  <style>
    :root{
      --bg1:#060511; --bg2:#0f0920;
      --muted: rgba(255,255,255,0.65);
      --text: #eaf2ff;
      --accent:#2fe0b8;
      --card: rgba(255,255,255,0.02);
      --radius:12px;
      --max-width:1100px;
    }
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;font-family:Poppins,system-ui;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text)}
    .shell{max-width:var(--max-width);margin:24px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .brand{font-weight:700;font-size:1.1rem}
    .back{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.03);text-decoration:none;color:var(--text)}
    .muted{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:12px;align-items:center;margin-bottom:14px}
    .search{flex:1;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;background:var(--accent);color:#04211a;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--muted)}
    .list{display:flex;flex-direction:column;gap:12px}
    .item{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.06);display:grid;grid-template-columns:1fr 220px;gap:12px;align-items:center}
    .title{font-weight:700;margin-bottom:6px}
    .meta{color:var(--muted);font-size:13px}
    .proof{white-space:pre-wrap;color:var(--muted);margin-top:6px}
    .thumb{width:180px;height:100px;object-fit:cover;border-radius:8px;cursor:pointer;border:1px solid rgba(255,255,255,0.05)}
    .status{font-weight:700;padding:6px 10px;border-radius:999px;font-size:12px;text-align:center}
    .status.pending{background:#fff6d6;color:#6a4f00}
    .status.approved{background:#bff0d9;color:#05461f}
    .status.rejected{background:#ffdede;color:#6b0b0b}
    .small{font-size:13px;color:var(--muted)}
    .empty{padding:40px;text-align:center;color:var(--muted)}
    .diag{margin-bottom:12px;color:var(--muted);font-size:13px}
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.75);z-index:999;padding:18px}
    .panel{width:100%;max-width:920px;background:#0b0a1a;border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.06)}
    .closeX{float:right;background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
    img.viewerImg{max-width:100%;display:block;margin:12px 0;border-radius:8px}
    @media(max-width:820px){ .item{grid-template-columns:1fr} .thumb{width:100%;height:160px} }
  </style>
</head>
<body>
  <main class="shell">
    <header>
      <a class="back" href="dashboard.html">← Back</a>
      <div style="text-align:right">
        <div class="brand">My Task Submissions</div>
        <div class="muted">All proofs you submitted and their review status</div>
      </div>
    </header>

    <div id="diag" class="diag">Starting…</div>

    <section class="controls">
      <input id="search" class="search" placeholder="Search by advert title, status or id" />
      <button id="refresh" class="btn ghost">Refresh</button>
    </section>

    <section id="list" class="list" aria-live="polite">
      <div class="empty">Loading your submissions…</div>
    </section>
  </main>

  <!-- overlay -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true">
      <button id="closeOverlay" class="closeX">✕</button>
      <div id="overlayContent"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getFirestore, collection, query, where, onSnapshot, getDocs, doc, getDoc, limit } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const diag = document.getElementById('diag');
    const listEl = document.getElementById('list');
    const searchEl = document.getElementById('search');
    const refreshBtn = document.getElementById('refresh');
    const overlay = document.getElementById('overlay');
    const overlayContent = document.getElementById('overlayContent');
    const closeOverlay = document.getElementById('closeOverlay');

    let currentUser = null;
    let unsub = null;
    let submissions = [];
    const advertCache = new Map();

    const SUB_COLLECTION_CANDIDATES = ['advert_submissions','submissions','task_submissions'];
    const AD_COLLECTION_CANDIDATES = ['advertise_tasks','adverts','tasks'];

    function escapeHtml(s){return String(s||'').replace(/[&<>]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[m]));}
    function niceDate(ts){try{if(!ts)return '-'; if(ts.toDate) ts=ts.toDate(); return new Date(ts).toLocaleString();}catch{return '-';}}

    function render(items){
      submissions = items.slice();
      const q = (searchEl.value||'').toLowerCase();
      const filtered = items.filter(it=>!q || (it.advertTitle||'').toLowerCase().includes(q) || (it.status||'').toLowerCase().includes(q) || it.id.includes(q));
      if(!filtered.length){ listEl.innerHTML='<div class="empty">No submissions found.</div>'; return; }
      listEl.innerHTML='';
      filtered.forEach(it=>{
        const row=document.createElement('div'); row.className='item';
        row.innerHTML=`
          <div>
            <div class="title">${escapeHtml(it.advertTitle||'(no title)')}</div>
            <div class="meta">Submitted: ${niceDate(it.createdAt)} • ID: <code>${escapeHtml(it.id)}</code></div>
            <div class="proof">${escapeHtml(it.textProof||'')}</div>
          </div>
          <div style="text-align:right">
            ${it.imageUrl?`<img class="thumb" src="${it.imageUrl}" />`:''}
            <div class="status ${it.status}">${(it.status||'pending').toUpperCase()}</div>
            <div class="small">Advert ID: <code>${escapeHtml(it.advertId||'')}</code></div>
          </div>`;
        if(it.imageUrl) row.querySelector('img').onclick=()=>openOverlay(it);
        listEl.appendChild(row);
      });
    }

    function openOverlay(it){
      overlayContent.innerHTML=`
        <h2>${escapeHtml(it.advertTitle||'')}</h2>
        <div class="small">Submission ID: ${escapeHtml(it.id)} • Advert ID: ${escapeHtml(it.advertId)}</div>
        <div style="margin-top:8px">Status: <strong>${escapeHtml(it.status||'pending')}</strong></div>
        <div class="small" style="margin-top:12px">${escapeHtml(it.textProof||'')}</div>
        ${it.imageUrl?`<img class="viewerImg" src="${it.imageUrl}" />`:''}`;
      overlay.style.display='flex';
    }

    closeOverlay.onclick=()=>{overlay.style.display='none'; overlayContent.innerHTML='';};
    overlay.onclick=(e)=>{if(e.target===overlay) closeOverlay.onclick();};

    async function fetchAdvertMeta(aid){
      if(!aid || advertCache.has(aid)) return advertCache.get(aid)||{};
      for(const col of AD_COLLECTION_CANDIDATES){
        try{const snap=await getDoc(doc(db,col,aid)); if(snap.exists()){const d=snap.data(); const m={ title:d.title||'', thumbnail:d.thumbnail||'' }; advertCache.set(aid,m); return m; }}catch{}
      }
      const fb={ title:'(task not found)' }; advertCache.set(aid,fb); return fb;
    }

    async function start(uid){
      diag.textContent='Loading submissions…';
      for(const col of SUB_COLLECTION_CANDIDATES){
        try{
          const q=query(collection(db,col), where('userId','==',uid));
          const snap=await getDocs(q);
          if(!snap.empty){
            onSnapshot(q, async s=>{
              const arr=[]; const ads=new Set();
              s.forEach(d=>{const x=d.data(); const aid=x.advertId||''; arr.push({ id:d.id, advertId:aid, textProof:x.textProof||'', imageUrl:x.imageUrl||'', status:x.status||'pending', createdAt:x.createdAt||null }); if(aid) ads.add(aid);});
              await Promise.all([...ads].map(fetchAdvertMeta));
              arr.forEach(it=>{ const m=advertCache.get(it.advertId)||{}; it.advertTitle=m.title||''; if(!it.imageUrl && m.thumbnail) it.imageUrl=m.thumbnail; });
              render(arr);
            });
            diag.textContent='Showing submissions'; return;
          }
        }catch{}
      }
      diag.textContent='No submissions found'; listEl.innerHTML='<div class="empty">No submissions found.</div>';
    }

    onAuthStateChanged(auth,u=>{ if(!u){ listEl.innerHTML='<div class="empty">Please sign in.</div>'; return;} start(u.uid); });
    refreshBtn.onclick=()=>currentUser && start(currentUser.uid);
    searchEl.oninput=()=>render(submissions);
  </script>
</body>
</html>
