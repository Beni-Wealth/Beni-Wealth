<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Beni-Wealth ‚Äî Shortlink-2 Complete</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#0b0613; --bg2:#120521; --muted: rgba(255,255,255,0.64);
  --text:#eaf2ff; --accent-start:#2fe0b8; --accent-end:#7a5fff;
  --bottom-nav-h:72px; --page-pad:28px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text)}
main{max-width:980px;margin:0 auto;padding:var(--page-pad) 20px calc(var(--bottom-nav-h) + 48px)}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.brand{display:flex;align-items:center;gap:12px}
.brand img{width:62px;height:62px;border-radius:12px;object-fit:cover}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:18px;padding:32px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 30px 80px rgba(0,0,0,0.6);text-align:center;margin:30px auto}
.plan-badge{display:inline-block;padding:8px 14px;border-radius:999px;background:linear-gradient(90deg,#ffffff08,#ffffff06);color:var(--muted);font-weight:700;margin-top:8px}
.earned{font-size:48px;font-weight:900;color:var(--accent-start);margin:18px 0}
.btn{display:inline-flex;align-items:center;gap:10px;padding:12px 16px;border-radius:12px;border:none;cursor:pointer;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:#041219;font-weight:700;margin-top:12px}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
.status{margin-top:14px;font-size:14px;color:var(--muted)} .status.error{color:#ffb3b3} .status.success{color:#bff0d9}
.bw-bottom-nav{position:fixed;left:18px;right:18px;bottom:16px;height:var(--bottom-nav-h);display:flex;align-items:center;justify-content:space-between;padding:10px;background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04));border-radius:40px;box-shadow:0 14px 40px rgba(2,6,23,0.6);backdrop-filter:blur(6px);z-index:120}
.bw-bottom-nav a{color:inherit;text-decoration:none;display:flex;flex-direction:column;align-items:center;gap:6px;width:64px;font-size:12px;text-align:center}
.icon-wrap{width:44px;height:44px;border-radius:10px;background:rgba(255,255,255,0.04);display:grid;place-items:center;font-size:18px}
.nav-center .center-btn{width:82px;height:82px;border-radius:50%;background:linear-gradient(135deg,var(--accent-start),var(--accent-end));display:grid;place-items:center;color:#041219;font-size:26px;transform:translateY(-22px)}
footer{margin-top:18px;color:rgba(255,255,255,0.3);font-size:13px;text-align:center}
</style>
</head>
<body>
<main id="shortlink-2-page" role="main" aria-labelledby="title" data-page-id="shortlink-2">
  <div class="header">
    <div class="brand">
      <img src="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png" alt="Beni-Wealth logo">
      <div>
        <div style="font-weight:700;font-size:18px">Beni-Wealth</div>
        <div style="color:var(--muted);font-size:13px">Shortlink-2 Reward</div>
      </div>
    </div>
    <div id="acctDisplay" style="color:var(--muted);font-size:13px">Checking sign-in‚Ä¶</div>
  </div>

  <h1 id="title" style="text-align:center">Claim your plan reward</h1>

  <section class="card" aria-labelledby="title">
    <div id="welcome" style="font-size:18px;font-weight:700">Welcome</div>
    <div id="planName" class="plan-badge">Plan: ‚Äî</div>

    <div id="earnedAmount" class="earned">‚Äî</div>
    <div id="earnedMsg" style="color:var(--muted);font-size:15px">You have earned ‚Äî</div>

    <div style="margin-top:12px">
      <button id="claimBtn" class="btn" disabled>Claim Reward</button>
      <button id="refreshBtn" class="btn ghost">Refresh</button>
    </div>

    <div id="status" class="status" aria-live="polite"></div>
    <div id="lastClaimText" class="status" style="margin-top:8px;color:var(--muted)"></div>

    <div style="margin-top:10px;color:var(--muted);font-size:13px">You can claim once every 24 hours. Credited to your balance and saved in transactions (tagged with pageId).</div>
  </section>

  <footer>¬© <span id="year"></span> Beni-Wealth</footer>
</main>

<nav class="bw-bottom-nav" role="navigation" aria-label="Main navigation">
  <a id="navHome"><div class="icon-wrap">üè†</div><div>Home</div></a>
  <a id="navShortlinks"><div class="icon-wrap">üîó</div><div>Shortlinks</div></a>
  <div class="nav-center"><a id="navCreate" class="center-btn">‚ûï</a></div>
  <a id="navNews"><div class="icon-wrap">üí¨</div><div>News</div></a>
  <a id="navAssets"><div class="icon-wrap">üë§</div><div>Assets</div></a>
</nav>

<script type="module">
// repo helper
const REPO_BASE = '/Beni-Wealth';
function withRepoPath(target){ try{ const m = new URL(target, location.href); if(m.origin===location.origin){ const p = m.pathname.replace(/\/+/g,'/'); if(p.indexOf(REPO_BASE)===0) return m.origin + p + m.search + m.hash; } return m.href;}catch(e){} const clean = String(target).replace(/^\/+/,''); const repo = REPO_BASE.replace(/^\/+/,''); if(clean.indexOf(repo)===0) return location.origin + '/' + clean; return location.origin + REPO_BASE + (clean?'/'+clean:''); }

// imports
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, getDoc, runTransaction, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
  authDomain: "beni-wealths.firebaseapp.com",
  projectId: "beni-wealths",
  storageBucket: "beni-wealths.firebasestorage.app",
  messagingSenderId: "807950483822",
  appId: "1:807950483822:web:e10fa87307e041c4d8417f",
  measurementId: "G-Z2XP3YN6NS"
};
if(!getApps().length) initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();
setPersistence(auth, browserLocalPersistence).catch(()=>{});

// page id
const PAGE_ID = 'shortlink-2';

// plan earnings
const PLAN_EARNINGS = { bronze:100, silver:175, gold:270, platinum:500, basic:0 };

// DOM
const acctDisplay = document.getElementById('acctDisplay');
const welcome = document.getElementById('welcome');
const planNameEl = document.getElementById('planName');
const earnedAmountEl = document.getElementById('earnedAmount');
const earnedMsgEl = document.getElementById('earnedMsg');
const claimBtn = document.getElementById('claimBtn');
const refreshBtn = document.getElementById('refreshBtn');
const statusEl = document.getElementById('status');
const lastClaimText = document.getElementById('lastClaimText');

function formatN(n){ return '‚Ç¶'+Number(n||0).toLocaleString('en-NG'); }
function timeRemaining(ms){ if(ms<=0) return 'now'; const s=Math.floor(ms/1000); const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); const sec=s%60; if(h>0) return `${h}h ${m}m`; if(m>0) return `${m}m ${sec}s`; return `${sec}s`; }

let currentUser=null, currentPlanKey='basic', currentEarn=0, lastClaimTimestamp=null, authReported=false;

async function loadUserState(user){
  statusEl.textContent=''; statusEl.className='status';
  if(!user){ acctDisplay.textContent='Not signed in'; welcome.textContent='Welcome'; planNameEl.textContent='Plan: ‚Äî'; earnedAmountEl.textContent='‚Äî'; earnedMsgEl.textContent='You have earned ‚Äî'; claimBtn.disabled=true; lastClaimText.textContent=''; return; }
  currentUser=user;
  const username = user.displayName || (user.email?user.email.split('@')[0]:'User');
  acctDisplay.textContent = username;
  welcome.textContent = `Hi, ${username}`;
  try{
    const uRef = doc(db,'users',user.uid);
    const snap = await getDoc(uRef);
    let plan='basic', balance=0;
    lastClaimTimestamp=null;
    if(snap.exists()){
      const d=snap.data();
      plan = (d.plan||d.type||d.membership||d.tier||'basic').toString().trim();
      balance = Number(d.balance||0);
      if(d.lastEarningClaim) lastClaimTimestamp = d.lastEarningClaim;
    }
    const pkey = plan.toLowerCase();
    currentPlanKey = pkey;
    currentEarn = PLAN_EARNINGS.hasOwnProperty(pkey)?PLAN_EARNINGS[pkey]:0;
    planNameEl.textContent = `Plan: ${pkey.charAt(0).toUpperCase()+pkey.slice(1)}`;
    earnedAmountEl.textContent = formatN(currentEarn);
    earnedMsgEl.textContent = `You have earned ${formatN(currentEarn)}.`;
    if(lastClaimTimestamp && lastClaimTimestamp instanceof Timestamp){
      const lastMillis = lastClaimTimestamp.toMillis();
      const elapsed = Date.now() - lastMillis;
      const dayMs = 24*3600*1000;
      if(elapsed >= dayMs) lastClaimText.textContent = `Last claimed: ${new Date(lastMillis).toLocaleString()}. You can claim now.`;
      else lastClaimText.textContent = `Last claimed: ${new Date(lastMillis).toLocaleString()}. Next claim in ${timeRemaining(dayMs-elapsed)}.`;
    } else lastClaimText.textContent = 'You have not claimed this reward yet. You can claim now.';
    claimBtn.disabled = currentEarn<=0;
  }catch(e){ console.error(e); statusEl.textContent='Unable to load user data ‚Äî check console.'; statusEl.className='status error'; }
}

// claim
claimBtn.addEventListener('click', async (ev)=>{
  ev.preventDefault();
  statusEl.textContent=''; statusEl.className='status';
  if(!currentUser){ statusEl.textContent='Please sign in to claim.'; statusEl.className='status error'; return; }
  if(currentEarn<=0){ statusEl.textContent='No reward for your plan.'; statusEl.className='status error'; return; }
  claimBtn.disabled=true; claimBtn.textContent='Processing...';
  const uid = currentUser.uid; const userRef = doc(db,'users',uid);
  try{
    await runTransaction(db, async (tx)=>{
      const uSnap = await tx.get(userRef);
      const nowMs = Date.now(); const dayMs = 24*3600*1000;
      let last=null, balance=0;
      if(uSnap.exists()){ const d=uSnap.data(); balance=Number(d.balance||0); if(d.lastEarningClaim) last=d.lastEarningClaim; }
      if(last && last instanceof Timestamp){ const lastMs = last.toMillis(); if(nowMs-lastMs < dayMs) throw new Error('CLAIM_AGAIN_LATER'); }
      const newBalance = balance + currentEarn;
      tx.set(userRef, { balance: newBalance, lastEarningClaim: serverTimestamp() }, { merge: true });
      const txId = `${Date.now()}-${Math.random().toString(36).slice(2,8)}`;
      const txRef = doc(db,'transactions',txId);
      tx.set(txRef, { userId:uid, type:'credit', source:'daily_plan_reward', plan:currentPlanKey, amount:currentEarn, pageId:PAGE_ID, createdAt:serverTimestamp() });
    });
    statusEl.textContent = `Success ‚Äî ${formatN(currentEarn)} credited to your balance.`; statusEl.className='status success';
    await loadUserState(currentUser);
  }catch(err){
    console.error(err);
    if(err && err.message==='CLAIM_AGAIN_LATER'){ statusEl.textContent='Already claimed within 24 hours. Try later.'; statusEl.className='status error'; }
    else { statusEl.textContent='Unable to process claim. Check connection/permissions.'; statusEl.className='status error'; }
  }finally{ claimBtn.disabled=false; claimBtn.textContent='Claim Reward'; }
});

// refresh
refreshBtn.addEventListener('click', async (e)=>{ e.preventDefault(); await loadUserState(auth.currentUser); statusEl.textContent='Refreshed'; statusEl.className='status'; });

// nav wiring
document.getElementById('navHome').addEventListener('click',(e)=>{e.preventDefault(); location.assign(withRepoPath('index.html'));});
document.getElementById('navShortlinks').addEventListener('click',(e)=>{e.preventDefault(); location.assign(withRepoPath('shortlinks.html'));});
document.getElementById('navCreate').addEventListener('click',(e)=>{e.preventDefault(); location.assign(withRepoPath('advertise-task.html'));});
document.getElementById('navNews').addEventListener('click',(e)=>{e.preventDefault(); location.assign(withRepoPath('news.html'));});
document.getElementById('navAssets').addEventListener('click',(e)=>{e.preventDefault(); location.assign(withRepoPath('dashboard.html'));});

// ensure padding
(function(){ const shell = document.querySelector('main'); const nav = document.querySelector('.bw-bottom-nav'); if(!shell||!nav)return; const need=(nav.getBoundingClientRect().height||72)+24; const cur=parseInt(getComputedStyle(shell).paddingBottom)||0; if(cur<need) shell.style.paddingBottom = need+'px'; })();

// auth tracking
acctDisplay.textContent='Checking sign-in‚Ä¶'; claimBtn.disabled=true; statusEl.textContent='';
onAuthStateChanged(auth, async (user)=>{ console.log('onAuthStateChanged',!!user); authReported=true; await loadUserState(user); });
if(auth.currentUser){ authReported=true; loadUserState(auth.currentUser).catch(()=>{}); }
setTimeout(()=>{ if(!authReported){ acctDisplay.innerHTML = `Not signed in ‚Äî <a style="color:var(--accent-start);text-decoration:underline" href="${withRepoPath('login.html')}">Sign in</a>`; claimBtn.disabled=true; statusEl.textContent='Sign in to claim.'; } },6000);

document.getElementById('year').textContent = new Date().getFullYear();
</script>
</body>
</html>
