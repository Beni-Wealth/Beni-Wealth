<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Referrals — Beni-Wealth</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <meta name="theme-color" content="#2fe0b8">
  <style>
    body{font-family:Poppins,sans-serif;background:#0b0613;color:#e9f0ff;margin:0}
    header{padding:18px;font-weight:700;background:#111}
    .wrap{max-width:1100px;margin:auto;padding:20px}
    .card{background:#151020;border-radius:12px;padding:16px;margin-bottom:14px}
    .big{font-size:1.6rem;font-weight:700}
    button{padding:10px 14px;border-radius:8px;border:none;background:#2fe0b8;color:#041219;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
<header>My Referrals</header>
<div class="wrap">
  <div class="card">
    <div>Referral Balance</div>
    <div class="big" id="rb">₦0</div>
    <button id="transfer">Transfer to Main Balance</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc, runTransaction, serverTimestamp, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = { apiKey:"AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk", authDomain:"beni-wealths.firebaseapp.com", projectId:"beni-wealths" };

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* PLANS */
const ACTIVE = ['bronze','silver'];
const NORMALIZE = p => ['gold','platinum'].includes((p||'').toLowerCase()) ? 'silver' : (p||'basic').toLowerCase();

const REWARD = {
  basic:  { bronze:300, silver:600 },
  bronze: { bronze:500, silver:1000 },
  silver: { bronze:700, silver:1400 }
};

const REF_FIELDS = ['referral','referrer','referredBy','invitedBy','sponsor'];

async function creditOnce(referrerUid,referredUid,amount){
  await runTransaction(db, async tx=>{
    const me = doc(db,'users',referrerUid);
    const lock = doc(db,'referralRewards',`${referrerUid}_${referredUid}`);
    if((await tx.get(lock)).exists()) return;
    const snap = await tx.get(me);
    const rb = Number(snap.data().referralBalance||0);
    tx.update(me,{ referralBalance: rb+amount });
    tx.set(lock,{ amount, createdAt:serverTimestamp() });
  });
}

onAuthStateChanged(auth, async user=>{
  if(!user) return;
  const meSnap = await getDoc(doc(db,'users',user.uid));
  const me = meSnap.data();
  const myPlan = NORMALIZE(me.plan);
  document.getElementById('rb').textContent = '₦'+(me.referralBalance||0);

  const myCode = me.username || user.email.split('@')[0];

  for(const f of REF_FIELDS){
    const q = query(collection(db,'users'), where(f,'==',myCode));
    const s = await getDocs(q);
    for(const d of s.docs){
      const rp = NORMALIZE(d.data().plan);
      if(!ACTIVE.includes(rp)) continue;
      const amt = REWARD[myPlan]?.[rp]||0;
      if(amt>0) await creditOnce(user.uid,d.id,amt);
    }
  }
});

// transfer
const btn = document.getElementById('transfer');
btn.onclick = async ()=>{
  const u = auth.currentUser; if(!u) return;
  await runTransaction(db, async tx=>{
    const ref = doc(db,'users',u.uid);
    const s = await tx.get(ref);
    const rb = Number(s.data().referralBalance||0);
    if(rb<=0) return;
    tx.update(ref,{ referralBalance:0, balance:(Number(s.data().balance||0)+rb) });
  });
  location.reload();
};
</script>
</body>
</html>
