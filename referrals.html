<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Referrals â€” Beni-Wealth</title>

  <!-- Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <!-- Favicons & Social preview -->
  <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <meta name="msapplication-TileImage" content="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">

  <meta property="og:type" content="website">
  <meta property="og:title" content="Beni-Wealth â€” Earn Steadily">
  <meta property="og:description" content="Complete simple micro-tasks, complete ptcs and blogs, complete shortlinks and earn instantly.">
  <meta property="og:image" content="https://res.cloudinary.com/dq7fpxfbc/image/upload/c_fill,w_1200,h_630/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="theme-color" content="#2fe0b8">

  <style>
    body{margin:0;font-family:Poppins,system-ui;background:#0b0613;color:#e9f0ff}
    header{padding:16px;font-weight:700}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,.08)}
    button{cursor:pointer}
  </style>
</head>
<body>

<header>Beni-Wealth â€” My Referrals</header>

<main style="padding:16px">
  <table>
    <thead>
      <tr>
        <th>Referred UID</th>
        <th>Referral Bonus</th>
      </tr>
    </thead>
    <tbody id="activatedBody">
      <tr><td colspan="2">Loadingâ€¦</td></tr>
    </tbody>
  </table>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getFirestore, collection, query, where, doc, runTransaction,
    serverTimestamp, onSnapshot
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

  /* ðŸ”´ REQUIRED CONFIG (WAS MISSING) */
  const firebaseConfig = {
    apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fB8yHeRjNjZk",
    authDomain: "beni-wealths.firebaseapp.com",
    projectId: "beni-wealths",
    storageBucket: "beni-wealths.firebasestorage.app",
    messagingSenderId: "807950483822",
    appId: "1:807950483822:web:e10fa87307e041c4d8417f"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let authChecked = false;
  let currentUser = null;

  onAuthStateChanged(auth, user => {
    if(!authChecked) authChecked = true;
    if(!user) return setTimeout(()=>location.href='login.html',50);
    currentUser = user;
    listen();
  });

  function listen(){
    const q = query(collection(db,'referralBonuses'), where('referrerUid','==',currentUser.uid));
    onSnapshot(q, snap => {
      const body = document.getElementById('activatedBody');
      if(snap.empty){ body.innerHTML='<tr><td colspan="2">No bonuses yet</td></tr>'; return; }
      body.innerHTML = '';
      snap.forEach(d => {
        const r = d.data();
        body.innerHTML += `
          <tr>
            <td>${r.referredUid}</td>
            <td>
              â‚¦${Number(r.amount).toLocaleString()}
              ${r.claimed ? 'âœ“' : `<button onclick="claim('${d.id}')">Claim</button>`}
            </td>
          </tr>`;
      });
    });
  }

  window.claim = async function(id){
    await runTransaction(db, async tx => {
      const bRef = doc(db,'referralBonuses',id);
      const uRef = doc(db,'users',currentUser.uid);
      const b = await tx.get(bRef);
      if(b.data().claimed) throw 'Already claimed';
      const u = await tx.get(uRef);
      tx.update(uRef,{ referralBalance:(u.data().referralBalance||0)+b.data().amount });
      tx.update(bRef,{ claimed:true, claimedAt:serverTimestamp() });
    });
    alert('Claimed');
  }
</script>
</body>
</html>
