<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Referral Auto Credit â€” Beni-Wealth</title>
</head>
<body>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, getDoc, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
  authDomain: "beni-wealths.firebaseapp.com",
  projectId: "beni-wealths",
  storageBucket: "beni-wealths.firebasestorage.app",
  messagingSenderId: "807950483822",
  appId: "1:807950483822:web:e10fa87307e041c4d8417f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* RULES */
const ACTIVE = ['bronze','silver'];
const REWARD = {
  basic:  { bronze: 300, silver: 600 },
  bronze: { bronze: 500, silver: 1000 },
  silver: { bronze: 700, silver: 1400 }
};

const REF_FIELDS = ['referral','referralCode','ref','referrer','referredBy','referred_by','invitedBy','sponsor'];

const norm = p => (p || 'basic').toLowerCase();

async function getReferrals(code){
  const map = new Map();
  for(const f of REF_FIELDS){
    try{
      const q = query(collection(db,'users'), where(f,'==',code));
      const s = await getDocs(q);
      s.forEach(d=>map.set(d.id,d.data()));
    }catch{}
  }
  return map;
}

async function creditOnce(referrerUid,referredUid,amount,refPlan,refdPlan){
  await runTransaction(db, async tx=>{
    const meRef = doc(db,'users',referrerUid);
    const rewardRef = doc(db,'referralRewards',`${referrerUid}_${referredUid}`);

    const meSnap = await tx.get(meRef);
    if(!meSnap.exists()) return;

    const rewardSnap = await tx.get(rewardRef);
    if(rewardSnap.exists()) return;

    const rb = Number(meSnap.data().referralBalance || 0);

    tx.update(meRef, { referralBalance: rb + amount });
    tx.set(rewardRef, {
      referrerUid,
      referredUid,
      amount,
      refPlan,
      referredPlan: refdPlan,
      createdAt: serverTimestamp()
    });
  });
}

onAuthStateChanged(auth, async user=>{
  if(!user) return;

  const meSnap = await getDoc(doc(db,'users',user.uid));
  if(!meSnap.exists()) return;

  const me = meSnap.data();
  const myPlan = norm(me.plan);
  const myCode = (me.username || user.email.split('@')[0]).toString();

  const refs = await getReferrals(myCode);

  for(const [uid,data] of refs){
    const rp = norm(data.plan);
    if(!ACTIVE.includes(rp)) continue;

    const amt = REWARD[myPlan]?.[rp] || 0;
    if(amt <= 0) continue;

    await creditOnce(user.uid,uid,amt,myPlan,rp);
  }
});
</script>
</body>
</html>
