<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Referrals — Beni-Wealth</title>

  <!-- Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <!-- Favicons & Social preview -->
  <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <meta name="msapplication-TileImage" content="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">

  <meta property="og:type" content="website">
  <meta property="og:title" content="Beni-Wealth — Earn Steadily">
  <meta property="og:description" content="Complete simple micro-tasks, complete ptcs and blogs, complete shortlinks and earn instantly.">
  <meta property="og:image" content="https://res.cloudinary.com/dq7fpxfbc/image/upload/c_fill,w_1200,h_630/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="theme-color" content="#2fe0b8">

  <style>
    body{margin:0;font-family:Poppins,system-ui;background:#0b0613;color:#e9f0ff}
    header{padding:16px;font-weight:700;font-size:18px}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;padding:16px}
    .card{background:#120a1f;border-radius:14px;padding:16px;box-shadow:0 8px 20px rgba(0,0,0,.25)}
    .label{opacity:.75;font-size:13px}
    .value{font-size:24px;font-weight:700;margin-top:6px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    button{background:#2fe0b8;border:0;border-radius:8px;padding:6px 12px;font-weight:600;cursor:pointer}
    .muted{opacity:.6}
  </style>
</head>
<body>

<header>My Referrals</header>

<section class="cards">
  <div class="card">
    <div class="label">Total Referral Earnings</div>
    <div class="value" id="totalReferral">₦0</div>
  </div>
  <div class="card">
    <div class="label">Referral Balance</div>
    <div class="value" id="referralBalance">₦0</div>
  </div>
</section>

<main style="padding:16px">
  <table>
    <thead>
      <tr>
        <th>Referred User</th>
        <th>Bonus</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="activatedBody">
      <tr><td colspan="3">Loading…</td></tr>
    </tbody>
  </table>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import {
    getFirestore, collection, query, where, doc, runTransaction,
    onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fB8yHeRjNjZk",
    authDomain: "beni-wealths.firebaseapp.com",
    projectId: "beni-wealths",
    storageBucket: "beni-wealths.firebasestorage.app",
    messagingSenderId: "807950483822",
    appId: "1:807950483822:web:e10fa87307e041c4d8417f"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let user = null;

  onAuthStateChanged(auth, u => {
    if(!u) return location.href='login.html';
    user = u;
    listenUser();
    listenBonuses();
  });

  function listenUser(){
    onSnapshot(doc(db,'users',user.uid), snap => {
      const d = snap.data()||{};
      document.getElementById('referralBalance').textContent = '₦' + Number(d.referralBalance||0).toLocaleString();
    });
  }

  function listenBonuses(){
    const q = query(collection(db,'referralBonuses'), where('referrerUid','==',user.uid));
    onSnapshot(q, snap => {
      const body = document.getElementById('activatedBody');
      let total = 0;
      if(snap.empty){ body.innerHTML='<tr><td colspan="3" class="muted">No referrals yet</td></tr>'; }
      else{
        body.innerHTML='';
        snap.forEach(docu => {
          const r = docu.data();
          total += Number(r.amount||0);
          body.innerHTML += `
            <tr>
              <td>${r.referredUid}</td>
              <td>₦${Number(r.amount).toLocaleString()}</td>
              <td>${r.claimed ? 'Claimed' : `<button onclick="claim('${docu.id}')">Claim</button>`}</td>
            </tr>`;
        });
      }
      document.getElementById('totalReferral').textContent = '₦' + total.toLocaleString();
    });
  }

  window.claim = async function(id){
    await runTransaction(db, async tx => {
      const bRef = doc(db,'referralBonuses',id);
      const uRef = doc(db,'users',user.uid);
      const b = await tx.get(bRef);
      if(b.data().claimed) throw 'Already claimed';
      const u = await tx.get(uRef);
      tx.update(uRef,{ referralBalance:(u.data().referralBalance||0)+b.data().amount });
      tx.update(bRef,{ claimed:true, claimedAt:serverTimestamp() });
    });
  }
</script>
</body>
</html>
