<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Referrals — Beni-Wealth</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300,500,700&display=swap" rel="stylesheet">
</head>
<body>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, query, where, getDocs, doc, getDoc,
  runTransaction, serverTimestamp, onSnapshot
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

/* ================= CONFIG ================= */
const firebaseConfig = { /* YOUR CONFIG HERE */ };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const BONUS_MAP = {
  bronze: { bronze: 500, silver: 700 },
  silver: { bronze: 700, silver: 1200 }
};

/* ================= AUTH FIX ================= */
let authChecked = false;
let currentUser = null;

onAuthStateChanged(auth, (user) => {
  if (!authChecked) authChecked = true;
  if (!user) return setTimeout(() => location.href = 'login.html', 50);
  currentUser = user;
  init();
});

/* ================= INIT ================= */
function init(){
  subscribeReferralBonuses();
}

/* ================= SUBSCRIBE ================= */
function subscribeReferralBonuses(){
  const q = query(collection(db,'referralBonuses'), where('referrerUid','==',currentUser.uid));
  onSnapshot(q, snap => {
    const rows = [];
    snap.forEach(d => rows.push({ id:d.id, ...d.data() }));
    render(rows);
  });
}

/* ================= RENDER ================= */
function render(list){
  const body = document.getElementById('activatedBody');
  if(!list.length){
    body.innerHTML = '<tr><td colspan="6">No activated referrals</td></tr>';
    return;
  }
  body.innerHTML = list.map(r => `
    <tr>
      <td>${r.referredUid}</td>
      <td>—</td>
      <td>Paid</td>
      <td>—</td>
      <td>—</td>
      <td>
        ₦${Number(r.amount).toLocaleString()} 
        ${r.claimed ? '✓' : `<button onclick="claimBonus('${r.id}')">Claim</button>`}
      </td>
    </tr>`).join('');
}

/* ================= CLAIM ================= */
window.claimBonus = async function(id){
  try{
    await runTransaction(db, async tx => {
      const bonusRef = doc(db,'referralBonuses',id);
      const userRef = doc(db,'users',currentUser.uid);
      const b = await tx.get(bonusRef);
      if(!b.exists()) throw 'Bonus missing';
      if(b.data().claimed) throw 'Already claimed';
      const u = await tx.get(userRef);
      const cur = Number(u.data().referralBalance||0);
      tx.update(userRef,{ referralBalance: cur + b.data().amount });
      tx.update(bonusRef,{ claimed:true, claimedAt:serverTimestamp() });
    });
    alert('Bonus claimed');
  }catch(e){ alert(e); }
}
</script>
</body>
</html>
