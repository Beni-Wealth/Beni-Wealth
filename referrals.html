<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Referrals — Beni-Wealth</title>

  <!-- Poppins (standard Beni-Wealth asset) -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <!-- Favicons & Social preview (standard Beni-Wealth asset) -->
  <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <meta name="theme-color" content="#2fe0b8">

  <style>
    :root{
      --bg-1:#0b0613; --bg-2:#0f0820; --muted:rgba(233,240,255,0.6);
      --card: rgba(255,255,255,0.03); --accent-start:#2fe0b8; --accent-end:#7a5fff;
      --text:#e9f0ff; --glass: rgba(255,255,255,0.04);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Poppins',sans-serif;
      background:linear-gradient(180deg,var(--bg-1),var(--bg-2));
      color:var(--text); min-height:100vh;
    }
    header{padding:18px 22px;border-bottom:1px solid rgba(255,255,255,0.04)}
    .brand{font-weight:700;font-size:1.1rem}
    .wrap{max-width:1100px;margin:20px auto;padding:0 18px}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
    .card{background:var(--card);border-radius:14px;padding:16px;border:1px solid rgba(255,255,255,0.04)}
    .card h3{font-size:.9rem;color:var(--accent-end)}
    .big{font-size:1.5rem;font-weight:700}
    .btn{margin-top:10px;padding:10px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn-transfer{background:linear-gradient(90deg,#ffd166,#ff7a7a);color:#221004}

    table{width:100%;border-collapse:collapse;margin-top:18px}
    th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,0.05);text-align:left}
    th{color:var(--muted);font-size:.8rem}

    .badge{padding:4px 10px;border-radius:999px;font-size:.7rem;font-weight:700}
    .paid{background:linear-gradient(90deg,#2fe0b8,#22c55e);color:#04231a}
    .pending{background:linear-gradient(90deg,#facc15,#fb923c);color:#231a04}
    .inactive{background:rgba(255,255,255,0.08);color:#fff}

    footer{text-align:center;padding:18px;color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="brand">Beni-Wealth — My Referrals</div>
</header>

<div class="wrap">
  <div class="cards">
    <div class="card"><h3>Total Referrals</h3><div class="big" id="total">0</div></div>
    <div class="card"><h3>Activated</h3><div class="big" id="activated">0</div></div>
    <div class="card">
      <h3>Referral Balance</h3>
      <div class="big" id="balance">₦0</div>
      <button class="btn btn-transfer" id="transferBtn">Transfer to Main Balance</button>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>User</th><th>Plan</th><th>Bonus</th><th>Status</th>
      </tr>
    </thead>
    <tbody id="rows">
      <tr><td colspan="4">Loading…</td></tr>
    </tbody>
  </table>
</div>

<footer>© 2025 Beni-Wealth</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, getDoc, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
  authDomain: "beni-wealths.firebaseapp.com",
  projectId: "beni-wealths",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const CREDIT = {
  basic:{ bronze:300, silver:600 },
  bronze:{ bronze:500, silver:1000 },
  silver:{ bronze:700, silver:1400 }
};

const REFERRAL_FIELDS = ['referral','referralCode','referrer','referredBy','invitedBy'];

function getBonus(rp, cp){ return CREDIT[rp]?.[cp] || 0; }

onAuthStateChanged(auth, async user => {
  if(!user) return location.href='login.html';

  const meRef = doc(db,'users',user.uid);
  const meSnap = await getDoc(meRef);
  const me = meSnap.data() || {};

  const myPlan = (me.plan || 'basic').toLowerCase();
  const myCode = me.username || user.email.split('@')[0];

  let total = 0, activated = 0;
  let referralBalance = Number(me.referralBalance || 0);

  document.getElementById('balance').textContent = '₦' + referralBalance.toLocaleString('en-NG');

  const found = new Map();
  for(const f of REFERRAL_FIELDS){
    const q = query(collection(db,'users'), where(f,'==',myCode));
    const snap = await getDocs(q);
    snap.forEach(d=>found.set(d.id,{ uid:d.id, ...d.data() }));
  }

  const rows = [];
  for(const d of found.values()){
    total++;
    const plan = (d.plan || 'basic').toLowerCase();
    const activatedNow = plan !== 'basic';
    if(activatedNow) activated++;

    const bonus = getBonus(myPlan, plan);

    let status = '<span class="badge inactive">Inactive</span>';
    if(activatedNow && bonus > 0){
      status = '<span class="badge pending">Pending</span>';
    }

    rows.push(`
      <tr>
        <td>${d.username || '-'}</td>
        <td>${plan}</td>
        <td>₦${bonus}</td>
        <td>${status}</td>
      </tr>`);
  }

  document.getElementById('total').textContent = total;
  document.getElementById('activated').textContent = activated;
  document.getElementById('rows').innerHTML = rows.join('') || '<tr><td colspan="4">No referrals yet</td></tr>';

  /* ----------- TRANSFER TO MAIN BALANCE ----------- */
  document.getElementById('transferBtn').onclick = async () => {
    if(referralBalance <= 0) return alert('No referral balance to transfer');
    if(!confirm(`Transfer ₦${referralBalance.toLocaleString()} to main balance?`)) return;

    try{
      await runTransaction(db, async tx => {
        const snap = await tx.get(meRef);
        const data = snap.data();
        const rb = Number(data.referralBalance || 0);
        if(rb <= 0) throw 'insufficient';

        const bal = Number(data.balance || 0);
        tx.set(meRef, { referralBalance: 0, balance: bal + rb }, { merge:true });

        tx.set(doc(collection(db,'referralTransfers')), {
          uid: user.uid,
          amount: rb,
          ts: serverTimestamp()
        });
      });

      alert('Transfer successful');
      location.reload();
    }catch(e){
      alert('Transfer failed');
    }
  };
});
</script>
</body>
</html>
