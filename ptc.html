<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth — PTC Catalog</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300,400,600,700&display=swap" rel="stylesheet"/>
  <meta name="theme-color" content="#7a5fff" />
  <style>
    /* your styles unchanged */
    :root{--bg:#0b0613;--panel:#0f0820;--muted:rgba(255,255,255,0.62);--card:#0f1120;--accent1:#7a5fff;--accent2:#35d6b1;--text:#eaf2ff;--gap:14px;--radius:12px;}
    *{box-sizing:border-box} html,body{height:100%;margin:0}
    body{margin:0;min-height:100vh;font-family:'Poppins',system-ui,Arial;background:linear-gradient(180deg,var(--bg),var(--panel));color:var(--text);padding:18px;}
    .wrap{max-width:1100px;margin:0 auto;}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px;}
    .brand{display:flex;flex-direction:column;gap:4px;}
    h1{margin:0;font-size:20px}
    .hint{color:var(--muted);font-size:13px;margin-top:2px}
    .controls{display:flex;gap:12px;align-items:center}
    .search{padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);min-width:200px;font-size:14px;outline:none;}
    .search::placeholder{color:rgba(255,255,255,0.32)}
    .filter{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);font-size:14px;}
    .signinBtn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#041219;}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:var(--gap);}
    .card{background:var(--card);padding:14px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.03);box-shadow:0 14px 40px rgba(0,0,0,0.55);display:flex;flex-direction:column;gap:10px;transition:transform .14s ease,box-shadow .14s ease;}
    .card:active,.card:focus-within{transform:translateY(2px);}
    .card h3{margin:0;font-size:16px;color:var(--accent1);font-weight:700}
    .meta{color:var(--muted);font-size:13px;margin-top:4px}
    .reward{font-weight:800;font-size:16px;margin-top:6px;color:var(--text)}
    .views-count{font-size:13px;color:var(--muted);margin-top:4px}
    .actions{margin-top:auto;display:flex;gap:8px;align-items:center}
    .btn{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:800;font-size:14px;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#041219;flex:1;min-width:0}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);border-radius:10px;padding:10px 12px;font-weight:700}
    .visited{opacity:0.8;border:1px solid rgba(61,46,111,0.12)}
    .visited-badge{font-size:12px;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);color:var(--muted);display:inline-block;margin-left:6px}
    .spinner{width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,0.22);border-top-color:#ffffff;animation:spin .9s linear infinite;display:none;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:rgba(0,0,0,0.7);color:#fff;padding:10px 14px;border-radius:8px;z-index:99999;font-size:14px;display:none;}
    .toast.show{display:block;animation:fade .3s ease;}
    @keyframes fade{from{opacity:0;transform:translateX(-50%) translateY(6px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>PTC Catalog</h1>
        <div class="hint">Tap a card to open the PTC page</div>
      </div>
      <div class="controls" role="search" aria-label="Search PTCs">
        <input id="searchInput" class="search" placeholder="Search PTC title or description..." aria-label="Search PTCs">
        <select id="filterSelect" class="filter" aria-label="Filter PTCs">
          <option value="all">All</option>
          <option value="fresh">Unvisited</option>
          <option value="visited">Visited</option>
        </select>
        <button id="signinBtn" class="signinBtn">Sign in</button>
      </div>
    </header>
    <main>
      <div id="grid" class="grid" role="list" aria-live="polite"></div>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, serverTimestamp, increment
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.appspot.com",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web=e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    if(!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    const GRID = document.getElementById('grid');
    const searchInput = document.getElementById('searchInput');
    const filterSelect = document.getElementById('filterSelect');
    const signinBtn = document.getElementById('signinBtn');
    const toast = document.getElementById('toast');

    const REWARD = 0.40;
    const COOLDOWN_MS = 1 * 60 * 60 * 1000;
    const VISITED_EXPIRE_MS = COOLDOWN_MS;

    function makePTC(i){
      return { id:i, title:`PTC #${i}`, description:`Visit the page and complete a small task to earn.`, reward:REWARD.toFixed(2) };
    }
    const PTCs = Array.from({length:20},(_,k)=>makePTC(k+1));

    function showToast(msg,ms=3000){
      toast.textContent=msg; toast.classList.add('show');
      clearTimeout(toast._t);
      toast._t=setTimeout(()=>toast.classList.remove('show'),ms);
    }

    let currentUser=null;
    const provider=new GoogleAuthProvider();
    signinBtn.addEventListener('click',async ()=>{
      try{await signInWithPopup(auth,provider);}catch(e){showToast('Sign-in failed');}
    });
    onAuthStateChanged(auth,user=>{ currentUser=user; signinBtn.textContent=user?'Signed in':'Sign in'; signinBtn.disabled=!!user; render(PTCs); });

    async function recordView(ptcId){
      const ref=doc(db,'ptcViews',String(ptcId));
      try{await updateDoc(ref,{count:increment(1),updatedAt:serverTimestamp()});}
      catch{await setDoc(ref,{count:1,updatedAt:serverTimestamp()});}
    }

    async function handlePTCClick(ptc,{btnOpen,spinnerEl,itemEl}){
      if(!currentUser){ showToast('Sign in to earn'); return; }
      btnOpen.disabled=true; spinnerEl.style.display='inline-block';

      const uid=currentUser.uid, key=`${ptc.id}_${uid}`;
      const clickRef=doc(db,'ptcClicks',key);
      const snap=await getDoc(clickRef);
      let lastMs=null;
      if(snap.exists()&&snap.data().lastClickedAt) lastMs=snap.data().lastClickedAt.toDate().getTime();
      if(lastMs && (Date.now()-lastMs)<COOLDOWN_MS){
        const mins=Math.ceil((COOLDOWN_MS-(Date.now()-lastMs))/60000);
        showToast(`Try again in ${mins} min(s)`);
        btnOpen.disabled=false; spinnerEl.style.display='none';
        return;
      }

      if(snap.exists()) await updateDoc(clickRef,{lastClickedAt:serverTimestamp(),count:increment(1)});
      else await setDoc(clickRef,{ptcId:ptc.id,viewerUid:uid,lastClickedAt:serverTimestamp(),count:1});

      await addDoc(collection(db,'transactions'),{userId:uid,type:'ptc_click',source:`ptc_${ptc.id}`,amount:REWARD,note:`PTC click reward`,createdAt:serverTimestamp()});
      await updateDoc(doc(db,'users',uid),{balance:increment(REWARD)});

      await recordView(ptc.id);
      showToast(`Credited ₦${REWARD.toFixed(2)}`);

      btnOpen.disabled=false; spinnerEl.style.display='none';
      window.open(`ptc-${ptc.id}.html`,'_blank');
    }

    function makeCard(ptc){
      const item=document.createElement('div'); item.className='card';
      const h=document.createElement('h3');h.textContent=ptc.title;
      const meta=document.createElement('div');meta.className='meta';meta.textContent=ptc.description;
      const rew=document.createElement('div');rew.className='reward';rew.textContent=`Reward: ₦${ptc.reward}`;
      const viewsEl=document.createElement('div');viewsEl.className='views-count';viewsEl.textContent='Views: …';

      (async ()=>{
        try{const vdoc=await getDoc(doc(db,'ptcViews',String(ptc.id)));viewsEl.textContent='Views: '+ (vdoc.exists()?vdoc.data().count||0:0);}catch{viewsEl.textContent='Views: 0';}
      })();

      const actions=document.createElement('div');actions.className='actions';
      const btnOpen=document.createElement('button');btnOpen.className='btn primary';
      btnOpen.innerHTML=`<span class="btn-text">Open</span><span class="spinner"></span>`;
      const spinnerEl=btnOpen.querySelector('.spinner');
      btnOpen.addEventListener('click',e=>{e.stopPropagation();handlePTCClick(ptc,{btnOpen,spinnerEl,itemEl:item});});
      const btnDetails=document.createElement('button');btnDetails.className='btn ghost';btnDetails.textContent='Details';
      btnDetails.addEventListener('click',e=>{e.stopPropagation();alert(`${ptc.title}\nReward: ₦${ptc.reward}`);});

      actions.appendChild(btnOpen);actions.appendChild(btnDetails);
      item.appendChild(h);item.appendChild(meta);item.appendChild(rew);item.appendChild(viewsEl);item.appendChild(actions);
      return item;
    }

    function render(items){
      GRID.innerHTML='';items.forEach(ptc=>GRID.appendChild(makeCard(ptc)));
    }
    render(PTCs);
  </script>
</body>
</html>

