<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth — PTC Catalog</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <meta name="theme-color" content="#7a5fff" />
  <style>
    :root{
      --bg:#0b0613;
      --panel:#0f0820;
      --muted:rgba(255,255,255,0.62);
      --card:#0f1120;
      --accent1:#7a5fff;
      --accent2:#35d6b1;
      --text:#eaf2ff;
      --gap:14px;
      --radius:12px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      margin:0;
      min-height:100vh;
      font-family:'Poppins',system-ui,Arial;
      background:linear-gradient(180deg,var(--bg),var(--panel));
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:18px;
    }

    .wrap{ max-width:1100px; margin:0 auto; }

    header{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px; }
    .brand { display:flex; flex-direction:column; gap:4px; }
    h1{margin:0;font-size:20px}
    .hint{color:var(--muted);font-size:13px;margin-top:2px}

    .controls{display:flex;gap:12px;align-items:center}
    .search{ padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,0.04); background:transparent;color:var(--text);min-width:200px;font-size:14px; outline:none; }
    .search::placeholder{color:rgba(255,255,255,0.32)}
    .filter{ padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04); background:transparent;color:var(--muted);font-size:14px; }
    .signinBtn{ padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#041219; }

    .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:var(--gap); }

    .card{ background:var(--card); padding:14px; border-radius:var(--radius); border:1px solid rgba(255,255,255,0.03); box-shadow:0 14px 40px rgba(0,0,0,0.55); display:flex; flex-direction:column; gap:10px; transition:transform .14s ease, box-shadow .14s ease; }
    .card:active, .card:focus-within { transform: translateY(2px); }
    .card h3{margin:0;font-size:16px;color:var(--accent1);font-weight:700}
    .meta{color:var(--muted);font-size:13px;margin-top:4px}
    .reward{font-weight:800;font-size:16px;margin-top:6px;color:var(--text)}

    .actions{margin-top:auto;display:flex;gap:8px;align-items:center}
    .btn{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:800;font-size:14px;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#041219;flex:1;min-width:0}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);border-radius:10px;padding:10px 12px;font-weight:700}

    .visited{opacity:0.8;box-shadow:0 8px 24px rgba(0,0,0,0.45);border:1px solid rgba(61,46,111,0.12)}
    .visited-badge{font-size:12px;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);color:var(--muted);display:inline-block;margin-left:6px}

    footer{margin-top:20px;color:var(--muted);font-size:13px;text-align:center}

    /* Spinner */
    .spinner { width:16px; height:16px; border-radius:50%; border:2px solid rgba(255,255,255,0.22); border-top-color: #ffffff; animation:spin 0.9s linear infinite; display:none; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width:720px) {
      body{padding:12px}
      header{flex-direction:column;align-items:flex-start;gap:8px}
      .controls{width:100%;display:flex;gap:8px}
      .search{flex:1;min-width:0}
      .grid{grid-template-columns:1fr;gap:12px}
      .actions{flex-direction:column-reverse}
      .btn.primary{width:100%}
      .btn.ghost{width:100%}
      .card{padding:12px}
      h1{font-size:18px}
    }

    @media (max-width:420px){
      .search{padding:10px}
      .filter{padding:8px}
      .brand h1{font-size:16px}
      .hint{font-size:12px}
      .btn{font-size:15px;padding:12px;border-radius:12px}
    }

    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:rgba(0,0,0,0.7); color:#fff; padding:10px 14px; border-radius:8px; z-index:99999; font-size:14px; display:none; }
    .toast.show { display:block; animation:fade .3s ease; }
    @keyframes fade { from{opacity:0; transform:translateX(-50%) translateY(6px)} to{opacity:1; transform:translateX(-50%) translateY(0)} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>PTC Catalog</h1>
        <div class="hint">Tap a card to open the PTC page</div>
      </div>

      <div class="controls" role="search" aria-label="Search PTCs">
        <input id="searchInput" class="search" placeholder="Search PTC title or description..." aria-label="Search PTCs">
        <select id="filterSelect" class="filter" aria-label="Filter PTCs">
          <option value="all">All</option>
          <option value="fresh">Unvisited</option>
          <option value="visited">Visited</option>
        </select>
        <button id="signinBtn" class="signinBtn">Sign in</button>
      </div>
    </header>

    <main>
      <div id="grid" class="grid" role="list" aria-live="polite"></div>
    </main>

    <footer>20 PTC links • Each opens the corresponding <code>ptc-X.html</code> page in a new tab.</footer>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module">
    // Firebase imports (modular)
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, serverTimestamp, increment
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // CONFIG - replace with your project values if different
    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.appspot.com",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    if(!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    // UI
    const GRID = document.getElementById('grid');
    const searchInput = document.getElementById('searchInput');
    const filterSelect = document.getElementById('filterSelect');
    const signinBtn = document.getElementById('signinBtn');
    const toast = document.getElementById('toast');

    // Reward and cooldown
    const REWARD = 0.40; // ₦0.40 per click
    const COOLDOWN_MS = 1 * 60 * 60 * 1000; // 1 hour
    const VISITED_EXPIRE_MS = COOLDOWN_MS; // visited badge expires after 1 hour

    // Data: 20 PTCs
    function makePTC(i){
      return {
        id: i,
        title: `PTC #${i}`,
        description: `Visit the page and complete a small task to earn.`,
        reward: REWARD.toFixed(2)
      };
    }
    const PTCs = Array.from({length:20}, (_,k)=> makePTC(k+1));

    // local storage helpers for quick UI visited flag (store timestamp)
    function storageKey(id){ return `ptc_visited_${id}`; }
    function getVisitedTs(id){
      try{
        const v = localStorage.getItem(storageKey(id));
        if(!v) return null;
        const n = Number(v);
        if(!isFinite(n)) return null;
        return n;
      }catch(e){ return null; }
    }
    function isVisitedLocal(id){
      try {
        const ts = getVisitedTs(id);
        if(!ts) return false;
        const age = Date.now() - ts;
        if(age >= VISITED_EXPIRE_MS){
          // expired -> remove
          try { localStorage.removeItem(storageKey(id)); } catch(e){}
          return false;
        }
        return true;
      } catch(e) { return false; }
    }
    function markVisitedLocal(id){
      try{ localStorage.setItem(storageKey(id), String(Date.now())); }catch(e){}
    }
    function clearVisitedLocal(id){
      try{ localStorage.removeItem(storageKey(id)); }catch(e){}
    }

    // Auth state
    let currentUser = null;
    const provider = new GoogleAuthProvider();

    signinBtn.addEventListener('click', async ()=>{
      try{ await signInWithPopup(auth, provider); }catch(err){ showToast('Sign-in failed: ' + (err && err.message ? err.message : String(err)), 4000); console.error('signIn error', err); }
    });

    onAuthStateChanged(auth, user=>{
      currentUser = user;
      if(user){ signinBtn.textContent = 'Signed in'; signinBtn.disabled = true; } else { signinBtn.textContent = 'Sign in'; signinBtn.disabled = false; }
    });

    // show small toast
    function showToast(msg, ms = 3000){
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> { toast.classList.remove('show'); }, ms);
    }

    // pending guard to prevent duplicate parallel requests for the same ptc+user
    const pending = new Set();

    // Server-side check & crediting logic
    // doc path: ptcClicks/<ptcId>_<uid> with fields { ptcId, viewerUid, lastClickedAt, count }
    async function handlePTCClick(ptc, ui = {}) {
      // ui: { btnOpen, spinnerEl, itemEl }
      const btnOpen = ui.btnOpen;
      const spinner = ui.spinnerEl;
      const itemEl = ui.itemEl;

      // If user not signed in, prompt sign-in
      if(!currentUser){
        showToast('Sign in to earn. Opening sign-in...', 2500);
        try{ await signInWithPopup(auth, provider); }catch(err){ showToast('Sign-in failed. Cannot credit.', 3000); return; }
      }
      if(!currentUser){ showToast('Sign in required to earn.', 2500); return; }

      const uid = currentUser.uid;
      const clickDocId = `${ptc.id}_${uid}`;

      // prevent duplicate parallel processing
      if(pending.has(clickDocId)){
        showToast('Processing... please wait', 1500);
        return;
      }
      pending.add(clickDocId);

      // show spinner + disable button
      if(btnOpen){ try { btnOpen.disabled = true; } catch(e){} if(spinner) spinner.style.display = 'inline-block'; }

      try{
        const clickRef = doc(db, 'ptcClicks', clickDocId);
        const snap = await getDoc(clickRef);

        if(snap.exists()){
          const data = snap.data();
          const last = data && data.lastClickedAt;
          if(last){
            const lastMs = typeof last.toDate === 'function' ? last.toDate().getTime() : (new Date(last)).getTime();
            const diff = Date.now() - lastMs;
            if(diff < COOLDOWN_MS){
              const mins = Math.ceil((COOLDOWN_MS - diff) / 60000);
              showToast(`You already claimed this PTC. Try again in ${mins} minute(s).`, 4500);
              return;
            }
          }
        }

        // Allowed: record click and credit (server records)
        try{
          if(snap.exists()){
            await updateDoc(clickRef, { lastClickedAt: serverTimestamp(), count: increment(1) });
          }else{
            await setDoc(clickRef, { ptcId: ptc.id, viewerUid: uid, lastClickedAt: serverTimestamp(), count: 1 });
          }
        }catch(e){ console.warn('ptcClicks write failed', e); }

        // Credit user: add transaction and increment balance
        try{
          const txsCol = collection(db, 'transactions');
          await addDoc(txsCol, {
            userId: uid,
            type: 'ptc_click',
            source: `ptc_${ptc.id}`,
            amount: REWARD,
            note: `PTC click reward for ptc-${ptc.id}`,
            createdAt: serverTimestamp()
          });
        }catch(e){ console.warn('transaction doc creation failed', e); }

        try{
          const userRef = doc(db, 'users', uid);
          await updateDoc(userRef, { balance: increment(REWARD) });
        }catch(e){ console.warn('update user balance failed', e); showToast('Credited but balance update blocked by rules.', 4000); }

        // mark local visited timestamp & update card UI
        markVisitedLocal(ptc.id);
        if(itemEl){
          const visitedBadge = itemEl.querySelector('.visited-badge');
          if(visitedBadge) visitedBadge.style.display = 'inline-block';
          itemEl.classList.add('visited');
        }

        showToast(`Credited ₦${REWARD.toFixed(2)} to your balance. Opening PTC...`, 2000);

        // open the ptc page in a new tab
        const url = `ptc-${ptc.id}.html`;
        window.open(url, '_blank', 'noopener');

      }catch(err){
        console.error('handlePTCClick error', err);
        showToast('Error processing PTC click: ' + (err && err.message ? err.message : String(err)), 4000);
      }finally{
        // cleanup
        pending.delete(clickDocId);
        if(btnOpen){ try { btnOpen.disabled = false; } catch(e){} if(spinner) spinner.style.display = 'none'; }
      }
    }

    // Build card DOM
    function makeCard(ptc){
      const item = document.createElement('div');
      item.className = 'card';
      item.setAttribute('role','listitem');
      item.tabIndex = 0;

      const h = document.createElement('h3'); h.textContent = ptc.title;
      const meta = document.createElement('div'); meta.className='meta'; meta.textContent = ptc.description;
      const reward = document.createElement('div'); reward.className='reward'; reward.textContent = `Reward: ₦${ptc.reward}`;

      const visitedBadge = document.createElement('div'); visitedBadge.className='visited-badge'; visitedBadge.style.display='none'; visitedBadge.textContent='Visited';

      const actions = document.createElement('div'); actions.className='actions';
      const btnOpen = document.createElement('button'); btnOpen.className='btn primary';
      btnOpen.innerHTML = `<span class="btn-text">Open</span><span class="spinner" aria-hidden="true"></span>`;
      const spinnerEl = btnOpen.querySelector('.spinner');

      const btnDetails = document.createElement('button'); btnDetails.className='btn ghost'; btnDetails.textContent='Details';

      // open (crediting + open)
      btnOpen.addEventListener('click', (e) => { e.stopPropagation(); handlePTCClick(ptc, { btnOpen, spinnerEl, itemEl: item }); });

      // allow tapping the card itself to open (mobile-friendly)
      item.addEventListener('click', (e) => { if(e.target.closest('button')) return; btnOpen.click(); });

      // keyboard support: Enter opens
      item.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btnOpen.click(); } });

      btnDetails.addEventListener('click', (e) => { e.stopPropagation(); alert(`${ptc.title}\nReward: ₦${ptc.reward}\n\n${ptc.description}`); });

      actions.appendChild(btnOpen);
      actions.appendChild(btnDetails);

      item.appendChild(h);
      item.appendChild(meta);
      item.appendChild(reward);

      const bottomRow = document.createElement('div');
      bottomRow.style.display = 'flex';
      bottomRow.style.alignItems = 'center';
      bottomRow.style.justifyContent = 'space-between';
      bottomRow.style.gap = '10px';
      bottomRow.appendChild(visitedBadge);
      bottomRow.appendChild(actions);

      item.appendChild(bottomRow);

      // initial visited state (will remove if expired)
      applyVisitedStyle(item, visitedBadge, ptc.id);

      return item;
    }

    function applyVisitedStyle(item, badge, id){
      if(isVisitedLocal(id)){
        item.classList.add('visited');
        badge.style.display = 'inline-block';
      } else {
        item.classList.remove('visited');
        badge.style.display = 'none';
      }
    }

    // render grid
    function render(items){
      GRID.innerHTML='';
      items.forEach(it => GRID.appendChild(makeCard(it)));
    }

    render(PTCs);

    // search/filter
    function filterAndRender(){
      const q = searchInput.value.trim().toLowerCase();
      const f = filterSelect.value;
      const filtered = PTCs.filter(p => {
        const text = (p.title + ' ' + p.description + ' ' + p.reward).toLowerCase();
        if(q && !text.includes(q)) return false;
        if(f === 'fresh' && isVisitedLocal(p.id)) return false;
        if(f === 'visited' && !isVisitedLocal(p.id)) return false;
        return true;
      });
      render(filtered);
    }

    searchInput.addEventListener('input', debounce(filterAndRender, 180));
    filterSelect.addEventListener('change', filterAndRender);

    // debounce
    function debounce(fn, ms=200){ let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=> fn(...a), ms); }; }

    // Periodically clean expired local visited markers and update UI (keeps badges accurate as time passes)
    setInterval(()=> {
      // iterate keys and remove expired ones; then re-render current view so badges refresh
      let changed = false;
      try{
        for(let i=1;i<=20;i++){
          const k = storageKey(i);
          const v = localStorage.getItem(k);
          if(!v) continue;
          const ts = Number(v);
          if(!isFinite(ts)) { localStorage.removeItem(k); changed = true; continue; }
          if(Date.now() - ts >= VISITED_EXPIRE_MS){ localStorage.removeItem(k); changed = true; }
        }
      }catch(e){ /* ignore storage errors */ }
      if(changed) filterAndRender();
    }, 30 * 1000); // check every 30s

    // expose for debugging
    window._ptc = { PTCs, isVisitedLocal, markVisitedLocal, clearVisitedLocal };

  </script>
</body>
</html>
