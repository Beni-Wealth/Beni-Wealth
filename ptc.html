<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth — PTC Catalog</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300,400,600,700&display=swap" rel="stylesheet"/>
  <meta name="theme-color" content="#7a5fff" />
  <style>
    /* your existing styles unchanged — omitted here for brevity */
  </style>
</head>
<body>
  <!-- your existing HTML unchanged — omitted for brevity -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      addDoc, collection, serverTimestamp, increment
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.appspot.com",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web=e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    if (!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    // UI refs
    const GRID = document.getElementById('grid');
    const searchInput = document.getElementById('searchInput');
    const filterSelect = document.getElementById('filterSelect');
    const signinBtn = document.getElementById('signinBtn');
    const toast = document.getElementById('toast');

    const REWARD = 0.40;
    const COOLDOWN_MS = 1 * 60 * 60 * 1000;
    const VISITED_EXPIRE_MS = COOLDOWN_MS;
    const PTCs = Array.from({length:20},(_,k)=>({
      id:k+1,
      title:`PTC #${k+1}`,
      description:`Visit the page and complete a small task to earn.`,
      reward:REWARD.toFixed(2)
    }));

    function showToast(msg, ms=3000){
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>toast.classList.remove('show'),ms);
    }

    let currentUser = null;
    const provider = new GoogleAuthProvider();
    signinBtn.addEventListener('click', async ()=>{
      try{ await signInWithPopup(auth, provider); }
      catch(err){ showToast('Sign‑in failed'); }
    });
    onAuthStateChanged(auth, user=>{
      currentUser=user;
      signinBtn.textContent=user?'Signed in':'Sign in';
      signinBtn.disabled=!!user;
    });

    const pending=new Set();

    // ** New helper: update views counter **
    async function incrementViews(ptcId){
      try{
        const viewRef = doc(db,'ptcViews', String(ptcId));
        // Try to update; if not exists, create with count=1
        try{
          await updateDoc(viewRef, { count: increment(1), updatedAt: serverTimestamp() });
        }catch(e){
          await setDoc(viewRef,{ count:1, updatedAt: serverTimestamp() });
        }
      }catch(err){ console.error("View counter update failed",err); }
    }

    async function handlePTCClick(ptc,{btnOpen,spinnerEl,itemEl}={}){
      if(!currentUser){
        showToast('Sign in to earn',2500);
        try{ await signInWithPopup(auth,provider); }
        catch{return;}
      }
      if(!currentUser) return;

      const uid=currentUser.uid;
      const clickDocId=`${ptc.id}_${uid}`;

      if(pending.has(clickDocId)){
        showToast('Processing…'); return;
      }
      pending.add(clickDocId);
      if(btnOpen) btnOpen.disabled=true;
      if(spinnerEl) spinnerEl.style.display='inline-block';

      try{
        const clickRef=doc(db,'ptcClicks',clickDocId);
        const s=await getDoc(clickRef);

        if(s.exists() && s.data().lastClickedAt){
          const lastMs=s.data().lastClickedAt.toDate().getTime();
          if(Date.now()-lastMs < COOLDOWN_MS){
            const mins=Math.ceil((COOLDOWN_MS-(Date.now()-lastMs))/60000);
            showToast(`Try again in ${mins} min`); return;
          }
        }

        if(s.exists()) await updateDoc(clickRef,{ lastClickedAt: serverTimestamp(), count:increment(1) });
        else await setDoc(clickRef,{ ptcId:ptc.id, viewerUid:uid, lastClickedAt:serverTimestamp(), count:1 });

        // ** Credit user **
        await addDoc(collection(db,'transactions'),{
          userId:uid,
          type:'ptc_click',
          source:`ptc_${ptc.id}`,
          amount:REWARD,
          note:`PTC click reward`,
          createdAt:serverTimestamp()
        });
        await updateDoc(doc(db,'users',uid),{ balance:increment(REWARD) });

        // ** New: increment total views counter **
        await incrementViews(ptc.id);

        localStorage.setItem(`ptc_visited_${ptc.id}`,String(Date.now()));
        if(itemEl) itemEl.classList.add('visited');

        showToast(`Credited ₦${REWARD.toFixed(2)}`,2000);
        window.open(`ptc-${ptc.id}.html`,'_blank','noopener');

      }catch(err){ console.error(err); showToast('Error processing'); }
      finally{
        pending.delete(clickDocId);
        if(btnOpen) btnOpen.disabled=false;
        if(spinnerEl) spinnerEl.style.display='none';
      }
    }

    function isVisitedLocal(id){
      const v=localStorage.getItem(`ptc_visited_${id}`);
      if(!v) return false;
      if(Date.now()-Number(v)>=VISITED_EXPIRE_MS){
        localStorage.removeItem(`ptc_visited_${id}`);
        return false;
      }
      return true;
    }

    function makeCard(ptc){
      const item=document.createElement('div'); item.className='card'; item.tabIndex=0;
      const h=document.createElement('h3'); h.textContent=ptc.title;
      const meta=document.createElement('div'); meta.className='meta'; meta.textContent=ptc.description;
      const reward=document.createElement('div'); reward.className='reward'; reward.textContent=`Reward: ₦${ptc.reward}`;
      const viewsCount=document.createElement('div'); viewsCount.className='views-count'; viewsCount.textContent='Views: …';

      // ** Display total views **
      (async ()=>{
        try{
          const vdoc=await getDoc(doc(db,'ptcViews',String(ptc.id)));
          viewsCount.textContent = 'Views: ' + (vdoc.exists()? (vdoc.data().count||0) : 0);
        }catch(e){ console.error('view fetch failed',e); }
      })();

      const visitedBadge=document.createElement('div'); visitedBadge.className='visited-badge'; visitedBadge.textContent='Visited';
      if(isVisitedLocal(ptc.id)){ item.classList.add('visited'); visitedBadge.style.display='inline-block'; }

      const actions=document.createElement('div'); actions.className='actions';
      const btnOpen=document.createElement('button'); btnOpen.className='btn primary';
      btnOpen.innerHTML=`<span class="btn-text">Open</span><span class="spinner"></span>`;
      const spinnerEl=btnOpen.querySelector('.spinner');
      const btnDetails=document.createElement('button'); btnDetails.className='btn ghost'; btnDetails.textContent='Details';

      btnOpen.addEventListener('click', e=>{ e.stopPropagation(); handlePTCClick(ptc,{btnOpen,spinnerEl,itemEl:item}); });
      item.addEventListener('click', e=>{ if(e.target.closest('button'))return; btnOpen.click(); });
      btnDetails.addEventListener('click', e=>{ e.stopPropagation(); alert(`${ptc.title}\nReward: ₦${ptc.reward}\n\n${ptc.description}`); });

      actions.append(btnOpen, btnDetails);
      item.append(h, meta, reward, viewsCount);
      const bottom=document.createElement('div');
      bottom.style.display='flex'; bottom.style.justifyContent='space-between';
      bottom.append(visitedBadge, actions);
      item.appendChild(bottom);

      return item;
    }

    function render(items){ GRID.innerHTML=''; items.forEach(it=>GRID.appendChild(makeCard(it))); }
    function filterAndRender(){
      const q=searchInput.value.trim().toLowerCase(),f=filterSelect.value;
      const filtered=PTCs.filter(p=>{
        const text=(p.title+' '+p.description+' '+p.reward).toLowerCase();
        if(q && !text.includes(q))return false;
        if(f==='fresh' && isVisitedLocal(p.id))return false;
        if(f==='visited' && !isVisitedLocal(p.id))return false;
        return true;
      });
      render(filtered);
    }

    searchInput.addEventListener('input', e=>filterAndRender());
    filterSelect.addEventListener('change', filterAndRender);

    // initial render
    render(PTCs);

  </script>
</body>
</html>
