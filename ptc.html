<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth — PTC Catalog</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300,400,600,700&display=swap" rel="stylesheet"/>
  <meta name="theme-color" content="#7a5fff" />
  <style>
    :root{
      --bg:#0b0613;--panel:#0f0820;--muted:rgba(255,255,255,0.62);
      --card:#0f1120;--accent1:#7a5fff;--accent2:#35d6b1;--text:#eaf2ff;
      --gap:14px;--radius:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family:'Poppins',system-ui,Arial;
      background:linear-gradient(180deg,var(--bg),var(--panel));
      color:var(--text);padding:18px;
    }
    .wrap{ max-width:1100px; margin:0 auto; }
    header{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px; }
    .brand h1{ margin:0;font-size:20px }
    .hint{color:var(--muted);font-size:13px;}
    .controls{display:flex;gap:12px;align-items:center}
    .search{ padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,0.04); background:transparent;color:var(--text);font-size:14px; outline:none;}
    .filter{ padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04); background:transparent;color:var(--muted);font-size:14px;}
    .signinBtn{ padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#041219;}
    .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:var(--gap); }

    .card{ background:var(--card); padding:14px; border-radius:var(--radius); border:1px solid rgba(255,255,255,0.03); 
          box-shadow:0 14px 40px rgba(0,0,0,0.55); display:flex; flex-direction:column; gap:10px; }
    .card:active, .card:focus-within { transform: translateY(2px); }
    .card h3{margin:0;font-size:16px;color:var(--accent1);font-weight:700}
    .meta{color:var(--muted);font-size:13px;margin-top:4px}
    .reward{font-weight:800;font-size:16px;margin-top:6px;color:var(--text)}
    .views-count{font-size:13px;color:var(--muted);margin-top:4px;}

    .actions{margin-top:auto;display:flex;gap:8px;align-items:center}
    .btn{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:800;font-size:14px;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#041219;flex:1;min-width:0}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);}

    .visited{opacity:0.8;box-shadow:0 8px 24px rgba(0,0,0,0.45);border:1px solid rgba(61,46,111,0.12)}
    .visited-badge{font-size:12px;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);color:var(--muted);display:inline-block;margin-left:6px}

    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:rgba(0,0,0,0.7); color:#fff; padding:10px 14px; border-radius:8px; z-index:99999; font-size:14px; display:none; }
    .toast.show { display:block; animation:fade .3s ease; }
    @keyframes fade { from{opacity:0; transform:translateX(-50%) translateY(6px)} to{opacity:1; transform:translateX(-50%) translateY(0)} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>PTC Catalog</h1>
        <div class="hint">Tap a card to open the PTC page</div>
      </div>
      <div class="controls">
        <input id="searchInput" class="search" placeholder="Search PTC title or description...">
        <select id="filterSelect" class="filter">
          <option value="all">All</option>
          <option value="fresh">Unvisited</option>
          <option value="visited">Visited</option>
        </select>
        <button id="signinBtn" class="signinBtn">Sign in</button>
      </div>
    </header>

    <main>
      <div id="grid" class="grid" role="list" aria-live="polite"></div>
    </main>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, serverTimestamp, increment,
      query, where, getDocs
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "...",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths"
    };
    if(!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    const GRID = document.getElementById('grid');
    const searchInput = document.getElementById('searchInput');
    const filterSelect = document.getElementById('filterSelect');
    const signinBtn = document.getElementById('signinBtn');
    const toast = document.getElementById('toast');

    const REWARD = 0.40;
    const COOLDOWN_MS = 1 * 60 * 60 * 1000;

    function showToast(msg, ms=3000){
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> toast.classList.remove('show'), ms);
    }

    let currentUser=null;
    const provider = new GoogleAuthProvider();
    signinBtn.addEventListener('click', async ()=>{
      try{ await signInWithPopup(auth,provider); }catch(err){ showToast('Sign-in failed'); }
    });
    onAuthStateChanged(auth,user=>{
      currentUser=user;
      signinBtn.textContent = user?'Signed in':'Sign in';
      signinBtn.disabled = !!user;
    });

    function makePTC(i){
      return { id:i, title:`PTC #${i}`, description:`Visit the page and earn`, reward:REWARD.toFixed(2) };
    }
    const PTCs = Array.from({length:20},(_,k)=>makePTC(k+1));

    async function getTotalViews(ptcId){
      try{
        const snap = await getDoc(doc(db,'ptcCounts',String(ptcId)));
        return snap.exists()?snap.data().count||0:0;
      }catch{return 0;}
    }

    async function updateTotalViews(ptcId){
      const ref = doc(db,'ptcCounts',String(ptcId));
      try{ await updateDoc(ref,{ count: increment(1) }); }
      catch{ await setDoc(ref,{ count:1 }); }
    }

    async function handlePTCClick(ptc,itemEl){
      if(!currentUser){ showToast('Sign in to earn'); return; }
      const uid = currentUser.uid;
      const docId = `${ptc.id}_${uid}`;
      const clickRef = doc(db,'ptcClicks',docId);
      const snap = await getDoc(clickRef);

      if(snap.exists()){
        const last = snap.data().lastClickedAt;
        if(last){
          const lastMs = last.toDate().getTime();
          if(Date.now()-lastMs < COOLDOWN_MS){
            const mins = Math.ceil((COOLDOWN_MS - (Date.now()-lastMs))/60000);
            showToast(`Try again in ${mins} min`);
            return;
          }
        }
      }

      await setDoc(clickRef,{ ptcId:ptc.id, viewerUid:uid, lastClickedAt: serverTimestamp() },{ merge:true });

      try{
        // record total views count
        await updateTotalViews(ptc.id);
        const total = await getTotalViews(ptc.id);
        const viewElem = itemEl.querySelector('.views-count');
        if(viewElem) viewElem.textContent = `Views: ${total}`;

        await addDoc(collection(db,'transactions'),{
          userId:uid,type:'ptc_click',source:`ptc_${ptc.id}`,amount:REWARD,
          note:`PTC click reward`,createdAt:serverTimestamp()
        });
        await updateDoc(doc(db,'users',uid),{ balance:increment(REWARD) });
        showToast(`Credited ₦${REWARD.toFixed(2)}`);
      }catch(err){ console.error(err); showToast('Credit failed'); }
    }

    function makeCard(ptc){
      const item=document.createElement('div');item.className='card';
      const title=document.createElement('h3');title.textContent=ptc.title;
      const desc=document.createElement('div');desc.className='meta';desc.textContent=ptc.description;
      const reward=document.createElement('div');reward.className='reward';reward.textContent=`Reward: ₦${ptc.reward}`;
      const views=document.createElement('div');views.className='views-count';views.textContent='Views: ...';

      const btnOpen=document.createElement('button');btnOpen.className='btn primary';btnOpen.textContent='Open';
      btnOpen.addEventListener('click',()=>handlePTCClick(ptc,item));

      item.append(title,desc,reward,views,btnOpen);
      getTotalViews(ptc.id).then(count=>views.textContent=`Views: ${count}`);

      return item;
    }

    function render(){
      GRID.innerHTML='';
      PTCs.forEach(ptc=>GRID.appendChild(makeCard(ptc)));
    }

    render();

    searchInput.addEventListener('input',()=>{
      const q=searchInput.value.toLowerCase();
      document.querySelectorAll('.card').forEach(card=>{
        const txt=card.textContent.toLowerCase();
        card.style.display=txt.includes(q)?'':'none';
      });
    });
    filterSelect.addEventListener('change',render);

  </script>
</body>
</html>
