<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth — PTC Catalog</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300,400,600,700&display=swap" rel="stylesheet"/>
  <meta name="theme-color" content="#7a5fff" />
  <style>
    :root{
      --bg:#0b0613;
      --panel:#0f0820;
      --muted:rgba(255,255,255,0.62);
      --card:#0f1120;
      --accent1:#7a5fff;
      --accent2:#35d6b1;
      --text:#eaf2ff;
      --gap:14px;
      --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      margin:0;
      min-height:100vh;
      font-family:'Poppins',system-ui,Arial;
      background:linear-gradient(180deg,var(--bg),var(--panel));
      color:var(--text);
      padding:12px;
    }
    .wrap{ max-width:1100px; margin:0 auto; }
    header{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px;}
    .brand{display:flex;flex-direction:column;gap:4px;}
    h1{margin:0;font-size:20px}
    .hint{color:var(--muted);font-size:13px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;width:100%;}
    .search{flex:1 1 auto;padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);font-size:14px;outline:none;}
    .search::placeholder{color:rgba(255,255,255,0.32)}
    .filter{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);font-size:14px;}
    .signinBtn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#041219;}
    .grid{display:grid;grid-template-columns:1fr;gap:var(--gap);}
    @media(min-width:600px){.grid{grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}}
    .card{background:var(--card);padding:14px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:8px;}
    .card h3{margin:0;font-size:17px;color:var(--accent1);font-weight:700;}
    .meta{color:var(--muted);font-size:13px;}
    .reward{font-weight:800;font-size:15px;color:var(--text);}
    .views-count{font-size:13px;color:var(--muted);}
    .visited-badge{font-size:12px;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);color:var(--muted);display:inline-block;}
    .actions{display:flex;gap:8px;flex-wrap:wrap;}
    .btn{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:800;font-size:14px;display:inline-flex;align-items:center;justify-content:center;gap:6px;}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#041219;flex:1;}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);}
    .spinner{width:18px;height:18px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin .9s linear infinite;display:none;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);color:#fff;padding:10px 14px;border-radius:8px;font-size:14px;display:none;z-index:99999;}
    .toast.show{display:block;}
  </style>
</head>
<body>

<div class="wrap">
  <header>
    <div class="brand"><h1>PTC Catalog</h1><div class="hint">Tap a card to open the PTC page</div></div>
    <div class="controls">
      <input id="searchInput" class="search" placeholder="Search PTC…">
      <select id="filterSelect" class="filter">
        <option value="all">All</option>
        <option value="fresh">Unvisited</option>
        <option value="visited">Visited</option>
      </select>
      <button id="signinBtn" class="signinBtn">Sign in</button>
    </div>
  </header>

  <div id="grid" class="grid"></div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  addDoc, collection, serverTimestamp, increment
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
  authDomain: "beni-wealths.firebaseapp.com",
  projectId: "beni-wealths",
  storageBucket: "beni-wealths.appspot.com",
  messagingSenderId: "807950483822",
  appId: "1:807950483822:web=e10fa87307e041c4d8417f",
  measurementId: "G-Z2XP3YN6NS"
};

if (!getApps().length) initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

const GRID = document.getElementById('grid');
const searchInput = document.getElementById('searchInput');
const filterSelect = document.getElementById('filterSelect');
const signinBtn = document.getElementById('signinBtn');
const toast = document.getElementById('toast');

const TOTAL_PTCS = 50;
const REWARD = 0.40;
const COOLDOWN_MS = 1 * 60 * 60 * 1000;

const PTCs = Array.from({ length: TOTAL_PTCS }, (_, i) => ({
  id: i + 1,
  title: `PTC #${i + 1}`,
  description: `Visit the page and complete a small task to earn.`,
  reward: REWARD.toFixed(2)
}));

function showToast(msg, ms=3000){
  toast.textContent = msg;
  toast.classList.add('show');
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>toast.classList.remove('show'), ms);
}

let currentUser=null;
const provider = new GoogleAuthProvider();
signinBtn.addEventListener('click', async ()=>{
  try{ await signInWithPopup(auth,provider);}catch{showToast('Sign in failed');}
});

onAuthStateChanged(auth,user=>{
  currentUser=user;
  signinBtn.textContent=user?'Signed in':'Sign in';
  filterAndRender(); 
});

async function incrementViews(ptcId){
  const vRef=doc(db,'ptcViews',String(ptcId));
  try{await updateDoc(vRef,{count:increment(1),updatedAt:serverTimestamp()});}
  catch{await setDoc(vRef,{count:1,updatedAt:serverTimestamp()});}
}

async function handlePTCClick(ptc,btnOpen,spinnerEl){
  if(!currentUser){ showToast('Sign in to earn'); return; }
  btnOpen.disabled=true; spinnerEl.style.display='inline-block';

  const uid=currentUser.uid;
  const key=`${ptc.id}_${uid}`;
  const clickRef=doc(db,'ptcClicks',key);
  const snap=await getDoc(clickRef);

  let lastMs=null;
  if(snap.exists()&&snap.data().lastClickedAt) lastMs=snap.data().lastClickedAt.toDate().getTime();
  if(lastMs && (Date.now()-lastMs)<COOLDOWN_MS){
    const mins=Math.ceil((COOLDOWN_MS-(Date.now()-lastMs))/60000);
    showToast(`Try again in ${mins} min(s)`);
    btnOpen.disabled=false; spinnerEl.style.display='none';
    return;
  }

  if(snap.exists()) await updateDoc(clickRef,{lastClickedAt:serverTimestamp(),count:increment(1)});
  else await setDoc(clickRef,{ptcId:ptc.id,viewerUid:uid,lastClickedAt:serverTimestamp(),count:1});

  await addDoc(collection(db,'transactions'),{userId:uid,type:'ptc_click',source:`ptc_${ptc.id}`,amount:REWARD,note:`PTC click reward`,createdAt:serverTimestamp()});
  await incrementViews(ptc.id);

  showToast(`Credited ₦${REWARD.toFixed(2)}`);

  setTimeout(()=>window.open(`ptc-${ptc.id}.html`,'_blank'),300);
  btnOpen.disabled=false; spinnerEl.style.display='none';
}

function isVisited(ptcId){
  if(!currentUser) return false;
  const key=`${ptcId}_${currentUser.uid}`;
  return currentUser && sessionStorage.getItem(key) && (Date.now()-Number(sessionStorage.getItem(key)))<COOLDOWN_MS;
}

async function makeCard(ptc){
  const item=document.createElement('div'); item.className='card';

  const h=document.createElement('h3'); h.textContent=ptc.title;
  const m=document.createElement('div'); m.className='meta'; m.textContent=ptc.description;
  const r=document.createElement('div'); r.className='reward'; r.textContent=`Reward: ₦${ptc.reward}`;

  const vc=document.createElement('div'); vc.className='views-count';
  try{const vdoc=await getDoc(doc(db,'ptcViews',String(ptc.id))); vc.textContent='Views: '+(vdoc.exists()?vdoc.data().count||0:0);}catch{vc.textContent='Views: 0';}

  const actions=document.createElement('div'); actions.className='actions';
  const btnOpen=document.createElement('button'); btnOpen.className='btn primary'; btnOpen.textContent='Open';
  const spinnerEl=document.createElement('span'); spinnerEl.className='spinner'; btnOpen.append(spinnerEl);

  btnOpen.addEventListener('click',()=>handlePTCClick(ptc,btnOpen,spinnerEl));

  const btnDetails=document.createElement('button'); btnDetails.className='btn ghost'; btnDetails.textContent='Details';
  btnDetails.addEventListener('click',()=>alert(`${ptc.title}\nReward: ₦${ptc.reward}`));

  actions.append(btnOpen,btnDetails);

  if(currentUser && isVisited(ptc.id)){
    const vb=document.createElement('div'); vb.className='visited-badge'; vb.textContent='Visited';
    item.append(vb);
  }

  item.append(h,m,r,vc,actions);
  return item;
}

async function filterAndRender(){
  const q=searchInput.value.toLowerCase();
  const f=filterSelect.value;
  GRID.innerHTML='';
  for(const p of PTCs){
    if(q && !(p.title+' '+p.description).toLowerCase().includes(q)) continue;
    if(f==='fresh' && currentUser && isVisited(p.id)) continue;
    if(f==='visited' && currentUser && !isVisited(p.id)) continue;
    GRID.append(await makeCard(p));
  }
}

searchInput.addEventListener('input',filterAndRender);
filterSelect.addEventListener('change',filterAndRender);

filterAndRender(); // initial
</script>

</body>
</html>
