<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth - withdraw</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <!-- Favicons & Social preview -->
  <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <meta name="msapplication-TileImage" content="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">

  <meta property="og:type" content="website">
  <meta property="og:title" content="Beni-Wealth — Earn Steadily">
  <meta property="og:description" content="Complete simple micro-tasks, complete shortlinks and earn instantly. Advertise efficiently with transparent metrics and fast payouts.">
  <meta property="og:image" content="https://res.cloudinary.com/dq7fpxfbc/image/upload/c_fill,w_1200,h_630/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="theme-color" content="#2fe0b8">

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family: 'Poppins',sans-serif}
    .glass{background:rgba(255,255,255,0.06);backdrop-filter:blur(6px)}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-900 via-slate-800 to-gray-900 text-slate-100 flex items-center justify-center p-6">
  <main class="max-w-3xl w-full">
    <div class="glass border border-white/6 rounded-2xl p-8 shadow-2xl">
      <header class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-2xl font-semibold">Request Withdrawal</h1>
          <p class="text-sm text-slate-400">Fill the details below to request a withdrawal.</p>
        </div>
        <div class="text-right">
          <div id="balanceDisplay" class="text-sm text-slate-300">Balance: ₦0</div>
          <a id="recordsLink" href="withdrawal-record.html" class="inline-block mt-2 px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white text-sm shadow">Records</a>
        </div>
      </header>

      <form id="withdrawForm" class="grid grid-cols-1 gap-4">
        <label class="block">
          <span class="text-sm text-slate-300">Account name</span>
          <input id="accountName" required type="text" placeholder="John Doe" class="mt-2 w-full rounded-lg bg-white/5 border border-white/6 py-3 px-4 outline-none focus:ring-2 focus:ring-indigo-500" />
        </label>

        <label class="block">
          <span class="text-sm text-slate-300">Account number</span>
          <input id="accountNumber" required inputmode="numeric" type="text" maxlength="10" placeholder="0123456789" class="mt-2 w-full rounded-lg bg-white/5 border border-white/6 py-3 px-4 outline-none focus:ring-2 focus:ring-indigo-500" />
          <p class="text-xs text-slate-400 mt-1">Most Nigerian banks use 10-digit account numbers — we'll validate this.</p>
        </label>

        <label class="block">
          <span class="text-sm text-slate-300">Bank</span>
          <select id="bank" required class="mt-2 w-full rounded-lg bg-white/5 border border-white/6 py-3 px-4 outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="">Select bank</option>
            <option>OPay</option>
            <option>Palmpay</option>
            <option>Kuda</option>
            <option>Access Bank</option>
            <option>GTBank (Guaranty Trust Bank)</option>
            <option>Zenith Bank</option>
            <option>First Bank</option>
            <option>UBA (United Bank for Africa)</option>
            <option>Fidelity Bank</option>
            <option>Stanbic IBTC</option>
            <option>Sterling Bank</option>
            <option>Premium Trust</option>
            <option>FCMB</option>
            <option>Polaris Bank</option>
            <option>Keystone Bank</option>
            <option>Wema Bank</option>
            <option>Union Bank</option>
            <option>Ecobank</option>
            <option>Heritage Bank</option>
            <option>Globus Bank</option>
            <option>Citibank</option>
            <option>Jaiz Bank</option>
            <option>Unity Bank</option>
            <option>StanChart (Standard Chartered)</option>
          </select>
        </label>

        <label class="block">
          <span class="text-sm text-slate-300">Amount (₦)</span>
          <input id="amount" required type="number" min="1000" step="1" placeholder="1000" class="mt-2 w-full rounded-lg bg-white/5 border border-white/6 py-3 px-4 outline-none focus:ring-2 focus:ring-indigo-500" />
          <p class="text-xs text-slate-400 mt-1">Minimum withdrawal amount is ₦1,000.</p>
        </label>

        <div class="flex items-center justify-between mt-2">
          <div id="formMsg" class="text-sm"></div>
          <div class="flex items-center gap-3">
            <button id="submitBtn" type="submit" class="px-5 py-2 bg-green-600 rounded-lg shadow hover:bg-green-500">Request</button>
            <button id="clearBtn" type="button" class="px-4 py-2 bg-white/5 rounded-lg">Clear</button>
          </div>
        </div>
      </form>

      <div id="statusToast" class="fixed right-6 bottom-6 invisible transform transition-all rounded-lg p-4 shadow-lg"></div>
    </div>

    <footer class="mt-6 text-center text-slate-400 text-xs">© Beni-Wealth</footer>
  </main>

  <script type="module">
    // ---------- FIREBASE CONFIG (from your saved config) ----------
    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import {
      getFirestore, collection, addDoc, serverTimestamp, doc, runTransaction, onSnapshot, getDoc
    } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    if (!getApps().length) initializeApp(firebaseConfig);
    const db = getFirestore();
    const auth = getAuth();

    // ---------- UI helpers ----------
    const form = document.getElementById('withdrawForm');
    const accountNameEl = document.getElementById('accountName');
    const accountNumberEl = document.getElementById('accountNumber');
    const bankEl = document.getElementById('bank');
    const amountEl = document.getElementById('amount');
    const formMsg = document.getElementById('formMsg');
    const submitBtn = document.getElementById('submitBtn');
    const clearBtn = document.getElementById('clearBtn');
    const statusToast = document.getElementById('statusToast');
    const balanceDisplay = document.getElementById('balanceDisplay');

    let currentUser = null;
    let currentBalance = 0;
    const MIN_WITHDRAWAL = 1000;

    function showToast(message, isError = false) {
      statusToast.textContent = message;
      statusToast.className = `fixed right-6 bottom-6 rounded-lg p-4 shadow-lg ${isError ? 'bg-red-600 text-white' : 'bg-green-600 text-white'} visible`;
      setTimeout(() => {
        statusToast.classList.remove('visible');
        statusToast.style.opacity = '0';
        statusToast.className = 'fixed right-6 bottom-6 invisible transform transition-all rounded-lg p-4 shadow-lg';
      }, 3500);
    }

    function setFormError(msg){ formMsg.textContent = msg; formMsg.className = 'text-sm text-red-400'; }
    function clearFormError(){ formMsg.textContent = ''; formMsg.className = 'text-sm'; }

    function formatN(n){ return '₦' + Number(n || 0).toLocaleString('en-NG'); }

    // auth state: track user and user's balance (live via onSnapshot)
    let userUnsub = null;
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if(user){
        // subscribe to user doc to keep balance fresh
        const uRef = doc(db, 'users', user.uid);
        if(userUnsub) userUnsub();
        userUnsub = onSnapshot(uRef, (snap)=>{
          const d = snap.exists() ? snap.data() : {};
          currentBalance = Number(d.balance || 0);
          balanceDisplay.textContent = `Balance: ${formatN(currentBalance)}`;
          // enable/disable submit depending on balance and auth
          submitBtn.disabled = currentBalance < MIN_WITHDRAWAL;
        }, (err)=>{ console.error('user doc listener err', err); });
      } else {
        if(userUnsub) userUnsub(); userUnsub = null;
        currentBalance = 0;
        balanceDisplay.textContent = `Balance: ${formatN(0)} (sign in required)`;
        submitBtn.disabled = true;
      }
    });

    function validateInputs(){
      const accountName = accountNameEl.value.trim();
      const accountNumber = accountNumberEl.value.trim();
      const bank = bankEl.value.trim();
      const amount = Number(amountEl.value);

      if (!accountName) return { ok:false, msg: 'Account name is required.' };
      if (!/^[0-9]{10}$/.test(accountNumber)) return { ok:false, msg: 'Account number must be 10 digits.' };
      if (!bank) return { ok:false, msg: 'Please select a bank.' };
      if (!amount || isNaN(amount)) return { ok:false, msg: 'Enter a valid amount.' };
      if (amount < MIN_WITHDRAWAL) return { ok:false, msg: `Minimum withdrawal is ${formatN(MIN_WITHDRAWAL)}.` };
      return { ok:true, data: { accountName, accountNumber, bank, amount } };
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearFormError();

      if(!currentUser){ setFormError('Please sign in to request a withdrawal.'); return; }

      const check = validateInputs();
      if(!check.ok){ setFormError(check.msg); return; }

      const { accountName, accountNumber, bank, amount } = check.data;

      // optimistic UI: disable button
      submitBtn.disabled = true; submitBtn.textContent = 'Processing...';

      try {
        // run transaction: ensure user has enough balance, deduct, create withdrawal and transaction docs
        const userRef = doc(db, 'users', currentUser.uid);

        await runTransaction(db, async (tx) => {
          const uSnap = await tx.get(userRef);
          if(!uSnap.exists()) throw new Error('User account not found');
          const uData = uSnap.data();
          const bal = Number(uData.balance || 0);
          if(bal < amount) throw new Error('INSUFFICIENT_FUNDS');

          const newBal = bal - amount;
          // update balance and write a withdrawal request
          tx.set(userRef, { balance: newBal }, { merge: true });

          const withdrawRef = doc(collection(db, 'withdrawal'));
          tx.set(withdrawRef, {
            accountName, accountNumber, bank, amount,
            status: 'pending', requestedBy: currentUser.uid, createdAt: serverTimestamp()
          });

          // also create a transaction record
          const txRef = doc(collection(db, 'transactions'));
          tx.set(txRef, {
            userId: currentUser.uid,
            type: 'debit',
            source: 'withdrawal_request',
            amount: amount,
            balanceAfter: newBal,
            createdAt: serverTimestamp(),
            meta: { withdrawalRef: withdrawRef.id }
          });
        });

        showToast('Withdrawal requested and debited from your balance.');
        form.reset();
      } catch (err) {
        console.error('withdraw err', err);
        if(err && err.message === 'INSUFFICIENT_FUNDS'){
          setFormError('Insufficient balance for this withdrawal.');
        } else if(err && err.message === 'User account not found'){
          setFormError('Account data not found — contact support.');
        } else {
          setFormError('Unable to submit withdrawal. Try again later.');
        }
      } finally {
        submitBtn.disabled = false; submitBtn.textContent = 'Request';
      }
    });

    clearBtn.addEventListener('click', () => form.reset());
  </script>
</body>
        </html>
