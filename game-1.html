<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth — Quiz Progress</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600,700&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --bg-1:#0b0613; --bg-2:#0f0820; --card:rgba(255,255,255,0.03);
      --muted:rgba(255,255,255,0.62); --accent:linear-gradient(90deg,#7a5fff,#35d6b1);
      --bar-bg: rgba(255,255,255,0.04); --bar-fill: linear-gradient(90deg,#35d6b1,#5b3bff);
      --radius:14px; color:#eaf2ff; font-family:'Poppins',system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    }
    html,body{height:100%;margin:0;background: radial-gradient(1000px 600px at 10% 10%, rgba(123,61,255,0.08), transparent), linear-gradient(180deg,var(--bg-1),var(--bg-2)); color:var(--card);}
    .wrap{max-width:920px;margin:28px auto;padding:20px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); border-radius:16px; padding:18px; border:1px solid rgba(255,255,255,0.02); color:var(--text); box-shadow:0 12px 40px rgba(0,0,0,0.45)}
    .top{display:flex;gap:12px;align-items:center}
    .avatar{width:56px;height:56px;border-radius:12px;display:grid;place-items:center;font-weight:800;background:var(--accent); color:#041219}
    h1{margin:0;font-size:18px}
    .muted{color:var(--muted);font-size:13px}
    .desc{margin-top:12px;color:var(--muted)}
    .progress-wrap{margin-top:18px}
    .bar{height:28px;border-radius:12px;background:var(--bar-bg);overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
    .bar-fill{height:100%;width:0%;background:var(--bar-fill);display:flex;align-items:center;justify-content:center;color:#041219;font-weight:800;transition:width 400ms ease}
    .stats{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
    .btn{padding:10px 14px;border-radius:12px;border:0;background:var(--accent);color:#041219;font-weight:800;cursor:pointer}
    .btn-ghost{padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer}
    .note{margin-top:12px;font-size:13px;color:var(--muted)}
    .center{display:flex;justify-content:center;align-items:center}
    .hidden{display:none}
    @media(max-width:720px){ .wrap{padding:12px} .top{flex-direction:row;gap:12px} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="avatar" id="avatar">U</div>
        <div style="flex:1">
          <h1 id="title">Current Affairs Quiz — Participation Progress</h1>
          <div class="muted" id="subtitle">Join now — the event unlocks at 20 participants.</div>
        </div>
        <div style="text-align:right">
          <div class="muted" id="uidline">UID: -</div>
          <div style="margin-top:6px"><button id="signinHint" class="btn-ghost hidden">Sign in</button></div>
        </div>
      </div>

      <p class="desc">This quiz collects entries from participating users. Each entry requires a ₦20 entry fee. Once 20 people have joined the round the progress reaches 100% (20/20). Press <strong>Play</strong> to join — you'll be debited ₦20 and then redirected to the round page.</p>

      <div class="progress-wrap">
        <div class="bar" aria-hidden="false" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
          <div id="barFill" class="bar-fill">0%</div>
        </div>
        <div class="stats">
          <div class="muted" id="countText">0 / 20 participants</div>
          <div class="muted" id="remainingText">20 spots left</div>
        </div>
      </div>

      <div style="margin-top:18px;display:flex;gap:12px;align-items:center">
        <button id="playBtn" class="btn">Play (₦20)</button>
        <button id="detailsBtn" class="btn-ghost">Details</button>
        <div style="margin-left:auto" id="statusMsg" class="muted"></div>
      </div>

      <div class="note" id="infoNote">After payment and successful join you will be redirected to the round page automatically.</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, runTransaction, serverTimestamp, onSnapshot
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // same config as your dashboard
    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI
    const avatarEl = document.getElementById('avatar');
    const uidline = document.getElementById('uidline');
    const barFill = document.getElementById('barFill');
    const countText = document.getElementById('countText');
    const remainingText = document.getElementById('remainingText');
    const playBtn = document.getElementById('playBtn');
    const statusMsg = document.getElementById('statusMsg');
    const signinHint = document.getElementById('signinHint');

    // config
    const QUIZ_ID = 'current_affairs_001';
    const MAX_PARTICIPANTS = 20;
    const ENTRY_FEE = 20;
    const REDIRECT_PAGE = 'round_1764190775161.html'; // requested redirect

    let currentUser = null;

    // helper: extract numeric balance from user doc shape
    function extractBalance(d){
      if(!d || typeof d !== 'object') return null;
      if(typeof d.balance === 'number') return d.balance;
      if(typeof d.walletBalance === 'number') return d.walletBalance;
      if(d.wallet && typeof d.wallet.balance === 'number') return d.wallet.balance;
      if(d.account && typeof d.account.balance === 'number') return d.account.balance;
      const tryFields = ['balance','walletBalance','amount','bal'];
      for(const f of tryFields){
        if(typeof d[f] === 'string'){
          const parsed = Number(String(d[f]).replace(/[^0-9.-]+/g,''));
          if(!isNaN(parsed)) return parsed;
        }
      }
      return null;
    }

    // live listen to progress doc
    const progressRef = doc(db, 'quizProgress', QUIZ_ID);
    onSnapshot(progressRef, (snap) => {
      const data = snap.exists() ? (snap.data() || {}) : {};
      const count = Number(data.participantsCount || 0);
      updateProgress(count);
    }, (err) => {
      console.warn('progress onSnapshot err', err);
      // show fallback 0
      updateProgress(0);
    });

    // initial read to ensure bar shows quickly
    (async function loadInitialProgress(){
      try {
        const s = await getDoc(progressRef);
        const cnt = s.exists() ? Number(s.data().participantsCount || 0) : 0;
        updateProgress(cnt);
      } catch(e) {
        console.warn('initial progress read failed', e);
        updateProgress(0);
      }
    })();

    function updateProgress(count){
      const pct = Math.min(100, Math.round((count / MAX_PARTICIPANTS) * 100));
      barFill.style.width = pct + '%';
      barFill.textContent = pct + '%';
      countText.textContent = `${count} / ${MAX_PARTICIPANTS} participants`;
      const remaining = Math.max(0, MAX_PARTICIPANTS - count);
      remainingText.textContent = `${remaining} spot${remaining===1?'':'s'} left`;
      // if full, optionally disable Play
      if(count >= MAX_PARTICIPANTS){
        playBtn.disabled = true;
        playBtn.textContent = 'Full';
        playBtn.style.opacity = 0.6;
      } else {
        playBtn.disabled = false;
        playBtn.textContent = `Play (₦${ENTRY_FEE})`;
        playBtn.style.opacity = 1;
      }
    }

    // On auth state change show user
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if(!user){
        avatarEl.textContent = 'U';
        uidline.textContent = 'UID: -';
        signinHint.classList.remove('hidden');
      } else {
        avatarEl.textContent = (user.displayName || user.email || 'U')[0].toUpperCase();
        uidline.textContent = `UID: ${user.uid.slice(0,6)}`;
        signinHint.classList.add('hidden');
      }
    });

    signinHint.addEventListener('click', () => {
      alert('Sign-in is handled centrally on your site. Make sure you are signed in on the main domain before visiting this page.');
    });

    // Play button — confirm and perform transactional debit + entry + progress increment
    playBtn.addEventListener('click', async () => {
      statusMsg.textContent = '';
      if(!currentUser) return alert('Please sign in on the site before joining.');

      // quick client-side check: read progress once to ensure not already full
      const pr = await getDoc(progressRef);
      const currentCount = pr.exists() ? Number(pr.data().participantsCount || 0) : 0;
      if(currentCount >= MAX_PARTICIPANTS) { alert('This round is full.'); return; }

      if(!confirm(`Confirm: ₦${ENTRY_FEE} entry fee will be deducted to join this round.`)) return;

      // run single transaction: (1) check users/{uid} balance or balances/{uid}, (2) prevent double-join, (3) deduct, (4) create entry doc quizEntries/{quizId}_{uid}, (5) increment participantsCount in quizProgress/{quizId}
      try {
        await runTransaction(db, async (tx) => {
          const uid = currentUser.uid;
          const uRef = doc(db, 'users', uid);
          const bRef = doc(db, 'balances', uid); // fallback doc
          const entryId = `${QUIZ_ID}_${uid}`;
          const entryRef = doc(db, 'quizEntries', entryId);
          const pRef = progressRef;

          // 1. check entry existence (prevent double join)
          const entrySnap = await tx.get(entryRef);
          if(entrySnap.exists()){
            throw new Error('already-joined');
          }

          // 2. resolve balance (users/{uid} preferred)
          const uSnap = await tx.get(uRef);
          let bal = null;
          if(uSnap.exists()){
            bal = extractBalance(uSnap.data());
          }
          // fallback to balances/{uid}
          if(bal === null || bal === undefined){
            const bSnap = await tx.get(bRef);
            if(bSnap.exists()){
              const bd = bSnap.data();
              bal = (typeof bd.balance === 'number')? bd.balance : (typeof bd.amount === 'number' ? bd.amount : null);
            }
          }
          if(bal === null || bal === undefined) bal = 0;

          if(Number(bal) < ENTRY_FEE){
            throw new Error('insufficient-funds');
          }

          // 3. deduct
          const newBal = Number(bal) - ENTRY_FEE;
          // write back to users/{uid} (merge)
          tx.set(uRef, { balance: newBal }, { merge: true });

          // 4. create entry doc
          tx.set(entryRef, {
            quizId: QUIZ_ID,
            userId: uid,
            userEmail: currentUser.email || null,
            joinedAt: serverTimestamp()
          });

          // 5. bump progress doc participantsCount
          const pSnap = await tx.get(pRef);
          const prevCount = pSnap.exists() ? Number(pSnap.data().participantsCount || 0) : 0;
          const nextCount = Math.min(MAX_PARTICIPANTS, prevCount + 1);
          tx.set(pRef, { participantsCount: nextCount }, { merge: true });

          // transaction body ends — if any step throws, nothing is written
        });

        // success — update UI and redirect
        statusMsg.textContent = 'Joined ✔ — redirecting…';
        // small delay so the user sees status
        setTimeout(() => { window.location.href = REDIRECT_PAGE; }, 700);
      } catch (err) {
        console.error('join transaction failed', err);
        if(err && err.message === 'already-joined'){
          alert('You have already joined this round.');
          return;
        }
        if(err && err.message === 'insufficient-funds'){
          alert('Insufficient balance to join. Please top up.');
          return;
        }
        alert('Could not join: ' + (err.message || err));
      }
    });
  </script>
</body>
</html>
