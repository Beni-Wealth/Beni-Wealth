<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth — Write a Blog (Gold & Platinum)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Favicons & theme colors copied from your register page -->
  <meta name="theme-color" content="#2fe0b8">
  <style>
    :root{
      --bg-1:#0b0613;
      --bg-2:#0f0820;
      --muted:rgba(233,240,255,0.62);
      --card: rgba(255,255,255,0.02);
      --accent-start:#2fe0b8;
      --accent-end:#7a5fff;
      --glass: rgba(255,255,255,0.03);
      --text: #e9f0ff;
      --danger: #ff6b6b;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family:'Poppins',system-ui,Segoe UI,Arial, sans-serif;
      background: linear-gradient(180deg,var(--bg-1),var(--bg-2));
      color: var(--text);
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:36px;
    }

    .container{width:100%;max-width:980px}
    .topbar{display:flex;align-items:center;gap:18px;margin-bottom:18px}
    .logoBox{width:72px;height:72px;border-radius:16px;overflow:hidden;box-shadow:0 10px 40px rgba(122,95,255,0.08)}
    .logoBox img{width:100%;height:100%;object-fit:cover}
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted)}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:var(--radius);
      padding:20px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.02);
      margin-bottom:16px;
    }

    label{display:block;margin:10px 0 6px;color:var(--muted);font-size:13px}
    input[type=text], textarea{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);font-size:14px}
    textarea{min-height:220px;resize:vertical}

    .row{display:flex;gap:12px;align-items:center}
    .btn{
      padding:10px 14px;border-radius:12px;border:0;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:#041219;font-weight:700;cursor:pointer
    }
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}

    .thumb-preview{width:180px;height:116px;border-radius:8px;object-fit:cover;border:1px dashed rgba(255,255,255,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.02))}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:13px}

    @media (max-width:820px){.row{flex-direction:column;align-items:stretch}}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="logoBox"><img src="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png" alt="Beni-Wealth"></div>
      <div>
        <h1>Beni-Wealth — Write a Blog</h1>
        <p class="lead">Only Gold & Platinum members can submit posts. Posts remain pending until admin approval.</p>
      </div>
    </div>

    <div id="status" class="card">Checking authentication & plan...</div>

    <div id="editor" class="card" style="display:none">
      <label for="title">Title</label>
      <input id="title" type="text" placeholder="Post title" />

      <label for="excerpt">Excerpt (short summary)</label>
      <input id="excerpt" type="text" placeholder="Short summary shown on listings" />

      <label for="content">Content</label>
      <textarea id="content" placeholder="Write your blog here..."></textarea>

      <div style="margin-top:12px">
        <label>Thumbnail (optional)</label>
        <div class="row" style="align-items:flex-start">
          <div style="flex:1">
            <input id="thumbFile" type="file" accept="image/*" />
            <div class="small muted" style="margin-top:6px">Thumbnail will be uploaded to Imgur and saved with the post. Max 5MB recommended.</div>
          </div>

          <div style="display:flex;flex-direction:column;align-items:center;gap:8px">
            <img id="thumbPreview" class="thumb-preview" src="" alt="preview" style="display:none"/>
            <div id="thumbStatus" class="small muted">No thumbnail</div>
          </div>
        </div>
      </div>

      <div style="margin-top:14px;display:flex;gap:10px;align-items:center">
        <button id="publish" class="btn">Publish (send for admin approval)</button>
        <button id="clearThumb" class="btn secondary">Remove Thumbnail</button>
        <div id="busy" style="display:none" class="small muted">Publishing...</div>
      </div>

      <div id="message" style="margin-top:12px"></div>
    </div>

    <div class="muted small" style="margin-top:10px">Note: This demo uses your Firebase config and Imgur Client ID provided earlier. For production, upload images via your server to keep keys private.</div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    // --- exact firebase config you provided in your register page ---
    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fB8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    // Imgur client id you gave earlier
    const IMGUR_CLIENT_ID = 'fb533db21a59486';
    const IMGUR_UPLOAD_URL = 'https://api.imgur.com/3/image';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const statusEl = document.getElementById('status');
    const editorEl = document.getElementById('editor');
    const titleEl = document.getElementById('title');
    const excerptEl = document.getElementById('excerpt');
    const contentEl = document.getElementById('content');
    const publishBtn = document.getElementById('publish');
    const busyEl = document.getElementById('busy');
    const messageEl = document.getElementById('message');

    const thumbFileEl = document.getElementById('thumbFile');
    const thumbPreview = document.getElementById('thumbPreview');
    const thumbStatus = document.getElementById('thumbStatus');
    const clearThumbBtn = document.getElementById('clearThumb');

    let selectedThumbFile = null;
    let uploadedThumbUrl = null;

    function showStatus(html){ statusEl.innerHTML = html; }
    function showMessage(html, isError=false){ messageEl.textContent = html; messageEl.style.color = isError ? 'var(--danger)' : 'var(--accent-start)'; }

    onAuthStateChanged(auth, async (user) => {
      if(!user){
        showStatus(`You must be signed in to write a blog. <a href=\"/login.html\">Sign in</a>`);
        editorEl.style.display = 'none';
        return;
      }

      showStatus('Loading your account...');

      try{
        const userDocRef = doc(db, 'users', user.uid);
        const userSnap = await getDoc(userDocRef);
        if(!userSnap.exists()){
          showStatus('No user record found. Please ensure your account document exists in `users/{uid}` with a `plan` field.');
          editorEl.style.display = 'none';
          return;
        }

        const data = userSnap.data();
        const plan = (data.plan || '').toLowerCase();

        if(plan === 'gold' || plan === 'platinum'){
          showStatus(`<strong>Signed in as</strong> ${user.email || user.displayName} — <strong>plan:</strong> ${plan}`);
          editorEl.style.display = 'block';
        } else {
          showStatus(`Your current plan is: <strong>${plan || 'none'}</strong>. Only <strong>gold</strong> and <strong>platinum</strong> users can publish blogs. <a href=\"/plans.html\">Upgrade</a>`);
          editorEl.style.display = 'none';
        }
      }catch(err){
        console.error(err);
        showStatus('Error loading your account — check console for details.');
        editorEl.style.display = 'none';
      }
    });

    // Thumbnail handling
    thumbFileEl.addEventListener('change', () => {
      const f = thumbFileEl.files[0];
      if(!f) return resetThumb();
      if(f.size > 5 * 1024 * 1024){ // 5MB limit
        alert('File too large. Please pick an image under 5MB.');
        thumbFileEl.value = '';
        return resetThumb();
      }
      selectedThumbFile = f;
      const url = URL.createObjectURL(f);
      thumbPreview.src = url; thumbPreview.style.display = 'block';
      thumbStatus.textContent = `Selected: ${f.name}`;
      uploadedThumbUrl = null; // clear previously uploaded
    });

    clearThumbBtn.addEventListener('click', () => {
      thumbFileEl.value = '';
      resetThumb();
    });

    function resetThumb(){
      selectedThumbFile = null;
      uploadedThumbUrl = null;
      thumbPreview.src = '';
      thumbPreview.style.display = 'none';
      thumbStatus.textContent = 'No thumbnail';
    }

    async function uploadImageToImgur(file){
      if(!file) return null;
      const reader = new FileReader();
      const base64 = await new Promise((res, rej) => {
        reader.onload = () => res(reader.result.split(',')[1]);
        reader.onerror = rej;
        reader.readAsDataURL(file);
      });

      try{
        thumbStatus.textContent = 'Uploading to Imgur...';
        const resp = await fetch(IMGUR_UPLOAD_URL, {
          method: 'POST',
          headers: {
            Authorization: `Client-ID ${IMGUR_CLIENT_ID}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ image: base64, type: 'base64' })
        });
        const json = await resp.json();
        if(!json || !json.success) throw new Error(json?.data?.error || 'Upload failed');
        const link = json.data.link;
        thumbStatus.textContent = 'Uploaded';
        return link;
      }catch(err){
        console.error('Imgur upload error', err);
        thumbStatus.textContent = 'Upload failed';
        return null;
      }
    }

    publishBtn.addEventListener('click', async () => {
      const title = titleEl.value.trim();
      const excerpt = excerptEl.value.trim();
      const content = contentEl.value.trim();

      if(!title || !content){ showMessage('Please provide both a title and content.', true); return; }

      publishBtn.disabled = true; busyEl.style.display = 'inline-block'; showMessage('');

      const user = auth.currentUser;
      if(!user){ showMessage('Authentication lost. Please sign in again.', true); publishBtn.disabled = false; busyEl.style.display = 'none'; return; }

      try{
        // get latest user's plan and name
        const userDocRef = doc(db, 'users', user.uid);
        const userSnap = await getDoc(userDocRef);
        const userData = userSnap.exists() ? userSnap.data() : {};
        const plan = (userData.plan || '').toLowerCase();

        if(!(plan === 'gold' || plan === 'platinum')){
          showMessage('Your plan no longer allows posting. Please upgrade.', true);
          publishBtn.disabled = false; busyEl.style.display = 'none';
          return;
        }

        // upload thumbnail if selected
        if(selectedThumbFile){
          uploadedThumbUrl = await uploadImageToImgur(selectedThumbFile);
          if(!uploadedThumbUrl){
            showMessage('Failed to upload thumbnail. Please try again or remove it.', true);
            publishBtn.disabled = false; busyEl.style.display = 'none';
            return;
          }
        }

        // create blog document
        await addDoc(collection(db, 'blogs'), {
          title,
          excerpt: excerpt || null,
          content,
          authorId: user.uid,
          authorName: user.displayName || user.email || null,
          status: 'pending',
          plan: plan,
          thumbnailUrl: uploadedThumbUrl || null,
          createdAt: serverTimestamp()
        });

        titleEl.value = '';
        excerptEl.value = '';
        contentEl.value = '';
        resetThumb();
        showMessage('Submitted! Your blog is pending admin approval.');
      }catch(err){
        console.error(err);
        showMessage('Failed to submit blog — check console for details.', true);
      } finally{
        publishBtn.disabled = false; busyEl.style.display = 'none';
      }
    });

  </script>

  <!--
    Firestore rules suggestion (paste into Firebase console -> Firestore -> Rules)
    - Uses your users/{uid}.plan field to restrict creation to gold/platinum
    - Requires status == 'pending' on create
    - Admins (users/{uid}.role == 'admin') can update status
  -->
  <!--
  service cloud.firestore {
    match /databases/{database}/documents {
      match /users/{userId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if false;
      }
      match /blogs/{blogId} {
        allow create: if request.auth != null
                      && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.plan in ["gold","platinum"]) 
                      && request.resource.data.authorId == request.auth.uid
                      && request.resource.data.status == "pending"
                      && (request.resource.data.thumbnailUrl == null || request.resource.data.thumbnailUrl is string);
        allow read: if resource.data.status == "approved" || (request.auth != null && request.auth.uid == resource.data.authorId);
        allow update: if request.auth != null && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin");
        allow delete: if request.auth != null && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin");
      }
    }
  }
  -->
</body>
</html>
