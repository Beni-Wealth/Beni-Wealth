<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth â€” Dashboard (Photo Upload, Enhanced)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #F7F3E3;
      --panel: #FFFFFF;
      --ink: #0B2545;
      --muted: #6B7A8A;
      --accent: #1976D2;
      --success: #2e7d32;
      --radius: 12px;
      --maxw: 980px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Poppins',Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink);-webkit-font-smoothing:antialiased;}
    body{display:flex;justify-content:center;padding:20px 16px 60px;}/* header */
header.app-header{
  position:fixed; left:50%; transform:translateX(-50%); top:12px;
  width:100%; max-width:var(--maxw); height:64px; z-index:1300;
  display:flex; align-items:center; justify-content:space-between; padding:8px 12px; pointer-events:none;
}
.header-inner{pointer-events:auto; display:flex; align-items:center; gap:12px; width:100%; justify-content:space-between;}
.left-controls{display:flex;align-items:center;gap:10px}
.hamburger{width:52px;height:52px;border-radius:12px;background:var(--panel);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 8px 28px rgba(11,37,69,0.06);border:1px solid rgba(11,37,69,0.04)}
.hamburger .bar{width:20px;height:2px;background:var(--ink);display:block;margin:3px 0;border-radius:2px}
.icon-btn{width:44px;height:44px;border-radius:12px;background:var(--panel);display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid rgba(11,37,69,0.03)}
.brand img{height:44px;border-radius:10px;box-shadow:0 10px 30px rgba(11,37,69,0.06)}

main.stage{width:100%; max-width:var(--maxw); margin-top:96px; display:grid; gap:20px;}

/* left sidebar (overlay) */
.sidebar {
  position:fixed; left:0; top:0; height:100vh; width:100%;
  transform:translateX(-100%);
  background:rgba(255,255,255,0.98); box-shadow:2px 0 24px rgba(0,0,0,0.08); z-index:2200; overflow:auto;
  transition: transform .34s cubic-bezier(.2,.9,.3,1);
  display:flex; flex-direction:column; gap:12px; padding:18px; border-top-right-radius:14px; border-bottom-right-radius:14px;
}
/* on large screens show a narrower panel centered: */
@media(min-width:1100px){
  .sidebar { width: clamp(420px, 36vw, 520px); left: calc(50% - 260px); border-radius:14px; top:28px; height:calc(100vh - 56px); }
  .sidebar.open { transform:translateX(0); left: calc(50% - 260px); }
}
.sidebar.open { transform:translateX(0); }

.side-head { display:flex; align-items:center; gap:12px; justify-content:space-between; }
.avatar-wrap{display:flex;align-items:center;gap:12px}
#avatar {
  width:72px;height:72px;border-radius:14px;background:linear-gradient(180deg,#1976D2,#115293);color:#fff;font-weight:700;font-size:28px;
  display:flex;align-items:center;justify-content:center;overflow:hidden;
}
#avatar img { width:100%; height:100%; object-fit:cover; display:block; }

.user-meta { display:flex; flex-direction:column; gap:6px; }
.user-meta .name { font-size:16px; font-weight:700; color:var(--ink); }
.user-meta .uid { font-size:13px; color:var(--muted); }
.ref-row { display:flex; align-items:center; gap:8px; font-size:13px; color:var(--muted); }
.ref-row button { padding:6px 8px; border-radius:8px; border:none; background:var(--accent); color:#fff; cursor:pointer; font-weight:600; }

.close-x { background:transparent;border:none;font-size:22px;cursor:pointer;color:var(--accent); }

nav.side-nav{margin-top:12px;display:flex;flex-direction:column;gap:8px;padding-right:8px}
.nav-item { display:flex; align-items:center; gap:12px; padding:10px; border-radius:10px; text-decoration:none; color:var(--ink); background:transparent; transition: background .12s, transform .12s; }
.nav-emoji{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;background:rgba(25,118,210,0.08)}
.nav-label{font-weight:600}

.side-footer{margin-top:auto;font-size:13px;color:var(--muted);display:flex;justify-content:space-between;align-items:center;gap:8px}

.backdrop{position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.24);opacity:0;pointer-events:none;z-index:2100;transition:opacity .22s}
.backdrop.visible{opacity:1;pointer-events:auto}

/* content layout */
.container{max-width:980px;margin:0 auto;display:grid;grid-template-columns:1fr 360px;gap:20px;align-items:start}
.left-col{display:flex;flex-direction:column;gap:16px}
.card{background:var(--panel);border-radius:12px;padding:16px;box-shadow:0 6px 24px rgba(11,37,69,0.05)}
.big-balance{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:22px;border-radius:12px}
.label{font-weight:700;color:var(--muted)}
.amount{font-size:36px;color:var(--accent);font-weight:800}

.stats-row{display:flex;gap:12px}
.stat{flex:1;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(25,118,210,0.04), rgba(25,118,210,0.01));text-align:center}
.stat .num{font-weight:800;font-size:18px}
.stat .lbl{color:var(--muted);font-size:13px;margin-top:6px}

.right-col{display:flex;flex-direction:column;gap:12px}
.tx-list table{width:100%;border-collapse:collapse}
.tx-list th,.tx-list td{text-align:left;padding:8px 0;border-bottom:1px solid #f3f3f3;font-size:14px;color:var(--ink)}
.tx-list thead th{color:var(--muted);font-weight:700;border-bottom:2px solid #eee}

.upload-row{display:flex;flex-direction:column;gap:8px;margin-top:10px}

.progress-wrap{margin-top:8px}
.progress{height:8px;background:#e9f3ff;border-radius:999px;overflow:hidden}
.progress > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#3aa0ff)}

.toast{position:fixed;right:20px;bottom:26px;background:var(--panel);padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(11,37,69,0.08);border-left:4px solid var(--accent);z-index:2400;display:none}
.toast.show{display:block}

@media (max-width:980px){ .container{grid-template-columns:1fr} .right-col{order:2} .sidebar.open{width:100%} }

  </style>
</head>
<body>
  <!-- toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>  <!-- backdrop -->  <div id="backdrop" class="backdrop" aria-hidden="true"></div>  <!-- sidebar (left overlay) -->  <aside id="sidebar" class="sidebar" aria-hidden="true" aria-modal="true" role="dialog">
    <div class="side-head">
      <div class="avatar-wrap">
        <div id="avatar" aria-hidden="true">U</div>
        <div class="user-meta">
          <div id="sb-name" class="name">User</div>
          <div id="sb-uid" class="uid">UID: -----</div>
          <div class="ref-row">Referral: <strong id="ref-code">-</strong><button id="copy-ref">Copy</button></div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <button id="side-notif" class="icon-btn" title="Notifications">ğŸ””</button>
        <button id="side-profile" class="icon-btn" title="Profile">ğŸ‘¤</button>
        <button id="close-x" class="close-x" aria-label="Close menu">Ã—</button>
      </div>
    </div><!-- photo upload block -->
<div class="card">
  <div style="font-weight:700;margin-bottom:8px">Profile photo</div>
  <div class="upload-row">
    <input id="photo-input" type="file" accept="image/*" style="padding:6px" aria-label="Choose profile photo" />
    <div id="preview-wrap" style="display:flex;align-items:center;gap:12px">
      <div id="preview" style="width:72px;height:72px;border-radius:12px;background:#f3f3f3;display:flex;align-items:center;justify-content:center;color:#777">Preview</div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button id="upload-btn" style="padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer">Upload Photo</button>
        <div id="upload-status" style="font-size:13px;color:var(--muted)"></div>
        <div id="upload-progress" class="progress-wrap" style="display:none">
          <div class="progress" aria-hidden="true"><i id="upload-progress-bar"></i></div>
          <div id="upload-percent" style="font-size:12px;color:var(--muted);margin-top:6px">0%</div>
        </div>
      </div>
    </div>
    <div style="font-size:12px;color:var(--muted);margin-top:6px">Max size 2.5MB (will compress if needed). Square images work best.</div>
  </div>
</div>

<nav id="side-nav" class="side-nav" aria-label="Sidebar navigation">
  <a class="nav-item" href="tasks.html"><div class="nav-emoji task-emoji">ğŸ§¾</div><div class="nav-label">Completed Tasks</div></a>
  <a class="nav-item" href="orders.html"><div class="nav-emoji">ğŸ“¦</div><div class="nav-label">Orders</div></a>
  <a class="nav-item" href="shortlinks.html"><div class="nav-emoji">ğŸ”—</div><div class="nav-label">Shortlinks</div></a>
  <a class="nav-item" href="terms.html"><div class="nav-emoji">ğŸ“œ</div><div class="nav-label">Terms</div></a>
  <a class="nav-item" href="contact.html"><div class="nav-emoji">âœ‰ï¸</div><div class="nav-label">Contact Us</div></a>
  <a id="signout-btn" class="nav-item" href="#"><div class="nav-emoji">â›”</div><div class="nav-label">Sign out</div></a>
</nav>

<div class="side-footer">
  <div style="font-size:13px;color:var(--muted)">Beni-Wealth â€¢ v1.0</div>
  <a href="profile.html" style="text-decoration:none;color:var(--accent);font-weight:600">View profile</a>
</div>

  </aside>  <!-- header (fixed) -->  <header class="app-header">
    <div class="header-inner">
      <div class="left-controls">
        <button id="menu-btn" class="hamburger" aria-label="Open menu" title="Menu">
          <span style="display:flex;flex-direction:column;align-items:center"><span class="bar"></span><span class="bar"></span><span class="bar"></span></span>
        </button>
        <div class="brand"><img src="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png" alt="logo"></div>
      </div><div style="display:flex;align-items:center;gap:12px;pointer-events:auto">
    <button id="top-notif" class="icon-btn" title="Notifications">ğŸ””</button>
    <!-- top-profile will show avatar img if uploaded -->
    <button id="top-profile" class="icon-btn" title="Profile">
      <span id="top-profile-placeholder">ğŸ‘¤</span>
    </button>
  </div>
</div>

  </header>  <!-- main content -->  <main class="stage" role="main">
    <div class="container">
      <div class="left-col">
        <div class="card big-balance">
          <div>
            <div class="label">Main Balance</div>
            <div id="main-balance" class="amount">â‚¦0.00</div>
            <div style="color:var(--muted);font-size:13px;margin-top:6px">Welcome back â€” nice to see you.</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
            <button id="withdraw-btn" style="background:var(--accent);border:none;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer">Withdraw</button>
            <button id="tasks-btn" style="border:1px solid rgba(11,37,69,0.06);background:transparent;padding:8px 12px;border-radius:8px;cursor:pointer">View Tasks</button>
          </div>
        </div><div class="stats-row">
      <div class="stat card">
        <div class="num" id="completed-count">0</div>
        <div class="lbl">Completed Tasks</div>
      </div>
      <div class="stat card">
        <div class="num" id="orders-count">0</div>
        <div class="lbl">Orders</div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:700">Quick Actions</div>
        <div style="color:var(--muted);font-size:13px">Shortcuts</div>
      </div>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="start-task" style="background:var(--accent);color:#fff;padding:10px;border-radius:8px;border:none;cursor:pointer">Start Task</button>
        <button id="complete-shortlink" style="border:1px solid rgba(11,37,69,0.06);padding:10px;border-radius:8px;background:transparent;cursor:pointer">Complete Shortlink</button>
        <button id="invite" style="border:1px solid rgba(11,37,69,0.06);padding:10px;border-radius:8px;background:transparent;cursor:pointer">Invite</button>
      </div>
    </div>
  </div>

  <aside class="right-col">
    <div class="card tx-list">
      <h3 style="margin-top:0">Recent Transactions</h3>
      <table>
        <thead><tr><th>Type</th><th>Date</th><th style="text-align:right">Amount</th></tr></thead>
        <tbody id="txn-body"><tr><td colspan="3" style="text-align:center;color:var(--muted);padding:18px">Loading...</td></tr></tbody>
      </table>
    </div>

    <div class="card leaderboard">
      <div style="display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:700">Leaderboard</div><div style="color:var(--muted);font-size:13px">Top referrers</div></div>
      <ol style="margin:12px 0 0 18px;color:var(--ink)"><li style="margin-bottom:8px">Blamo â€” â‚¦12,000</li><li style="margin-bottom:8px">Ada â€” â‚¦10,200</li><li style="margin-bottom:8px">Chike â€” â‚¦8,400</li></ol>
    </div>
  </aside>
</div>

  </main>  <!-- Firebase + app logic (includes Storage upload & Firestore photoURL save) -->  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js';
    import {
      getFirestore, doc, getDoc, collection, query, where, orderBy, limit,
      onSnapshot, setDoc
    } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js';
    import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js';

    // Beni-Wealth Firebase config (from script)
    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // DOM
    const menuBtn = document.getElementById('menu-btn');
    const sidebar = document.getElementById('sidebar');
    const closeX = document.getElementById('close-x');
    const backdrop = document.getElementById('backdrop');
    const sideNav = document.getElementById('side-nav');

    const avatarEl = document.getElementById('avatar');
    const sbName = document.getElementById('sb-name');
    const sbUid = document.getElementById('sb-uid');
    const topProfilePlaceholder = document.getElementById('top-profile-placeholder');

    const photoInput = document.getElementById('photo-input');
    const preview = document.getElementById('preview');
    const uploadBtn = document.getElementById('upload-btn');
    const uploadStatus = document.getElementById('upload-status');
    const uploadProgressWrap = document.getElementById('upload-progress');
    const uploadProgressBar = document.getElementById('upload-progress-bar');
    const uploadPercent = document.getElementById('upload-percent');

    const mainBalanceEl = document.getElementById('main-balance');
    const completedCountEl = document.getElementById('completed-count');
    const ordersCountEl = document.getElementById('orders-count');
    const txnBody = document.getElementById('txn-body');

    const signoutBtn = document.getElementById('signout-btn');
    const copyRefBtn = document.getElementById('copy-ref');
    const refCodeEl = document.getElementById('ref-code');
    const toast = document.getElementById('toast');

    let currentUserUid = null;
    let selectedFile = null;
    let userUnsub = null;
    let txUnsub = null;
    let countsUnsub = { tasks: null, orders: null };

    // helper: show toast
    function showToast(msg, timeout = 2800) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), timeout);
    }

    // sidebar open/close
    function openSidebar() {
      sidebar.classList.add('open');
      backdrop.classList.add('visible');
      sidebar.setAttribute('aria-hidden', 'false');
      backdrop.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
      closeX.focus();
    }
    function closeSidebar() {
      sidebar.classList.remove('open');
      backdrop.classList.remove('visible');
      sidebar.setAttribute('aria-hidden', 'true');
      backdrop.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      menuBtn.focus();
    }

    menuBtn.addEventListener('click', openSidebar);
    closeX.addEventListener('click', closeSidebar);
    backdrop.addEventListener('click', closeSidebar);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && sidebar.classList.contains('open')) closeSidebar(); });

    // file input preview + validation + compress
    photoInput.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) { selectedFile = null; preview.innerHTML = 'Preview'; return; }

      // validate type
      const allowed = ['image/jpeg','image/png','image/webp'];
      if (!allowed.includes(f.type)) {
        uploadStatus.textContent = 'Unsupported file type. Use JPG/PNG/WebP.';
        photoInput.value = '';
        selectedFile = null;
        return;
      }

      // immediate size check
      if (f.size > 8 * 1024 * 1024) { // too big to handle
        uploadStatus.textContent = 'File too large (max 8 MB).';
        photoInput.value = '';
        selectedFile = null;
        return;
      }

      // show preview
      const url = URL.createObjectURL(f);
      preview.innerHTML = `<img src="${url}" alt="preview" style="width:72px;height:72px;border-radius:12px;object-fit:cover">`;
      uploadStatus.textContent = '';
      selectedFile = f;
    });

    // image compression (returns Blob)
    async function compressImage(file, maxWidth = 1024, maxHeight = 1024, quality = 0.8) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          let { width, height } = img;
          const ratio = Math.min(maxWidth / width, maxHeight / height, 1);
          width = Math.round(width * ratio);
          height = Math.round(height * ratio);
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          canvas.toBlob((blob) => {
            if (!blob) return reject(new Error('Compression failed'));
            resolve(blob);
          }, 'image/jpeg', quality);
        };
        img.onerror = (e) => reject(e);
        img.src = URL.createObjectURL(file);
      });
    }

    // upload handler (with compression + progress)
    uploadBtn.addEventListener('click', async () => {
      if (!currentUserUid) { uploadStatus.textContent = 'You must be signed in.'; return; }
      if (!selectedFile) { uploadStatus.textContent = 'Please select an image first.'; return; }

      uploadBtn.disabled = true;
      uploadStatus.textContent = 'Preparing image...';

      try {
        // compress if necessary
        let uploadBlob = selectedFile;
        if (selectedFile.size > 500 * 1024) { // if > 500KB, compress
          uploadStatus.textContent = 'Compressing image...';
          try {
            const compressed = 
