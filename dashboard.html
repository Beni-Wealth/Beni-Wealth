<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth ‚Äî Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-1:#0b0613; --bg-2:#0f0820; --muted:rgba(255,255,255,0.62);
      --accent-start:#2fe0b8; --accent-end:#7a5fff; --glass:rgba(255,255,255,0.03);
      --text:#e9f0ff;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:20px 18px 160px;font-family:'Poppins',system-ui,Segoe UI,Arial;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:var(--text)}
    .header{display:flex;align-items:center;gap:14px;padding:6px 4px 18px}
    .avatar{width:74px;height:74px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent-start),var(--accent-end));color:#041219;font-weight:800;font-size:22px;box-shadow:0 6px 18px rgba(0,0,0,0.5)}
    .greet{flex:1}
    .greet h1{margin:0;font-size:22px}
    .greet p{margin:6px 0 0;color:var(--muted);font-size:13px}
    .icons{display:flex;gap:12px;align-items:center}
    .icon-btn{width:44px;height:44px;border-radius:12px;background:var(--glass);display:grid;place-items:center;color:var(--text);cursor:pointer;border:0}

    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:20px;padding:18px 22px;margin:8px 0;box-shadow:0 16px 40px rgba(0,0,0,0.6)}
    .small{font-size:14px;color:var(--muted)}
    .balance-row{display:flex;align-items:center;gap:12px}
    /* Reduced balance size from 52px -> 36px */
    .big-balance{font-size:36px;font-weight:800;line-height:1}
    .approx{margin-top:8px;color:var(--muted);font-size:14px}

    .buttons{display:flex;gap:14px;margin-top:16px}
    .btn{flex:1;padding:12px;border-radius:999px;border:1px solid rgba(255,255,255,0.04);cursor:pointer;text-align:center}
    .btn.primary{background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:#041219;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}

    .list{margin-top:18px;display:flex;flex-direction:column;gap:14px}
    .list-item{background:rgba(255,255,255,0.02);border-radius:14px;padding:18px;display:flex;align-items:center;justify-content:space-between;gap:14px;cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
    .li-left{display:flex;gap:14px;align-items:center}
    .li-icon{width:56px;height:56px;border-radius:12px;background:rgba(255,255,255,0.02);display:grid;place-items:center;font-size:22px}
    .li-text h3{margin:0;color:var(--accent-end);font-size:18px}
    .li-text p{margin:6px 0 0;color:var(--muted);font-size:13px}

    /* Bottom nav: make items more spread out like your screenshot */
    .bottom-nav{
      position:fixed;
      left:18px;
      right:18px;
      bottom:16px;
      background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04));
      padding:14px 18px;
      border-radius:40px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 14px 40px rgba(2,6,23,0.6);
      backdrop-filter: blur(6px);
      opacity: 0.98;
    }

    /* Give each nav slot a fixed width so spacing is wide and even */
    .nav-btn{width:64px;text-align:center;color:var(--muted);font-size:12px;display:flex;flex-direction:column;align-items:center}
    .nav-btn .icon-wrap{display:block;margin-bottom:6px;width:44px;height:44px;border-radius:10px;background:rgba(255,255,255,0.04);display:grid;place-items:center;font-size:18px}
    .nav-center{flex:0 0 100px;display:flex;justify-content:center}
    .nav-center .center-btn{width:82px;height:82px;border-radius:50%;background:linear-gradient(135deg,var(--accent-start),var(--accent-end));display:grid;place-items:center;color:#041219;font-size:26px;box-shadow:0 12px 36px rgba(61,46,111,0.35);transform:translateY(-22px)}

    .error{color:#ffb3b3;margin-bottom:12px}
    @media(min-width:900px){body{padding:40px 80px}}
    @media(max-width:360px){ .nav-btn{width:52px} .nav-center .center-btn{width:70px;height:70px} }
  </style>
</head>
<body>
  <div class="header">
    <div class="avatar" id="avatar">U</div>
    <div class="greet">
      <h1 id="greeting">Hello, User</h1>
      <p id="uidline">UID: -</p>
    </div>
    <div class="icons">
      <button class="icon-btn" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
      <button class="icon-btn" id="chatBtn" title="Chat">üí¨</button>
    </div>
  </div>

  <div id="assetsError"></div>

  <div class="card">
    <div class="small">Total Assets (NGN)</div>
    <div class="balance-row" style="justify-content:space-between;align-items:center">
      <div>
        <div class="big-balance" id="balance">‚Ç¶0.00</div>
        <div class="approx" id="approx">‚âà ‚Ç¶0.00</div>
      </div>
      <div style="margin-left:auto;">
        <button class="icon-btn" id="eyeBtn" aria-pressed="false" aria-label="Hide balance" title="Hide/Show balance">üëÅÔ∏è</button>
      </div>
    </div>

    <div class="buttons">
      <div class="btn primary" id="rechargeBtn">Recharge</div>
      <div class="btn ghost" id="withdrawBtn">Withdraw</div>
    </div>
  </div>

  <div class="list">
    <div class="list-item" id="ordersItem" role="button" aria-label="My Orders">
      <div class="li-left">
        <div class="li-icon">üìÑ</div>
        <div class="li-text">
          <h3>My Orders</h3>
          <p class="small">orders overview</p>
        </div>
      </div>
      <div>‚Ä∫</div>
    </div>

    <div class="list-item" id="tasksItem" role="button" aria-label="Available tasks">
      <div class="li-left">
        <div class="li-icon">üîé</div>
        <div class="li-text">
          <h3>available tasks</h3>
          <p class="small">Market & promotions</p>
        </div>
      </div>
      <div>‚Ä∫</div>
    </div>

    <div class="list-item" id="earningsItem" role="button" aria-label="Earnings Report">
      <div class="li-left">
        <div class="li-icon">üìà</div>
        <div class="li-text">
          <h3>Earnings Report</h3>
          <p class="small">Performance</p>
        </div>
      </div>
      <div>‚Ä∫</div>
    </div>
  </div>

  <div class="bottom-nav" role="navigation" aria-label="Main navigation">
    <div class="nav-btn" id="navHome"><div class="icon-wrap">üè†</div><span>Home</span></div>
    <div class="nav-btn" id="navConvert"><div class="icon-wrap">üîÅ</div><span>Convert</span></div>
    <div class="nav-center"><div class="center-btn" id="navCenter">‚öñÔ∏è</div></div>
    <div class="nav-btn" id="navNews"><div class="icon-wrap">üí¨</div><span>News</span></div>
    <div class="nav-btn" id="navAssets"><div class="icon-wrap">üë§</div><span>Assets</span></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Beni-Wealth config
    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const avatarEl = document.getElementById('avatar');
    const greetingEl = document.getElementById('greeting');
    const uidLine = document.getElementById('uidline');
    const balanceEl = document.getElementById('balance');
    const approxEl = document.getElementById('approx');
    const eyeBtn = document.getElementById('eyeBtn');
    const assetsError = document.getElementById('assetsError');

    function formatN(n){ const num = Number(n || 0); return '‚Ç¶' + num.toLocaleString('en-NG', {minimumFractionDigits:2, maximumFractionDigits:2}); }
    function gen5(){ return Math.floor(10000 + Math.random()*90000).toString(); }
    function showAssetsError(msg){ assetsError.innerHTML = msg ? `<div class="error">${msg}</div>` : ''; }

    function makeHiddenKey(uid){ return `bw_balance_hidden_${uid || 'guest'}`; }
    function getPersistedHidden(uid){ try{ return localStorage.getItem(makeHiddenKey(uid)) === '1'; }catch(e){return false;} }
    function setPersistedHidden(uid, hidden){ try{ localStorage.setItem(makeHiddenKey(uid), hidden ? '1' : '0'); }catch(e){} }

    function setBalanceVisibility(hidden, uid){
      setPersistedHidden(uid, hidden);
      eyeBtn.setAttribute('aria-pressed', hidden ? 'true' : 'false');
      eyeBtn.setAttribute('aria-label', hidden ? 'Show balance' : 'Hide balance');
      eyeBtn.textContent = hidden ? 'üôà' : 'üëÅÔ∏è';
      if(hidden){
        balanceEl.textContent = '‚Ç¶‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        approxEl.textContent = '‚âà ‚Ç¶‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
      } else {
        balanceEl.textContent = balanceEl.dataset.realText || '‚Ç¶0.00';
        approxEl.textContent = approxEl.dataset.realText || `‚âà ${balanceEl.dataset.realText || '‚Ç¶0.00'}`;
      }
    }

    eyeBtn.addEventListener('click', ()=>{
      const uid = eyeBtn.dataset.uid || 'guest';
      const hidden = getPersistedHidden(uid);
      setBalanceVisibility(!hidden, uid);
    });

    // navigations
    document.getElementById('settingsBtn').addEventListener('click', ()=> window.location.href='profile.html');
    document.getElementById('chatBtn').addEventListener('click', ()=> window.location.href='chat.html');
    document.getElementById('rechargeBtn').addEventListener('click', ()=> window.location.href='recharge.html');
    document.getElementById('withdrawBtn').addEventListener('click', ()=> window.location.href='withdraw.html');
    document.getElementById('navHome').addEventListener('click', ()=> window.location.href='catalog.html');
    document.getElementById('navConvert').addEventListener('click', ()=> window.location.href='convert.html');
    document.getElementById('navCenter').addEventListener('click', ()=> window.location.href='center.html');
    document.getElementById('navNews').addEventListener('click', ()=> window.location.href='news.html');
    document.getElementById('navAssets').addEventListener('click', ()=> window.location.href='assets.html');

    document.getElementById('ordersItem').addEventListener('click', ()=> window.location.href='orders.html');
    document.getElementById('tasksItem').addEventListener('click', ()=> window.location.href='tasks.html');
    document.getElementById('earningsItem').addEventListener('click', ()=> window.location.href='earnings.html');

    async function tryBalanceFallback(uid){
      try{
        const bRef = doc(db, 'balances', uid);
        const bSnap = await getDoc(bRef);
        if(bSnap && bSnap.exists()){
          const bd = bSnap.data();
          if(bd && (bd.balance !== undefined || bd.amount !== undefined)) return Number(bd.balance ?? bd.amount ?? 0);
        }
      }catch(e){ console.warn('balances/{uid} lookup failed', e); }
      try{
        const col = collection(db, 'balances');
        const q = query(col, where('userId','==', uid));
        const snap = await getDocs(q);
        if(!snap.empty){ const d = snap.docs[0].data(); return Number(d.balance ?? d.amount ?? 0); }
      }catch(e){ console.warn('balances collection query failed', e); }
      return null;
    }

    // wire auth and realtime
    onAuthStateChanged(auth, async (user) => {
      eyeBtn.dataset.uid = 'guest';
      setBalanceVisibility(getPersistedHidden('guest'), 'guest');

      if(!user){
        const demo = gen5();
        uidLine.textContent = `UID: ${demo}`;
        greetingEl.textContent = 'Hello, User';
        return;
      }

      eyeBtn.dataset.uid = user.uid;
      setBalanceVisibility(getPersistedHidden(user.uid), user.uid);
      uidLine.textContent = `UID: ${user.uid.slice(0,5)}`;

      const uRef = doc(db, 'users', user.uid);
      const unsub = onSnapshot(uRef, async (snap) => {
        try{
          if(!snap.exists()){
            greetingEl.textContent = user.displayName ? `Hi, ${user.displayName}` : 'Hello, User';
            avatarEl.textContent = (user.displayName || (user.email && user.email[0]) || 'U').charAt(0).toUpperCase();
            const fb = await tryBalanceFallback(user.uid);
            const val = fb !== null ? fb : 0;
            balanceEl.dataset.realText = formatN(val);
            approxEl.dataset.realText = `‚âà ${formatN(val)}`;
            setBalanceVisibility(getPersistedHidden(user.uid), user.uid);
            return;
          }
          const data = snap.data();
          const username = data.username || user.displayName || (user.email ? user.email.split('@')[0] : null);
          if(username){
            greetingEl.textContent = `Hi, ${username}`;
            avatarEl.textContent = username.charAt(0).toUpperCase();
          } else {
            greetingEl.textContent = 'Hello, User';
            avatarEl.textContent = (user.email && user.email[0]) ? user.email[0].toUpperCase() : 'U';
          }

          const balNum = Number(data.balance ?? 0);
          balanceEl.dataset.realText = formatN(balNum);
          approxEl.dataset.realText = `‚âà ${formatN(balNum)}`;
          setBalanceVisibility(getPersistedHidden(user.uid), user.uid);

        }catch(e){
          console.error('onSnapshot handler error', e);
          if(e && e.code === 'permission-denied'){
            showAssetsError('Permission denied: check Firestore rules for users/{uid} read access.');
          } else {
            showAssetsError('Error reading user data ‚Äî see console.');
          }
        }
      }, (err) => {
        console.warn('users/{uid} onSnapshot error', err);
        if(err && err.code === 'permission-denied'){
          showAssetsError('Permission denied: check Firestore rules for users/{uid} read access.');
        } else {
          showAssetsError('Could not get live updates ‚Äî falling back to one-time reads (see console).');
        }
        (async ()=>{
          try{
            const uSnap = await getDoc(uRef);
            if(uSnap.exists()){
              const d = uSnap.data();
              const username = d.username || user.displayName || (user.email ? user.email.split('@')[0] : null);
              if(username) { greetingEl.textContent = `Hi, ${username}`; avatarEl.textContent = username.charAt(0).toUpperCase(); }
              const bal = Number(d.balance ?? 0);
              balanceEl.dataset.realText = formatN(bal);
              approxEl.dataset.realText = `‚âà ${formatN(bal)}`;
              setBalanceVisibility(getPersistedHidden(user.uid), user.uid);
            } else {
              const fb = await tryBalanceFallback(user.uid);
              const val = fb !== null ? fb : 0;
              balanceEl.dataset.realText = formatN(val);
              approxEl.dataset.realText = `‚âà ${formatN(val)}`;
              setBalanceVisibility(getPersistedHidden(user.uid), user.uid);
            }
          }catch(e){ console.error('fallback read failed', e); }
        })();
      });
    });
  </script>
</body>
</html>
