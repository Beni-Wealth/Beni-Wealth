<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth ‚Äî Dashboard (Balance hide + persist)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-1:#0b0613; --bg-2:#0f0820; --muted:rgba(255,255,255,0.62);
      --accent-start:#2fe0b8; --accent-end:#7a5fff; --glass:rgba(255,255,255,0.03);
      --text:#e9f0ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;padding:20px 18px 140px;font-family:'Poppins',system-ui,Segoe UI,Arial;
      background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:var(--text)
    }

    /* header */
    .header{display:flex;align-items:center;gap:14px;padding:6px 4px 18px}
    .avatar{width:74px;height:74px;border-radius:50%;display:grid;place-items:center;
      background:linear-gradient(135deg,var(--accent-start),var(--accent-end));
      color:#041219;font-weight:800;font-size:22px;box-shadow:0 6px 18px rgba(0,0,0,0.5)}
    .greet{flex:1}
    .greet h1{margin:0;font-size:22px}
    .greet p{margin:6px 0 0;color:var(--muted);font-size:13px}
    .icons{display:flex;gap:12px;align-items:center}
    .icon-btn{width:44px;height:44px;border-radius:12px;background:var(--glass);display:grid;place-items:center;color:var(--text);cursor:pointer;border:0}

    /* balance card */
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:20px;padding:22px;margin:8px 0;box-shadow:0 16px 40px rgba(0,0,0,0.6)}
    .small{font-size:14px;color:var(--muted)}
    .balance-row{display:flex;align-items:center;gap:12px}
    .big-balance{font-size:52px;font-weight:800;line-height:1}
    .approx{margin-top:8px;color:var(--muted);font-size:14px}

    .buttons{display:flex;gap:14px;margin-top:18px}
    .btn{flex:1;padding:14px;border-radius:999px;border:1px solid rgba(255,255,255,0.04);cursor:pointer;text-align:center}
    .btn.primary{background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:#041219;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}

    /* big bottom nav like image */
    .bottom-nav{position:fixed;left:18px;right:18px;bottom:18px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:34px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 12px 40px rgba(2,6,23,0.6)}
    .nav-btn{flex:1;text-align:center;color:var(--muted);font-size:12px}
    .nav-btn .icon-wrap{display:block;margin:0 auto 6px;width:46px;height:46px;border-radius:12px;background:rgba(255,255,255,0.04);display:grid;place-items:center;font-size:18px}
    .nav-center{flex:0 0 84px;display:flex;justify-content:center}
    .nav-center .center-btn{width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,var(--accent-start),var(--accent-end));display:grid;place-items:center;color:#041219;font-size:24px;box-shadow:0 12px 36px rgba(61,46,111,0.35);transform:translateY(-18px)}

    /* small screen adjustments */
    @media (max-width:420px){
      .big-balance{font-size:46px}
      .avatar{width:60px;height:60px;font-size:18px}
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="avatar" id="avatar">U</div>
    <div class="greet">
      <h1 id="greeting">Hello, User</h1>
      <p id="uidline">UID: -</p>
    </div>
    <div class="icons">
      <button class="icon-btn" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
      <button class="icon-btn" id="chatBtn" title="Chat">üí¨</button>
    </div>
  </div>

  <div class="card">
    <div class="small">Total Assets (NGN)</div>

    <div class="balance-row" style="justify-content:space-between;align-items:center">
      <div>
        <div class="big-balance" id="balance">‚Ç¶0.00</div>
        <div class="approx" id="approx">‚âà ‚Ç¶0.00</div>
      </div>

      <!-- Eye toggle: toggles both balance and approx. aria-label updates for accessibility -->
      <div style="margin-left:auto;">
        <button class="icon-btn" id="eyeBtn" aria-pressed="false" aria-label="Hide balance" title="Hide/Show balance">üëÅÔ∏è</button>
      </div>
    </div>

    <div class="buttons">
      <div class="btn primary" id="rechargeBtn">Recharge</div>
      <div class="btn ghost" id="withdrawBtn">Withdraw</div>
    </div>
  </div>

  <!-- some list items (kept minimal) -->
  <div style="margin-top:14px">
    <div style="margin:14px 0;padding:16px;border-radius:14px;background:rgba(255,255,255,0.02)">My Orders</div>
    <div style="margin:14px 0;padding:16px;border-radius:14px;background:rgba(255,255,255,0.02)">available tasks</div>
    <div style="margin:14px 0;padding:16px;border-radius:14px;background:rgba(255,255,255,0.02)">Earnings Report</div>
  </div>

  <div class="bottom-nav" role="navigation" aria-label="Main navigation">
    <div class="nav-btn" id="navHome"><div class="icon-wrap">üè†</div><span>Home</span></div>
    <div class="nav-btn" id="navConvert"><div class="icon-wrap">üîÅ</div><span>Convert</span></div>
    <div class="nav-center"><div class="center-btn" id="navCenter">‚öñÔ∏è</div></div>
    <div class="nav-btn" id="navNews"><div class="icon-wrap">üí¨</div><span>News</span></div>
    <div class="nav-btn" id="navAssets"><div class="icon-wrap">üë§</div><span>Assets</span></div>
  </div>

  <script type="module">
    // -------- Firebase (static imports) -------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Beni-Wealth config (your values)
    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const avatarEl = document.getElementById('avatar');
    const greetingEl = document.getElementById('greeting');
    const uidLine = document.getElementById('uidline');
    const balanceEl = document.getElementById('balance');
    const approxEl = document.getElementById('approx');
    const eyeBtn = document.getElementById('eyeBtn');

    // helpers
    function formatN(n){ const num = Number(n || 0); return '‚Ç¶' + num.toLocaleString('en-NG', {minimumFractionDigits:2, maximumFractionDigits:2}); }
    function gen5(){ return Math.floor(10000 + Math.random()*90000).toString(); }

    // Key to persist per-user: use uid when available
    function makeHiddenKey(uid){ return `bw_balance_hidden_${uid || 'guest'}`; }

    // Apply visibility state to UI
    function setBalanceVisibility(hidden, uid){
      // save to localStorage (per-user)
      try{ localStorage.setItem(makeHiddenKey(uid), hidden ? '1' : '0'); } catch(e){}
      // update UI text and ARIA
      eyeBtn.setAttribute('aria-pressed', hidden ? 'true' : 'false');
      eyeBtn.setAttribute('aria-label', hidden ? 'Show balance' : 'Hide balance');
      if(hidden){
        balanceEl.textContent = '‚Ç¶‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        approxEl.textContent = '‚âà ‚Ç¶‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
      } else {
        // show real text saved on dataset.real (or fallback)
        balanceEl.textContent = balanceEl.dataset.realText || '‚Ç¶0.00';
        approxEl.textContent = approxEl.dataset.realText || `‚âà ${balanceEl.dataset.realText || '‚Ç¶0.00'}`;
      }
      // small visual change to button (optional)
      eyeBtn.textContent = hidden ? 'üôà' : 'üëÅÔ∏è';
    }

    // Read persistent preference for this user
    function getPersistedHidden(uid){
      try{
        const v = localStorage.getItem(makeHiddenKey(uid));
        return v === '1';
      }catch(e){ return false; }
    }

    // Toggle handler uses current user's uid if signed in (stored on element)
    eyeBtn.addEventListener('click', ()=>{
      const uid = eyeBtn.dataset.uid || 'guest';
      const currentlyHidden = getPersistedHidden(uid);
      setBalanceVisibility(!currentlyHidden, uid);
    });

    // Wire navigation (keeps layout unchanged)
    document.getElementById('settingsBtn').addEventListener('click', ()=> window.location.href='profile.html');
    document.getElementById('chatBtn').addEventListener('click', ()=> window.location.href='chat.html');
    document.getElementById('rechargeBtn').addEventListener('click', ()=> window.location.href='recharge.html');
    document.getElementById('withdrawBtn').addEventListener('click', ()=> window.location.href='withdraw.html');
    document.getElementById('navHome').addEventListener('click', ()=> window.location.href='index.html');
    document.getElementById('navConvert').addEventListener('click', ()=> window.location.href='convert.html');
    document.getElementById('navCenter').addEventListener('click', ()=> window.location.href='center.html');
    document.getElementById('navNews').addEventListener('click', ()=> window.location.href='news.html');
    document.getElementById('navAssets').addEventListener('click', ()=> window.location.href='assets.html');

    // Firestore lookups: primary = users/{uid}.balance
    async function readBalanceFallbacks(uid){
      // try balances/{uid} or balances collection as a fallback
      try{
        const bRef = doc(db, 'balances', uid);
        const bSnap = await getDoc(bRef);
        if(bSnap && bSnap.exists()){
          const bd = bSnap.data();
          if(bd && (bd.balance !== undefined || bd.amount !== undefined)) return Number(bd.balance ?? bd.amount ?? 0);
        }
      }catch(e){ console.warn('balances/{uid} lookup failed', e); }
      try{
        const col = collection(db, 'balances');
        const q = query(col, where('userId','==', uid));
        const snap = await getDocs(q);
        if(!snap.empty){ const d = snap.docs[0].data(); return Number(d.balance ?? d.amount ?? 0); }
      }catch(e){ console.warn('balances collection query failed', e); }
      return null;
    }

    // live wiring when user signs in
    onAuthStateChanged(auth, async (user) => {
      // persist key depends on uid; set default guest before settled
      const guestKey = makeHiddenKey('guest');
      // default UI while loading
      uidLine.textContent = 'UID: -';
      greetingEl.textContent = 'Hello, User';
      // apply persisted guest visibility for immediate UI (if any)
      const guestHidden = getPersistedHidden(null);
      setBalanceVisibility(guestHidden, null);

      if(!user){
        // If not signed-in: show demo uid & keep guest key
        const demo = gen5();
        uidLine.textContent = `UID: ${demo}`;
        eyeBtn.dataset.uid = 'guest';
        return;
      }

      // Use user uid for persisted preference key
      eyeBtn.dataset.uid = user.uid;
      const userHidden = getPersistedHidden(user.uid);
      // set visibility according to stored preference (this controls what user sees even before balance arrives)
      setBalanceVisibility(userHidden, user.uid);

      // set header
      uidLine.textContent = `UID: ${user.uid.slice(0,5)}`;
      greetingEl.textContent = 'Hello, User';

      // realtime listen to users/{uid}
      const uRef = doc(db, 'users', user.uid);
      const unsub = onSnapshot(uRef, async (snap) => {
        try{
          if(snap && snap.exists()){
            const data = snap.data();
            // username display if present
            const username = data.username || user.displayName || null;
            if(username){
              greetingEl.textContent = `Hi, ${username}`;
              avatarEl.textContent = username.charAt(0).toUpperCase();
            } else {
              // keep generic
              greetingEl.textContent = 'Hello, User';
              avatarEl.textContent = (user.email && user.email[0]) ? user.email[0].toUpperCase() : 'U';
            }

            // balance
            const balNum = Number(data.balance ?? 0);
            const formatted = formatN(balNum);
            balanceEl.dataset.realText = formatted;
            approxEl.dataset.realText = `‚âà ${formatted}`;
            // show or hide depending on preference
            const hidden = getPersistedHidden(user.uid);
            setBalanceVisibility(hidden, user.uid);
          } else {
            // if no user doc: fallback reads
            const fb = await readBalanceFallbacks(user.uid);
            const val = fb !== null ? fb : 0;
            const formatted = formatN(val);
            balanceEl.dataset.realText = formatted;
            approxEl.dataset.realText = `‚âà ${formatted}`;
            const hidden = getPersistedHidden(user.uid);
            setBalanceVisibility(hidden, user.uid);
          }
        }catch(e){
          console.error('onSnapshot handler error', e);
          // still ensure visibility preference honored
          const hidden = getPersistedHidden(user.uid);
          setBalanceVisibility(hidden, user.uid);
        }
      }, err => {
        console.warn('onSnapshot users/{uid} error', err);
        // if permission denied, still honor persisted preference and show 0
        const hidden = getPersistedHidden(user.uid);
        setBalanceVisibility(hidden, user.uid);
      });
    });
  </script>
</body>
</html>
