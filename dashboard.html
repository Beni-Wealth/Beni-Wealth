<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth — Dashboard (Live Balance)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-1:#0b0613; --bg-2:#0f0820; --muted:rgba(255,255,255,0.62);
      --accent-start:#2fe0b8; --accent-end:#7a5fff; --glass:rgba(255,255,255,0.03); --text:#e9f0ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Poppins',system-ui;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:var(--text);padding:20px}
    .card{background:rgba(255,255,255,0.02);border-radius:16px;padding:18px;max-width:720px;margin:12px auto}
    .header{display:flex;align-items:center;gap:12px}
    .avatar{width:64px;height:64px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent-start),var(--accent-end));color:#041219;font-weight:800}
    .greet h1{margin:0;font-size:20px} .greet p{margin:6px 0 0;color:var(--muted);font-size:13px}
    .big-balance{font-size:44px;font-weight:800}
    .muted{color:var(--muted)}
    .btn{padding:10px 14px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);cursor:pointer}
    .spinner{width:24px;height:24px;border-radius:50%;border:3px solid rgba(255,255,255,0.06);border-top-color:var(--accent-start);animation:spin 1s linear infinite;display:inline-block;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    .notice{margin-top:10px;color:var(--muted);font-size:13px}
    .bottom-nav{position:fixed;left:20px;right:20px;bottom:18px;background:rgba(0,0,0,0.18);padding:12px;border-radius:28px;display:flex;justify-content:space-between;align-items:center}
  </style>
</head>
<body>
  <div class="card header" style="justify-content:space-between">
    <div style="display:flex;align-items:center;gap:12px">
      <div class="avatar" id="avatar">U</div>
      <div class="greet">
        <h1 id="greeting">Hello, User</h1>
        <p id="uidline">UID: -</p>
      </div>
    </div>
    <div style="text-align:right">
      <div><button id="loginBtn" class="btn" style="display:none">Login</button></div>
    </div>
  </div>

  <div class="card" id="balanceCard">
    <div class="muted">Total Assets (NGN)</div>
    <div style="display:flex;align-items:center;gap:12px;margin-top:8px;">
      <div class="big-balance" id="balance">₦0.00</div>
      <div style="margin-left:auto">
        <div id="loading" style="display:none"><span class="spinner"></span> Loading</div>
      </div>
    </div>
    <div class="muted" id="approx">≈ ₦0.00</div>

    <div class="notice" id="notice">Connecting to Firebase...</div>
  </div>

  <div class="bottom-nav">
    <div>Home</div><div>Convert</div><div style="width:56px;height:56px;border-radius:28px;background:linear-gradient(135deg,var(--accent-start),var(--accent-end));"></div><div>News</div><div>Assets</div>
  </div>

<script type="module">
  // --------- CONFIG: Beni-Wealth Firebase (already provided by you) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
    authDomain: "beni-wealths.firebaseapp.com",
    projectId: "beni-wealths",
    storageBucket: "beni-wealths.firebasestorage.app",
    messagingSenderId: "807950483822",
    appId: "1:807950483822:web:e10fa87307e041c4d8417f",
    measurementId: "G-Z2XP3YN6NS"
  };

  // ---------- static imports (modular SDK) ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, onSnapshot, collection, query, where, orderBy, limit, getDocs
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // UI refs
  const greetingEl = document.getElementById('greeting');
  const uidLine = document.getElementById('uidline');
  const avatarEl = document.getElementById('avatar');
  const balanceEl = document.getElementById('balance');
  const approxEl = document.getElementById('approx');
  const noticeEl = document.getElementById('notice');
  const loadingEl = document.getElementById('loading');
  const loginBtn = document.getElementById('loginBtn');

  /** Helpers **/
  function formatN(n){ const num = Number(n || 0); return '₦' + num.toLocaleString('en-NG', {minimumFractionDigits:2, maximumFractionDigits:2}); }
  function gen5(){ return Math.floor(10000 + Math.random()*90000).toString(); }
  function showLoading(on){ loadingEl.style.display = on ? 'inline-block' : 'none'; }
  function renderBalanceNumber(n){ const formatted = formatN(n); balanceEl.textContent = formatted; approxEl.textContent = `≈ ${formatted}`; balanceEl.dataset.realText = formatted; }

  /** Fallback reads if users/{uid}.balance not present **/
  async function readBalanceFallbacks(uid){
    console.info('Attempting fallback balance reads for uid=', uid);

    // 1) users/{uid}.balance (one-time)
    try{
      const uRef = doc(db, 'users', uid);
      const uSnap = await getDoc(uRef);
      console.info('users/{uid} snapshot exists:', uSnap.exists());
      if(uSnap.exists()){
        const d = uSnap.data();
        if(d && (d.balance !== undefined && d.balance !== null)){
          console.info('Found balance on users/{uid}:', d.balance);
          return Number(d.balance);
        }
      }
    }catch(e){ console.warn('read users/{uid} failed', e); }

    // 2) balances/{uid}
    try{
      const bRef = doc(db, 'balances', uid);
      const bSnap = await getDoc(bRef);
      if(bSnap && (typeof bSnap.exists === 'function' ? bSnap.exists() : !!bSnap.exists)){
        const bd = bSnap.data();
        if(bd && (bd.balance !== undefined || bd.amount !== undefined)){
          console.info('Found balance on balances/{uid}:', bd);
          return Number(bd.balance ?? bd.amount ?? 0);
        }
      }
    }catch(e){ console.warn('read balances/{uid} failed', e); }

    // 3) balances collection: newest entry for userId
    try{
      const col = collection(db, 'balances');
      const q = query(col, where('userId','==', uid), orderBy('date','desc'), limit(1));
      const snap = await getDocs(q);
      console.info('balances collection query size:', snap.size ?? (snap.docs ? snap.docs.length : 0));
      if(!snap.empty){
        const d = snap.docs[0].data();
        console.info('latest balances doc:', d);
        return Number(d.balance ?? d.amount ?? 0);
      }
    }catch(e){ console.warn('query balances collection failed', e); }

    return null;
  }

  // Main: onAuthStateChanged — listens for a logged-in user and pulls balance real-time
  onAuthStateChanged(auth, async (user) => {
    showLoading(true);
    if(!user){
      // Not signed in — show Login button (helps testing)
      loginBtn.style.display = 'inline-block';
      noticeEl.textContent = 'You are not signed in. Click Login to sign in (or open your login page in another tab).';
      showLoading(false);
      renderBalanceNumber(0);
      uidLine.textContent = `UID: ${gen5()}`;
      greetingEl.textContent = 'Hello, User';
      loginBtn.onclick = ()=> window.location.href = 'login.html';
      return;
    }

    // Signed in
    loginBtn.style.display = 'none';
    const displayUid = user.uid ? user.uid.slice(0,5) : gen5();
    uidLine.textContent = `UID: ${displayUid}`;
    greetingEl.textContent = 'Hello, User';
    noticeEl.textContent = 'Fetching balance...';
    console.info('Signed in:', user.uid);

    // Real-time listener on users/{uid}
    const userRef = doc(db, 'users', user.uid);
    let seenFirst = false;
    const unsub = onSnapshot(userRef, async (snap) => {
      try{
        if(snap && snap.exists()){
          const data = snap.data();
          console.info('users/{uid} onSnapshot data=', data);
          if(data && (data.balance !== undefined && data.balance !== null)){
            renderBalanceNumber(Number(data.balance));
            noticeEl.textContent = 'Balance pulled from users/{uid}.';
            seenFirst = true;
            showLoading(false);
            return;
          }
        }
        // fallback reads if no balance field
        const fallback = await readBalanceFallbacks(user.uid);
        if(fallback !== null){
          renderBalanceNumber(fallback);
          noticeEl.textContent = 'Balance pulled from fallback location.';
        } else {
          renderBalanceNumber(0);
          noticeEl.textContent = 'No balance found — showing ₦0.00. Check Firestore docs / rules.';
        }
      }catch(err){
        console.error('onSnapshot handler error', err);
        noticeEl.textContent = 'Error reading balance. See console for details.';
        renderBalanceNumber(0);
      }finally{
        if(!seenFirst) showLoading(false);
      }
    }, (err) => {
      console.warn('onSnapshot error', err);
      // If snapshot fails (rules/network), do one-time fallback reads
      (async ()=>{
        try{
          const fallback = await readBalanceFallbacks(user.uid);
          if(fallback !== null) renderBalanceNumber(fallback);
          else renderBalanceNumber(0);
          noticeEl.textContent = 'onSnapshot failed; used fallback reads (check console).';
        }catch(e){
          console.error('fallback read after onSnapshot error failed', e);
          noticeEl.textContent = 'Failed to read balance (check console).';
          renderBalanceNumber(0);
        } finally { showLoading(false); }
      })();
    });

    // (optional) store unsub globally if you want to stop listening later:
    // window._beni_unsub = unsub;
  });

  console.info('Dashboard loaded. If balance still shows 0.00: (1) check browser console for permission-denied or other errors, (2) make sure you are signed into the same Firebase project, (3) confirm balance is stored at users/{uid}.balance or balances/{uid} or balances collection.');
</script>
</body>
</html>
