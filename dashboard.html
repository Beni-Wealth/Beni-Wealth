<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Dashboard</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f6f8;
      color: #333;
    }
    .dashboard-container {
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
    }
    .dashboard-header {
      text-align: center;
      margin-bottom: 30px;
    }
    .dashboard-header h1 {
      font-size: 28px;
      margin: 0;
    }
    .dashboard-header p {
      font-size: 16px;
      color: #666;
    }
    .dashboard-content {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
    }
    .dashboard-card,
    .referral-container,
    .total-referrals-container {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 20px;
      flex: 1;
      min-width: 250px;
    }
    .dashboard-card h2,
    .total-referrals-container h2 {
      margin-top: 0;
      font-size: 20px;
    }
    .dashboard-card p,
    .total-referrals-container p {
      font-size: 18px;
      font-weight: bold;
      color: #27ae60;
    }
    .referral-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .copy-btn {
      background: #27ae60;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    .copy-btn:hover {
      background: #219150;
    }
    .transaction-history {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .transaction-history h2 {
      margin-top: 0;
    }
    .transaction-table {
      width: 100%;
      border-collapse: collapse;
    }
    .transaction-table th,
    .transaction-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .bottom-nav {
      display: flex;
      justify-content: space-around;
      background: #fff;
      padding: 15px;
      position: fixed;
      bottom: 0;
      width: 100%;
      box-shadow: 0 -1px 5px rgba(0,0,0,0.1);
    }
    .nav-item {
      text-align: center;
      font-size: 14px;
      color: #333;
    }
    .nav-item span {
      display: block;
      font-size: 24px;
    }
    .whatsapp-icon {
      position: fixed;
      bottom: 120px;
      right: 20px;
      background-color: #25D366;
      color: white;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 30px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      cursor: pointer;
      z-index: 1000;
    }
    .small-muted { color: #888; font-size: 13px; }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="dashboard-header">
      <h1 id="greeting">Welcome back, User üíº</h1>
      <p>User Dashboard</p>
    </div>
    <div class="dashboard-content">
      <div class="dashboard-card">
        <h2>Balance</h2>
        <p id="balance">Loading...</p>
      </div>
      <div class="dashboard-card">
        <div class="referral-container">
          <p id="referral-code">Referral Code: ‚Äî</p>
          <button class="copy-btn" id="copy-btn">Copy Link</button>
        </div>
        <p class="small-muted" style="margin-top:10px;">Share this link to earn referrals.</p>
      </div>
      <div class="total-referrals-container">
        <h2>Total Referrals</h2>
        <p id="total-referrals">‚Äî</p>
      </div>
    </div>

    <div class="transaction-history">
      <h2>Recent Transactions</h2>
      <table class="transaction-table">
        <thead>
          <tr>
            <th>Source</th>
            <th>Time</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody id="transaction-body">
          <tr id="loading-row"><td colspan="3">Loading transactions‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item" onclick="window.open('https://sites.google.com/view/easypay-ng/menu', '_blank')">
      <span>üìã</span>Menu
    </div>
    <div class="nav-item" onclick="window.open('https://sites.google.com/view/easypay-ng/post-job', '_blank')">
      <span>üì¢</span>Advertise
    </div>
    <div class="nav-item" onclick="window.open('https://sites.google.com/view/easypay-ng/earm', '_blank')">
      <span>üí∏</span>Earn
    </div>
    <div class="nav-item" onclick="window.open('https://sites.google.com/view/easypay-ng/leaderboard', '_blank')">
      <span>üèÜ</span>Leaderboard
    </div>
  </div>

  <div class="whatsapp-icon" onclick="window.open('https://wa.me/2348037402826', '_blank')">
    üí¨
  </div>

  <!-- Firebase (compat) SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // ----- IMPORTANT -----
    // I used the Firebase config available in your project context (EasyPay).
    // If you want to use a different Firebase project for Beni-Wealth, replace the config below with your Beni-Wealth config.
    const firebaseConfig = {
      apiKey: "AIzaSyDRkip46Ql5KhNfuatWAcAxQzgP5tQ8UY",
      authDomain: "easypay-6bce8.firebaseapp.com",
      projectId: "easypay-6bce8",
      storageBucket: "easypay-6bce8.firebasestorage.app",
      messagingSenderId: "862671358267",
      appId: "1:862671358267:web:b243c7b69840ef918c8f1e",
      measurementId: "G-2FZKDQ47FZ"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Utility: format Firestore timestamp to readable string
    function formatTimestamp(ts) {
      if (!ts) return '-';
      let date;
      if (ts.toDate) date = ts.toDate();
      else if (ts.seconds) date = new Date(ts.seconds * 1000);
      else date = new Date(ts);
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      let hr = date.getHours();
      const min = String(date.getMinutes()).padStart(2, '0');
      const ampm = hr >= 12 ? 'PM' : 'AM';
      hr = hr % 12;
      if (hr === 0) hr = 12;
      return `${y}-${m}-${d} ${hr}:${min} ${ampm}`;
    }

    // When auth state changes, load user data
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        // Not signed in ‚Äî redirect to register/login page (adjust path if you use another)
        window.location.href = 'https://beni-wealth.github.io/Beni-Wealth/register.html';
        return;
      }

      try {
        const uid = user.uid;
        // Attempt to read user document from 'users' collection
        const userDocRef = db.collection('users').doc(uid);
        const userSnap = await userDocRef.get();

        let username = null;
        let balance = 0;
        let referralCount = 0;

        if (userSnap.exists) {
          const data = userSnap.data();
          username = data.username || data.name || user.displayName || null;
          balance = (typeof data.balance === 'number') ? data.balance : (data.balance ? Number(data.balance) : 0);
          referralCount = (typeof data.referralCount === 'number') ? data.referralCount : (data.referralCount ? Number(data.referralCount) : 0);
        } else {
          // If users collection not populated, try displayName or email
          username = user.displayName || (user.email ? user.email.split('@')[0] : 'User');
        }

        // Update UI
        const greetingEl = document.getElementById('greeting');
        greetingEl.textContent = `Welcome back, ${username} üíº`;

        document.getElementById('balance').textContent = `‚Ç¶${balance.toFixed(2)}`;
        document.getElementById('total-referrals').textContent = referralCount;

        // Build referral link using the username field (as requested)
        const referralLink = `https://beni-wealth.github.io/Beni-Wealth/register.html?ref=${encodeURIComponent(username)}`;
        document.getElementById('referral-code').textContent = `Referral Code: ${username}`;
        // attach copy handler (safe closure)
        document.getElementById('copy-btn').onclick = () => {
          copyToClipboard(referralLink);
        };

        // Load transactions: assume a 'transactions' collection with userId field
        const txBody = document.getElementById('transaction-body');
        txBody.innerHTML = '<tr id="loading-row"><td colspan="3">Loading transactions‚Ä¶</td></tr>';

        const txQuery = db.collection('transactions')
                         .where('userId', '==', uid)
                         .orderBy('timestamp', 'desc')
                         .limit(10);

        const txSnap = await txQuery.get();
        txBody.innerHTML = ''; // clear loading row

        if (txSnap.empty) {
          txBody.innerHTML = '<tr><td colspan="3">No transactions yet.</td></tr>';
        } else {
          txSnap.forEach(doc => {
            const tx = doc.data();
            const source = tx.source || '‚Äî';
            const amount = (typeof tx.amount === 'number') ? tx.amount : (tx.amount ? Number(tx.amount) : 0);
            const time = formatTimestamp(tx.timestamp);
            const row = document.createElement('tr');
            row.innerHTML = `<td>${escapeHtml(source)}</td><td>${time}</td><td>‚Ç¶${amount}</td>`;
            txBody.appendChild(row);
          });
        }

      } catch (err) {
        console.error('Error fetching user data or transactions:', err);
        alert('Error loading dashboard data. Open console for details.');
      }
    });

    // clipboard helper
    function copyToClipboard(text) {
      // modern approach
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          alert('Referral link copied to clipboard!');
        }).catch(() => {
          fallbackCopy(text);
        });
      } else {
        fallbackCopy(text);
      }
    }
    function fallbackCopy(text) {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.select();
      try {
        document.execCommand('copy');
        alert('Referral link copied to clipboard!');
      } catch (e) {
        prompt('Copy this link:', text);
      }
      document.body.removeChild(ta);
    }

    // basic html-escape for safety
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
  </script>
</body>
</html>
