<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth — Dashboard (Balance wired, referral removed)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg-1:#0f0b1a;--bg-2:#110c21;--muted:rgba(255,255,255,0.6);--accent-start:#2fe0b8;--accent-end:#6ea8ff;--glass:rgba(255,255,255,0.02);--text:#e6eef8}
    *{box-sizing:border-box}body{font-family:'Poppins',system-ui,Segoe UI,Arial;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:var(--text);margin:0;padding:22px}
    .header{display:flex;align-items:center;gap:14px}.avatar{width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(--accent-start),var(--accent-end));display:flex;align-items:center;justify-content:center;font-weight:700;color:#04101a}.greeting{flex:1}.greeting h3{margin:0;font-size:20px}.greeting p{margin:4px 0 0;color:var(--muted);font-size:13px}.icon-btn{width:40px;height:40px;border-radius:10px;background:var(--glass);display:flex;align-items:center;justify-content:center;color:var(--muted);cursor:pointer;border:0}
    .card{margin-top:18px;background:linear-gradient(180deg, rgba(255,255,255,0.025), rgba(255,255,255,0.015));padding:22px;border-radius:18px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    .small{color:var(--muted);font-size:13px}.big-balance{font-size:36px;font-weight:700;margin:8px 0}.balance-row{display:flex;gap:10px;align-items:center}
    .btn{padding:10px 18px;border-radius:999px;border:0;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:#04101a;font-weight:600;cursor:pointer}
    .btn-outline{padding:10px 18px;border-radius:999px;border:1px solid rgba(255,255,255,0.05);background:transparent;color:#fff;cursor:pointer}
    .eye{width:40px;height:40px;border-radius:10px;background:var(--glass);display:flex;align-items:center;justify-content:center;cursor:pointer}
    .list{margin-top:20px;display:grid;gap:14px}
    .list-item{display:flex;gap:12px;align-items:center;padding:14px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);cursor:pointer}
    .list-item h4{margin:0;color:var(--accent-end);text-decoration:underline}.list-item p{margin:3px 0 0;color:var(--muted);font-size:13px}
    .txs{margin-top:18px}.tx{display:flex;justify-content:space-between;padding:10px;border-radius:10px;background:rgba(255,255,255,0.01);font-size:14px}.tx .left{display:flex;flex-direction:column}.tx .right{color:var(--muted)}
    .error{color:#ffb3b3}
    .bottom-nav{position:fixed;left:18px;right:18px;bottom:18px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:40px;display:flex;gap:22px;align-items:center;justify-content:space-between;box-shadow:0 10px 30px rgba(2,6,23,0.6)}
    @media(min-width:900px){body{padding:40px}}
  </style>
</head>
<body>
  <div class="header">
    <div class="avatar" id="avatar">U</div>
    <div class="greeting">
      <h3 id="greet">Hi, User</h3>
      <p id="uid">UID: -</p>
    </div>
    <button class="icon-btn" id="settingsBtn" title="Settings">⚙️</button>
    <button class="icon-btn" id="chatBtn" title="Chat">💬</button>
  </div>

  <div class="card" id="assetsCard">
    <div class="head">
      <div>
        <div class="small">Total Assets (NGN)</div>
        <div class="big-balance balance-row"><div id="balance">₦0.00</div><div class="eye" id="toggleEye" title="Toggle balance">👁️</div></div>
        <div class="small" id="approx">≈ ₦0.00</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:10px;align-items:flex-end">
        <button class="btn" id="rechargeBtn">Recharge</button>
        <button class="btn-outline" id="withdrawBtn">Withdraw</button>
      </div>
    </div>

    <!-- Referral removed as requested -->
  </div>

  <div class="list">
    <div class="list-item" id="ordersItem">
      <div style="width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,0.02);display:grid;place-items:center">📄</div>
      <div>
        <h4>My Orders</h4>
        <p>orders overview</p>
      </div>
    </div>

    <div class="list-item" id="tasksItem">
      <div style="width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,0.02);display:grid;place-items:center">🔎</div>
      <div>
        <h4>available tasks</h4>
        <p>Market & promotions</p>
      </div>
    </div>

    <div class="list-item" id="earningsItem">
      <div style="width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,0.02);display:grid;place-items:center">📈</div>
      <div>
        <h4>Earnings Report</h4>
        <p>Performance</p>
      </div>
    </div>
  </div>

  <div class="txs card" id="txsCard" style="max-width:720px;margin:18px auto 120px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div class="small">Transaction History (last 10)</div><a href="transactions.html" class="small" target="_blank">See all</a></div>
    <div id="txList">
      <div class="tx"><div class="left"><strong>—</strong><span class="small">No transactions yet</span></div><div class="right">₦0</div></div>
    </div>
  </div>

  <nav class="bottom-nav" aria-label="Main navigation">
    <div class="nav-item" id="navHome"><div class="icon">🏠</div><span>Home</span></div>
    <div class="nav-item" id="navConvert"><div class="icon">🔁</div><span>Convert</span></div>
    <div class="nav-item active" id="navCenter"><div class="icon">⚖️</div><span>Center</span></div>
    <div class="nav-item" id="navNews"><div class="icon">💬</div><span>News</span></div>
    <div class="nav-item" id="navAssets"><div class="icon">👤</div><span>Assets</span></div>
  </nav>

<script type="module">
/* ---------- Firebase config (Beni-Wealth) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
  authDomain: "beni-wealths.firebaseapp.com",
  projectId: "beni-wealths",
  storageBucket: "beni-wealths.firebasestorage.app",
  messagingSenderId: "807950483822",
  appId: "1:807950483822:web:e10fa87307e041c4d8417f",
  measurementId: "G-Z2XP3YN6NS"
};

/* ---------- Static imports (modular SDK) ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, onSnapshot, collection, query, where, orderBy, limit, getDocs
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ---------- UI elements ---------- */
const avatarEl = document.getElementById('avatar');
const greetEl = document.getElementById('greet');
const uidEl = document.getElementById('uid');
const balanceEl = document.getElementById('balance');
const approxEl = document.getElementById('approx');
const txListEl = document.getElementById('txList');
const toggleEye = document.getElementById('toggleEye');

/* ---------- helpers ---------- */
function formatN(n){ const num = Number(n || 0); return '₦' + num.toLocaleString('en-NG', {minimumFractionDigits:2, maximumFractionDigits:2}); }
function gen5(){ return Math.floor(10000 + Math.random()*90000).toString(); }

/* Toggle eye */
let showing = true;
toggleEye.addEventListener('click', ()=>{ showing = !showing; balanceEl.textContent = showing ? (balanceEl.dataset.realText || '₦0.00') : '₦••••'; });

/* Page navigation wiring */
document.getElementById('settingsBtn').addEventListener('click', ()=> window.location.href='profile.html');
document.getElementById('chatBtn').addEventListener('click', ()=> window.location.href='chat.html');
document.getElementById('rechargeBtn').addEventListener('click', ()=> window.location.href='recharge.html');
document.getElementById('withdrawBtn').addEventListener('click', ()=> window.location.href='withdraw.html');
document.getElementById('ordersItem').addEventListener('click', ()=> window.location.href='orders.html');
document.getElementById('tasksItem').addEventListener('click', ()=> window.location.href='tasks.html');
document.getElementById('earningsItem').addEventListener('click', ()=> window.location.href='earnings.html');
document.getElementById('navHome').addEventListener('click', ()=> window.location.href='index.html');
document.getElementById('navConvert').addEventListener('click', ()=> window.location.href='convert.html');
document.getElementById('navCenter').addEventListener('click', ()=> window.location.href='center.html');
document.getElementById('navNews').addEventListener('click', ()=> window.location.href='news.html');
document.getElementById('navAssets').addEventListener('click', ()=> window.location.href='assets.html');

/* ---------- Read transactions (optional) ---------- */
async function loadTransactions(uid){
  try{
    const txCol = collection(db, 'transactions');
    const q = query(txCol, where('userId','==', uid), orderBy('date','desc'), limit(10));
    const snap = await getDocs(q);
    txListEl.innerHTML = '';
    if(snap.empty){ txListEl.innerHTML = `<div class="tx"><div class="left"><strong>—</strong><span class="small">No transactions yet</span></div><div class="right">₦0</div></div>`; return; }
    snap.forEach(docu=>{ const d = docu.data(); const when = d.date && d.date.toDate ? d.date.toDate().toLocaleString() : ''; const amount = Number(d.amount||0); const source = d.source || d.note || 'Tx'; const html = `<div class="tx"><div class="left"><strong>${source}</strong><span class="small">${when}</span></div><div class="right">${formatN(amount)}</div></div>`; txListEl.insertAdjacentHTML('beforeend', html); });
  }catch(e){ console.error('loadTransactions error', e); }
}

/* ---------- Primary: wire to Firebase and populate user info ---------- */
onAuthStateChanged(auth, async user => {
  if(!user){
    // Not signed in: show placeholders but do not auto-redirect
    greetEl.textContent = 'Hi, User';
    uidEl.textContent = `UID: ${gen5()}`;
    balanceEl.textContent = '₦0.00';
    approxEl.textContent = '≈ ₦0.00';
    txListEl.innerHTML = `<div class="tx"><div class="left"><strong>—</strong><span class="small">Not signed in</span></div><div class="right">₦0</div></div>`;
    return;
  }

  // Try to use auth.displayName immediately
  const quickName = user.displayName || (user.email ? user.email.split('@')[0] : null);
  if(quickName){ greetEl.textContent = `Hi, ${quickName}`; avatarEl.textContent = quickName.charAt(0).toUpperCase(); }

  // show first 5 of uid in the header line
  uidEl.textContent = `UID: ${user.uid.slice(0,5)}`;

  // subscribe to users/{uid} to get username and balance (real-time)
  const uRef = doc(db, 'users', user.uid);
  let unsub = onSnapshot(uRef, async snap => {
    try{
      if(snap && snap.exists()){
        const data = snap.data();
        // username -> greeting (users/{uid}.username authoritative)
        const username = data.username || user.displayName || (user.email ? user.email.split('@')[0] : null);
        if(username){ greetEl.textContent = `Hi, ${username}`; avatarEl.textContent = username.charAt(0).toUpperCase(); }

        // balance -> Total Assets
        if(data.balance !== undefined && data.balance !== null){ const bal = Number(data.balance || 0); balanceEl.dataset.realText = formatN(bal); balanceEl.textContent = balanceEl.dataset.realText; approxEl.textContent = `≈ ${balanceEl.dataset.realText}`; }
        else { const fb = await tryBalanceFallback(user.uid); const val = fb !== null ? fb : 0; balanceEl.dataset.realText = formatN(val); balanceEl.textContent = balanceEl.dataset.realText; approxEl.textContent = `≈ ${balanceEl.dataset.realText}`; }
      } else {
        // no user doc — fallback reads
        const fb = await tryBalanceFallback(user.uid); const val = fb !== null ? fb : 0; balanceEl.dataset.realText = formatN(val); balanceEl.textContent = balanceEl.dataset.realText; approxEl.textContent = `≈ ${balanceEl.dataset.realText}`; const username = user.displayName || (user.email ? user.email.split('@')[0] : null); if(username){ greetEl.textContent = `Hi, ${username}`; avatarEl.textContent = username.charAt(0).toUpperCase(); }
      }

      // load transactions one-time for display
      try{ await loadTransactions(user.uid); }catch(e){ console.warn(e); }
    }catch(err){
      console.error('onSnapshot handler error', err);
      // show an error message visibly if permission denied
      if(err && err.code === 'permission-denied'){
        // visible error
        const el = document.createElement('div'); el.className = 'error'; el.textContent = 'Permission denied: check Firestore rules for users/{uid} read access.'; document.getElementById('assetsCard').prepend(el);
      }
    }
  }, err => {
    console.warn('users/{uid} onSnapshot error', err);
    (async ()=>{
      try{ const uSnap = await getDoc(uRef); if(uSnap.exists()){ const data = uSnap.data(); const username = data.username || user.displayName || (user.email ? user.email.split('@')[0] : null); if(username){ greetEl.textContent = `Hi, ${username}`; avatarEl.textContent = username.charAt(0).toUpperCase(); } if(data.balance !== undefined && data.balance !== null){ const bal = Number(data.balance||0); balanceEl.dataset.realText = formatN(bal); balanceEl.textContent = balanceEl.dataset.realText; approxEl.textContent = `≈ ${balanceEl.dataset.realText}`; } else { const fb = await tryBalanceFallback(user.uid); const val = fb !== null ? fb : 0; balanceEl.dataset.realText = formatN(val); balanceEl.textContent = balanceEl.dataset.realText; approxEl.textContent = `≈ ${balanceEl.dataset.realText}`; } } else { const fb = await tryBalanceFallback(user.uid); const val = fb !== null ? fb : 0; balanceEl.dataset.realText = formatN(val); balanceEl.textContent = balanceEl.dataset.realText; approxEl.textContent = `≈ ${balanceEl.dataset.realText}`; } await loadTransactions(user.uid); } catch(e){ console.error('fallback read failed', e); if(e && e.code === 'permission-denied'){ const el = document.createElement('div'); el.className='error'; el.textContent='Permission denied: check Firestore rules for users/{uid} read access.'; document.getElementById('assetsCard').prepend(el);} }
    })();
  });

});

/* ---------- fallback balance read helper ---------- */
async function tryBalanceFallback(uid){
  try{ const bRef = doc(db, 'balances', uid); const bSnap = await getDoc(bRef); if(bSnap && bSnap.exists()){ const bd = bSnap.data(); if(bd && (bd.balance !== undefined || bd.amount !== undefined)) return Number(bd.balance ?? bd.amount ?? 0); } }catch(e){ console.warn('balances/{uid} lookup failed', e); }
  try{ const col = collection(db, 'balances'); const q = query(col, where('userId','==', uid), orderBy('date','desc'), limit(1)); const snap = await getDocs(q); if(!snap.empty){ const d = snap.docs[0].data(); return Number(d.balance ?? d.amount ?? 0); } }catch(e){ console.warn('balances collection query failed', e); }
  return null;
}
</script>
</body>
</html>
