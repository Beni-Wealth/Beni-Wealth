<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Beni-Wealth — Stake</title>

  <!-- favicon -->
  <link rel="icon" type="image/png" sizes="32x32"
    href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
        rel="stylesheet"/>
  <meta name="theme-color" content="#2fe0b8"/>

  <style>
    :root {
      --bg:#041018; --text:#eaf2ff; --muted:#9fb3c9;
      --accent:#2fe0b8; --accent2:#35d6b1; --card:#0f1120; --radius:12px;
    }
    *{box-sizing:border-box;}
    body{margin:0;font-family:'Poppins',Arial;background:var(--bg);color:var(--text);padding:20px;}
    .container{max-width:480px;margin:0 auto;}
    h2{text-align:center;color:var(--accent);margin-bottom:10px;}
    .balance{font-size:20px;font-weight:700;text-align:center;margin-bottom:20px;color:var(--accent2);}
    .card{background:var(--card);padding:16px;border-radius:var(--radius);margin-bottom:20px;border:1px solid rgba(255,255,255,0.08);}
    .card label{display:block;font-size:14px;color:var(--muted);margin-bottom:6px;}
    .card select,input{width:100%;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.07);color:var(--text);margin-bottom:12px;}
    .btn{width:100%;padding:12px;font-size:16px;font-weight:700;border:none;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#041219;cursor:pointer;}
    .btn-history{margin-top:10px;text-align:center;font-size:14px;color:var(--accent2);cursor:pointer;text-decoration:underline;}
    .loading{text-align:center;color:var(--muted);margin-top:10px;}
  </style>
</head>
<body>

<div class="container">
  <h2>Beni-Wealth Stake</h2>
  <div class="balance" id="userBalance">Balance: ₦0.00</div>

  <div class="card" id="stakeCard">
    <div id="noMatches" class="loading">Loading available matches...</div>

    <label>Match</label>
    <select id="matchSelect"></select>

    <label>Choose Outcome</label>
    <select id="outcomeSelect"></select>

    <label>Stake Amount (min ₦100)</label>
    <input type="number" id="stakeAmount" placeholder="Enter amount">

    <button class="btn" id="submitStake">Submit Stake</button>
    <div id="stakeMsg" class="loading"></div>
  </div>

  <!-- History Redirect Button -->
  <div class="btn-history" id="goHistory">View History</div>

</div>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  serverTimestamp,
  query,
  where,
  getDocs,
  updateDoc,
  doc,
  increment
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
  authDomain: "beni-wealths.firebaseapp.com",
  projectId: "beni-wealths",
  storageBucket: "beni-wealths.appspot.com",
  messagingSenderId: "807950483822",
  appId: "1:807950483822:web=e10fa87307e041c4d8417f",
  measurementId: "G-Z2XP3YN6NS"
};

if (!getApps().length) initializeApp(firebaseConfig);

const auth = getAuth();
const db = getFirestore();

const userBalanceEl = document.getElementById('userBalance');
const matchSelect = document.getElementById('matchSelect');
const outcomeSelect = document.getElementById('outcomeSelect');
const noMatchesEl = document.getElementById('noMatches');
const stakeMsg = document.getElementById('stakeMsg');
const submitStakeBtn = document.getElementById('submitStake');
const goHistoryBtn = document.getElementById('goHistory');

let currentUser = null;
let matches = [];

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    userBalanceEl.textContent = "Balance: Sign in to see balance";
    return;
  }
  currentUser = user;
  await loadBalance();
  await loadMatches();
});

async function loadBalance() {
  try {
    const uQ = query(collection(db,'users'), where('__name__','==',currentUser.uid));
    const uSnap = await getDocs(uQ);
    if (!uSnap.empty) {
      const d = uSnap.docs[0].data();
      userBalanceEl.textContent = `Balance: ₦${Number(d.balance||0).toLocaleString('en-NG',{minimumFractionDigits:2})}`;
    }
  } catch (e) {
    console.error("Balance error:", e);
  }
}

async function loadMatches() {
  try {
    const mQ = query(collection(db,'matches'), where('active','==',true));
    const mSnap = await getDocs(mQ);

    matches = mSnap.docs.map(d => ({ id:d.id, ...d.data() }));
    matchSelect.innerHTML = "";
    outcomeSelect.innerHTML = "";

    if (matches.length === 0) {
      noMatchesEl.textContent = "No available stakes at the moment.";
      matchSelect.style.display = 'none';
      outcomeSelect.style.display = 'none';
      submitStakeBtn.disabled = true;
      return;
    }

    noMatchesEl.style.display = 'none';
    matchSelect.style.display = '';
    submitStakeBtn.disabled = false;

    matches.forEach(m => {
      const o = document.createElement('option');
      o.value = m.id;
      o.textContent = m.title;
      matchSelect.appendChild(o);
    });
    updateOutcomeOptions();
  } catch (e) {
    console.error("Matches load error:", e);
    noMatchesEl.textContent = "Error loading matches";
  }
}

function updateOutcomeOptions() {
  outcomeSelect.innerHTML = "";
  const sel = matches.find(m => m.id === matchSelect.value);
  if (!sel) return;
  (sel.options || []).forEach(optVal => {
    const o = document.createElement('option');
    o.value = optVal;
    o.textContent = optVal;
    outcomeSelect.appendChild(o);
  });
}

matchSelect.addEventListener('change', updateOutcomeOptions);

submitStakeBtn.addEventListener('click', async () => {
  stakeMsg.textContent = "Processing...";
  const matchId = matchSelect.value;
  const choice = outcomeSelect.value;
  const amount = Number(document.getElementById('stakeAmount').value);

  if (!matchId || !choice || !amount || amount < 100) {
    stakeMsg.textContent = "Fill all fields correctly (min ₦100).";
    return;
  }

  try {
    await updateDoc(doc(db,'users',currentUser.uid), { balance: increment(-amount) });
    await addDoc(collection(db,'stakes'), {
      userId: currentUser.uid,
      matchId,
      title: matches.find(m => m.id === matchId)?.title || "",
      choice,
      amount,
      status: "pending",
      wonAmount:0,
      credited:false,
      createdAt: serverTimestamp()
    });
    stakeMsg.textContent = "Stake submitted!";
    await loadBalance();
  } catch (e) {
    console.error("Stake submission error:", e);
    stakeMsg.textContent = "Error submitting stake";
  }
});

// Redirect to history page
goHistoryBtn.addEventListener('click', () => {
  window.location.href = "bet-history.html";
});

</script>

</body>
</html>
