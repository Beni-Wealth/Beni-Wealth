<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Beni-Wealth â€” Stake</title>

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32"
  href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
      rel="stylesheet"/>
<meta name="theme-color" content="#2fe0b8"/>

<style>
  :root {
    --bg-1: #0b0613;
    --bg-2: #0f0820;
    --panel: rgba(255,255,255,0.02);
    --text: #eaf2ff;
    --muted: rgba(255,255,255,0.6);
    --accent-a: #4a6eff;
    --accent-b: #2e99f8;
    --card-bg: rgba(255,255,255,0.04);
    --radius: 12px;
  }

  *{box-sizing:border-box;}
  body{
    margin:0;
    padding:20px;
    font-family:'Poppins',Arial;
    background: linear-gradient(180deg,var(--bg-1),var(--bg-2));
    color:var(--text);
  }
  .container{max-width:480px;margin:0 auto;}

  h2{
    text-align:center;
    color:var(--accent-a);
    margin-bottom:12px;
  }

  .balance{
    text-align:center;
    font-size:20px;
    font-weight:700;
    margin-bottom:20px;
    color:var(--accent-b);
  }

  .card{
    background:var(--card-bg);
    padding:16px;
    border-radius:var(--radius);
    margin-bottom:20px;
    border:1px solid rgba(255,255,255,0.05);
  }
  .card label{
    display:block;
    font-size:14px;
    color:var(--muted);
    margin-bottom:6px;
  }
  .card select,input{
    width:100%;
    padding:10px;
    border-radius:10px;
    border:none;
    background:rgba(255,255,255,0.07);
    color:var(--text);
    margin-bottom:12px;
  }

  .btn{
    width:100%;
    padding:12px;
    font-size:16px;
    font-weight:700;
    border:none;
    border-radius:10px;
    background:linear-gradient(90deg,var(--accent-a),var(--accent-b));
    color:#041219;
    cursor:pointer;
  }
  .btn:disabled{
    opacity:0.6;
    cursor:not-allowed;
  }

  .btn-history{
    margin-top:10px;
    text-align:center;
    font-size:14px;
    color:var(--accent-b);
    cursor:pointer;
    text-decoration:underline;
  }

  .loading{
    text-align:center;
    color:var(--muted);
    margin-top:10px;
  }
</style>
</head>
<body>

<div class="container">
  <h2>Beni-Wealth Stake</h2>

  <div class="balance" id="userBalance">Balance: â‚¦0.00</div>

  <div class="card" id="stakeCard">
    <div id="noMatches" class="loading">Loading available matches...</div>

    <label>Match</label>
    <select id="matchSelect"></select>

    <label>Choose Outcome</label>
    <select id="outcomeSelect"></select>

    <label>Stake Amount (min â‚¦100)</label>
    <input type="number" id="stakeAmount" placeholder="Enter amount">

    <button class="btn" id="submitStake" disabled>Submit Stake</button>
    <div id="stakeMsg" class="loading"></div>
  </div>

  <div class="btn-history" id="goHistory">View History</div>
</div>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, serverTimestamp, query,
  where, getDocs, updateDoc, doc, increment
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fB8yHeRjNjZk",
  authDomain: "beni-wealths.firebaseapp.com",
  projectId: "beni-wealths",
  storageBucket: "beni-wealths.appspot.com",
  messagingSenderId: "807950483822",
  appId: "1:807950483822:web=e10fa87307e041c4d8417f",
  measurementId: "G-Z2XP3YN6NS"
};

if (!getApps().length) initializeApp(firebaseConfig);

const auth = getAuth();
const db = getFirestore();

const userBalanceEl = document.getElementById('userBalance');
const matchSelect = document.getElementById('matchSelect');
const outcomeSelect = document.getElementById('outcomeSelect');
const noMatchesEl = document.getElementById('noMatches');
const stakeMsg = document.getElementById('stakeMsg');
const submitStakeBtn = document.getElementById('submitStake');
const goHistoryBtn = document.getElementById('goHistory');
const stakeAmountInput = document.getElementById('stakeAmount');

let currentUser = null;
let matches = [];
let currentBalance = 0;

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    userBalanceEl.textContent = "Balance: Sign in to see balance";
    submitStakeBtn.disabled = true;
    return;
  }
  currentUser = user;
  await loadBalance();
  await loadMatches();
});

// ðŸ”¹ AUTO-RESET STAKE AMOUNT WHEN MATCH CHANGES
matchSelect.addEventListener('change', () => {
  stakeAmountInput.value = "";
  checkStakeButton();
});

// ðŸ”¹ CHECK STAKE BUTTON WHEN OUTCOME CHANGES
outcomeSelect.addEventListener('change', checkStakeButton);

// Load user balance
async function loadBalance() {
  try {
    const uQ = query(collection(db,'users'), where('__name__','==',currentUser.uid));
    const uSnap = await getDocs(uQ);
    if (!uSnap.empty) {
      const d = uSnap.docs[0].data();
      currentBalance = Number(d.balance || 0);
      userBalanceEl.textContent = `Balance: â‚¦${currentBalance.toLocaleString('en-NG',{minimumFractionDigits:2})}`;
    }
  } catch (e) {
    console.error("Balance error:", e);
  }
  checkStakeButton();
}

// Load active matches
async function loadMatches() {
  try {
    const mQ = query(collection(db,'matches'), where('active','==',true));
    const mSnap = await getDocs(mQ);

    matches = mSnap.docs.map(d => ({ id:d.id, ...d.data() }));
    matchSelect.innerHTML = "";
    outcomeSelect.innerHTML = "";

    if (matches.length === 0) {
      noMatchesEl.textContent = "No available stakes at the moment.";
      matchSelect.style.display = 'none';
      outcomeSelect.style.display = 'none';
      submitStakeBtn.disabled = true;
      return;
    }

    noMatchesEl.style.display = 'none';
    matchSelect.style.display = '';
    submitStakeBtn.disabled = false;

    matches.forEach(m => {
      const o = document.createElement('option');
      o.value = m.id;
      o.textContent = m.title;
      matchSelect.appendChild(o);
    });
    updateOutcomeOptions();
  } catch (e) {
    console.error("Matches load error:", e);
    noMatchesEl.textContent = "Error loading matches";
  }
}

function updateOutcomeOptions() {
  outcomeSelect.innerHTML = "";
  const sel = matches.find(m => m.id === matchSelect.value);
  if (!sel) return;
  (sel.options || []).forEach(optVal => {
    const o = document.createElement('option');
    o.value = optVal;
    o.textContent = optVal;
    outcomeSelect.appendChild(o);
  });
}

stakeAmountInput.addEventListener('input', checkStakeButton);
function checkStakeButton() {
  const amount = Number(stakeAmountInput.value);
  const matchChosen = Boolean(matchSelect.value);
  const outcomeChosen = Boolean(outcomeSelect.value);

  submitStakeBtn.disabled = (!currentUser || !matchChosen || !outcomeChosen || !amount || amount < 100 || amount > currentBalance);
}

submitStakeBtn.addEventListener('click', async () => {
  stakeMsg.textContent = "";
  const matchId = matchSelect.value;
  const choice = outcomeSelect.value;
  const amount = Number(stakeAmountInput.value);

  if (amount > currentBalance) {
    stakeMsg.textContent = "Insufficient balance!";
    return;
  }
  if (!matchId || !choice || !amount || amount < 100) {
    stakeMsg.textContent = "Fill all fields correctly (min â‚¦100).";
    return;
  }
  try {
    await updateDoc(doc(db,'users',currentUser.uid), { balance: increment(-amount) });
    await addDoc(collection(db,'stakes'), {
      userId: currentUser.uid,
      matchId,
      title: matches.find(m=>m.id===matchId)?.title || "",
      choice,
      amount,
      status: "pending",
      wonAmount:0,
      credited:false,
      createdAt: serverTimestamp()
    });
    stakeMsg.textContent = "Stake submitted!";
    await loadBalance();
    stakeAmountInput.value = "";
    checkStakeButton();
  } catch (e) {
    console.error("Stake submission error:", e);
    stakeMsg.textContent = "Error submitting stake";
  }
});

goHistoryBtn.addEventListener('click', () => window.location.href = "bet-history.html");
</script>
</body>
</html>
