<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth — Stake</title>

  <!-- favicon -->
  <link rel="icon" type="image/png" sizes="32x32"
    href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
    rel="stylesheet" />
  <meta name="theme-color" content="#2fe0b8" />

  <style>
    :root {
      --bg:#041018;
      --text:#eaf2ff;
      --muted:#9fb3c9;
      --accent:#2fe0b8;
      --accent2:#35d6b1;
      --card:#0f1120;
      --radius:12px;
    }
    *{box-sizing:border-box;}
    html,body{margin:0;font-family:'Poppins',Arial;background:var(--bg);color:var(--text);padding:20px;}
    .container{max-width:480px;margin:0 auto;}
    h2{text-align:center;color:var(--accent);margin-bottom:10px;}
    .balance{font-size:20px;font-weight:700;text-align:center;margin-bottom:20px;color:var(--accent2);}
    .card{background:var(--card);padding:16px;border-radius:var(--radius);margin-bottom:20px;border:1px solid rgba(255,255,255,0.08);}
    .card label{display:block;font-size:14px;color:var(--muted);margin-bottom:6px;}
    .card select,input{width:100%;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.07);color:var(--text);margin-bottom:12px;}
    .btn{width:100%;padding:12px;font-size:16px;font-weight:700;border:none;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#041219;cursor:pointer;}
    .history{margin-top:30px;}
    .history h3{margin:0 0 12px 0;color:var(--accent);}
    .stake-item{background:rgba(255,255,255,0.04);padding:12px;border-radius:10px;margin-bottom:10px;}
    .stake-item div{font-size:14px;margin:2px 0;}
    .status-won{color:#00b300;font-weight:700;}
    .status-lost{color:#ff4d4d;font-weight:700;}
    .status-pending{color:var(--muted);font-weight:700;}
    .loading{text-align:center;color:var(--muted);margin-top:10px;}
  </style>
</head>
<body>

<div class="container">
  <h2>Beni-Wealth Stake</h2>
  <div class="balance" id="userBalance">Balance: ₦0.00</div>

  <div class="card" id="stakeCard">
    <div id="noMatches" class="loading">Loading available matches...</div>

    <label>Match</label>
    <select id="matchSelect"></select>

    <label>Choose Outcome</label>
    <select id="outcomeSelect"></select>

    <label>Stake Amount (min ₦100)</label>
    <input type="number" id="stakeAmount" placeholder="Enter amount">

    <button class="btn" id="submitStake">Submit Stake</button>
    <div id="stakeMsg" class="loading"></div>
  </div>

  <div class="history">
    <h3>Your Stake History</h3>
    <div id="historyList"></div>
  </div>
</div>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  serverTimestamp,
  query,
  where,
  getDocs,
  orderBy,
  updateDoc,
  doc,
  increment
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
  authDomain: "beni-wealths.firebaseapp.com",
  projectId: "beni-wealths",
  storageBucket: "beni-wealths.appspot.com",
  messagingSenderId: "807950483822",
  appId: "1:807950483822:web=e10fa87307e041c4d8417f",
  measurementId: "G-Z2XP3YN6NS"
};

if (!getApps().length) initializeApp(firebaseConfig);

const auth = getAuth();
const db = getFirestore();

const userBalanceEl = document.getElementById('userBalance');
const matchSelect = document.getElementById('matchSelect');
const outcomeSelect = document.getElementById('outcomeSelect');
const noMatchesEl = document.getElementById('noMatches');
const stakeMsg = document.getElementById('stakeMsg');
const historyListEl = document.getElementById('historyList');
const submitStakeBtn = document.getElementById('submitStake');

let currentUser = null;
let matches = [];

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    userBalanceEl.textContent = "Balance: Sign in to see balance";
    return;
  }
  currentUser = user;
  await loadBalance();
  await loadMatches();
  await loadHistory();
});

async function loadBalance() {
  try {
    const uQ = query(collection(db,'users'), where('__name__','==',currentUser.uid));
    const uSnap = await getDocs(uQ);
    if (!uSnap.empty) {
      const d = uSnap.docs[0].data();
      userBalanceEl.textContent = `Balance: ₦${Number(d.balance||0).toLocaleString('en-NG',{minimumFractionDigits:2})}`;
    }
  } catch (e) {
    console.error("Balance error:", e);
  }
}

async function loadMatches() {
  try {
    const mQ = query(collection(db,'matches'), where('active','==',true));
    const mSnap = await getDocs(mQ);

    matches = mSnap.docs.map(d => ({ id:d.id, ...d.data() }));
    matchSelect.innerHTML = "";
    outcomeSelect.innerHTML = "";

    if (matches.length === 0) {
      noMatchesEl.textContent = "No available stakes at the moment.";
      matchSelect.style.display = 'none';
      outcomeSelect.style.display = 'none';
      submitStakeBtn.disabled = true;
      return;
    }

    noMatchesEl.style.display = 'none';
    matchSelect.style.display = '';
    submitStakeBtn.disabled = false;

    matches.forEach(m => {
      const o = document.createElement('option');
      o.value = m.id;
      o.textContent = m.title;
      matchSelect.appendChild(o);
    });
    updateOutcomeOptions();
  } catch (e) {
    console.error("Matches load error:", e);
    noMatchesEl.textContent = "Error loading matches";
  }
}

function updateOutcomeOptions() {
  outcomeSelect.innerHTML = "";
  const sel = matches.find(m => m.id === matchSelect.value);
  if (!sel) return;
  (sel.options || []).forEach(optVal => {
    const o = document.createElement('option');
    o.value = optVal;
    o.textContent = optVal;
    outcomeSelect.appendChild(o);
  });
}

matchSelect.addEventListener('change', updateOutcomeOptions);

submitStakeBtn.addEventListener('click', async () => {
  stakeMsg.textContent = "Processing...";
  const matchId = matchSelect.value;
  const choice = outcomeSelect.value;
  const amount = Number(document.getElementById('stakeAmount').value);

  if (!matchId || !choice || !amount || amount < 100) {
    stakeMsg.textContent = "Fill all fields correctly (min ₦100).";
    return;
  }

  try {
    await updateDoc(doc(db,'users',currentUser.uid), { balance: increment(-amount) });
    await addDoc(collection(db,'stakes'), {
      userId: currentUser.uid,
      matchId,
      title: matches.find(m=>m.id===matchId)?.title || "",
      choice,
      amount,
      status: "pending",
      wonAmount:0,
      credited:false,
      createdAt: serverTimestamp()
    });
    stakeMsg.textContent = "Stake submitted!";
    await loadBalance();
    await loadHistory();
  } catch (e) {
    console.error("Stake submission error:", e);
    stakeMsg.textContent = "Error submitting stake";
  }
});

async function loadHistory() {
  historyListEl.innerHTML = "";
  const loading = document.createElement('div');
  loading.className = "loading";
  loading.textContent = "Loading...";
  historyListEl.appendChild(loading);

  try {
    const hQ = query(collection(db,'stakes'),
                     where('userId','==',currentUser.uid),
                     orderBy('createdAt','desc'));
    const hSnap = await getDocs(hQ);

    historyListEl.innerHTML = ""; // clear loading

    if (hSnap.empty) {
      historyListEl.textContent = "No stake history yet.";
      return;
    }

    for (const sDoc of hSnap.docs) {
      const data = sDoc.data();
      const div = document.createElement('div');
      div.className = "stake-item";

      let statusText = "pending";
      let wonAmt = 0;

      // fetch match result
      const rQ = query(collection(db,'matches'), where('__name__','==',data.matchId));
      const rSnap = await getDocs(rQ);
      const mdata = (!rSnap.empty ? rSnap.docs[0].data() : null);

      if (mdata && mdata.winner) {
        if (data.choice === mdata.winner) {
          statusText = "won";
          if (!data.credited) {
            const creditAmt = data.amount * 2;
            await updateDoc(doc(db,'users',currentUser.uid), { balance: increment(creditAmt) });
            await updateDoc(doc(db,'stakes',sDoc.id), { status:"won", credited:true, wonAmount:creditAmt });
            data.credited=true; data.wonAmount=creditAmt;
          }
        } else {
          statusText = "lost";
          if (!data.credited) {
            await updateDoc(doc(db,'stakes',sDoc.id), { status:"lost", credited:true, wonAmount:0 });
          }
        }
      }

      wonAmt = data.wonAmount || 0;
      const statusClass = statusText==="won"? "status-won":
                          statusText==="lost"? "status-lost": "status-pending";

      div.innerHTML = `
        <div><strong>Match:</strong> ${data.title}</div>
        <div><strong>Choice:</strong> ${data.choice}</div>
        <div><strong>Amount:</strong> ₦${data.amount}</div>
        <div><strong>Status:</strong> <span class="${statusClass}">${statusText}</span></div>
        <div><strong>Won:</strong> ₦${wonAmt.toLocaleString('en-NG',{minimumFractionDigits:2})}</div>
      `;
      historyListEl.appendChild(div);
    }
  } catch (err) {
    console.error("History load error:", err);
    historyListEl.innerHTML = "Error loading history.";
  }
}
</script>

</body>
</html>
