<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Beni-Wealth — Admin Submissions</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

<style>
  body {
    margin: 0; padding: 20px;
    font-family: 'Poppins', Arial;
    background: #041018; color: #eaf2ff;
  }
  .container {
    max-width: 900px; margin: 0 auto;
  }
  h2 {
    text-align: center; color: #2fe0b8; margin-bottom: 10px;
  }
  .submission {
    background: #0f1120;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px; padding: 12px;
    margin-bottom: 14px;
  }
  .submission p {
    margin: 4px; font-size: 14px;
  }
  select, button {
    padding: 8px; border-radius: 8px;
    border: none; font-weight: 600;
  }
  .btn-update {
    background: #2fa8ff; color: #041219;
    cursor: pointer; margin-top: 6px;
  }
</style>
</head>

<body>
<div class="container">
  <h2>Admin — Manage Submissions</h2>

  <!-- SORT CONTROLS -->
  <p>
    <strong>Sort by:</strong>
    <select id="sortOrder" style="margin-bottom: 12px; width: 100%;">
      <option value="newest">Newest first</option>
      <option value="uid_asc">User ID (A → Z)</option>
      <option value="uid_desc">User ID (Z → A)</option>
    </select>
  </p>

  <div id="subsList">Loading submissions…</div>
</div>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, query,
  getDocs, doc, getDoc, runTransaction,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fB8yHeRjNjZk",
  authDomain: "beni-wealths.firebaseapp.com",
  projectId: "beni-wealths",
  storageBucket: "beni-wealths.appspot.com",
  messagingSenderId: "807950483822",
  appId: "1:807950483822:web=e10fa87307e041c4d8417f",
  measurementId: "G-Z2XP3YN6NS"
};

if (!getApps().length) initializeApp(firebaseConfig);

const db = getFirestore();
const subsList = document.getElementById('subsList');

// load submissions immediately
loadSubs();

// re-load when sort order changes
document.getElementById('sortOrder').addEventListener('change', () => {
  loadSubs();
});

async function loadSubs() {
  subsList.innerHTML = "Loading…";

  try {
    const q = query(collection(db, 'stakes'));
    const snapshot = await getDocs(q);

    if (snapshot.empty) {
      subsList.textContent = "No submissions found.";
      return;
    }

    const allSubs = [];
    snapshot.forEach(docSnap => {
      allSubs.push({ id: docSnap.id, data: docSnap.data() });
    });

    const sortBy = document.getElementById('sortOrder').value;

    if (sortBy === "uid_asc") {
      allSubs.sort((a, b) => a.data.userId.localeCompare(b.data.userId));
    } else if (sortBy === "uid_desc") {
      allSubs.sort((a, b) => b.data.userId.localeCompare(a.data.userId));
    } else {
      allSubs.sort((a, b) => b.id.localeCompare(a.id));
    }

    subsList.innerHTML = "";
    allSubs.forEach(item => {
      const { id, data } = item;

      const div = document.createElement('div');
      div.className = "submission";
      div.innerHTML = `
        <p><strong>User:</strong> ${data.userId}</p>
        <p><strong>Match:</strong> ${data.title}</p>
        <p><strong>Choice:</strong> ${data.choice}</p>
        <p><strong>Stake:</strong> ₦${(data.amount||0).toLocaleString('en-NG',{minimumFractionDigits:2})}</p>

        <p><strong>Wallet Balance:</strong> <span id="balance_${id}">Fetching…</span></p>

        <p><strong>Status:</strong>
          <select id="status_${id}">
            <option value="pending" ${data.status==='pending'?'selected':''}>pending</option>
            <option value="won" ${data.status==='won'?'selected':''}>won</option>
            <option value="lost" ${data.status==='lost'?'selected':''}>lost</option>
          </select>
        </p>

        <button class="btn-update" data-id="${id}">Update</button>

        <p><small>Won Amt: ₦${(data.wonAmount||0).toLocaleString('en-NG',{minimumFractionDigits:2})} |
        Credited: ${data.credited? 'Yes':'No'}</small></p>
      `;
      subsList.appendChild(div);

      const userDoc = doc(db, 'users', data.userId);
      onSnapshot(userDoc, (uSnap) => {
        const balEl = document.getElementById(`balance_${id}`);
        if (uSnap.exists()) {
          const b = uSnap.data().balance || 0;
          balEl.textContent = `₦${b.toLocaleString('en-NG',{minimumFractionDigits:2})}`;
        } else {
          balEl.textContent = "User not found";
        }
      });
    });

    document.querySelectorAll('.btn-update').forEach(btn => {
      btn.addEventListener('click', () => updateSubmission(btn.dataset.id));
    });

  } catch (err) {
    console.error("Load error:", err);
    subsList.textContent = "Error loading submissions.";
  }
}

async function updateSubmission(submissionId) {
  try {
    const sel = document.getElementById(`status_${submissionId}`);
    const newStatus = sel.value;

    const stakeRef = doc(db, 'stakes', submissionId);
    const stakeSnap = await getDoc(stakeRef);
    if (!stakeSnap.exists()) {
      alert("Submission not found!");
      return;
    }
    const stakeData = stakeSnap.data();
    const userRef = doc(db, 'users', stakeData.userId);

    await runTransaction(db, async (transaction) => {
      const userSnap = await transaction.get(userRef);
      if (!userSnap.exists()) throw new Error("User not found!");

      const updates = { status: newStatus };

      if (newStatus === "won") {
        const creditAmount = (stakeData.amount || 0) * 2;
        updates.wonAmount = creditAmount;
        updates.credited = true;

        const oldBalance = userSnap.data().balance || 0;
        transaction.update(userRef, { balance: oldBalance + creditAmount });

      } else {
        updates.wonAmount = 0;
        updates.credited = false;
      }

      transaction.update(stakeRef, updates);
    });

    alert("Updated and wallet credited (if won)!");
    loadSubs();

  } catch (err) {
    console.error("Transaction failed:", err);
    alert("Update failed: " + err.message);
  }
}
</script>
</body>
</html>
