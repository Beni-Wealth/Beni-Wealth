<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Beni-Wealth — Read & Claim</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <meta name="theme-color" content="#2fe0b8" />
  <style>
    /* ... keep your existing CSS (omitted here for brevity) ... */
    body { font-family: Poppins, system-ui, Arial; background: #041018; color: #eaf2ff; margin:0 }
    /* Add the rest of your styles from the previous page */
  </style>
</head>
<body>
  <header class="topbar" role="banner">
    <div>
      <div class="brand">Beni-Wealth</div>
      <div class="subtitle">Read • Earn • Claim</div>
    </div>
    <div class="top-right">
      <div id="topTimer" class="top-timer" aria-live="polite">Wait: 10s</div>
      <div id="userBadge" class="user-badge">Not signed in</div>
    </div>
  </header>

  <main class="main" role="main" aria-live="polite">
    <div class="iframe-wrap" id="iframeWrap">
      <iframe id="articleFrame" src="https://www.dirtynaija.ng/articles/how-1-battery-turns-siblings-into-expert-charger-hunters" title="Article" sandbox="allow-scripts allow-forms allow-same-origin allow-popups" loading="lazy"></iframe>

      <div id="claimOverlay" class="overlay" aria-hidden="true" style="display:none;">
        <div class="panel" role="dialog" aria-modal="true" aria-label="Claim reward">
          <div style="font-weight:900;font-size:18px">Claim ₦0.20</div>
          <div class="muted" style="margin-top:8px">Thanks for reading — tap below to add ₦0.20 to your account.</div>
          <div style="display:flex;gap:12px;justify-content:center;margin-top:14px">
            <button id="claimBtn" class="claim-btn">Claim ₦0.20</button>
            <button id="dismissBtn" class="secondary">Maybe later</button>
          </div>
          <div id="claimStatus" class="status-line" aria-live="polite"></div>
        </div>
      </div>
    </div>
  </main>

  <div id="toastRoot" aria-live="polite" style="position:fixed;right:20px;bottom:20px;z-index:9999"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-functions.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Your firebase config
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    const ARTICLE_URL = "https://www.dirtynaija.ng/articles/how-1-battery-turns-siblings-into-expert-charger-hunters";
    const CLAIM_AMOUNT = 0.2;
    const COUNTDOWN_SECONDS = 10;
    const FUNCTIONS_REGION = 'us-central1'; // must match functions region used during deploy

    const app = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    const functions = getFunctions(app, FUNCTIONS_REGION);
    const db = getFirestore(app);

    const topTimer = document.getElementById('topTimer');
    const userBadge = document.getElementById('userBadge');
    const claimOverlay = document.getElementById('claimOverlay');
    const claimBtn = document.getElementById('claimBtn');
    const dismissBtn = document.getElementById('dismissBtn');
    const claimStatus = document.getElementById('claimStatus');
    const toastRoot = document.getElementById('toastRoot');

    function toast(msg, ms=3500){
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      toastRoot.appendChild(t);
      setTimeout(()=> t.remove(), ms);
    }

    let currentUser = null;
    onAuthStateChanged(auth, (u) => {
      currentUser = u;
      if(!u) userBadge.textContent = 'Not signed in';
      else {
        const name = u.displayName || (u.email ? u.email.split('@')[0] : u.uid.slice(0,6));
        userBadge.textContent = `Signed in • ${name}`;
      }
    });

    // countdown
    let secondsLeft = COUNTDOWN_SECONDS;
    let countdownTimer = null;
    function startCountdown(n=COUNTDOWN_SECONDS){
      clearInterval(countdownTimer);
      secondsLeft = n;
      topTimer.textContent = `Wait: ${secondsLeft}s`;
      countdownTimer = setInterval(()=>{
        secondsLeft--;
        topTimer.textContent = (secondsLeft>0)? `Wait: ${secondsLeft}s` : 'Claim ready';
        if(secondsLeft<=0){
          clearInterval(countdownTimer);
          showClaimOverlay();
          attemptClaim(); // automatically attempt server-side claim immediately
        }
      }, 1000);
    }
    startCountdown(COUNTDOWN_SECONDS);

    function showClaimOverlay(){ claimOverlay.style.display='flex'; claimOverlay.setAttribute('aria-hidden','false'); claimBtn.focus(); claimStatus.textContent=''; }
    function hideClaimOverlay(){ claimOverlay.style.display='none'; claimOverlay.setAttribute('aria-hidden','true'); }

    dismissBtn.addEventListener('click', (e)=>{ e.preventDefault(); hideClaimOverlay(); });

    // main claim attempt using httpsCallable only
    let claiming = false;
    async function attemptClaim(){
      if (claiming) return;
      claiming = true;
      claimBtn.disabled = true;
      claimBtn.textContent = 'Processing...';
      claimStatus.textContent = '';

      if(!currentUser){
        claimBtn.disabled = false;
        claimBtn.textContent = `Claim ₦${CLAIM_AMOUNT}`;
        claiming = false;
        if(confirm('You must sign in to claim. Go to login page?')) window.location.href = 'login.html';
        return;
      }

      try {
        const call = httpsCallable(functions, 'claimReward');
        const res = await call({ articleUrl: ARTICLE_URL });

        // res.data should be { success: true, message: "...", newBalance: ... }
        const data = res.data ?? res;
        const message = data?.message ?? 'Claim successful';
        const newBalance = data?.newBalance ?? data?.new_balance;
        toast(message);
        claimStatus.textContent = message + (newBalance !== undefined ? ` — New balance: ₦${Number(newBalance).toFixed(2)}` : '');
        topTimer.textContent = 'Claimed';
        claimBtn.textContent = 'Claimed';
        claimBtn.disabled = true;
        setTimeout(()=> hideClaimOverlay(), 1200);
      } catch (err) {
        // better error messages (handle HttpsError from server)
        console.error('claim error', err);
        // if firebase HttpsError it should be under err.code and err.message
        const message = err?.message ?? String(err);
        claimStatus.textContent = message;
        toast(message);

        // if it's a cooldown error, firebase on the server threw resource-exhausted
        if (err?.code === 'resource-exhausted' || /cooldown/i.test(message)) {
          // Show friendly info and restart a short countdown for UX (you can use actual remaining time from server if you return it)
          hideClaimOverlay();
          // short fallback: 7 seconds visual retry so UX doesn't look stuck
          startCountdown(7);
        } else {
          // allow manual retry
          claimBtn.disabled = false;
          claimBtn.textContent = `Claim ₦${CLAIM_AMOUNT}`;
        }
      } finally {
        claiming = false;
      }
    }

    claimBtn.addEventListener('click', (e)=>{ e.preventDefault(); attemptClaim(); });

    // accessibility escape to close
    window.addEventListener('keydown', (ev)=>{ if(ev.key === 'Escape') hideClaimOverlay(); });

    console.log('Read & Claim loaded. functions region=', FUNCTIONS_REGION);
  </script>
</body>
</html>
