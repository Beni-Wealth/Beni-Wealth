<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Beni-Wealth — Read & Claim</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <meta name="theme-color" content="#2fe0b8" />
  <style>
    :root{
      --bg:#0b0613; --panel:#0f0820; --muted:rgba(255,255,255,0.68);
      --accent1:#7a5fff; --accent2:#35d6b1; --text:#eaf2ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family:Poppins,system-ui,Arial;
      background: linear-gradient(180deg,var(--bg),var(--panel));
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:0;
      margin:0;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    /* top bar */
    .topbar{
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 16px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.006));
      border-bottom: 1px solid rgba(255,255,255,0.02);
      z-index:40;
    }
    .brand { font-weight:800; font-size:16px; margin:0; }
    .subtitle { font-size:13px; color:var(--muted); margin-top:2px; font-weight:600; }

    .top-right { display:flex; align-items:center; gap:10px; }

    .user-badge{
      font-size:13px; color:var(--muted); background:rgba(255,255,255,0.02);
      padding:8px 12px; border-radius:999px; border:1px solid rgba(255,255,255,0.03);
    }

    /* top-timer pill */
    .top-timer {
      font-weight:800;
      font-size:13px;
      padding:8px 12px;
      border-radius:999px;
      background: linear-gradient(90deg,var(--accent1),var(--accent2));
      color:#041219;
      border:1px solid rgba(255,255,255,0.03);
      min-width:86px;
      text-align:center;
    }

    /* main content fills remaining viewport */
    .main {
      position:relative;
      flex:1 1 auto;
      min-height:0; /* allow children to stretch in flexbox */
    }

    .iframe-wrap {
      position:absolute;
      inset:0;
      background:#041018;
      display:flex;
      align-items:stretch;
      justify-content:stretch;
    }

    iframe{
      width:100%;
      height:100%;
      border:0;
      display:block;
    }

    /* claim overlay */
    .overlay {
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(90deg, rgba(2,6,23,0.56), rgba(2,6,23,0.45));
      z-index:60;
      padding:20px;
    }
    .panel {
      width:min(520px, 94%);
      border-radius:12px;
      padding:18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.03);
      box-shadow:0 30px 80px rgba(0,0,0,0.6);
      text-align:center;
      color:var(--text);
    }
    .big-num{ font-size:40px; font-weight:900; margin:6px 0; }
    .muted{ color:var(--muted); font-size:13px; }

    .claim-btn{
      padding:10px 16px; border-radius:10px; border:0; cursor:pointer; font-weight:800;
      background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#041219; font-size:15px;
      box-shadow:0 10px 30px rgba(61,46,111,0.18);
    }
    .secondary{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); padding:9px 12px; border-radius:9px; cursor:pointer; font-weight:700; }

    /* small status text */
    .status-line { margin-top:10px; font-size:13px; color:var(--muted); }

    /* toast */
    .toast{ position:fixed; right:20px; bottom:20px; background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#041219; padding:10px 14px; border-radius:10px; font-weight:700; box-shadow:0 12px 40px rgba(0,0,0,0.6); z-index:9999 }

    @media (max-width:520px){
      .topbar{ padding:8px 12px; height:56px; }
      .big-num{ font-size:30px; }
    }
  </style>
</head>
<body>
  <header class="topbar" role="banner">
    <div>
      <div class="brand">Beni-Wealth</div>
      <div class="subtitle">Read • Earn • Claim</div>
    </div>

    <div class="top-right">
      <div id="topTimer" class="top-timer" aria-live="polite">Wait: 10s</div>
      <div id="userBadge" class="user-badge">Not signed in</div>
    </div>
  </header>

  <main class="main" role="main" aria-live="polite">
    <div class="iframe-wrap" id="iframeWrap">
      <iframe id="articleFrame"
              src="https://www.dirtynaija.ng/articles/how-1-battery-turns-siblings-into-expert-charger-hunters"
              title="Article"
              sandbox="allow-scripts allow-forms allow-same-origin allow-popups"
              loading="lazy"></iframe>

      <!-- claim overlay (hidden until countdown ends) -->
      <div id="claimOverlay" class="overlay" aria-hidden="true" style="display:none;">
        <div class="panel" role="dialog" aria-modal="true" aria-label="Claim reward">
          <div style="font-weight:900;font-size:18px">Claim ₦0.20</div>
          <div class="muted" style="margin-top:8px">Thanks for reading — tap below to add ₦0.20 to your account.</div>

          <div style="display:flex;gap:12px;justify-content:center;margin-top:14px">
            <button id="claimBtn" class="claim-btn">Claim ₦0.20</button>
            <button id="dismissBtn" class="secondary">Maybe later</button>
          </div>

          <div id="claimStatus" class="status-line" aria-live="polite"></div>
        </div>
      </div>

    </div>
  </main>

  <div id="toastRoot" aria-live="polite" style="position:fixed;right:20px;bottom:20px;z-index:9999"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-functions.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // === your firebase config (already provided) ===
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    // Article / claim settings
    const ARTICLE_URL = "https://www.dirtynaija.ng/articles/how-1-battery-turns-siblings-into-expert-charger-hunters";
    const CLAIM_AMOUNT = 0.2;
    const COUNTDOWN_SECONDS = 10;    // user requested 10s countdown
    const INTERNAL_RETRY_COUNT = 7;  // retry cooldown on internal error
    const FALLBACK_REGION = 'us-central1'; // change if you deployed to another region

    // init firebase
    const app = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    const functions = getFunctions(app);
    const db = getFirestore(app);

    // DOM
    const topTimer = document.getElementById('topTimer');
    const userBadge = document.getElementById('userBadge');
    const articleFrame = document.getElementById('articleFrame');
    const claimOverlay = document.getElementById('claimOverlay');
    const claimBtn = document.getElementById('claimBtn');
    const dismissBtn = document.getElementById('dismissBtn');
    const claimStatus = document.getElementById('claimStatus');
    const toastRoot = document.getElementById('toastRoot');

    function toast(msg, ms=3500){
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      toastRoot.appendChild(t);
      setTimeout(()=> t.remove(), ms);
    }

    // user / auth state
    let currentUser = null;
    onAuthStateChanged(auth, (u) => {
      currentUser = u;
      if(!u) userBadge.textContent = 'Not signed in';
      else {
        const name = u.displayName || (u.email ? u.email.split('@')[0] : u.uid.slice(0,6));
        userBadge.textContent = `Signed in • ${name}`;
      }
    });

    // Countdown at top (non-blocking)
    let countdownTimer = null;
    let secondsLeft = COUNTDOWN_SECONDS;

    function startTopCountdown(n = COUNTDOWN_SECONDS){
      clearInterval(countdownTimer);
      secondsLeft = n;
      updateTopTimer();
      countdownTimer = setInterval(() => {
        secondsLeft--;
        updateTopTimer();
        if(secondsLeft <= 0){
          clearInterval(countdownTimer);
          // show claim overlay once timer finishes
          showClaimOverlay();
        }
      }, 1000);
    }

    function updateTopTimer(){
      topTimer.textContent = (secondsLeft > 0) ? `Wait: ${secondsLeft}s` : 'Claim ready';
    }

    function showClaimOverlay(){
      claimOverlay.style.display = 'flex';
      claimOverlay.setAttribute('aria-hidden','false');
      claimBtn.focus();
      claimStatus.textContent = '';
    }

    function hideClaimOverlay(){
      claimOverlay.style.display = 'none';
      claimOverlay.setAttribute('aria-hidden','true');
    }

    // start first countdown
    startTopCountdown(COUNTDOWN_SECONDS);

    dismissBtn.addEventListener('click', (e) => { e.preventDefault(); hideClaimOverlay(); });

    // Helper: direct-call fallback using REST to functions endpoint
    async function callFunctionDirectREST(articleUrl) {
      // builds URL like https://us-central1-your-project.cloudfunctions.net/claimReward
      const projectId = FIREBASE_CONFIG.projectId;
      const url = `https://${FALLBACK_REGION}-${projectId}.cloudfunctions.net/claimReward`;

      // get id token for authorization
      const idToken = await currentUser.getIdToken();

      const body = JSON.stringify({ data: { articleUrl } });

      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + idToken
        },
        body
      });

      let json = null;
      try { json = await res.json(); } catch(e) { throw new Error(`Function returned non-JSON (${res.status})`); }

      // callable functions usually return { result: { ... } }
      const payload = json.result ?? json; // accept either shape
      return payload;
    }

    // Main claim flow: try httpsCallable first, fallback to REST endpoint if that fails.
    async function performClaim(articleUrl) {
      // 1) Primary: httpsCallable (recommended)
      try {
        const call = httpsCallable(functions, 'claimReward');
        const r = await call({ articleUrl });
        // typically r.data = { success, message, newBalance }
        return r.data ?? r;
      } catch (errPrimary) {
        // if httpsCallable fails, try REST fallback
        console.warn('httpsCallable failed, attempting direct REST fallback', errPrimary);
        // rethrow internal errors to let caller handle them if they specifically are internal
        const errMsg = (errPrimary && errPrimary.message) ? errPrimary.message : String(errPrimary);
        const errCode = errPrimary && errPrimary.code ? errPrimary.code : null;

        // Try the REST fallback — but still surface internal-like errors
        try {
          if(!currentUser) throw new Error('Not authenticated (cannot call function).');
          const fallbackRes = await callFunctionDirectREST(articleUrl);
          return fallbackRes;
        } catch (errFallback) {
          // If fallback also fails, attach both messages for debugging
          console.error('Fallback function call failed', errFallback);
          const combined = `${errMsg} — fallback: ${errFallback && errFallback.message ? errFallback.message : String(errFallback)}`;
          // mimic an HttpsError-like shape so calling code can test for 'internal'
          const e = new Error(combined);
          e.code = errPrimary?.code ?? errFallback?.code ?? null;
          throw e;
        }
      }
    }

    // Claim button handler
    claimBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      claimBtn.disabled = true;
      claimBtn.textContent = 'Processing...';
      claimStatus.textContent = '';

      if(!currentUser){
        claimBtn.disabled = false;
        claimBtn.textContent = `Claim ₦${CLAIM_AMOUNT}`;
        if(confirm('You need to sign in to claim. Go to login now?')) window.location.href = 'login.html';
        return;
      }

      try {
        const res = await performClaim(ARTICLE_URL);
        // server expected to return something like { success:true, message:'Claimed ₦0.20', newBalance: X }
        const msg = (res && (res.message || res.success && 'Claim successful')) || 'Claim succeeded';
        const newBal = res && (res.newBalance ?? res.new_balance ?? res.new_balance_in_currency);
        toast(msg);
        claimStatus.textContent = msg + (newBal !== undefined ? ` — New balance: ₦${Number(newBal).toFixed(2)}` : '');
        // update top timer text to show claimed
        topTimer.textContent = 'Claimed';
        // optionally refresh user's balance doc once
        try {
          const uDoc = await getDoc(doc(db, 'users', currentUser.uid));
          if(uDoc.exists()) console.log('Refreshed balance:', uDoc.data().balance);
        } catch(e){ console.warn('refresh failed', e); }
        // disable claim button permanently (prevent double-click attempts)
        claimBtn.disabled = true;
        claimBtn.textContent = 'Claimed';
        setTimeout(()=> hideClaimOverlay(), 1200);
      } catch (err) {
        console.error('Claim failed', err);
        const msgText = err?.message || String(err);
        claimStatus.textContent = msgText;
        toast(msgText);

        // If this looks like an "internal" server error, restart a 7s cooldown
        if(/internal/i.test(msgText) || (err && err.code === 'internal')) {
          toast('Server reported internal error — retrying in 7 seconds');
          hideClaimOverlay();
          startTopCountdown(INTERNAL_RETRY_COUNT);
        }
      } finally {
        // Only reset the claim button if still not successfully claimed
        if(claimBtn.textContent !== 'Claimed'){
          claimBtn.disabled = false;
          claimBtn.textContent = `Claim ₦${CLAIM_AMOUNT}`;
        }
      }
    });

    // accessibility: close overlay on escape
    window.addEventListener('keydown', (ev) => {
      if(ev.key === 'Escape') hideClaimOverlay();
    });

    // Safety note visible in console for admins
    console.log('Read & Claim page loaded. COUNTDOWN_SECONDS=', COUNTDOWN_SECONDS, 'FALLBACK_REGION=', FALLBACK_REGION);

  </script>
</body>
</html>
