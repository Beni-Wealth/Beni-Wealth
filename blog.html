<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth — Published Blogs</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300,400,600,700&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --bg-1:#041021;
      --card:#071826;
      --muted:rgba(255,255,255,0.66);
      --accent-gradient: linear-gradient(90deg,#7a5fff,#35d6b1);
      --glass: rgba(255,255,255,0.02);
      --pill-bg: rgba(255,255,255,0.04);
      --max-width:1100px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{margin:0;min-height:100vh;background:radial-gradient(800px 500px at 10% 10%,rgba(122,95,255,0.06),transparent),linear-gradient(180deg,var(--bg-1),#071126);color:#eaf2ff;font-family:'Poppins',system-ui,-apple-system,'Segoe UI',Roboto,Arial;}
    .wrap{max-width:var(--max-width);margin:0 auto;padding:28px;}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    h1{margin:0;font-size:20px}
    .note{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    .card{background:linear-gradient(180deg,var(--card),rgba(255,255,255,0.01));border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03);cursor:pointer;display:flex;flex-direction:column;gap:10px;min-height:240px}
    .thumb{width:100%;height:140px;object-fit:cover;border-radius:8px;background:var(--glass);border:1px dashed rgba(255,255,255,0.03)}
    .title{font-weight:700;font-size:15px;margin:0}
    .meta{color:var(--muted);font-size:13px;display:flex;justify-content:space-between;align-items:center}
    .tags{font-size:12px;color:var(--muted)}
    .small-btn{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.04);background:var(--pill-bg);font-size:12px;cursor:pointer}
    .views-count{font-size:13px;color:var(--muted)}

    .viewer-page{position:fixed;inset:0;background:linear-gradient(180deg,rgba(2,6,10,0.98),rgba(2,6,10,0.99));z-index:9999;display:none;overflow:auto;}
    .viewer-page.show{display:block;}
    .viewer-inner{max-width:var(--max-width);margin:0 auto;padding:28px;min-height:100vh;box-sizing:border-box;}
    .viewer-header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px;}
    .viewer-title{font-size:20px;margin:0;}
    .viewer-by{color:var(--muted);font-size:13px;margin-top:6px}
    .viewer-content{background:linear-gradient(180deg,#071428,#071826);border-radius:12px;padding:20px;border:1px solid rgba(255,255,255,0.04);color:#e6f6ff;line-height:1.6;font-size:15px;}
    .viewer-controls{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-top:14px;}
    .timer-pill{padding:8px 12px;border-radius:999px;font-weight:700;background:var(--pill-bg);color:var(--muted);font-size:14px}
    .viewer-close{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px 12px;border-radius:8px;cursor:pointer}
    .viewer-footer-note{color:var(--muted);font-size:13px}

    #congratsOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:10000;}
    #congratsBox{background:#071a2b;padding:24px;border-radius:12px;text-align:center;width:90%;max-width:360px;color:#eaf2ff;font-family:'Poppins',sans-serif;}
    #congratsBox h2{margin:0 0 12px;font-size:20px;}
    #congratsBox p{margin:6px 0;font-size:15px;}
    #congratsBox button{margin-top:12px;padding:8px 14px;border:none;background:var(--accent-gradient);border-radius:8px;font-weight:700;cursor:pointer;color:#041219;}
  </style>
</head>
<body>

  <div class="wrap" id="mainPage">
    <header>
      <h1>Published Blogs</h1>
      <div style="display:flex;gap:12px;align-items:center">
        <div class="note">Click a blog to open.</div>
        <button id="signinBtn" class="small-btn">Sign in</button>
      </div>
    </header>

    <div id="statusArea" class="note" style="margin-bottom:12px"></div>
    <div id="grid" class="grid" role="list" aria-label="Published blogs"></div>
  </div>

  <!-- Blog Viewer -->
  <div id="viewerPage" class="viewer-page" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="viewer-inner">
      <div class="viewer-header">
        <div>
          <h2 id="viewTitle" class="viewer-title"></h2>
          <div id="viewMeta" class="viewer-by"></div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <div class="timer-pill" id="timerPill">10s</div>
          <button id="closeViewer" class="viewer-close">Back</button>
        </div>
      </div>
      <div id="viewContent" class="viewer-content"></div>
      <div class="viewer-controls">
        <div class="viewer-footer-note">Blog ID: <span id="viewId"></span></div>
        <div id="awardMsg" class="viewer-footer-note" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <!-- Congrats Popup -->
  <div id="congratsOverlay">
    <div id="congratsBox">
      <h2>Congratulations!</h2>
      <p id="congratsText"></p>
      <button onclick="document.getElementById('congratsOverlay').style.display='none'">OK</button>
    </div>
  </div>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore, collection, query, where, onSnapshot, doc, getDoc,
  updateDoc, setDoc, serverTimestamp, increment
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
  authDomain: "beni-wealths.firebaseapp.com",
  projectId: "beni-wealths",
  storageBucket: "beni-wealths.appspot.com",
  messagingSenderId: "807950483822",
  appId: "1:807950483822:web:e10fa87307e041c4d8417f",
  measurementId: "G-Z2XP3YN6NS"
};

if(!getApps().length) initializeApp(firebaseConfig);

const auth = getAuth();
const db = getFirestore();

const grid=document.getElementById('grid'), statusArea=document.getElementById('statusArea');
const signinBtn=document.getElementById('signinBtn'), viewerPage=document.getElementById('viewerPage');
const viewTitle=document.getElementById('viewTitle'), viewMeta=document.getElementById('viewMeta');
const viewContent=document.getElementById('viewContent'), viewId=document.getElementById('viewId');
const timerPill=document.getElementById('timerPill'), awardMsg=document.getElementById('awardMsg');
const congratsOverlay=document.getElementById('congratsOverlay'), congratsText=document.getElementById('congratsText');
let currentUser=null, currentTimer=null, remaining=10, activeBlog=null;

// 1 hour cooldown
const COOLDOWN_MS = 1 * 60 * 60 * 1000;

// update statusArea
function showStatus(txt){ statusArea.textContent = txt; }
function clearStatus(){ statusArea.textContent = ''; }

// properly track view counts
async function getViewCount(blogId){
  try{
    const snap = await getDoc(doc(db,'blogViewsCount',blogId));
    return snap.exists() ? (snap.data().count||0) : 0;
  }catch{return 0;}
}

// render grid
function renderGrid(docs){
  grid.innerHTML='';
  if(!docs.length){ grid.innerHTML='<div class="note">No blogs found</div>'; return; }
  docs.forEach(async snapDoc => {
    const id=snapDoc.id; const data=snapDoc.data();
    const views = await getViewCount(id);
    const card=document.createElement('article'); card.className='card';
    card.innerHTML=`
      <img class="thumb" src="${data.thumbnail||''}">
      <div><h3 class="title">${data.title||'Untitled'}</h3></div>
      <div class="meta"><div class="tags">${(data.tags||[]).join(', ')}</div><div class="small-btn">Read</div></div>
      <div class="views-count">Views: ${views}</div>
    `;
    card.onclick=()=>openFullPage(id,data);
    grid.appendChild(card);
  });
}

// subscribe published blogs
function subscribePublished(){
  showStatus('Loading blogs…');
  const q=query(collection(db,'blogs'),where('status','==','published'));
  onSnapshot(q,(snap)=>{
    renderGrid(snap.docs);
    clearStatus();
  }, err=>{
    showStatus('Error loading blogs'); console.error(err);
  });
}

// reward view — with cooldown
async function rewardView(blogId){
  if(!currentUser) return;
  try{
    const viewRef=doc(db,'blogViews',`${blogId}_${currentUser.uid}`);
    const snap=await getDoc(viewRef);
    const now=Date.now();
    let allow=true;

    if(snap.exists()){
      const last = snap.data().lastRewardedAt;
      if(last && last.toDate){
        const lastMs = last.toDate().getTime();
        if(now - lastMs < COOLDOWN_MS) allow=false;
      }
    }

    if(!allow){
      awardMsg.textContent='You must wait before earning again.';
      return;
    }

    // update user‑view record
    await setDoc(viewRef,{ blogId, userId:currentUser.uid, lastRewardedAt: serverTimestamp() });

    // increment blog view count
    const countRef = doc(db,'blogViewsCount',blogId);
    try{ await updateDoc(countRef,{ count: increment(1) }); }
    catch{ await setDoc(countRef,{ count:1 }); }

    // credit author
    const authorId = activeBlog.data.userId;
    if(authorId){
      const authorRef = doc(db,'users',authorId);
      await updateDoc(authorRef,{ balance: increment(1) });
    }

    // credit viewer
    const viewerRef = doc(db,'users',currentUser.uid);
    await updateDoc(viewerRef,{ balance: increment(0.5) });

    congratsText.textContent=`You earned ₦0.5!`;
    congratsOverlay.style.display='flex';
    awardMsg.textContent='';

  }catch(err){ console.error(err); awardMsg.textContent='Reward failed'; }
}

// open blog with timer
async function openFullPage(id,data){
  activeBlog={id,data};
  viewTitle.textContent=data.title||'Untitled';
  viewMeta.textContent=`Published: ${data.publishedAt?.toDate?.().toLocaleString()||'-'}`;
  viewContent.textContent=data.content||'';
  viewId.textContent=id;
  awardMsg.textContent='';
  remaining=10; timerPill.textContent=`${remaining}s`;
  viewerPage.classList.add('show');

  if(currentTimer){ clearInterval(currentTimer); currentTimer=null; }
  if(!currentUser){
    awardMsg.textContent='Sign‑in to earn ₦0.5';
    return;
  }

  currentTimer=setInterval(()=>{
    remaining--; timerPill.textContent=`${remaining}s`;
    if(remaining<=0){
      clearInterval(currentTimer); currentTimer=null;
      rewardView(id);
    }
  },1000);
}

const provider=new GoogleAuthProvider();
signinBtn.onclick=async()=>{ try{ await signInWithPopup(auth,provider); }catch(err){ console.error(err); } };
onAuthStateChanged(auth,user=>{
  currentUser=user;
  signinBtn.textContent=user?'Signed in':'Sign in';
  signinBtn.disabled=!!user;
});

document.getElementById('closeViewer').onclick=()=>{
  viewerPage.classList.remove('show');
  if(currentTimer){ clearInterval(currentTimer); currentTimer=null; }
};

window.addEventListener('load',subscribePublished);

</script>
</body>
</html>
