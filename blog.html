<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth — Published Blogs</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --bg-1:#041021;
      --card:#071826;
      --muted:rgba(255,255,255,0.66);
      --accent:linear-gradient(90deg,#7a5fff,#35d6b1);
      --glass: rgba(255,255,255,0.02);
      --pill-bg: rgba(255,255,255,0.04);
    }
    *{box-sizing:border-box}
    body{ margin:0; min-height:100vh; background: radial-gradient(800px 500px at 10% 10%, rgba(122,95,255,0.06), transparent), linear-gradient(180deg,var(--bg-1),#071126); color:#eaf2ff; font-family:'Poppins',system-ui,-apple-system,'Segoe UI',Roboto,Arial; padding:28px; }
    .wrap{ max-width:1100px; margin:0 auto; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px }
    h1{ margin:0; font-size:20px }
    .note{ color:var(--muted); font-size:13px }
    .grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:14px; }
    .card{ background:linear-gradient(180deg,var(--card), rgba(255,255,255,0.01)); border-radius:12px; padding:14px; border:1px solid rgba(255,255,255,0.03); cursor:pointer; display:flex; flex-direction:column; gap:10px }
    .thumb{ width:100%; height:140px; object-fit:cover; border-radius:8px; background:var(--glass); border:1px dashed rgba(255,255,255,0.03) }
    .title{ font-weight:700; font-size:15px; margin:0 }
    .meta{ color:var(--muted); font-size:13px; display:flex; justify-content:space-between; align-items:center }
    .tags{ font-size:12px; color:var(--muted) }
    .small-btn{ padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.04); background:var(--pill-bg); font-size:12px; cursor:pointer }
    .overlay{ position:fixed; inset:0; background:linear-gradient(180deg, rgba(2,6,10,0.86), rgba(2,6,10,0.96)); display:none; align-items:center; justify-content:center; z-index:9999; padding:28px; }
    .overlay.show{ display:flex; }
    .sheet{ width:100%; max-width:900px; max-height:96vh; overflow:auto; background:linear-gradient(180deg,#071428,#071826); border-radius:12px; padding:20px; border:1px solid rgba(255,255,255,0.04); box-shadow:0 8px 40px rgba(0,0,0,0.6); position:relative; }
    .sheet h2{ margin:0 0 8px; font-size:20px }
    .sheet .by{ color:var(--muted); font-size:13px; margin-bottom:12px }
    .sheet .content{ color:#e6f6ff; line-height:1.6; font-size:15px }
    .close-btn{ position:absolute; right:14px; top:14px; background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); padding:6px 9px; border-radius:8px; cursor:pointer }
    .overlay-footer{ display:flex; gap:12px; align-items:center; margin-top:14px; justify-content:space-between; }
    .timer-pill{ padding:8px 12px; border-radius:999px; font-weight:700; background:var(--pill-bg); color:var(--muted); font-size:14px }
    .status{ font-size:13px; color:var(--muted) }
    @media(max-width:980px){ .grid{ grid-template-columns:repeat(2,1fr); } }
    @media(max-width:600px){ .grid{ grid-template-columns:1fr; } .sheet{ padding:14px } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Published Blogs</h1>
      <div style="display:flex;gap:12px;align-items:center">
        <div class="note">Click a blog to open. Watch 10s to reward the author ₦1 and you earn ₦1 (once every 2 hours).</div>
        <button id="signinBtn" class="small-btn">Sign in</button>
      </div>
    </header>

    <div id="statusArea" class="note" style="margin-bottom:12px"></div>
    <div id="grid" class="grid" role="list" aria-label="Published blogs"></div>
  </div>

  <!-- overlay -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet" role="document">
      <button id="closeOverlay" class="close-btn">Close</button>
      <div id="blogHeader">
        <h2 id="overlayTitle"></h2>
        <div class="by" id="overlayMeta"></div>
      </div>
      <div id="overlayBody" class="content" style="white-space:pre-wrap;margin-top:10px"></div>

      <div class="overlay-footer">
        <div class="status" id="overlayStatus">Blog ID: <span id="overlayId"></span></div>
        <div style="display:flex; gap:8px; align-items:center">
          <div class="timer-pill" id="timerPill">10s</div>
          <div id="awardMsg" class="status"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, collection, query, where, onSnapshot, getDocs, doc, getDoc,
      addDoc, updateDoc, serverTimestamp, increment, setDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // --- YOUR FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.appspot.com",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    if(!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    // UI refs
    const grid = document.getElementById('grid');
    const statusArea = document.getElementById('statusArea');
    const signinBtn = document.getElementById('signinBtn');
    const overlay = document.getElementById('overlay');
    const overlayTitle = document.getElementById('overlayTitle');
    const overlayMeta = document.getElementById('overlayMeta');
    const overlayBody = document.getElementById('overlayBody');
    const overlayId = document.getElementById('overlayId');
    const timerPill = document.getElementById('timerPill');
    const awardMsg = document.getElementById('awardMsg');
    const closeOverlay = document.getElementById('closeOverlay');

    let currentUser = null;
    let currentTimer = null;
    let remaining = 10;
    let activeBlog = null; // { id, data }
    // cooldown in ms
    const COOLDOWN_MS = 2 * 60 * 60 * 1000; // 2 hours

    function showStatus(text){ statusArea.textContent = text; }
    function clearStatus(){ statusArea.textContent = ''; }
    function makeThumb(src, title){
      if(src) return src;
      return 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="320" height="200"><rect width="100%" height="100%" fill="%23071a28"/><text x="50%" y="50%" fill="%23aaaaaa" font-size="16" dominant-baseline="middle" text-anchor="middle">No thumbnail</text></svg>';
    }

    function subscribePublished(){
      showStatus('Loading published blogs…');
      const col = collection(db, 'blogs');
      const q = query(col, where('status','==','published'));
      onSnapshot(q, (snap) => {
        const docs = snap.docs.slice().sort((a,b)=>{
          const ad = a.data().publishedAt;
          const bd = b.data().publishedAt;
          const at = ad && typeof ad.toDate === 'function' ? ad.toDate().getTime() : (ad ? new Date(ad).getTime() : 0);
          const bt = bd && typeof bd.toDate === 'function' ? bd.toDate().getTime() : (bd ? new Date(bd).getTime() : 0);
          return bt - at;
        });
        renderGrid(docs);
        clearStatus();
      }, (err) => {
        console.error('subscribePublished error', err);
        showStatus('Error loading blogs: ' + (err && err.message ? err.message : String(err)));
      });
    }

    function renderGrid(docs){
      grid.innerHTML = '';
      if(!docs || docs.length === 0){ grid.innerHTML = '<div class="note">No published blogs yet.</div>'; return; }
      docs.forEach(snap => {
        const id = snap.id;
        const data = snap.data();
        const card = document.createElement('article');
        card.className = 'card';
        card.tabIndex = 0;
        card.innerHTML = `
          <img class="thumb" src="${makeThumb(data.thumbnail)}" alt="${(data.title||'Untitled')}">
          <div>
            <h3 class="title">${escapeHtml(data.title||'Untitled')}</h3>
            <div class="meta"><div class="tags">${escapeHtml((data.tags||[]).join(', '))}</div><div class="small-btn">Read</div></div>
            <div class="note" style="margin-top:8px">${escapeHtml((data.content||'').slice(0,140))}${(data.content && data.content.length>140)?'…':''}</div>
          </div>
        `;
        card.addEventListener('click', ()=> openOverlay(id, data));
        card.addEventListener('keypress', (e)=> { if(e.key === 'Enter') openOverlay(id,data); });
        grid.appendChild(card);
      });
    }

    function escapeHtml(str){ if(!str) return ''; return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    async function openOverlay(id, data){
      activeBlog = { id, data };
      overlayTitle.textContent = data.title || 'Untitled';
      overlayMeta.textContent = `By ${data.author || data.userId || 'Unknown'} • Published: ${formatDate(data.publishedAt)}`;
      overlayBody.textContent = data.content || '';
      overlayId.textContent = id;
      awardMsg.textContent = '';
      remaining = 10;
      timerPill.textContent = `${remaining}s`;
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden','false');

      if(currentTimer){ clearInterval(currentTimer); currentTimer = null; }

      if(!currentUser){
        awardMsg.textContent = 'Sign in to reward the author and earn ₦1 when you watch 10s.';
        return;
      }

      const viewerUid = currentUser.uid;
      const authorId = data.userId || data.authorId;

      if(viewerUid === authorId){
        awardMsg.textContent = 'You are the author — viewing does not award.';
        return;
      }

      // check cooldown then start timer if allowed
      await checkCooldownAndStart(id, viewerUid);
    }

    // returns { allowed: bool, remainingMs: number (if disallowed) }
    async function checkCooldown(blogId, viewerUid){
      try{
        const viewDocRef = doc(db, 'blogViews', `${blogId}_${viewerUid}`);
        const snap = await getDoc(viewDocRef);
        if(!snap.exists()) return { allowed: true };
        const data = snap.data();
        const last = data && data.lastViewedAt;
        if(!last) return { allowed: true };
        const lastMs = typeof last.toDate === 'function' ? last.toDate().getTime() : (new Date(last).getTime ? new Date(last).getTime() : 0);
        const now = Date.now();
        const diff = now - lastMs;
        if(diff >= COOLDOWN_MS) return { allowed: true };
        return { allowed: false, remainingMs: COOLDOWN_MS - diff };
      }catch(err){
        console.error('checkCooldown error', err);
        return { allowed: true }; // fail-open (so user can still view) — but log error
      }
    }

    async function checkCooldownAndStart(blogId, viewerUid){
      awardMsg.textContent = 'Checking view cooldown…';
      const res = await checkCooldown(blogId, viewerUid);
      if(!res.allowed){
        const mins = Math.ceil(res.remainingMs / 60000);
        awardMsg.textContent = `You can reward this blog in ${mins} minute(s).`;
        return;
      }
      awardMsg.textContent = 'Watch 10s to reward author ₦1 and earn ₦1.';
      currentTimer = setInterval(()=>{
        remaining -= 1;
        timerPill.textContent = `${remaining}s`;
        if(remaining <= 0){
          clearInterval(currentTimer);
          currentTimer = null;
          timerPill.textContent = '0s';
          awardView(activeBlog.id, currentUser.uid);
        }
      }, 1000);
    }

    async function awardView(blogId, viewerUid){
      if(!activeBlog) return;
      const authorId = activeBlog.data.userId || activeBlog.data.authorId;
      if(!authorId){
        awardMsg.textContent = 'Author info missing; cannot award.';
        return;
      }
      awardMsg.textContent = 'Awarding ₦1 to author and ₦1 to you…';
      try{
        const viewDocRef = doc(db, 'blogViews', `${blogId}_${viewerUid}`);

        // attempt atomic-ish update: if doc exists, update lastViewedAt & increment count;
        // if not, create it.
        try{
          await updateDoc(viewDocRef, { lastViewedAt: serverTimestamp(), count: increment(1) });
        }catch(err){
          // likely doc doesn't exist -> create
          try{
            await setDoc(viewDocRef, { blogId, viewerUid, lastViewedAt: serverTimestamp(), count: 1 });
          }catch(inner){
            console.warn('setDoc blogViews failed', inner);
            // continue — not fatal
          }
        }

        // add transactions & update balances
        const txsCol = collection(db, 'transactions');

        // Author transaction + increment blogBalance
        await addDoc(txsCol, {
          userId: authorId,
          type: 'view_reward',
          source: 'blog_view',
          amount: 1,
          note: `Paid ₦1 for view of blog ${blogId}`,
          blogId,
          createdAt: serverTimestamp()
        });
        const authorRef = doc(db, 'users', authorId);
        try{ await updateDoc(authorRef, { blogBalance: increment(1) }); }catch(e){ console.warn('author balance update failed', e); }

        // Viewer transaction + increment balance
        await addDoc(txsCol, {
          userId: viewerUid,
          type: 'view_bonus',
          source: 'blog_view_watch',
          amount: 1,
          note: `Earned ₦1 for watching blog ${blogId}`,
          blogId,
          createdAt: serverTimestamp()
        });
        const viewerRef = doc(db, 'users', viewerUid);
        try{ await updateDoc(viewerRef, { balance: increment(1) }); }catch(e){ console.warn('viewer balance update failed', e); }

        // Notifications (optional)
        const notCol = collection(db, 'notifications');
        await addDoc(notCol, { userId: authorId, type: 'blog_reward', message: `Your blog "${activeBlog.data.title || 'Untitled'}" earned ₦1 from a viewer.`, blogId, createdAt: serverTimestamp() });
        await addDoc(notCol, { userId: viewerUid, type: 'view_credited', message: `You earned ₦1 for watching "${activeBlog.data.title || 'Untitled'}".`, blogId, createdAt: serverTimestamp() });

        awardMsg.textContent = 'Success — author and you were paid ₦1.';
      }catch(err){
        console.error('awardView error', err);
        awardMsg.textContent = 'Error awarding: ' + (err && err.message ? err.message : String(err));
      }
    }

    function formatDate(ts){
      if(!ts) return '-';
      try{ if(typeof ts.toDate === 'function') return ts.toDate().toLocaleString(); return new Date(ts).toLocaleString(); }catch(e){ return '-'; }
    }

    closeOverlay.addEventListener('click', ()=> {
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden','true');
      if(currentTimer){ clearInterval(currentTimer); currentTimer = null; }
      activeBlog = null;
    });

    // auth
    const provider = new GoogleAuthProvider();
    signinBtn.addEventListener('click', async ()=>{
      try{
        await signInWithPopup(auth, provider);
      }catch(err){
        console.error('signIn error', err);
        showStatus('Sign-in failed: ' + (err && err.message ? err.message : String(err)));
      }
    });

    onAuthStateChanged(auth, user=>{
      currentUser = user;
      if(user){
        signinBtn.textContent = 'Signed in';
        signinBtn.disabled = true;
      }else{
        signinBtn.textContent = 'Sign in';
        signinBtn.disabled = false;
      }
    });

    // start
    subscribePublished();
  </script>
</body>
</html>
