<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Adverts ‚Äî Beni-Wealth</title>

  <!-- Poppins (Beni-Wealth standard) -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300,400,600,700&display=swap" rel="stylesheet"/>

  <!-- Favicons & Social preview -->
  <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <meta name="theme-color" content="#2fe0b8">

  <style>
    :root{
      --bg1:#060511; --bg2:#0f0920;
      --muted: rgba(255,255,255,0.62);
      --text: #eaf2ff;
      --accent-start:#2fe0b8; --accent-end:#7a5fff;
      --card: rgba(255,255,255,0.02);
      --radius:12px;
      --btn-copy:#ffd166;
    }
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;font-family:'Poppins',sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);-webkit-font-smoothing:antialiased}
    .shell{max-width:1200px;margin:20px auto;padding:20px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .back{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.03);text-decoration:none;color:var(--text)}
    .brand{font-weight:700;font-size:1.1rem}
    .muted{color:var(--muted);font-size:13px}
    .toolbar{display:flex;gap:12px;align-items:center;margin-bottom:18px}
    .search{flex:1;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:#041219;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}

    .card{background:var(--card);border-radius:var(--radius);padding:14px;border:1px solid rgba(255,255,255,0.04)}
    .card-head{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .title{font-weight:700;font-size:1rem}
    .id-copy{font-size:0.85rem;color:var(--muted);cursor:pointer}
    .meta{color:var(--muted);font-size:12px}
    .actions{display:flex;gap:8px;margin-top:10px}
    .pill{padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
    .pill.pending{background:#fff6d6;color:#6a4f00}
    .pill.approved{background:#bff0d9;color:#05461f}
    .pill.rejected{background:#ffd6d6;color:#6a0000}

    .details-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.8);z-index:999;padding:22px}
    .details-panel{width:100%;max-width:800px;background:var(--bg1);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.04);color:var(--text);max-height:90vh;overflow:auto}
    .closeX{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
    .sub-table{width:100%;border-collapse:collapse;margin-top:12px}
    .sub-table th, .sub-table td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:left;font-size:13px}
    .sub-table th{background:rgba(255,255,255,0.04);color:var(--text);font-weight:700}
    .approve-btn{background:var(--accent-start);color:#041219;padding:6px 10px;border-radius:8px}
    .reject-btn{background:#ff6b6b;color:#041219;padding:6px 10px;border-radius:8px}
  </style>
</head>
<body>
  <main class="shell">
    <header>
      <a class="back" href="dashboard.html">‚Üê Back</a>
      <div>
        <div class="brand">My Adverts</div>
        <div class="muted">View your adverts and submissions</div>
      </div>
    </header>

    <div class="toolbar">
      <input id="search" class="search" placeholder="Search by title or advert ID" />
      <button id="refresh" class="btn ghost">Refresh</button>
    </div>

    <div id="grid" class="grid" aria-live="polite">
      <div class="muted">Loading adverts‚Ä¶</div>
    </div>
  </main>

  <!-- Details overlay -->
  <div id="detailsOverlay" class="details-overlay">
    <div class="details-panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><span id="advTitle" class="title"></span> <span id="advId" class="id-copy"></span></div>
        <button id="closeDetails" class="closeX">‚úï</button>
      </div>
      <div id="subContainer"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, query, where, onSnapshot, getDocs, doc,
      runTransaction, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:80795087310246:web:e10fa87307e041c4d8417f",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let advertsMap = new Map();
    let currentUser = null;

    const grid = document.getElementById("grid");
    const searchInput = document.getElementById("search");
    const refreshBtn = document.getElementById("refresh");

    function renderGrid(filter=""){
      grid.innerHTML = "";
      const lower = filter.toLowerCase();
      let any = false;
      advertsMap.forEach(({id,data}) => {
        const title = (data.title||"").toLowerCase();
        if(!title.includes(lower) && !id.includes(lower)) return;
        any = true;

        const card = document.createElement("div");
        card.className="card";

        card.innerHTML = `
          <div class="card-head">
            <div>
              <div class="title">${data.title||"Untitled"}</div>
              <div class="id-copy" title="Click to copy ID" data-id="${id}">${id.slice(0,8)}‚Ä¶</div>
              <div class="meta">${data.platform||""} ‚Äî ${data.status||""}</div>
            </div>
            <div><span class="pill ${data.status||"pending"}">${data.status?.toUpperCase()||"PENDING"}</span></div>
          </div>
          <div class="actions">
            <button class="btn ghost view-btn" data-id="${id}">View Submissions</button>
          </div>`;

        grid.appendChild(card);
      });
      if(!any) grid.innerHTML="<div class='muted'>No adverts found</div>";
    }

    function attachAdvertListener(uid){
      const col = collection(db,"advertise_tasks");
      onSnapshot(col, snap => {
        advertsMap.clear();
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const isOwner = d.createdBy === uid || d.ownerUid===uid;
          if(isOwner){
            advertsMap.set(docSnap.id,{id: docSnap.id, data:d});
          }
        });
        renderGrid(searchInput.value);
      });
    }

    onAuthStateChanged(auth,user=>{
      if(!user) location.href="login.html";
      currentUser=user;
      attachAdvertListener(user.uid);
    });

    searchInput.oninput=()=> renderGrid(searchInput.value);

    refreshBtn.onclick=()=> renderGrid(searchInput.value);

    document.body.addEventListener("click", async e=>{
      if(e.target.matches(".id-copy")){
        const id = e.target.dataset.id;
        await navigator.clipboard.writeText(id);
        alert("Advert ID copied");
      }
      if(e.target.matches(".view-btn")){
        const advertId = e.target.dataset.id;
        openDetails(advertId);
      }
    });

    const detailsOverlay = document.getElementById("detailsOverlay");
    const closeDetails = document.getElementById("closeDetails");
    const advTitle = document.getElementById("advTitle");
    const advId = document.getElementById("advId");
    const subContainer = document.getElementById("subContainer");

    async function openDetails(adId){
      const advert = advertsMap.get(adId);
      if(!advert) return;
      advTitle.textContent = advert.data.title||"Untitled";
      advId.textContent = `(${adId})`;

      subContainer.innerHTML="<div class='muted'>Loading submissions‚Ä¶</div>";

      const subQ = query(collection(db,"advert_submissions"), where("advertId","==", adId));
      const snap = await getDocs(subQ);
      if(snap.empty){
        subContainer.innerHTML="<div class='muted'>No submissions</div>";
      } else {
        let html=`<table class='sub-table'><thead><tr><th>ID</th><th>User</th><th>Status</th><th>Action</th></tr></thead><tbody>`;
        snap.forEach(s=>{
          const d = s.data();
          const sid = s.id;
          html+=`<tr>
            <td>${sid} <span class='id-copy' data-id='${sid}' title='Copy submission ID'>üìã</span></td>
            <td>${d.userId||""}</td>
            <td>${d.status||""}</td>
            <td>
              <button class='approve-btn' data-id='${sid}' data-user='${d.userId||""}'>Approve</button>
              <button class='reject-btn' data-id='${sid}'>Reject</button>
            </td>
          </tr>`;
        });
        html+="</tbody></table>";
        subContainer.innerHTML=html;
      }

      detailsOverlay.style.display="flex";
    }

    closeDetails.onclick=()=> detailsOverlay.style.display="none";

    subContainer.addEventListener("click", async e=>{
      if(e.target.matches(".approve-btn")){
        const sid = e.target.dataset.id;
        const uid = e.target.dataset.user;
        const payAmt = 0; // you can compute from advert details if needed
        try {
          await runTransaction(db, async tx=>{
            const subRef = doc(db,"advert_submissions",sid);
            const subSnap = await tx.get(subRef);
            if(!subSnap.exists()) throw "Submission not found";
            if(subSnap.data().status!=="pending") throw "Not pending";

            tx.update(subRef,{status:"approved",approvedAt:serverTimestamp()});

            const userRef = doc(db,"users",uid);
            const userSnap = await tx.get(userRef);
            const curBal = Number(userSnap.data().balance||0);
            tx.update(userRef,{balance:curBal+payAmt});
          });
          alert("Approved");
        } catch(err){
          alert("Approve failed: "+err);
        }
      }
      if(e.target.matches(".reject-btn")){
        const sid = e.target.dataset.id;
        try {
          await runTransaction(db, async tx=>{
            tx.update(doc(db,"advert_submissions",sid),{status:"rejected"});
          });
          alert("Rejected");
        } catch(err){
          alert("Reject failed: "+err);
        }
      }
      if(e.target.matches(".id-copy")){
        const id = e.target.dataset.id;
        await navigator.clipboard.writeText(id);
        alert("ID copied");
      }
    });
  </script>
</body>
</html>
