<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Adverts — Beni-Wealth (Table)</title>

  <!-- Poppins + Favicons & Social preview -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300,400,600,700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <meta name="msapplication-TileImage" content="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Beni-Wealth — My Adverts">
  <meta property="og:description" content="Your adverts — review submissions and manage approvals.">
  <meta property="og:image" content="https://res.cloudinary.com/dq7fpxfbc/image/upload/c_fill,w_1200,h_630/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="theme-color" content="#2fe0b8">

  <style>
    :root{
      --bg1:#060511; --bg2:#0f0920;
      --muted: rgba(255,255,255,0.62);
      --text: #eaf2ff;
      --accent-start:#2fe0b8; --accent-end:#7a5fff;
      --card: rgba(255,255,255,0.02);
      --radius:12px;
      --max-width:1200px;
      --bottom-nav-h:72px;
    }
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;font-family:'Poppins',sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);-webkit-font-smoothing:antialiased}
    .wrap{max-width:var(--max-width);margin:20px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .brand{font-weight:800;font-size:1.05rem}
    .muted{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    .search{flex:1;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));color:var(--text)}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:#041219;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .table-wrap{overflow:auto;border-radius:12px;background:var(--card);padding:10px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 18px 60px rgba(0,0,0,0.55)}
    table{width:100%;border-collapse:collapse;min-width:900px}
    thead th{position:sticky;top:0;background:linear-gradient(90deg, rgba(47,224,184,0.06), rgba(122,95,255,0.04));padding:12px;text-align:left;font-weight:700}
    tbody td{padding:12px;border-bottom:1px solid rgba(255,255,255,0.02);vertical-align:middle}
    .small{font-size:13px;color:var(--muted)}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
    .pill.pending{background:#fff7d9;color:#6a4f00}
    .pill.approved{background:#bff0d9;color:#043f20}
    .pill.rejected{background:#ffdede;color:#6b0b0b}
    .viewer{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:9999;padding:20px}
    .panel{width:980px;max-width:calc(100% - 40px);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:16px;box-shadow:0 30px 120px rgba(0,0,0,0.8);color:var(--text);max-height:92vh;overflow:auto}
    .panel .grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
    .panel img{max-width:100%;border-radius:8px;display:block}
    @media(max-width:900px){ .panel .grid{grid-template-columns:1fr} .panel{width:calc(100% - 40px)} }
    .meta-row{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .note{margin-top:8px;color:var(--muted)}
  </style>
</head>
<body>
  <main class="wrap">
    <header>
      <div>
        <div class="brand">My Adverts — Table</div>
        <div class="muted">All adverts you own — open Details to review submissions</div>
      </div>
      <div id="authInfo" class="muted">Checking sign-in…</div>
    </header>

    <div class="controls">
      <input id="search" class="search" placeholder="Search by title, platform or status" />
      <button id="refresh" class="btn ghost">Refresh</button>
      <div style="margin-left:auto" id="count" class="small">—</div>
    </div>

    <div id="diag" class="small muted">Connecting…</div>

    <div id="tableWrap" class="table-wrap" style="margin-top:12px">
      <table aria-live="polite">
        <thead>
          <tr>
            <th>Advert id</th>
            <th>Title / Platform</th>
            <th>Workers</th>
            <th>Unit price</th>
            <th>Created</th>
            <th>Status</th>
            <th style="width:120px">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="7" class="small muted">Loading your adverts…</td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <!-- details viewer -->
  <div id="viewer" class="viewer" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>
          <div id="vTitle" style="font-weight:800">Advert</div>
          <div id="vMeta" class="small muted" style="margin-top:6px">meta</div>
        </div>
        <div>
          <button id="vClose" class="btn ghost">Close</button>
        </div>
      </div>

      <div class="grid" style="margin-top:12px">
        <div>
          <div id="vDesc" class="small muted"></div>

          <div style="margin-top:12px">
            <div style="font-weight:700;margin-bottom:8px">Submissions</div>
            <div id="subList" style="display:flex;flex-direction:column;gap:12px">
              <div class="small muted">Loading submissions…</div>
            </div>
          </div>
        </div>

        <div>
          <div style="font-weight:700;margin-bottom:6px">Advert Info</div>
          <div class="meta-row"><div class="small muted">ID</div><div id="vId" class="small muted">—</div></div>
          <div class="meta-row" style="margin-top:6px"><div class="small muted">Workers</div><div id="vWorkers" class="small muted">—</div></div>
          <div class="meta-row" style="margin-top:6px"><div class="small muted">Unit price</div><div id="vUnitPrice" class="small muted">—</div></div>
          <div class="meta-row" style="margin-top:6px"><div class="small muted">Created</div><div id="vCreated" class="small muted">—</div></div>
          <div style="margin-top:10px" id="vNote" class="note"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import {
      getFirestore, collection, onSnapshot, query, getDocs, orderBy, limit,
      where, runTransaction, doc, serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

    // Firebase config (your project)
    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    if(!getApps().length) initializeApp(firebaseConfig);
    const db = getFirestore();
    const auth = getAuth();

    // admin emails that can see all adverts
    const ADMIN_EMAILS = ['beniwealth70@gmail.com','owanaomubo76@gmail.com'];

    // DOM
    const authInfo = document.getElementById('authInfo');
    const diag = document.getElementById('diag');
    const tbody = document.getElementById('tbody');
    const search = document.getElementById('search');
    const refresh = document.getElementById('refresh');
    const countEl = document.getElementById('count');

    const viewer = document.getElementById('viewer');
    const vClose = document.getElementById('vClose');
    const vTitle = document.getElementById('vTitle');
    const vMeta = document.getElementById('vMeta');
    const vDesc = document.getElementById('vDesc');
    const vId = document.getElementById('vId');
    const vWorkers = document.getElementById('vWorkers');
    const vUnitPrice = document.getElementById('vUnitPrice');
    const vCreated = document.getElementById('vCreated');
    const vNote = document.getElementById('vNote');
    const subList = document.getElementById('subList');

    // state
    let currentUser = null;
    let advertsMap = new Map();
    let advertsUnsub = null;
    let subsUnsub = null;
    let authSettled = false;

    // candidate owner fields (apps vary)
    const OWNER_FIELDS = ['createdBy','owner','userId','uid','requestedBy','creator','ownerUid','user','requested_by','created_by'];

    // helpers
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function fmtDate(v){
      try{
        if(!v) return '-';
        if(typeof v.toDate === 'function') return v.toDate().toLocaleString();
        if(typeof v.seconds === 'number') return new Date(v.seconds*1000).toLocaleString();
        return new Date(v).toLocaleString();
      }catch(e){ return '-'; }
    }
    function getUnitPrice(ad){
      if(!ad) return 0;
      const keys = ['unitPrice','unit_price','price','per','unit','amount'];
      for(const k of keys) if(typeof ad[k] !== 'undefined' && !isNaN(Number(ad[k]))) return Number(ad[k]);
      const total = Number(ad.totalCost ?? ad.total_cost ?? ad.total ?? 0) || 0;
      const w = Number(ad.workers ?? ad.worker_count ?? ad.requested_workers || 0) || 0;
      return (w>0 && total>0) ? (total / w) : 0;
    }

    // robust owner match: supports uid, email, displayName, username local-part, arrays, objects
    function docOwnedByUser(docData, user){
      if(!docData || !user) return false;
      const uids = [user.uid];
      const emails = [user.email?.toLowerCase()];
      const names = [ (user.displayName || '').toLowerCase(), (user.email||'').split('@')[0].toLowerCase() ];

      for(const f of OWNER_FIELDS){
        const val = docData[f];
        if(val === undefined || val === null) continue;
        if(typeof val === 'string'){
          const low = val.toLowerCase();
          if(uids.includes(val) || emails.includes(low) || names.includes(low)) return true;
          // maybe string contains uid/email as substring
          if(low === user.uid.toLowerCase() || low === (user.email||'').toLowerCase()) return true;
        } else if(typeof val === 'object'){
          // object may contain uid/email keys
          const vstr = JSON.stringify(val).toLowerCase();
          if(vstr.includes(user.uid.toLowerCase()) || vstr.includes((user.email||'').toLowerCase())) return true;
        } else if(Array.isArray(val)){
          if(val.includes(user.uid) || val.includes(user.email) || val.includes((user.email||'').split('@')[0])) return true;
        }
      }
      return false;
    }

    // show table rows based on advertsMap
    function renderTable(){
      const qText = (search.value || '').trim().toLowerCase();
      const rows = [];
      for(const [id,item] of advertsMap.entries()){
        const d = item.data || {};
        const hay = ((d.title||'') + ' ' + (d.platform||'') + ' ' + (d.status||'')).toLowerCase();
        if(qText && !hay.includes(qText)) continue;
        const unit = getUnitPrice(d);
        rows.push({
          id,
          title: d.title || '(untitled)',
          platform: d.platform || d.subcategory || '',
          workers: Number(d.workers || d.worker_count || d.requested_workers || 0) || 0,
          unitPrice: unit,
          createdAt: d.createdAt || d.created_at || null,
          status: (d.status || 'pending').toString().toLowerCase()
        });
      }

      // sort newest first
      rows.sort((a,b) => {
        const ta = a.createdAt && a.createdAt.toDate ? a.createdAt.toDate().getTime() : (a.createdAt?Date.parse(a.createdAt):0);
        const tb = b.createdAt && b.createdAt.toDate ? b.createdAt.toDate().getTime() : (b.createdAt?Date.parse(b.createdAt):0);
        return tb - ta;
      });

      countEl.textContent = `${rows.length} advert${rows.length===1?'':'s'}`;
      if(rows.length === 0){
        tbody.innerHTML = `<tr><td colspan="7" class="small muted">No adverts found</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map(r => {
        const statusClass = r.status === 'approved' ? 'approved' : r.status === 'rejected' ? 'rejected' : 'pending';
        return `<tr data-id="${escapeHtml(r.id)}">
          <td style="font-family:monospace">${escapeHtml(r.id)}</td>
          <td><div style="font-weight:700">${escapeHtml(r.title)}</div><div class="small muted">${escapeHtml(r.platform)}</div></td>
          <td>${r.workers}</td>
          <td>₦${Number(r.unitPrice||0).toLocaleString('en-NG')}</td>
          <td class="small muted">${fmtDate(r.createdAt)}</td>
          <td><span class="pill ${statusClass}">${(r.status||'PENDING').toUpperCase()}</span></td>
          <td><button class="btn ghost detailsBtn">Details</button></td>
        </tr>`;
      }).join('');

      // wire detail buttons
      document.querySelectorAll('.detailsBtn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const tr = e.target.closest('tr');
          const id = tr.getAttribute('data-id');
          openDetails(id);
        });
      });
    }

    function openDetails(adId){
      const ad = advertsMap.get(adId);
      if(!ad){ alert('Advert not found'); return; }
      const d = ad.data || {};
      vTitle.textContent = d.title || '(untitled)';
      vMeta.textContent = `${d.platform || d.subcategory || ''} • ${(d.status||'').toUpperCase()}`;
      vDesc.textContent = d.description || '';
      vId.textContent = adId;
      vWorkers.textContent = String(Number(d.workers || d.worker_count || d.requested_workers || 0) || 0);
      vUnitPrice.textContent = '₦' + Number(getUnitPrice(d) || 0).toLocaleString('en-NG');
      vCreated.textContent = fmtDate(d.createdAt);
      vNote.textContent = '';

      attachSubsListener(adId);
      viewer.style.display = 'flex';
      viewer.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
    }

    vClose.addEventListener('click', () => {
      viewer.style.display = 'none';
      viewer.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
      detachSubsListener();
    });
    viewer.addEventListener('click', (e) => { if(e.target === viewer) vClose.click(); });

    // attach subscriptions listener for advert
    function attachSubsListener(adId){
      detachSubsListener();
      subList.innerHTML = `<div class="small muted">Loading submissions…</div>`;
      try{
        const col = collection(db,'advert_submissions');
        // avoid orderBy index issues: query by advertId equality only
        const q = query(col, where('advertId','==', adId));
        subsUnsub = onSnapshot(q, snap => {
          const subs = [];
          snap.forEach(s => {
            const d = s.data() || {};
            subs.push({
              id: s.id,
              userId: d.userId || d.user || d.workerId || '',
              textProof: d.textProof || d.text_proof || d.proofText || '',
              imageUrl: d.imageUrl || d.image || '',
              status: (d.status || 'pending').toLowerCase(),
              createdAt: d.createdAt || d.created_at || null,
              paidAmount: Number(d.paidAmount || d.amount || 0)
            });
          });
          // sort by createdAt desc
          subs.sort((a,b) => {
            const ta = a.createdAt && a.createdAt.toDate ? a.createdAt.toDate().getTime() : (a.createdAt?Date.parse(a.createdAt):0);
            const tb = b.createdAt && b.createdAt.toDate ? b.createdAt.toDate().getTime() : (b.createdAt?Date.parse(b.createdAt):0);
            return tb - ta;
          });
          renderSubmissions(subs);
        }, err => {
          console.error('subs listener error', err);
          subList.innerHTML = `<div class="small muted">Unable to load submissions: ${escapeHtml(err.message||String(err))}</div>`;
        });
      }catch(e){
        console.error('attachSubsListener error', e);
        subList.innerHTML = `<div class="small muted">Unable to listen for submissions.</div>`;
      }
    }
    function detachSubsListener(){ if(subsUnsub){ try{subsUnsub(); }catch(e){} subsUnsub=null; } }

    // render submissions (owner controls)
    function renderSubmissions(list){
      subList.innerHTML = '';
      if(!list || list.length === 0){ subList.innerHTML = `<div class="small muted">No submissions yet.</div>`; return; }

      const advertId = vId.textContent;
      const advert = advertsMap.get(advertId) || {};
      const adData = advert.data || {};
      // determine advert owner value(s)
      const advertOwnerMatches = (() => {
        // collect owner candidates from doc
        const ownerVals = [];
        for(const f of OWNER_FIELDS){
          if(adData[f] !== undefined && adData[f] !== null) ownerVals.push(adData[f]);
        }
        return ownerVals;
      })();

      list.forEach(item => {
        const node = document.createElement('div');
        node.style.display = 'flex';
        node.style.justifyContent = 'space-between';
        node.style.gap = '12px';
        node.style.alignItems = 'flex-start';
        node.style.padding = '10px';
        node.style.borderRadius = '8px';
        node.style.background = 'linear-gradient(180deg, rgba(255,255,255,0.01), transparent)';
        node.style.border = '1px solid rgba(255,255,255,0.03)';

        const left = document.createElement('div'); left.style.flex='1';
        const meta = document.createElement('div'); meta.className='small muted';
        meta.textContent = `Submitted: ${fmtDate(item.createdAt)} • ID: ${item.id} • By: ${item.userId || '-'}`;
        const text = document.createElement('div'); text.style.marginTop='8px'; text.style.color='var(--muted)'; text.style.whiteSpace='pre-wrap';
        text.textContent = item.textProof || '(no text proof)';
        left.appendChild(meta); left.appendChild(text);

        const right = document.createElement('div');
        right.style.minWidth='220px'; right.style.textAlign='right'; right.style.display='flex'; right.style.flexDirection='column'; right.style.alignItems='flex-end'; right.style.gap='8px';

        if(item.imageUrl){
          const img = document.createElement('img');
          img.src = item.imageUrl;
          img.alt = 'proof';
          img.style.maxWidth='240px';
          img.style.borderRadius='8px';
          img.style.cursor='pointer';
          img.style.border='1px solid rgba(255,255,255,0.04)';
          img.addEventListener('click', ()=> window.open(item.imageUrl,'_blank','noopener'));
          right.appendChild(img);
        }

        const pill = document.createElement('div'); pill.className='pill ' + (item.status==='approved'?'approved':item.status==='rejected'?'rejected':'pending');
        pill.textContent = (item.status||'PENDING').toUpperCase();
        right.appendChild(pill);

        // allow actions if currentUser is advert owner or admin
        const currentIsAdmin = currentUser && ADMIN_EMAILS.includes((currentUser.email||'').toLowerCase());
        let currentIsOwner = false;
        if(currentUser && advertOwnerMatches.length){
          // check whether any owner value matches the signed-in user (uid/email/displayName)
          currentIsOwner = advertOwnerMatches.some(v=>{
            if(!v) return false;
            if(typeof v === 'string'){
              const low = v.toLowerCase();
              const u = (currentUser.email||'').toLowerCase();
              const n = (currentUser.displayName||'').toLowerCase();
              return v === currentUser.uid || low === u || low === n || low === (currentUser.email||'').split('@')[0];
            } else if(typeof v === 'object'){
              const s = JSON.stringify(v).toLowerCase();
              return s.includes((currentUser.email||'').toLowerCase()) || s.includes((currentUser.uid||'').toLowerCase());
            } else if(Array.isArray(v)){
              return v.includes(currentUser.uid) || v.includes(currentUser.email);
            }
            return false;
          });
        }
        if(currentUser && (currentIsOwner || currentIsAdmin)){
          const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='8px';
          const payAmount = item.paidAmount || Math.round(getUnitPrice(adData) * 0.7) || 0;
          const approveBtn = document.createElement('button'); approveBtn.className='btn'; approveBtn.textContent = `Approve (₦${payAmount.toLocaleString()})`;
          const rejectBtn = document.createElement('button'); rejectBtn.className='btn ghost'; rejectBtn.textContent='Reject';

          const isPending = item.status === 'pending';
          if(!isPending){ approveBtn.disabled=true; rejectBtn.disabled=true; approveBtn.style.opacity='.6'; rejectBtn.style.opacity='.6'; }

          approveBtn.addEventListener('click', async ()=>{
            if(!isPending) return;
            if(!confirm(`Approve submission and credit user ₦${payAmount.toLocaleString()}?`)) return;
            approveBtn.disabled=true; rejectBtn.disabled=true;
            try{
              await setSubmissionStatusTransaction({ type:'approve', submissionId:item.id, submitterUid:item.userId, amount:payAmount});
              vNote.textContent = 'Approved — changes saved';
            }catch(err){ console.error('approve error',err); alert('Approve failed: '+(err.message||err)); approveBtn.disabled=false; rejectBtn.disabled=false; }
          });

          rejectBtn.addEventListener('click', async ()=>{
            if(!isPending) return;
            if(!confirm('Reject this submission?')) return;
            approveBtn.disabled=true; rejectBtn.disabled=true;
            try{
              await setSubmissionStatusTransaction({ type:'reject', submissionId:item.id });
              vNote.textContent = 'Rejected — changes saved';
            }catch(err){ console.error('reject err',err); alert('Reject failed: '+(err.message||err)); approveBtn.disabled=false; rejectBtn.disabled=false; }
          });

          controls.appendChild(approveBtn); controls.appendChild(rejectBtn);
          right.appendChild(controls);
        }

        node.appendChild(left); node.appendChild(right);
        subList.appendChild(node);
      });
    }

    // transaction to approve/reject
    async function setSubmissionStatusTransaction(payload){
      if(!payload || !payload.type) throw new Error('Invalid payload');
      if(payload.type === 'approve'){
        const { submissionId, submitterUid, amount } = payload;
        if(!submissionId || !submitterUid) throw new Error('Missing fields');
        const subRef = doc(db,'advert_submissions',submissionId);
        const userRef = doc(db,'users',submitterUid);
        await runTransaction(db, async (tx) => {
          const sSnap = await tx.get(subRef);
          if(!sSnap.exists()) throw new Error('Submission not found');
          const sData = sSnap.data() || {};
          const cur = (sData.status || 'pending').toLowerCase();
          if(cur !== 'pending') throw new Error('Submission not pending');
          // credit user balance (best-effort)
          const uSnap = await tx.get(userRef);
          if(uSnap.exists()){
            const u = uSnap.data() || {};
            const old = Number(u.balance || 0);
            tx.update(userRef, { balance: old + Number(amount || 0), updatedAt: serverTimestamp() });
          } else {
            tx.set(userRef, { balance: Number(amount || 0), updatedAt: serverTimestamp() }, { merge:true });
          }
          tx.update(subRef, { status:'approved', approvedAt: serverTimestamp(), paidAmount:Number(amount||0), paidBy: currentUser ? currentUser.uid : null });
        });
      } else if(payload.type === 'reject'){
        const { submissionId } = payload;
        if(!submissionId) throw new Error('Missing id');
        const subRef = doc(db,'advert_submissions',submissionId);
        await runTransaction(db, async (tx) => {
          const sSnap = await tx.get(subRef);
          if(!sSnap.exists()) throw new Error('Submission not found');
          const sData = sSnap.data() || {};
          const cur = (sData.status || 'pending').toLowerCase();
          if(cur !== 'pending') throw new Error('Submission not pending');
          tx.update(subRef, { status:'rejected', rejectedAt: serverTimestamp() });
        });
      } else throw new Error('Unknown action');
    }

    // adverts listener: single broad listener and client-side owner filtering (or admin sees all)
    function startAdvertsListenerForUser(user){
      if(advertsUnsub){ try{ advertsUnsub(); }catch(e){} advertsUnsub=null; }
      advertsMap = new Map();
      tbody.innerHTML = `<tr><td colspan="7" class="small muted">Loading your adverts…</td></tr>`;
      countEl.textContent = '…';
      diag.textContent = 'Listening to advertise_tasks…';

      try{
        const col = collection(db,'advertise_tasks');
        // listen broad (no orderBy) to prevent index issues
        advertsUnsub = onSnapshot(col, snap => {
          // rebuild map each snapshot (keeps it consistent)
          advertsMap = new Map();
          snap.forEach(ds => {
            const d = ds.data() || {};
            // admin sees everything
            const isAdmin = user && ADMIN_EMAILS.includes((user.email||'').toLowerCase());
            if(isAdmin){
              advertsMap.set(ds.id, { id: ds.id, data: d });
              return;
            }
            // else check owner fields
            if(docOwnedByUser(d, user)) advertsMap.set(ds.id, { id: ds.id, data: d });
          });
          diag.textContent = `Found ${advertsMap.size} advert(s) relevant to you`;
          renderTable();
        }, err => {
          console.error('adverts onSnapshot error', err);
          diag.textContent = 'Realtime listener failed — attempting one-time fetch';
          // fallback to one-time fetch
          fetchAdvertsOnce(user);
        });
      }catch(e){
        console.error('startAdvertsListener error', e);
        diag.textContent = 'Could not start adverts listener — attempting one-time fetch';
        fetchAdvertsOnce(user);
      }
    }

    async function fetchAdvertsOnce(user){
      try{
        tbody.innerHTML = `<tr><td colspan="7" class="small muted">Fetching adverts…</td></tr>`;
        const col = collection(db,'advertise_tasks');
        // limit to 1000 to avoid huge reads
        const snap = await getDocs(query(col, limit(1000)));
        advertsMap = new Map();
        snap.forEach(ds => {
          const d = ds.data() || {};
          const isAdmin = user && ADMIN_EMAILS.includes((user.email||'').toLowerCase());
          if(isAdmin || docOwnedByUser(d,user)) advertsMap.set(ds.id, { id: ds.id, data: d });
        });
        diag.textContent = `Fetched ${advertsMap.size} advert(s)`;
        renderTable();
      }catch(err){
        console.error('fetchAdvertsOnce error', err);
        tbody.innerHTML = `<tr><td colspan="7" class="small muted">Unable to load adverts: ${escapeHtml(err.message || String(err))}</td></tr>`;
        diag.textContent = 'Failed to load adverts — check console and Firestore rules';
      }
    }

    // UI wiring
    search.addEventListener('input', renderTable);
    refresh.addEventListener('click', ()=> { if(currentUser) startAdvertsListenerForUser(currentUser); });

    // auth handling (wait briefly, show sign-in link only after a small grace period)
    let authTimeout = setTimeout(()=> {
      if(!auth.currentUser){
        authInfo.innerHTML = `Not signed in — <a href="login.html" style="color:var(--accent-start)">Sign in</a>`;
        diag.textContent = 'Sign in to view your adverts.';
      }
    }, 3000);

    onAuthStateChanged(auth, user => {
      authSettled = true;
      clearTimeout(authTimeout);
      currentUser = user;
      if(!user){
        authInfo.innerHTML = `Not signed in — <a href="login.html" style="color:var(--accent-start)">Sign in</a>`;
        diag.textContent = 'Please sign in to view adverts.';
        tbody.innerHTML = `<tr><td colspan="7" class="small muted">Sign in to view your adverts.</td></tr>`;
        if(advertsUnsub){ try{ advertsUnsub(); }catch(e){} advertsUnsub=null; }
        return;
      }
      authInfo.textContent = `${user.email || user.displayName || user.uid}`;
      diag.textContent = 'Signed in — loading adverts…';
      // start listener/fetch
      startAdvertsListenerForUser(user);
    });

    // if auth already available (rare), handle immediately
    if(auth.currentUser){
      clearTimeout(authTimeout);
      currentUser = auth.currentUser;
      authInfo.textContent = `${currentUser.email || currentUser.displayName || currentUser.uid}`;
      startAdvertsListenerForUser(currentUser);
    }

    // cleanup
    window.addEventListener('beforeunload', () => {
      if(advertsUnsub){ try{ advertsUnsub(); }catch(e){} }
      if(subsUnsub){ try{ subsUnsub(); }catch(e){} }
    });
  </script>
</body>
</html>
