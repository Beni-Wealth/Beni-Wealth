<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Adverts ‚Äî Beni-Wealth</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300,400,600,700&display=swap" rel="stylesheet"/>
  <link rel="icon" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png"/>
  <meta name="theme-color" content="#2fe0b8">

  <style>
    /* EXISTING BENI-WEALTH THEME */
    :root{--bg1:#060511;--bg2:#0f0920;--muted:rgba(255,255,255,0.62);--text:#eaf2ff;--accent-start:#2fe0b8;--accent-end:#7a5fff;--card:rgba(255,255,255,0.02);--radius:12px;}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;font-family:'Poppins',sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text)}
    header{display:flex;align-items:center;gap:12px;padding:18px 22px;border-bottom:1px solid rgba(255,255,255,.05);font-weight:700;font-size:1.2rem}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:#041219;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .search{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);flex:1}
    .muted{color:var(--muted)}
    .id-copy{cursor:pointer;color:var(--muted);font-size:0.85rem}
    table{width:100%;border-collapse:collapse;margin-top:18px}
    th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,.06);font-size:14px;text-align:left}
    th{background:rgba(255,255,255,0.04);font-weight:700}
    .thumb-img{width:60px;height:60px;object-fit:cover;border-radius:6px;cursor:pointer}
    #overlayViewer{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.9);z-index:1000}
    #overlayViewer img{max-width:90%;max-height:90%;border-radius:10px}
    .disabled{opacity:.6;pointer-events:none}
  </style>

</head>
<body>

  <header>
    <a class="btn ghost" id="backBtn">‚Üê Back</a>
    My Adverts & Submissions
  </header>

  <!-- SEARCH & FILTER -->
  <div style="display:flex;gap:12px;padding:0 22px">
    <input id="searchInput" class="search" placeholder="Search adverts by title or ID"/>
    <button id="refreshBtn" class="btn ghost">Refresh</button>
  </div>

  <!-- ADVERTS LIST -->
  <div id="advertsSection" style="padding:22px"></div>

  <!-- SUBMISSIONS VIEW (FULL PAGE) -->
  <div id="subsSection" style="padding:22px;display:none"></div>

  <!-- IMAGE OVERLAY -->
  <div id="overlayViewer"><img id="viewerImage"/></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, query, where, onSnapshot, getDocs, doc,
  runTransaction, serverTimestamp, orderBy, getDoc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
  authDomain: "beni-wealths.firebaseapp.com",
  projectId: "beni-wealths",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;
const adverts = new Map();
const pendingCounts = {};

const advertsSection = document.getElementById("advertsSection");
const subsSection = document.getElementById("subsSection");
const searchInput = document.getElementById("searchInput");
const refreshBtn = document.getElementById("refreshBtn");
const overlayViewer = document.getElementById("overlayViewer");
const viewerImage = document.getElementById("viewerImage");
const backBtn = document.getElementById("backBtn");

function partial(str){ return str ? str.slice(0,8)+"..." : ""; }
function niceTime(ts){
  try{ return ts.toDate().toLocaleString(); }catch(e){ return "-"; }
}

// render adverts with pending badge
function renderAdverts(filter=""){
  advertsSection.innerHTML = "";
  const lower = filter.toLowerCase();
  let found = false;
  adverts.forEach(({id,data})=>{
    if(!data.title?.toLowerCase().includes(lower) && !id.toLowerCase().includes(lower)) return;
    found = true;
    const pending = pendingCounts[id] || 0;
    const badge = pending > 0 ? `<span style="margin-left:8px;font-size:0.9rem;color:#2fe0b8;">üîî ${pending}</span>` : "";
    advertsSection.innerHTML += `
      <div style="border:1px solid rgba(255,255,255,.1);padding:14px;border-radius:10px;margin-bottom:12px">
        <div><strong>${data.title}</strong>${badge}</div>
        <div class="muted">Unit Price: ‚Ç¶${data.unitPrice||0} | Status: ${(data.status||"PENDING").toUpperCase()}</div>
        <button class="btn ghost viewSubsBtn" data-id="${id}" style="margin-top:10px">View Submissions</button>
      </div>`;
  });
  if(!found) advertsSection.innerHTML = "<div class='muted'>No adverts found</div>";
}

// fetch user's adverts and pending counts
function attachAdvertListener(uid){
  // listen for adverts and filter to owner
  onSnapshot(collection(db,"advertise_tasks"),snap=>{
    adverts.clear();
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      if(d.owner === uid){
        adverts.set(docSnap.id,{id:docSnap.id,data:d});
      }
    });
    updatePendingCounts();
  }, err=>{
    console.error('advert listener error', err);
    advertsSection.innerHTML = `<div class="muted">Failed to load adverts: ${err.message || err}</div>`;
  });
}

// count pending submissions per advert
async function updatePendingCounts(){
  // reset
  Object.keys(pendingCounts).forEach(k=>delete pendingCounts[k]);
  try{
    const allSubs = await getDocs(collection(db,"advert_submissions"));
    allSubs.forEach(s => {
      const d = s.data();
      if(adverts.has(d.advertId) && d.status === "pending"){
        pendingCounts[d.advertId] = (pendingCounts[d.advertId]||0) + 1;
      }
    });
  }catch(err){
    console.error('updatePendingCounts error', err);
  }
  renderAdverts(searchInput.value);
}

// show submissions list (newest first)
async function showSubmissions(adId){
  const advertRaw = adverts.get(adId);
  let advert = advertRaw;
  subsSection.style.display = "block";
  advertsSection.style.display = "none";
  subsSection.innerHTML = `
    <button class="btn ghost" id="backToAdverts">‚Üê Back to Adverts</button>
    <div id="subsHeader"><h2>Loading advert‚Ä¶</h2></div>
    <div id="subsTableArea">Loading submissions‚Ä¶</div>
  `;
  document.getElementById("backToAdverts").onclick=()=>{
    subsSection.style.display="none";
    advertsSection.style.display="block";
  };

  // if advert not present in adverts map, fetch it directly
  if(!advert){
    try{
      const adDoc = await getDoc(doc(db,'advertise_tasks',adId));
      if(!adDoc.exists()){
        document.getElementById("subsTableArea").innerHTML = "<div class='muted'>Advert not found</div>";
        return;
      }
      advert = { id: adDoc.id, data: adDoc.data() };
      adverts.set(adId, advert); // cache it
    }catch(err){
      console.error('failed to load advert doc', err);
      document.getElementById("subsTableArea").innerHTML = `<div class='muted'>Failed to load advert: ${err.message||err}</div>`;
      return;
    }
  }

  // update header now that we have advert
  const headerHtml = `<h2>${advert.data.title} <span class="muted">(${partial(adId)})</span></h2>
    <div class="muted">Unit Price: ‚Ç¶${advert.data.unitPrice||0}</div>`;
  document.getElementById("subsHeader").innerHTML = headerHtml;

  // fetch submissions
  try{
    // NOTE: orderBy on createdAt may require a composite index if you also use where; if you
    // see an error mentioning "create index", follow the link in the console to create it.
    const q = query(
      collection(db,"advert_submissions"),
      where("advertId","==",adId),
      orderBy("createdAt","desc")
    );
    const snap = await getDocs(q);

    if(snap.empty){
      document.getElementById("subsTableArea").innerHTML = "<div class='muted'>No submissions</div>";
      return;
    }

    // build table and attach data-advert for future reference
    let table = `<table data-advert="${adId}"><thead><tr><th>Sub ID</th><th>User</th><th>Submitted</th><th>Text Proof</th><th>Image</th><th>Status</th><th>Action</th></tr></thead><tbody>`;
    snap.forEach(s=>{
      const d=s.data(), sid=s.id;
      table+=`
        <tr>
          <td>${partial(sid)}</td>
          <td>${partial(d.userId)}</td>
          <td>${niceTime(d.createdAt)}</td>
          <td>${d.textProof||"<span class='muted'>No text</span>"}</td>
          <td>${d.imageUrl?`<img src="${d.imageUrl}" class="thumb-img" data-src="${d.imageUrl}">`:"<span class='muted'>No image</span>"}</td>
          <td>${d.status||""}</td>
          <td>
            <button class="approve-btn btn ghost" ${d.status!=="pending"?"disabled":""}
              data-sid="${sid}" data-uid="${d.userId}" data-plan="${d.userPlan||''}" data-price="${advert.data.unitPrice||0}">Approve</button>
            <button class="reject-btn btn ghost" ${d.status!=="pending"?"disabled":""} data-sid="${sid}">Reject</button>
          </td>
        </tr>`;
    });
    table += "</tbody></table>";
    document.getElementById("subsTableArea").innerHTML = table;
  }catch(err){
    console.error('Failed to load submissions:', err);
    document.getElementById("subsTableArea").innerHTML = `<div class='muted'>Failed to load submissions: ${err.message || err}</div>`;
    // if error mentions index creation, guide devs via console link
  }
}

onAuthStateChanged(auth,user=>{
  if(!user) location.href="login.html";
  currentUser = user;
  attachAdvertListener(user.uid);
});

searchInput.oninput=()=> renderAdverts(searchInput.value);
refreshBtn.onclick=()=> updatePendingCounts();

// events
document.body.addEventListener("click",async e=>{

  if(e.target.matches(".viewSubsBtn")){
    showSubmissions(e.target.dataset.id);
  }

  if(e.target.matches(".thumb-img")){
    viewerImage.src = e.target.dataset.src;
    overlayViewer.style.display="flex";
  }

  if(e.target.matches(".approve-btn")){
    const sid = e.target.dataset.sid;
    const uid = e.target.dataset.uid;
    // plan unused here; using 70% payout for consistency
    // const plan = e.target.dataset.plan.toLowerCase();
    const price = Number(e.target.dataset.price||0);

    try{
      await runTransaction(db,async tx=>{
        const subRef = doc(db,"advert_submissions",sid);
        const subSnap = await tx.get(subRef);
        if(!subSnap.exists() || subSnap.data().status!=="pending") throw "Cannot approve";

        // payout: 70% of unit price
        const payout = Math.round(price * 0.7);
        console.log('Approving submission', sid, 'price=', price, 'payout=', payout);

        tx.update(subRef,{status:"approved",approvedAt:serverTimestamp(),paidAmount:payout});

        if(uid){
          const userRef = doc(db,"users",uid);
          const userSnap = await tx.get(userRef);
          const balance = Number(userSnap.data().balance||0);
          tx.update(userRef,{balance:balance+payout});
        }
      });
      alert("Approved and credited!");
      updatePendingCounts();
      // re-show submissions for the advert (table has data-advert attribute)
      const table = e.target.closest("table");
      if(table && table.dataset && table.dataset.advert){
        showSubmissions(table.dataset.advert);
      }
    }catch(err){
      console.error('approve error', err);
      alert("Error: "+(err.message||err));
    }
  }

  if(e.target.matches(".reject-btn")){
    const sid = e.target.dataset.sid;
    try{
      await runTransaction(db,async tx=>{
        const subRef = doc(db,"advert_submissions",sid);
        const subSnap = await tx.get(subRef);
        if(!subSnap.exists()) throw "Missing submission";
        // set rejected and clear paidAmount
        tx.update(subRef,{status:"rejected", paidAmount: 0, approvedAt: null});
      });
      alert("Rejected");
      updatePendingCounts();
      const table = e.target.closest("table");
      if(table && table.dataset && table.dataset.advert){
        showSubmissions(table.dataset.advert);
      }
    }catch(err){
      console.error('reject error', err);
      alert("Error: "+(err.message||err));
    }
  }
});

overlayViewer.addEventListener("click",()=>overlayViewer.style.display="none");
backBtn.onclick=()=>location.href="dashboard.html";

</script>

</body>
</html>
