<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Adverts ‚Äî Beni-Wealth</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300,400,600,700&display=swap" rel="stylesheet"/>
  <link rel="icon" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png"/>
  <meta name="theme-color" content="#2fe0b8">

  <style>
    /* EXISTING BENI-WEALTH THEME */
    :root{--bg1:#060511;--bg2:#0f0920;--muted:rgba(255,255,255,0.62);--text:#eaf2ff;--accent-start:#2fe0b8;--accent-end:#7a5fff;--card:rgba(255,255,255,0.02);--radius:12px;}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;font-family:'Poppins',sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text)}
    header{display:flex;align-items:center;gap:12px;padding:18px 22px;border-bottom:1px solid rgba(255,255,255,.05);font-weight:700;font-size:1.2rem}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:#041219;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .search{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);flex:1}
    .muted{color:var(--muted)}
    .id-copy{cursor:pointer;color:var(--muted);font-size:0.85rem}
    table{width:100%;border-collapse:collapse;margin-top:18px}
    th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,.06);font-size:14px;text-align:left}
    th{background:rgba(255,255,255,0.04);font-weight:700}
    .thumb-img{width:60px;height:60px;object-fit:cover;border-radius:6px;cursor:pointer}
    #overlayViewer{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.9);z-index:1000}
    #overlayViewer img{max-width:90%;max-height:90%;border-radius:10px}
    .disabled{opacity:.6;pointer-events:none}
  </style>

</head>
<body>

  <header>
    <a class="btn ghost" id="backBtn">‚Üê Back</a>
    My Adverts & Submissions
  </header>

  <!-- SEARCH & FILTER -->
  <div style="display:flex;gap:12px;padding:0 22px">
    <input id="searchInput" class="search" placeholder="Search adverts by title or ID"/>
    <button id="refreshBtn" class="btn ghost">Refresh</button>
  </div>

  <!-- ADVERTS LIST -->
  <div id="advertsSection" style="padding:22px"></div>

  <!-- SUBMISSIONS VIEW (FULL PAGE) -->
  <div id="subsSection" style="padding:22px;display:none"></div>

  <!-- IMAGE OVERLAY -->
  <div id="overlayViewer"><img id="viewerImage"/></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, query, where, onSnapshot, getDocs, doc,
  runTransaction, serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
  authDomain: "beni-wealths.firebaseapp.com",
  projectId: "beni-wealths",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;
const adverts = new Map();
const pendingCounts = {};

const advertsSection = document.getElementById("advertsSection");
const subsSection = document.getElementById("subsSection");
const searchInput = document.getElementById("searchInput");
const refreshBtn = document.getElementById("refreshBtn");
const overlayViewer = document.getElementById("overlayViewer");
const viewerImage = document.getElementById("viewerImage");
const backBtn = document.getElementById("backBtn");

function partial(str){ return str ? str.slice(0,8)+"..." : ""; }
function niceTime(ts){
  try{ return ts.toDate().toLocaleString(); }catch(e){ return "-"; }
}

// render adverts with pending badge
function renderAdverts(filter=""){
  advertsSection.innerHTML = "";
  const lower = filter.toLowerCase();
  let found = false;
  adverts.forEach(({id,data})=>{
    if(!data.title?.toLowerCase().includes(lower) && !id.toLowerCase().includes(lower)) return;
    found = true;
    const pending = pendingCounts[id] || 0;
    const badge = pending > 0 ? `<span style="margin-left:8px;font-size:0.9rem;color:#2fe0b8;">üîî ${pending}</span>` : "";
    advertsSection.innerHTML += `
      <div style="border:1px solid rgba(255,255,255,.1);padding:14px;border-radius:10px;margin-bottom:12px">
        <div><strong>${data.title}</strong>${badge}</div>
        <div class="muted">Unit Price: ‚Ç¶${data.unitPrice||0} | Status: ${(data.status||"PENDING").toUpperCase()}</div>
        <button class="btn ghost viewSubsBtn" data-id="${id}" style="margin-top:10px">View Submissions</button>
      </div>`;
  });
  if(!found) advertsSection.innerHTML = "<div class='muted'>No adverts found</div>";
}

// fetch user's adverts and pending counts
function attachAdvertListener(uid){
  onSnapshot(collection(db,"advertise_tasks"),snap=>{
    adverts.clear();
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      if(d.owner === uid){
        adverts.set(docSnap.id,{id:docSnap.id,data:d});
      }
    });
    updatePendingCounts();
  });
}

// count pending submissions per advert
async function updatePendingCounts(){
  Object.keys(pendingCounts).forEach(k=>delete pendingCounts[k]);
  const allSubs = await getDocs(collection(db,"advert_submissions"));
  allSubs.forEach(s => {
    const d = s.data();
    if(adverts.has(d.advertId) && d.status === "pending"){
      pendingCounts[d.advertId] = (pendingCounts[d.advertId]||0) + 1;
    }
  });
  renderAdverts(searchInput.value);
}

// show submissions list
async function showSubmissions(adId){
  const advert = adverts.get(adId);
  subsSection.style.display = "block";
  advertsSection.style.display = "none";
  subsSection.innerHTML = `
    <button class="btn ghost" id="backToAdverts">‚Üê Back to Adverts</button>
    <h2>${advert.data.title} <span class="muted">(${partial(adId)})</span></h2>
    <div class="muted">Unit Price: ‚Ç¶${advert.data.unitPrice||0}</div>
    <div id="subsTableArea">Loading submissions‚Ä¶</div>
  `;
  document.getElementById("backToAdverts").onclick=()=>{
    subsSection.style.display="none";
    advertsSection.style.display="block";
  };

  const snap = await getDocs(query(collection(db,"advert_submissions"),where("advertId","==",adId)));
  if(snap.empty){
    document.getElementById("subsTableArea").innerHTML = "<div class='muted'>No submissions</div>";
    return;
  }

  let table = `<table><thead><tr><th>Sub ID</th><th>User</th><th>Submitted</th><th>Text Proof</th><th>Image</th><th>Status</th><th>Action</th></tr></thead><tbody>`;
  snap.forEach(s=>{
    const d=s.data(), sid=s.id;
    table+=`
      <tr>
        <td>${partial(sid)}</td>
        <td>${partial(d.userId)}</td>
        <td>${niceTime(d.createdAt)}</td>
        <td>${d.textProof||"<span class='muted'>No text</span>"}</td>
        <td>${d.imageUrl?`<img src="${d.imageUrl}" class="thumb-img" data-src="${d.imageUrl}">`:"<span class='muted'>No image</span>"}</td>
        <td>${d.status||""}</td>
        <td>
          <button class="approve-btn btn ghost" ${d.status!=="pending"?"disabled":""} 
            data-sid="${sid}" data-uid="${d.userId}" data-plan="${d.userPlan||''}" data-price="${advert.data.unitPrice||0}">Approve</button>
          <button class="reject-btn btn ghost" ${d.status!=="pending"?"disabled":""} data-sid="${sid}">Reject</button>
        </td>
      </tr>`;
  });
  table += "</tbody></table>";
  document.getElementById("subsTableArea").innerHTML = table;
}

onAuthStateChanged(auth,user=>{
  if(!user) location.href="login.html";
  currentUser = user;
  attachAdvertListener(user.uid);
});

searchInput.oninput=()=> renderAdverts(searchInput.value);
refreshBtn.onclick=()=> updatePendingCounts();

// events
document.body.addEventListener("click",async e=>{

  if(e.target.matches(".viewSubsBtn")){
    showSubmissions(e.target.dataset.id);
  }

  if(e.target.matches(".thumb-img")){
    viewerImage.src = e.target.dataset.src;
    overlayViewer.style.display="flex";
  }

  if(e.target.matches(".approve-btn")){
    const sid = e.target.dataset.sid;
    const uid = e.target.dataset.uid;
    const plan = e.target.dataset.plan.toLowerCase();
    const price = Number(e.target.dataset.price||0);

    try{
      await runTransaction(db,async tx=>{
        const subRef = doc(db,"advert_submissions",sid);
        const subSnap = await tx.get(subRef);
        if(!subSnap.exists() || subSnap.data().status!=="pending") throw "Cannot approve";

        const payout = Math.round(price * (plan==="bronze"?0.6:0.8));
        tx.update(subRef,{status:"approved",approvedAt:serverTimestamp(),paidAmount:payout});

        const userRef = doc(db,"users",uid);
        const userSnap = await tx.get(userRef);
        const balance = Number(userSnap.data().balance||0);
        tx.update(userRef,{balance:balance+payout});
      });

      alert("Approved and credited!");
      updatePendingCounts();
      showSubmissions(e.target.closest("table").dataset.advert);

    }catch(err){ alert("Error: "+err); }
  }

  if(e.target.matches(".reject-btn")){
    const sid = e.target.dataset.sid;
    try{
      await runTransaction(db,async tx=>{
        tx.update(doc(db,"advert_submissions",sid),{status:"rejected"});
      });
      alert("Rejected");
      updatePendingCounts();
      showSubmissions(e.target.closest("table").dataset.advert);
    }catch(err){ alert("Error: "+err); }
  }
});

overlayViewer.addEventListener("click",()=>overlayViewer.style.display="none");
backBtn.onclick=()=>location.href="dashboard.html";

</script>

</body>
</html>
