<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth — Pool Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-1:#0b0710;
      --bg-2:#0e0620;
      --card:#0f1726;
      --muted:#9aa4b2;
      --accent-1:#7c3aed; /* purple */
      --accent-2:#4ade80; /* green */
      --accent-grad: linear-gradient(90deg,#7c3aed,#06b6d4);
      --glass: rgba(255,255,255,0.03);
      --glass-2: rgba(255,255,255,0.02);
      --danger:#ef4444;
      --success:#10b981;
      --text:#e6eef8;
    }
    html,body{height:100%;margin:0;font-family:"Poppins",system-ui,Segoe UI,Roboto,Arial;background:radial-gradient(1000px 600px at 10% 10%, rgba(124,58,237,0.12), transparent), linear-gradient(180deg,var(--bg-1), var(--bg-2)); color:var(--text); -webkit-font-smoothing:antialiased;}
    .wrap{max-width:1120px;margin:28px auto;padding:20px}
    header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:56px;height:56px;border-radius:14px;background:linear-gradient(135deg,#7c3aed,#06b6d4);display:flex;align-items:center;justify-content:center;color:#061226;font-weight:800;font-size:18px;box-shadow:0 8px 30px rgba(7,10,25,0.6)}
    .title{font-size:20px;font-weight:700}
    .subtitle{color:var(--muted);font-size:13px;margin-top:4px}
    .header-right{display:flex;align-items:center;gap:12px}

    /* Balance-like admin header block */
    .hero{margin-top:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:16px;padding:18px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 8px 30px rgba(2,6,23,0.5)}
    .hero-left{display:flex;gap:14px;align-items:center}
    .hero-avatar{width:72px;height:72px;border-radius:14px;background:linear-gradient(135deg,#7c3aed,#06b6d4);display:flex;align-items:center;justify-content:center;font-weight:800;color:#071022;font-size:20px}
    .hero-meta{line-height:1}
    .hero-meta .who{font-weight:800;font-size:18px}
    .hero-meta .uid{font-size:12px;color:var(--muted)}
    .hero-balance{background:var(--card);border-radius:12px;padding:12px 16px;text-align:right;min-width:180px}
    .balance-amt{font-weight:800;font-size:22px}
    .balance-sub{font-size:12px;color:var(--muted)}

    .grid{display:grid;grid-template-columns:1fr 380px;gap:18px;margin-top:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.015),transparent);border-radius:14px;padding:14px;box-shadow:0 8px 24px rgba(3,6,18,0.6);border:1px solid rgba(255,255,255,0.02)}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    .round-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:var(--glass-2);margin-top:10px;border:1px solid rgba(255,255,255,0.02)}
    .round-meta{display:flex;flex-direction:column}
    .round-meta .id{font-weight:700}
    .round-actions{display:flex;gap:8px;align-items:center}

    .btn{padding:10px 14px;border-radius:12px;border:0;background:transparent;color:var(--text);cursor:pointer;font-weight:700}
    .btn-primary{background:var(--accent-grad);color:#041328;border-radius:12px;padding:10px 16px}
    .btn-ghost{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.03)}
    .btn-danger{background:var(--danger);color:white;border-radius:10px;padding:8px 12px}
    .btn-small{padding:6px 10px;border-radius:8px;font-weight:700}

    .log{margin-top:12px;max-height:300px;overflow:auto;border-radius:10px;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    pre{white-space:pre-wrap;font-size:12px;color:var(--text);margin:0}

    .hidden{display:none}
    .footer-note{margin-top:12px;color:var(--muted);font-size:12px;text-align:center}

    @media (max-width:980px){ .grid{grid-template-columns:1fr} .hero{flex-direction:column;align-items:flex-start;gap:12px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">BW</div>
        <div>
          <div class="title">Beni-Wealth Admin</div>
          <div class="subtitle">Pool Game — rounds & audits</div>
        </div>
      </div>

      <div class="header-right">
        <div id="adminInfo" class="muted">Not signed in</div>
        <div id="authBtns">
          <button id="signInBtn" class="btn btn-primary">Sign in (Google)</button>
        </div>
        <div id="signOutContainer" class="hidden" style="display:flex;gap:8px;align-items:center">
          <div id="signedInEmail" class="small"></div>
          <button id="signOutBtn" class="btn btn-ghost">Sign out</button>
        </div>
      </div>
    </header>

    <div class="hero">
      <div class="hero-left">
        <div class="hero-avatar" id="heroAvatar">BW</div>
        <div class="hero-meta">
          <div class="who" id="adminName">Hi, Admin</div>
          <div class="uid small" id="adminUid">uid: —</div>
        </div>
      </div>
      <div class="hero-balance">
        <div class="small">Active Round</div>
        <div id="activeRoundHeader" style="display:flex;justify-content:space-between;align-items:center">
          <div class="small muted">No active round</div>
          <div style="text-align:right">
            <div class="balance-amt" id="activeRoundId">—</div>
            <div class="balance-sub small" id="activeRoundSub">—</div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">Create Round</div>
              <div class="small">Open a round for players to join</div>
            </div>
            <div>
              <button id="createRoundBtn" class="btn-primary">Create Round</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">All Rounds</div>
            <div class="small">Latest first</div>
          </div>

          <div id="roundList" style="margin-top:12px">
            <div class="small muted">Loading...</div>
          </div>
        </div>
      </div>

      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Round details</div>
            <div class="small">select a round</div>
          </div>

          <div id="roundDetails" style="margin-top:12px" class="muted">No round selected</div>

          <div id="roundActions" class="hidden" style="margin-top:12px;display:flex;gap:8px">
            <button id="endRoundBtn" class="btn-danger btn-small">End Round</button>
            <button id="resetRoundBtn" class="btn-ghost btn-small">Reset Round</button>
            <button id="exportCsvBtn" class="btn btn-small">Export CSV</button>
          </div>

          <div style="margin-top:12px">
            <div style="font-weight:700">Shot log (recent)</div>
            <div id="shotLog" class="log"><div class="small">Select a round to view</div></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="font-weight:700">Notes</div>
          <div class="small" style="margin-top:8px">
            This admin panel writes to <code>games/pool/rounds/{'{roundId}'}</code>. Only allowed Google accounts can access this page.
          </div>
        </div>
      </div>
    </div>

    <div class="footer-note">Beni-Wealth • Pool Admin — Dark Theme</div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, updateDoc, getDocs, query, where, orderBy, serverTimestamp, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

    // -----------------------
    // Firebase config (already provided)
    // -----------------------
    const firebaseConfig = {
      apiKey: 'AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk',
      authDomain: 'beni-wealths.firebaseapp.com',
      projectId: 'beni-wealths',
      storageBucket: 'beni-wealths.firebasestorage.app',
      messagingSenderId: '807950483822',
      appId: '1:807950483822:web:e10fa87307e041c4d8417f',
      measurementId: 'G-Z2XP3YN6NS'
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // allowed admins
    const allowedAdmins = ['beniwealth70@gmail.com','owanaomubo76@gmail.com'];

    // UI refs
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const adminInfo = document.getElementById('adminInfo');
    const signOutContainer = document.getElementById('signOutContainer');
    const signedInEmail = document.getElementById('signedInEmail');
    const createRoundBtn = document.getElementById('createRoundBtn');
    const activeRoundHeader = document.getElementById('activeRoundHeader');
    const activeRoundIdEl = document.getElementById('activeRoundId');
    const activeRoundSub = document.getElementById('activeRoundSub');
    const roundList = document.getElementById('roundList');
    const roundDetails = document.getElementById('roundDetails');
    const shotLog = document.getElementById('shotLog');
    const roundActions = document.getElementById('roundActions');
    const endRoundBtn = document.getElementById('endRoundBtn');
    const resetRoundBtn = document.getElementById('resetRoundBtn');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const heroAvatar = document.getElementById('heroAvatar');
    const adminName = document.getElementById('adminName');
    const adminUid = document.getElementById('adminUid');

    let selectedRoundId = null;

    // rounds collection helper
    const roundsCollectionRef = () => collection(db, 'games', 'pool', 'rounds');

    signInBtn.addEventListener('click', async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        alert('Sign in failed: ' + (e.message || e));
      }
    });

    signOutBtn.addEventListener('click', async () => {
      await signOut(auth);
      location.reload();
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        adminInfo.textContent = 'Not signed in';
        signOutContainer.classList.add('hidden');
        document.getElementById('authBtns').classList.remove('hidden');
        return;
      }
      // verify allowed
      if (!allowedAdmins.includes(user.email)) {
        alert('Access denied — authorized admins only.');
        await signOut(auth);
        adminInfo.textContent = 'Access denied';
        return;
      }
      // show admin UI
      document.getElementById('authBtns').classList.add('hidden');
      signOutContainer.classList.remove('hidden');
      signedInEmail.textContent = user.email;
      adminName.textContent = 'Hi, ' + (user.displayName || user.email.split('@')[0]);
      adminUid.textContent = 'UID: ' + (user.uid || '—');
      heroAvatar.textContent = (user.displayName ? user.displayName[0].toUpperCase() : 'BW');
      adminInfo.textContent = 'Signed in as admin';
      await loadRounds();
    });

    // create new round
    createRoundBtn.addEventListener('click', async () => {
      const id = 'round_' + Date.now();
      // close any open rounds
      const qOpen = query(roundsCollectionRef(), where('status','==','open'));
      const sOpen = await getDocs(qOpen);
      const updates = [];
      sOpen.forEach(d => updates.push(updateDoc(doc(db,'games','pool','rounds',d.id), { status:'closed' })));
      await Promise.all(updates);

      // create new
      const newDoc = doc(db,'games','pool','rounds',id);
      await setDoc(newDoc, {
        createdByAdmin: (auth.currentUser && auth.currentUser.email) || 'admin',
        entryFee: 20,
        status: 'open',
        createdAt: serverTimestamp(),
        tableState: { remainingBalls: 7 },
        shotLog: [],
        result: null
      });
      await loadRounds();
      alert('Round created: ' + id);
    });

    // load rounds list & active round
    async function loadRounds(){
      roundList.innerHTML = '<div class="small muted">Loading...</div>';
      shotLog.innerHTML = '<div class="small muted">Select a round to view shot log</div>';
      roundDetails.innerHTML = 'No round selected';
      roundActions.classList.add('hidden');
      selectedRoundId = null;

      const q = query(roundsCollectionRef(), orderBy('createdAt','desc'));
      const snap = await getDocs(q);
      roundList.innerHTML = '';
      let hasActive = false;

      if (snap.empty) {
        roundList.innerHTML = '<div class="small muted">No rounds yet</div>';
        activeRoundIdEl.textContent = '—';
        activeRoundSub.textContent = 'No active round';
        return;
      }

      snap.forEach(docSnap => {
        const r = docSnap.data();
        const rid = docSnap.id;
        const createdAt = r.createdAt && r.createdAt.toDate ? r.createdAt.toDate().toLocaleString() : '—';

        const el = document.createElement('div');
        el.className = 'round-item';
        el.innerHTML = `<div class="round-meta">
                          <div class="id">${rid}</div>
                          <div class="small">Created: ${createdAt}</div>
                          <div class="small">Status: ${r.status || '—'} • Entry ₦${r.entryFee ?? 0}</div>
                        </div>`;

        const actions = document.createElement('div');
        actions.className = 'round-actions';
        const viewBtn = document.createElement('button'); viewBtn.className='btn btn-small'; viewBtn.textContent='View';
        viewBtn.onclick = () => selectRound(rid);
        const makeActive = document.createElement('button'); makeActive.className='btn btn-ghost btn-small';
        makeActive.textContent = (r.status==='open'?'Active':'Make Active');
        makeActive.disabled = (r.status==='open');
        makeActive.onclick = async () => {
          // close existing open
          const q2 = query(roundsCollectionRef(), where('status','==','open'));
          const s2 = await getDocs(q2);
          const updates = [];
          s2.forEach(d => updates.push(updateDoc(doc(db,'games','pool','rounds',d.id), { status:'closed' })));
          await Promise.all(updates);
          await updateDoc(doc(db,'games','pool','rounds',rid), { status:'open', updatedAt: serverTimestamp() });
          await loadRounds();
        };

        actions.appendChild(viewBtn);
        actions.appendChild(makeActive);
        el.appendChild(actions);
        roundList.appendChild(el);

        if (r.status === 'open' && !hasActive) {
          hasActive = true;
          activeRoundIdEl.textContent = rid;
          activeRoundSub.textContent = 'Entry fee ₦' + (r.entryFee ?? 0);
        }
      });

      if (!hasActive) {
        activeRoundIdEl.textContent = '—';
        activeRoundSub.textContent = 'No active round';
      }
    }

    // select and show round details
    async function selectRound(rid){
      selectedRoundId = rid;
      const dref = doc(db,'games','pool','rounds',rid);
      const snap = await getDoc(dref);
      if (!snap.exists()) { roundDetails.textContent = 'Round not found'; return; }
      const r = snap.data();
      const createdAt = r.createdAt && r.createdAt.toDate ? r.createdAt.toDate().toLocaleString() : '—';
      roundDetails.innerHTML = `<div style="font-weight:800">${rid}</div>
        <div class="small">Status: ${r.status || '—'}</div>
        <div class="small">Created: ${createdAt}</div>
        <div class="small">Entry fee: ₦${r.entryFee ?? 0}</div>
        <div style="margin-top:8px">Player: ${r.playerUid ?? '—'}</div>
        <div style="margin-top:8px">Result: ${r.result ? JSON.stringify(r.result) : '—'}</div>`;
      roundActions.classList.remove('hidden');

      // load shot log
      const shots = r.shotLog || [];
      if (shots.length === 0) {
        shotLog.innerHTML = '<div class="small muted">No shots logged</div>';
      } else {
        shotLog.innerHTML = '';
        const list = shots.slice(-200).reverse();
        list.forEach(s => {
          const p = document.createElement('pre');
          const ts = s.ts && s.ts.toDate ? s.ts.toDate().toLocaleString() : (s.ts || '');
          p.textContent = `[${s.by}] ${ts}\nshot: ${JSON.stringify(s.shot)}\nresult: ${JSON.stringify(s.result)}\n---`;
          shotLog.appendChild(p);
        });
      }
    }

    endRoundBtn.addEventListener('click', async () => {
      if (!selectedRoundId) return alert('Select a round first'); 
      if (!confirm('End round ' + selectedRoundId + '?')) return;
      await updateDoc(doc(db,'games','pool','rounds',selectedRoundId), { status:'closed', closedAt: serverTimestamp() });
      await loadRounds();
      selectRound(selectedRoundId);
      alert('Round ended');
    });

    resetRoundBtn.addEventListener('click', async () => {
      if (!selectedRoundId) return alert('Select a round first');
      if (!confirm('Reset round (clear shots & restore table)?')) return;
      await updateDoc(doc(db,'games','pool','rounds',selectedRoundId), {
        shotLog: [],
        tableState: { remainingBalls: 7 },
        result: null,
        updatedAt: serverTimestamp()
      });
      await loadRounds();
      selectRound(selectedRoundId);
      alert('Round reset');
    });

    exportCsvBtn.addEventListener('click', async () => {
      if (!selectedRoundId) return alert('Select a round first');
      const snap = await getDoc(doc(db,'games','pool','rounds',selectedRoundId));
      const r = snap.data(); const shots = r.shotLog || [];
      if (shots.length === 0) return alert('No shots to export');
      const rows = [['by','ts','shot','result']];
      shots.forEach(s => {
        const ts = s.ts && s.ts.toDate ? s.ts.toDate().toISOString() : (s.ts || '');
        rows.push([s.by, ts, JSON.stringify(s.shot).replace(/\n/g,' '), JSON.stringify(s.result).replace(/\n/g,' ')]);
      });
      const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `round_${selectedRoundId}_shots.csv`; a.click(); URL.revokeObjectURL(url);
    });

    // initial no-op: rounds will load after auth triggers
  </script>
</body>
</html>
