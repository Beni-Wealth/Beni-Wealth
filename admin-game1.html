<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth — Pool Game Admin</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --accent:#ff6b6b;
      --muted:#6b7280;
      --success:#10b981;
      --danger:#ef4444;
      --glass: rgba(2,6,23,0.03);
    }
    html,body{height:100%;margin:0;font-family:"Poppins",system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#0f1724}
    .wrap{max-width:1100px;margin:28px auto;padding:18px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(90deg,var(--accent),#ff8b8b);display:flex;align-items:center;justify-content:center;color:#081022;font-weight:800}
    h1{margin:0;font-size:20px}
    .sub{color:var(--muted);font-size:13px}

    .controls{display:flex;gap:12px;align-items:center}
    .btn{padding:10px 14px;border-radius:10px;border:0;background:var(--card);box-shadow:0 6px 18px rgba(10,20,40,0.04);cursor:pointer;font-weight:700}
    .btn-primary{background:linear-gradient(90deg,var(--accent),#ff8b8b);color:#081022}
    .btn-ghost{background:transparent;border:1px solid rgba(15,23,36,0.06)}
    .btn-danger{background:var(--danger);color:#fff}

    .grid{display:grid;grid-template-columns:1fr 380px;gap:18px}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 8px 30px rgba(2,6,23,0.04)}
    .muted{color:var(--muted);font-size:13px}
    .round-item{padding:12px;border-radius:10px;border:1px solid rgba(15,23,36,0.04);display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:10px}
    .round-meta{font-size:13px;color:#0f1724}
    .small{font-size:12px;color:var(--muted)}
    .log{max-height:260px;overflow:auto;margin-top:8px;border-radius:8px;padding:8px;background:var(--glass);}
    pre{white-space:pre-wrap;font-size:12px;color:#0f1724}
    .signin{display:flex;gap:8px;align-items:center}
    .hidden{display:none}

    @media (max-width:980px){
      .grid{grid-template-columns:1fr; }
      .controls{flex-wrap:wrap}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">BW</div>
        <div>
          <h1>Beni-Wealth — Pool Game Admin</h1>
          <div class="sub">Create rounds, end/reset rounds and inspect shot logs</div>
        </div>
      </div>

      <div class="controls">
        <div id="adminInfo" class="muted">Not signed in</div>
        <div id="authBtns" class="signin">
          <button id="signInBtn" class="btn">Sign in (Google)</button>
        </div>
        <div id="signOutContainer" class="signin hidden">
          <div id="signedInEmail" class="small"></div>
          <button id="signOutBtn" class="btn btn-ghost">Sign out</button>
        </div>
      </div>
    </header>

    <div class="grid">
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:700">Create New Round</div>
              <div class="small">Creates an admin-open round at games/pool/rounds</div>
            </div>
            <div>
              <button id="createRoundBtn" class="btn btn-primary">Create Round</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">Active Round</div>
            <div class="small">Only one active round allowed</div>
          </div>
          <div id="activeRoundBox" style="margin-top:12px" class="muted">Loading...</div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">All Rounds</div>
            <div class="small">Latest first</div>
          </div>
          <div id="roundList" class="log"><div class="small">Loading...</div></div>
        </div>
      </div>

      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">Round details</div>
            <div class="small">Select a round to view</div>
          </div>

          <div id="roundDetails" style="margin-top:12px" class="muted">No round selected</div>
          <div style="margin-top:12px" id="roundActions" class="hidden">
            <button id="endRoundBtn" class="btn btn-danger">End Round</button>
            <button id="resetRoundBtn" class="btn btn-ghost">Reset Scores</button>
            <button id="exportCsvBtn" class="btn">Export CSV</button>
          </div>

          <div style="margin-top:12px">
            <div style="font-weight:700">Shot log (recent)</div>
            <div id="shotLog" class="log"><div class="small">Select a round to load shot log</div></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="font-weight:700">Notes</div>
          <div class="small" style="margin-top:8px">
            - This admin page writes to <code>games/pool/rounds/{roundId}</code> and expects Cloud Functions to use the same path.<br>
            - Only the two allowed Google accounts can access this page (configured below).
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase modular SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, updateDoc, getDocs, query, where, orderBy, serverTimestamp, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

    // -----------------------
    // Your Firebase config (inserted)
    // -----------------------
    const firebaseConfig = {
      apiKey: 'AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk',
      authDomain: 'beni-wealths.firebaseapp.com',
      projectId: 'beni-wealths',
      storageBucket: 'beni-wealths.firebasestorage.app',
      messagingSenderId: '807950483822',
      appId: '1:807950483822:web:e10fa87307e041c4d8417f',
      measurementId: 'G-Z2XP3YN6NS'
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // allowed admins
    const allowedAdmins = ['beniwealth70@gmail.com', 'owanaomubo76@gmail.com'];

    // UI refs
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const adminInfo = document.getElementById('adminInfo');
    const signOutContainer = document.getElementById('signOutContainer');
    const signedInEmail = document.getElementById('signedInEmail');
    const createRoundBtn = document.getElementById('createRoundBtn');
    const activeRoundBox = document.getElementById('activeRoundBox');
    const roundList = document.getElementById('roundList');
    const roundDetails = document.getElementById('roundDetails');
    const shotLog = document.getElementById('shotLog');
    const roundActions = document.getElementById('roundActions');
    const endRoundBtn = document.getElementById('endRoundBtn');
    const resetRoundBtn = document.getElementById('resetRoundBtn');
    const exportCsvBtn = document.getElementById('exportCsvBtn');

    let selectedRoundId = null;

    // auth handlers
    signInBtn.addEventListener('click', async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        alert('Sign in failed: ' + (e.message || e));
      }
    });

    signOutBtn.addEventListener('click', async () => {
      await signOut(auth);
      location.reload();
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        adminInfo.textContent = 'Not signed in';
        signOutContainer.classList.add('hidden');
        return;
      }
      // verify email allowed
      if (!allowedAdmins.includes(user.email)) {
        alert('Access denied. This admin page is for authorized admins only.');
        // sign out immediately
        await signOut(auth);
        adminInfo.textContent = 'Access denied';
        return;
      }
      adminInfo.textContent = 'Signed in as admin';
      signedInEmail.textContent = user.email;
      signOutContainer.classList.remove('hidden');
      document.getElementById('authBtns').classList.add('hidden');

      // load rounds
      await loadRounds();
    });

    // Utility: rounds collection path used by game code
    const roundsCollectionRef = ( ) => collection(db, 'games', 'pool', 'rounds');

    // create a new round doc (only admin)
    createRoundBtn.addEventListener('click', async () => {
      const id = 'round_' + Date.now();
      // deactivate previous active rounds
      const q = query(roundsCollectionRef(), where('status','==','open'));
      const qsnap = await getDocs(q);
      const batchUpdates = [];
      qsnap.forEach(d => {
        // update status to closed
        batchUpdates.push(updateDoc(doc(db, 'games','pool','rounds', d.id), { status: 'closed' }));
      });
      // set new round
      const newDocRef = doc(db, 'games','pool','rounds', id);
      await setDoc(newDocRef, {
        createdByAdmin: (auth.currentUser && auth.currentUser.email) || 'admin',
        entryFee: 20,
        status: 'open',
        createdAt: serverTimestamp(),
        tableState: { remainingBalls: 7 },
        shotLog: [],
        result: null
      });
      // run any pending updates
      await Promise.all(batchUpdates);
      await loadRounds();
      alert('New round created: ' + id);
    });

    // load rounds and active round
    async function loadRounds(){
      activeRoundBox.innerHTML = 'Loading...';
      roundList.innerHTML = '<div class="small">Loading...</div>';
      // fetch all rounds ordered desc
      const q = query(roundsCollectionRef(), orderBy('createdAt','desc'));
      const snap = await getDocs(q);
      roundList.innerHTML = '';
      activeRoundBox.innerHTML = 'No active round';

      if (snap.empty) {
        roundList.innerHTML = '<div class="small">No rounds yet</div>';
        return;
      }

      snap.forEach(docSnap => {
        const r = docSnap.data();
        const rid = docSnap.id;

        // render item
        const item = document.createElement('div');
        item.className = 'round-item';
        const meta = document.createElement('div');
        meta.className = 'round-meta';
        const createdAt = r.createdAt ? (r.createdAt.toDate ? r.createdAt.toDate().toLocaleString() : r.createdAt) : '—';
        meta.innerHTML = `<div style="font-weight:700">${rid}</div>
                          <div class="small">Created: ${createdAt}</div>
                          <div class="small">Status: ${r.status || '—'} • Entry ₦${r.entryFee ?? 0}</div>`;

        const actions = document.createElement('div');
        actions.style.display = 'flex';
        actions.style.flexDirection = 'column';
        actions.style.gap = '6px';

        const viewBtn = document.createElement('button');
        viewBtn.className = 'btn';
        viewBtn.textContent = 'View';
        viewBtn.onclick = () => selectRound(rid);

        const activeBtn = document.createElement('button');
        activeBtn.className = 'btn btn-ghost';
        activeBtn.textContent = (r.status === 'open') ? 'Active' : 'Make Active';
        activeBtn.disabled = (r.status === 'open');
        activeBtn.onclick = async () => {
          // close existing open rounds, then open this one
          const q2 = query(roundsCollectionRef(), where('status','==','open'));
          const s2 = await getDocs(q2);
          const updates = [];
          s2.forEach(d => updates.push(updateDoc(doc(db,'games','pool','rounds',d.id), { status: 'closed' })));
          await Promise.all(updates);
          await updateDoc(doc(db,'games','pool','rounds',rid), { status: 'open', updatedAt: serverTimestamp() });
          await loadRounds();
        };

        actions.appendChild(viewBtn);
        actions.appendChild(activeBtn);

        item.appendChild(meta);
        item.appendChild(actions);
        roundList.appendChild(item);

        // if this is active, show in activeRoundBox
        if (r.status === 'open') {
          activeRoundBox.innerHTML = `
            <div style="padding:12px;border-radius:8px;border:1px solid rgba(15,23,36,0.04)">
              <div style="font-weight:700">${rid}</div>
              <div class="small">Created: ${createdAt}</div>
              <div class="small">Entry fee: ₦${r.entryFee ?? 0}</div>
              <div style="margin-top:8px"><button class="btn btn-danger" onclick="endRoundClient('${rid}')">End Active Round</button></div>
            </div>
          `;
        }
      });
    }

    // select a round to show details and shot log
    async function selectRound(rid){
      selectedRoundId = rid;
      const dref = doc(db,'games','pool','rounds', rid);
      const snap = await getDoc(dref);
      if (!snap.exists()){
        roundDetails.textContent = 'Round not found';
        return;
      }
      const r = snap.data();
      const createdAt = r.createdAt ? (r.createdAt.toDate ? r.createdAt.toDate().toLocaleString() : r.createdAt) : '—';
      roundDetails.innerHTML = `
        <div style="font-weight:800">${rid}</div>
        <div class="small">Status: ${r.status || '—'}</div>
        <div class="small">Created: ${createdAt}</div>
        <div class="small">Entry fee: ₦${r.entryFee ?? 0}</div>
        <div style="margin-top:8px">Player: ${r.playerUid ?? '—'}</div>
        <div style="margin-top:8px">Result: ${r.result ? JSON.stringify(r.result) : '—'}</div>
      `;
      roundActions.classList.remove('hidden');

      // load shot log
      const shots = r.shotLog || [];
      if (shots.length === 0) {
        shotLog.innerHTML = '<div class="small">No shots logged yet</div>';
      } else {
        shotLog.innerHTML = '';
        // show last 100
        const list = shots.slice(-100).reverse();
        list.forEach(s => {
          const p = document.createElement('pre');
          // show who, shot, result ts (approx)
          const ts = s.ts && s.ts.toDate ? s.ts.toDate().toLocaleString() : s.ts || '';
          p.textContent = `[${s.by}] ${ts}\nshot: ${JSON.stringify(s.shot)}\nresult: ${JSON.stringify(s.result)}\n---`;
          shotLog.appendChild(p);
        });
      }
    }

    // end round selectedRoundId
    endRoundBtn.addEventListener('click', async () => {
      if (!selectedRoundId) return alert('Select a round first');
      await updateDoc(doc(db,'games','pool','rounds',selectedRoundId), { status: 'closed', closedAt: serverTimestamp() });
      await loadRounds();
      selectRound(selectedRoundId);
      alert('Round ended');
    });

    // reset round scores (set totals back to 0 and clear shotLog / result) — admin action
    resetRoundBtn.addEventListener('click', async () => {
      if (!selectedRoundId) return alert('Select a round first');
      await updateDoc(doc(db,'games','pool','rounds',selectedRoundId), {
        shotLog: [],
        tableState: { remainingBalls: 7 },
        result: null,
        updatedAt: serverTimestamp()
      });
      await loadRounds();
      selectRound(selectedRoundId);
      alert('Round reset');
    });

    // export CSV of shot log
    exportCsvBtn.addEventListener('click', () => {
      if (!selectedRoundId) return alert('Select a round first');
      (async () => {
        const snap = await getDoc(doc(db,'games','pool','rounds',selectedRoundId));
        const r = snap.data();
        const shots = r.shotLog || [];
        if (shots.length === 0) return alert('No shots to export');
        const rows = [['by','ts','shot','result']];
        shots.forEach(s => {
          const ts = s.ts && s.ts.toDate ? s.ts.toDate().toISOString() : (s.ts || '');
          rows.push([s.by, ts, JSON.stringify(s.shot).replace(/\\n/g,' '), JSON.stringify(s.result).replace(/\\n/g,' ')]);
        });
        const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\\n');
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `round_${selectedRoundId}_shots.csv`; a.click(); URL.revokeObjectURL(url);
      })();
    });

    // helper to end active round from active box (global)
    window.endRoundClient = async function(rid) {
      if (!confirm('End round ' + rid + '?')) return;
      await updateDoc(doc(db,'games','pool','rounds',rid), { status: 'closed', closedAt: serverTimestamp() });
      await loadRounds();
      alert('Round ended');
    }

    // initial load (check auth state listener will call loadRounds after signin)
    // but try to show rounds if already signed in
    (async () => {
      // no-op; rounds load after auth
    })();
  </script>
</body>
</html>
