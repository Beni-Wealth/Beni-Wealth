<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth ‚Äî Profile</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300,400,600,700&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#2fe0b8">
  <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">

  <style>
    :root{
      --bg-1:#0b0613; --bg-2:#0f0820; --muted:rgba(255,255,255,0.62);
      --accent-a:#8446ff; --accent-b:#6ce2c8; --glass:rgba(255,255,255,0.03);
      --text:#e9f0ff; --container-w:900px; --radius:18px; --bottom-nav-h:74px;
      font-family:'Poppins',system-ui,-apple-system,'Segoe UI',Roboto,Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:var(--text);display:flex;justify-content:center;padding:28px;-webkit-font-smoothing:antialiased}

    .phone{width:100%;max-width:var(--container-w);border-radius:24px;padding:22px 22px calc(var(--bottom-nav-h) + 64px);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));box-shadow:0 28px 90px rgba(0,0,0,0.65);overflow:auto}

    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:64px;height:64px;border-radius:12px;object-fit:cover}
    .brand .title{font-weight:800;font-size:18px}
    .brand .sub{font-size:12px;color:var(--muted)}

    h1{font-size:20px;margin:6px 0 8px}
    .lead{color:var(--muted);font-size:14px;margin-bottom:14px}

    .grid{display:grid;grid-template-columns:1fr 320px;gap:18px}
    @media(max-width:920px){.grid{grid-template-columns:1fr} }

    .card{border-radius:16px;padding:16px;background:linear-gradient(180deg,rgba(255,255,255,0.014),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);box-shadow:0 18px 60px rgba(0,0,0,0.45)}
    .row{display:flex;gap:12px;align-items:center}
    .label{width:140px;color:var(--muted);font-size:14px}
    input[type="text"], input[type="email"], input[type="password"]{flex:1;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:var(--text)}
    input[readonly]{background:transparent;border:0;color:var(--muted);font-weight:700}

    .avatar{width:84px;height:84px;border-radius:16px;display:grid;place-items:center;font-weight:900;font-size:28px;background:linear-gradient(135deg,var(--accent-b),var(--accent-a));color:#041219}

    .btn{padding:10px 14px;border-radius:12px;border:none;cursor:pointer;background:linear-gradient(90deg,var(--accent-b),var(--accent-a));color:#041219;font-weight:800}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .muted{color:var(--muted);font-size:13px}

    .meta-list{display:flex;flex-direction:column;gap:8px}
    .meta-row{display:flex;justify-content:space-between;padding:8px;border-radius:10px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}

    .bottom-nav{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;height:var(--bottom-nav-h);width:calc(min(var(--container-w),100%) - 24px);max-width:var(--container-w);background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));border-radius:38px;padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;box-shadow:0 18px 60px rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.04);z-index:999;backdrop-filter: blur(6px)}
    .nav-btn{ width:56px; text-align:center; color:var(--muted); font-size:11px; display:flex; flex-direction:column; align-items:center; gap:6px; cursor:pointer }
    .icon-wrap{ width:44px; height:44px; border-radius:10px; display:grid; place-items:center; background: rgba(255,255,255,0.02); font-size:18px }
    .nav-center .center-btn{ width:82px;height:82px;border-radius:50%;background:linear-gradient(135deg,var(--accent-b),var(--accent-a));display:grid;place-items:center;color:#041219;font-size:26px;transform:translateY(-22px) }

    footer{margin-top:18px;text-align:center;color:rgba(255,255,255,0.35)}
    @media(max-width:520px){body{padding:16px} .avatar{width:72px;height:72px;font-size:22px}}
  </style>
</head>
<body>
  <div class="phone" role="main">
    <header>
      <div class="brand">
        <img src="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png" alt="Beni-Wealth logo">
        <div>
          <div class="title">Beni-Wealth</div>
          <div class="sub">Profile & Settings</div>
        </div>
      </div>
      <div style="text-align:right;color:var(--muted);font-size:13px">Need help? <a href="mailto:beniwealth70@gmail.com" style="color:var(--accent-b);text-decoration:underline">beniwealth70@gmail.com</a></div>
    </header>

    <h1>Profile</h1>
    <p class="lead">View your account details and security settings. (Username is read-only)</p>

    <div class="grid">
      <section class="card">
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
          <div class="avatar" id="avatar">U</div>
          <div>
            <div id="displayName" style="font-weight:800;font-size:18px">‚Äî</div>
            <div class="muted" id="emailLine">‚Äî</div>
            <div class="muted" id="joinedLine">Joined: ‚Äî</div>
          </div>
        </div>

        <!-- Username (read-only) -->
        <div style="margin-top:8px">
          <div class="row" style="margin-bottom:8px">
            <div class="label">Username</div>
            <input id="usernameInput" type="text" readonly aria-readonly="true" />
          </div>
          <div class="muted">Your username is set by the system and cannot be edited here. Contact support to request a change.</div>
        </div>

        <hr style="border:0;height:1px;background:rgba(255,255,255,0.02);margin:14px 0">

        <!-- Password section -->
        <div>
          <div style="font-weight:700;margin-bottom:8px">Password</div>
          <div class="muted">To change password you must provide your current password (reauthentication)</div>

          <div style="margin-top:12px">
            <div class="row" style="margin-bottom:8px">
              <div class="label">Current password</div>
              <input id="currentPass" type="password" autocomplete="current-password" placeholder="Current password">
            </div>
            <div class="row" style="margin-bottom:8px">
              <div class="label">New password</div>
              <input id="newPass" type="password" autocomplete="new-password" placeholder="New password (min 6)">
            </div>
            <div style="display:flex;gap:10px;margin-top:8px">
              <button id="changePassBtn" class="btn">Change password</button>
              <button id="signOutBtn" class="btn ghost">Sign out</button>
            </div>
          </div>
        </div>
      </section>

      <aside class="card">
        <div style="font-weight:700;margin-bottom:8px">Account details</div>
        <div class="meta-list">
          <div class="meta-row"><div class="muted">Plan</div><div id="metaPlan">‚Äî</div></div>
          <div class="meta-row"><div class="muted">Balance</div><div id="metaBalance">‚Ç¶0.00</div></div>
          <div class="meta-row"><div class="muted">Plan expiry</div><div id="metaExpiry">‚Äî</div></div>
          <div class="meta-row"><div class="muted">User ID</div><div id="metaUid">‚Äî</div></div>
        </div>

        <div style="margin-top:12px;color:var(--muted);font-size:13px">If you need your username changed, contact support at <a href="mailto:beniwealth70@gmail.com" style="color:var(--accent-b);text-decoration:underline">beniwealth70@gmail.com</a></div>
      </aside>
    </div>

    <footer>¬© <span id="year"></span> Beni-Wealth</footer>
  </div>

  <nav class="bottom-nav" role="navigation" aria-label="Main navigation">
    <div class="nav-btn" id="navHome"><div class="icon-wrap">üè†</div><span>Home</span></div>
    <div class="nav-btn" id="navConvert"><div class="icon-wrap">üîÅ</div><span>Convert</span></div>
    <div class="nav-center"><div class="center-btn" id="navCenter">‚öñÔ∏è</div></div>
    <div class="nav-btn" id="navNews"><div class="icon-wrap">üí¨</div><span>News</span></div>
    <div class="nav-btn" id="navAssets"><div class="icon-wrap">üë§</div><span>Assets</span></div>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, updatePassword, reauthenticateWithCredential, EmailAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const avatar = document.getElementById('avatar');
    const displayNameEl = document.getElementById('displayName');
    const emailLine = document.getElementById('emailLine');
    const joinedLine = document.getElementById('joinedLine');
    const usernameInput = document.getElementById('usernameInput');
    const currentPass = document.getElementById('currentPass');
    const newPass = document.getElementById('newPass');
    const changePassBtn = document.getElementById('changePassBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const metaPlan = document.getElementById('metaPlan');
    const metaBalance = document.getElementById('metaBalance');
    const metaExpiry = document.getElementById('metaExpiry');
    const metaUid = document.getElementById('metaUid');

    let currentUser = null;
    let currentUid = null;

    function toast(msg){
      const t = document.createElement('div'); t.className='toast'; t.textContent = msg; document.body.appendChild(t);
      setTimeout(()=>{ t.style.transition='opacity .24s'; t.style.opacity='0'; setTimeout(()=>t.remove(),260); },3000);
    }

    function formatN(n){ const num = Number(n || 0); return '‚Ç¶' + num.toLocaleString('en-NG', {minimumFractionDigits:2, maximumFractionDigits:2}); }

    function formatCreatedAt(value){
      if (!value) return '‚Äî';
      try {
        if (value && typeof value.toDate === 'function') { const d = value.toDate(); return isNaN(d.getTime()) ? '‚Äî' : d.toLocaleString(); }
        if (typeof value === 'object' && typeof value.seconds === 'number') { const ms = value.seconds * 1000 + (value.nanoseconds || 0) / 1e6; const d = new Date(ms); return isNaN(d.getTime()) ? '‚Äî' : d.toLocaleString(); }
        if (typeof value === 'string') { const d = new Date(value); return isNaN(d.getTime()) ? '‚Äî' : d.toLocaleString(); }
        return 'Pending‚Ä¶';
      } catch (e) { return '‚Äî'; }
    }

    // Change password handler (reauth + update)
    changePassBtn.addEventListener('click', async () => {
      const cur = currentPass.value || '';
      const nxt = newPass.value || '';
      if(!currentUid) return toast('Not signed in');
      if(!cur || !nxt) return toast('Both current and new passwords are required');
      if(nxt.length < 6) return toast('New password should be at least 6 characters');

      changePassBtn.disabled = true; changePassBtn.textContent = 'Processing...';
      try{
        const cred = EmailAuthProvider.credential(auth.currentUser.email, cur);
        await reauthenticateWithCredential(auth.currentUser, cred);
        await updatePassword(auth.currentUser, nxt);
        const userRef = doc(db, 'users', currentUid);
        await updateDoc(userRef, { lastPasswordChangeAt: serverTimestamp() }).catch(()=>{});
        toast('Password updated successfully'); currentPass.value = ''; newPass.value = '';
      }catch(err){
        console.error('Password change failed', err);
        if(err && err.code === 'auth/wrong-password') toast('Current password is incorrect');
        else if(err && err.code === 'auth/requires-recent-login'){
          if(confirm('You need to re-login to change your password. Sign out now?')){ await signOut(auth); window.location.href='login.html'; }
        } else {
          toast(err && err.message ? err.message : 'Failed to change password');
        }
      } finally { changePassBtn.disabled = false; changePassBtn.textContent = 'Change password'; }
    });

    signOutBtn.addEventListener('click', async () => {
      if(confirm('Sign out of this account?')){ await signOut(auth); window.location.href = 'index.html'; }
    });

    // nav wiring
    document.getElementById('navHome').addEventListener('click', ()=> window.location.href='catalog.html');
    document.getElementById('navConvert').addEventListener('click', ()=> window.location.href='convert.html');
    document.getElementById('navCenter').addEventListener('click', ()=> window.location.href='center.html');
    document.getElementById('navNews').addEventListener('click', ()=> window.location.href='news.html');
    document.getElementById('navAssets').addEventListener('click', ()=> window.location.href='dashboard.html');

    // listen for auth state and populate UI; username is displayed but not editable
    onAuthStateChanged(auth, async (user) => {
      currentUser = user; currentUid = user ? user.uid : null;
      if(!user){
        displayNameEl.textContent = 'Guest'; emailLine.textContent = 'Not signed in'; joinedLine.textContent = 'Joined: ‚Äî'; usernameInput.value = ''; avatar.textContent = 'U'; metaPlan.textContent = '‚Äî'; metaBalance.textContent = formatN(0); metaExpiry.textContent = '‚Äî'; metaUid.textContent = '‚Äî';
        return;
      }

      displayNameEl.textContent = user.displayName || user.email || 'User';
      emailLine.textContent = user.email || '‚Äî';
      avatar.textContent = (user.displayName || user.email || 'U').charAt(0).toUpperCase();
      metaUid.textContent = user.uid.slice(0,10);

      try{
        const userRef = doc(db, 'users', user.uid);
        let snap = await getDoc(userRef);
        let data = snap.exists ? snap.data() : null;

        // if user doc doesn't exist, create minimal doc and wait for createdAt to resolve
        if(!data){
          await setDoc(userRef, { username: user.displayName || null, plan: 'Basic', balance: 0, createdAt: serverTimestamp() }, { merge: true });
          for(let i=0;i<6;i++){ await new Promise(r=>setTimeout(r,500)); snap = await getDoc(userRef); if(snap.exists && snap.data().createdAt){ data = snap.data(); break; } }
          if(!data){ snap = await getDoc(userRef); data = snap.exists ? snap.data() : null; }
        }

        const username = data?.username || user.displayName || (user.email ? user.email.split('@')[0] : '');
        usernameInput.value = username;

        // joined date: prefer Firestore createdAt
        const createdAt = data?.createdAt || data?.createdAtISO || (user.metadata && user.metadata.creationTime) || null;
        joinedLine.textContent = 'Joined: ' + (createdAt ? formatCreatedAt(createdAt) : '‚Äî');

        metaPlan.textContent = data?.plan || 'Basic';
        metaBalance.textContent = formatN(Number(data?.balance || 0));
        metaExpiry.textContent = data?.planExpiryAt ? formatCreatedAt(data.planExpiryAt) : '‚Äî';

        // ensure username input remains readonly (UI safeguard)
        usernameInput.setAttribute('readonly', 'true'); usernameInput.disabled = true; usernameInput.style.opacity = '1'; usernameInput.style.color = 'var(--muted)';

      }catch(err){ console.error('Failed to load user doc', err); toast('Could not load profile data (see console)'); joinedLine.textContent = user.metadata?.creationTime ? `Joined: ${new Date(user.metadata.creationTime).toLocaleString()}` : 'Joined: ‚Äî'; }
    });

    function formatCreatedAt(value){ if(!value) return '‚Äî'; try{ if(value && typeof value.toDate === 'function'){ const d = value.toDate(); return isNaN(d.getTime()) ? '‚Äî' : d.toLocaleString(); } if(typeof value === 'object' && typeof value.seconds === 'number'){ const ms = value.seconds * 1000 + (value.nanoseconds||0)/1e6; const d = new Date(ms); return isNaN(d.getTime()) ? '‚Äî' : d.toLocaleString(); } if(typeof value === 'string'){ const d = new Date(value); return isNaN(d.getTime()) ? '‚Äî' : d.toLocaleString(); } return 'Pending‚Ä¶'; }catch(e){return '‚Äî';} }

    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
