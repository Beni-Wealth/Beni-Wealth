<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth ‚Äî Deposit History</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#0b0613; --bg2:#120521;
      --muted: rgba(255,255,255,0.64);
      --text: #eaf2ff;
      --accent-start:#2fe0b8; --accent-end:#7a5fff;
      --glass: rgba(255,255,255,0.03);
      --card: rgba(255,255,255,0.02);
      --radius:14px;
      --bottom-nav-h:72px;
      --page-pad:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Poppins',system-ui,-apple-system,'Segoe UI',Roboto,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);-webkit-font-smoothing:antialiased}
    .shell{max-width:1100px;margin:0 auto;padding:var(--page-pad) 18px calc(var(--bottom-nav-h) + 48px)}
    header.appbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{width:54px;height:54px;border-radius:12px;object-fit:cover;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
    .title-block .title{font-weight:700;font-size:18px}
    .title-block .sub{color:var(--muted);font-size:13px;margin-top:3px}
    .muted{color:var(--muted)}
    .card{
      background: linear-gradient(180deg, var(--card), rgba(255,255,255,0.01));
      border-radius:calc(var(--radius));
      padding:18px;
      border:1px solid rgba(255,255,255,0.04);
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
    }

    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .search{flex:1;min-width:200px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:#041219;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .small{font-size:13px;color:var(--muted)}

    /* table */
    .table-wrap{overflow:auto;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    table{width:100%;border-collapse:collapse;min-width:720px}
    th, td{padding:12px 14px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03)}
    th{font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:0.04em}
    td{font-size:15px;color:var(--text);vertical-align:middle}
    tr:hover td{background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));}

    .status-pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px;color:#041219}
    .status-pending{background:#fff6d6;color:#6a4f00} /* light yellow */
    .status-success{background:#bff0d9;color:#05461f} /* light green */
    .status-rejected{background:#ffdede;color:#6b0b0b} /* light red */

    .proof-link{color:var(--accent-start);text-decoration:underline;cursor:pointer}
    .proof-link:focus{outline:2px solid rgba(47,224,184,0.25);border-radius:4px}

    /* overlay viewer */
    .viewer-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.8);z-index:9999;padding:20px}
    .viewer{max-width:100%;max-height:100%;border-radius:12px;overflow:hidden;box-shadow:0 30px 100px rgba(0,0,0,0.8);background:#000;display:flex;flex-direction:column}
    .viewer img{max-width:calc(100vw - 80px);max-height:calc(100vh - 160px);display:block;margin:0 auto}
    .viewer .meta{padding:12px;background:rgba(0,0,0,0.45);color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    .viewer .meta .close{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04);padding:6px 10px;border-radius:8px;cursor:pointer}

    /* responsive tweaks */
    @media (max-width:760px){
      th,td{padding:10px}
      .brand img{width:48px;height:48px}
      .controls{flex-direction:column;align-items:stretch}
    }

    /* bottom nav (same theme) */
    .bw-bottom-nav {
      position: fixed; left: 18px; right: 18px; bottom: 16px; height: var(--bottom-nav-h);
      display:flex;align-items:center;justify-content:space-between;padding:10px;
      background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04));
      border-radius: 40px; box-shadow: 0 14px 40px rgba(2,6,23,0.6); backdrop-filter: blur(6px); z-index:120; color:var(--text);
    }
    .bw-bottom-nav a{ text-decoration:none; color:inherit; display:flex; flex-direction:column; align-items:center; gap:6px; width:64px; font-size:12px; text-align:center; user-select:none }
    .bw-bottom-nav .icon-wrap{ width:44px; height:44px; border-radius:10px; background: rgba(255,255,255,0.04); display:grid;place-items:center; font-size:18px }
  </style>
</head>
<body>
  <main class="shell">
    <header class="appbar">
      <div class="brand">
        <img src="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png" alt="Beni-Wealth" />
        <div class="title-block">
          <div class="title">Deposit History</div>
          <div class="sub small">Your submitted deposits and verification status</div>
        </div>
      </div>

      <div style="text-align:right">
        <div id="acctDisplay" class="small">Checking sign-in‚Ä¶</div>
      </div>
    </header>

    <section class="card" aria-labelledby="title">
      <div class="controls" role="toolbar" aria-label="controls">
        <input id="q" class="search" placeholder="Search sender name or status..." />
        <button id="refreshBtn" class="btn ghost">Refresh</button>
        <div class="small" id="countText">‚Äî</div>
      </div>

      <div class="table-wrap" role="region" aria-label="Deposit table">
        <table id="depositsTable" aria-live="polite">
          <thead>
            <tr>
              <th>Sender name</th>
              <th>Date</th>
              <th>Proof</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="4" class="small muted">Loading deposits‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <footer class="small muted">¬© <span id="year"></span> Beni-Wealth</footer>
  </main>

  <!-- image viewer overlay -->
  <div id="viewerBackdrop" class="viewer-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="viewer" role="document">
      <img id="viewerImg" alt="Proof image" />
      <div class="meta">
        <div id="viewerMeta" class="small"></div>
        <div>
          <button id="openNewTabBtn" class="btn ghost" style="margin-right:8px">Open in new tab</button>
          <button id="closeViewerBtn" class="close">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- bottom nav -->
  <nav class="bw-bottom-nav" role="navigation" aria-label="Main navigation">
    <a id="navHome"><div class="icon-wrap">üè†</div><div>Home</div></a>
    <a id="navShortlinks"><div class="icon-wrap">üîó</div><div>Shortlinks</div></a>
    <div class="nav-center"><a id="navCreate" class="center-btn" aria-label="Create">‚ûï</a></div>
    <a id="navNews"><div class="icon-wrap">üí¨</div><div>News</div></a>
    <a id="navAssets"><div class="icon-wrap">üë§</div><div>Assets</div></a>
  </nav>

  <script type="module">
    // ----------------- Repo helper -----------------
    const REPO_BASE = '/Beni-Wealth';
    function withRepoPath(target){
      if(!target) return location.href;
      try {
        const maybe = new URL(target, location.href);
        if (maybe.protocol === 'http:' || maybe.protocol === 'https:') {
          if (maybe.origin === location.origin) {
            const pathname = maybe.pathname.replace(/\/+/g,'/');
            if (pathname.indexOf(REPO_BASE) === 0) return maybe.origin + pathname + maybe.search + maybe.hash;
          }
          return maybe.href;
        }
      } catch(e){}
      const clean = String(target).replace(/^\/+/, '');
      const repoClean = REPO_BASE.replace(/^\/+/, '');
      if (clean.indexOf(repoClean) === 0) return location.origin + '/' + clean;
      return location.origin + REPO_BASE + (clean ? '/' + clean : '');
    }

    // ----------------- Firebase imports & init -----------------
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    if (!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    // ----------------- DOM refs -----------------
    const acctDisplay = document.getElementById('acctDisplay');
    const tbody = document.getElementById('tbody');
    const countText = document.getElementById('countText');
    const qInput = document.getElementById('q');
    const refreshBtn = document.getElementById('refreshBtn');
    const viewerBackdrop = document.getElementById('viewerBackdrop');
    const viewerImg = document.getElementById('viewerImg');
    const viewerMeta = document.getElementById('viewerMeta');
    const closeViewerBtn = document.getElementById('closeViewerBtn');
    const openNewTabBtn = document.getElementById('openNewTabBtn');

    // repo nav wiring
    document.getElementById('navHome').addEventListener('click',(e)=>{e.preventDefault();location.assign(withRepoPath('catalog.html'));});
    document.getElementById('navShortlinks').addEventListener('click',(e)=>{e.preventDefault();location.assign(withRepoPath('convert.html'));});
    document.getElementById('navCreate').addEventListener('click',(e)=>{e.preventDefault();location.assign(withRepoPath('center.html'));});
    document.getElementById('navNews').addEventListener('click',(e)=>{e.preventDefault();location.assign(withRepoPath('news.html'));});
    document.getElementById('navAssets').addEventListener('click',(e)=>{e.preventDefault();location.assign(withRepoPath('dashboard.html'));});

    // ----------------- helpers -----------------
    function niceDate(d){
      try {
        // support Firestore Timestamp objects and raw Date strings
        const dt = (d && typeof d.toDate === 'function') ? d.toDate() : (d ? new Date(d) : null);
        if(!dt || isNaN(dt.getTime())) return '-';
        return dt.toLocaleString();
      } catch(e){ return '-'; }
    }

    function statusClass(status){
      const s = String(status || '').toLowerCase();
      if(s === 'pending') return 'status-pending';
      if(s === 'success' || s === 'successful' || s === 'completed') return 'status-success';
      if(s === 'rejected' || s === 'failed') return 'status-rejected';
      return 'status-pending';
    }

    function escapeHtml(s){ return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // ----------------- load deposits -----------------
    let currentUser = null;
    let depositsCache = []; // raw list

    async function loadDepositsForUser(uid){
      // show loading skeleton
      tbody.innerHTML = `<tr><td colspan="4" class="small muted">Loading deposits‚Ä¶</td></tr>`;
      countText.textContent = 'Loading‚Ä¶';

      if(!uid){
        tbody.innerHTML = `<tr><td colspan="4" class="small muted">No user id provided.</td></tr>`;
        countText.textContent = '-';
        return;
      }

      try {
        const col = collection(db, 'deposits');

        // First attempt: run the intended query with orderBy (this may require a composite index)
        try {
          const q = query(col, where('userId','==', uid), orderBy('createdAt','desc'));
          const snap = await getDocs(q);
          const docs = [];
          snap.forEach(d => docs.push({ id: d.id, ...d.data() }));
          depositsCache = docs;
          renderTable(depositsCache);
          return;
        } catch (errQuery) {
          // if ordering/index fails, we fall back to a simpler query to determine if it's an index vs permission problem
          console.warn('Primary ordered query failed ‚Äî falling back to simpler query. Error:', errQuery);

          // If permission denied, rethrow so outer catch handles it uniformly
          if(errQuery && String(errQuery.code || '').toLowerCase().includes('permission')) throw errQuery;

          // If it's an index error or other ordering issue, try the simple where query (no orderBy)
          try {
            const q2 = query(col, where('userId','==', uid));
            const snap2 = await getDocs(q2);
            const docs2 = [];
            snap2.forEach(d => docs2.push({ id: d.id, ...d.data() }));
            depositsCache = docs2;
            renderTable(depositsCache);
            // inform user that results are shown without ordering (helpful debug text)
            countText.textContent = `${depositsCache.length} deposit${depositsCache.length>1?'s':''} (unordered)`;
            return;
          } catch (errFallback) {
            console.warn('Fallback simple query also failed:', errFallback);
            throw errFallback; // let outer catch render the full error
          }
        }

      } catch (err) {
        // top-level error handling ‚Äî surface the real firebase error code + message in UI for debugging
        console.error('loadDepositsForUser error', err);
        const code = err && err.code ? err.code : 'unknown_error';
        const msg  = err && err.message ? err.message : String(err);

        // Friendly UI message while keeping sensitivity low
        tbody.innerHTML = `<tr><td colspan="4" class="small muted">Unable to load deposits: <strong>${escapeHtml(code)}</strong> ‚Äî ${escapeHtml(msg)}</td></tr>`;
        countText.textContent = 'Error';

        // Helpful hints for common cases
        // permission-denied -> Firestore rules need to allow the read for this user
        // failed-precondition / requires an index -> create composite index for where+orderBy
        return;
      }
    }

    function renderTable(list){
      if(!list || list.length === 0){
        tbody.innerHTML = `<tr><td colspan="4" class="small muted">No deposits found.</td></tr>`;
        countText.textContent = '0 deposits';
        return;
      }
      countText.textContent = `${list.length} deposit${list.length>1?'s':''}`;
      const rows = list.map(doc => {
        const sender = escapeHtml(doc.accountNameEntered || doc.username || '-');
        const createdAt = niceDate(doc.createdAt);
        const proofUrl = doc.proofUrl || '';
        const status = doc.status || 'pending';
        const pillClass = statusClass(status);
        const proofCell = proofUrl
          ? `<a class="proof-link" data-proof="${escapeHtml(proofUrl)}" href="${escapeHtml(proofUrl)}" target="_blank" rel="noopener noreferrer">View proof</a>`
          : `<span class="small muted">‚Äî</span>`;

        return `<tr data-id="${escapeHtml(doc.id)}">
          <td>${sender}</td>
          <td>${createdAt}</td>
          <td>${proofCell}</td>
          <td><span class="status-pill ${pillClass}">${escapeHtml(String(status).toUpperCase())}</span></td>
        </tr>`;
      });
      tbody.innerHTML = rows.join('');
      // attach proof click handlers (open overlay)
      document.querySelectorAll('.proof-link').forEach(a=>{
        a.addEventListener('click', (ev)=>{
          ev.preventDefault();
          const url = a.getAttribute('data-proof');
          openViewer(url);
        });
      });
    }

    // ----------------- viewer overlay -----------------
    function openViewer(url){
      if(!url) return;
      viewerImg.src = url;
      viewerMeta.textContent = url;
      openNewTabBtn.onclick = ()=> window.open(url, '_blank', 'noopener');
      viewerBackdrop.style.display = 'flex';
      viewerBackdrop.setAttribute('aria-hidden', 'false');
      // trap scroll
      document.body.style.overflow = 'hidden';
    }
    function closeViewer(){
      viewerBackdrop.style.display = 'none';
      viewerBackdrop.setAttribute('aria-hidden', 'true');
      viewerImg.src = '';
      document.body.style.overflow = '';
    }
    closeViewerBtn.addEventListener('click', closeViewer);
    viewerBackdrop.addEventListener('click', (e)=>{ if(e.target === viewerBackdrop) closeViewer(); });

    // ----------------- search/filter -----------------
    qInput.addEventListener('input', (e)=>{
      const q = (e.target.value || '').toLowerCase().trim();
      if(!q) return renderTable(depositsCache);
      const filtered = depositsCache.filter(d=>{
        const name = String(d.accountNameEntered || d.username || '').toLowerCase();
        const status = String(d.status || '').toLowerCase();
        return name.includes(q) || status.includes(q) || (d.proofUrl || '').toLowerCase().includes(q);
      });
      renderTable(filtered);
    });

    refreshBtn.addEventListener('click', async ()=> {
      if(!currentUser) return;
      await loadDepositsForUser(currentUser.uid);
    });

    // ----------------- auth & initial load -----------------
    acctDisplay.textContent = 'Checking sign-in‚Ä¶';
    onAuthStateChanged(auth, async (user) => {
      if(!user){
        acctDisplay.innerHTML = `Not signed in ‚Äî <a style="color:var(--accent-start)" href="${withRepoPath('login.html')}">Sign in</a>`;
        tbody.innerHTML = `<tr><td colspan="4" class="small muted">Sign in to view your deposit history.</td></tr>`;
        countText.textContent = '-';
        currentUser = null;
        return;
      }
      currentUser = user;
      const username = user.displayName || (user.email ? user.email.split('@')[0] : 'User');
      acctDisplay.textContent = username;
      // load deposits for the signed-in user
      await loadDepositsForUser(user.uid);
    });

    // immediate check (safe fallback; onAuthStateChanged should handle most cases)
    if(auth.currentUser){
      currentUser = auth.currentUser;
      acctDisplay.textContent = currentUser.displayName || (currentUser.email ? currentUser.email.split('@')[0] : 'User');
      loadDepositsForUser(currentUser.uid).catch(e=>console.error(e));
    } else {
      // fallback: after 6s show sign-in CTA if listener doesn't report
      setTimeout(()=> {
        if(!currentUser){
          acctDisplay.innerHTML = `Not signed in ‚Äî <a style="color:var(--accent-start)" href="${withRepoPath('login.html')}">Sign in</a>`;
          tbody.innerHTML = `<tr><td colspan="4" class="small muted">Sign in to view your deposit history.</td></tr>`;
          countText.textContent = '-';
        }
      }, 6000);
    }

    // set year
    document.getElementById('year').textContent = new Date().getFullYear();

  </script>
</body>
</html>
