<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth — Register</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-1:#0b0613;
      --bg-2:#0f0820;
      --muted:rgba(233,240,255,0.62);
      --card: rgba(255,255,255,0.02);
      --accent-start:#2fe0b8;
      --accent-end:#7a5fff;
      --glass: rgba(255,255,255,0.03);
      --text: #e9f0ff;
      --danger: #ff6b6b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family:'Poppins',system-ui,Segoe UI,Arial, sans-serif;
      background: linear-gradient(180deg,var(--bg-1),var(--bg-2));
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px;
    }

    .card {
      width:100%;
      max-width:420px;
      border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:28px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.6);
      animation: enter .28s ease;
    }
    @keyframes enter { from { opacity:0; transform: translateY(12px); } to { opacity:1; transform:none } }

    .logo {
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:8px;
    }
    .logo img{ width:56px; height:56px; border-radius:12px; object-fit:cover; box-shadow:0 8px 28px rgba(122,95,255,0.12) }
    h1 { margin:0; font-size:20px; }
    p.lead{ margin:8px 0 18px; color:var(--muted); font-size:14px }

    form { display:flex; flex-direction:column; gap:12px; }
    label{ font-size:13px; color:var(--muted); }
    input[type="text"], input[type="email"], input[type="password"] {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.04);
      padding:12px 14px;
      border-radius:10px;
      color:var(--text);
      font-size:14px;
      outline: none;
      transition: box-shadow .12s, border-color .12s;
    }
    input::placeholder{ color: rgba(233,240,255,0.28) }
    input:focus{ box-shadow: 0 6px 20px rgba(47,224,184,0.06); border-color: rgba(127,90,255,0.14) }

    .row { display:flex; gap:10px; }
    .row .col { flex:1; }

    .error { color: var(--danger); font-size:13px; height:18px; margin-top:6px; }
    .actions { display:flex; gap:12px; margin-top:6px; align-items:center; }
    .btn {
      padding:12px 14px;
      border-radius:12px;
      background: linear-gradient(90deg,var(--accent-start),var(--accent-end));
      color:#041219;
      font-weight:700;
      border:0;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:10px;
    }
    .btn[disabled]{ opacity:0.6; cursor:not-allowed }
    .btn.secondary{
      background:transparent;
      border:1px solid rgba(255,255,255,0.04);
      color:var(--text);
    }

    .spinner {
      width:18px; height:18px;
      border-radius:50%;
      border:3px solid rgba(4,6,9,0.08);
      border-top-color: rgba(4,6,9,0.18);
      animation: spin 1s linear infinite;
      display:none;
    }
    .spinner.show{ display:inline-block }

    .muted { color:var(--muted); font-size:13px; margin-top:10px; text-align:center }

    @media (max-width:420px){
      .card{ padding:18px; }
      .logo img{ width:48px; height:48px }
    }
  </style>
</head>
<body>
  <main class="card" role="main" aria-labelledby="registerTitle">
    <div class="logo">
      <img src="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png" alt="Beni-Wealth logo">
      <div>
        <h1 id="registerTitle">Create your Beni-Wealth account</h1>
        <p class="lead">Quick signup — receive notifications and earn instantly.</p>
      </div>
    </div>

    <form id="registerForm" novalidate>
      <input id="fullName" name="fullName" type="text" placeholder="Full name" required autocomplete="name" />
      <input id="username" name="username" type="text" placeholder="Username" required autocomplete="username" />
      <input id="referral" name="referral" type="text" placeholder="Referral code (optional)" />
      <input id="email" name="email" type="email" placeholder="Email address" required autocomplete="email" />
      <div class="row">
        <div class="col"><input id="password" name="password" type="password" placeholder="Password (min 6)" minlength="6" required autocomplete="new-password" /></div>
        <div class="col"><input id="confirmPassword" name="confirmPassword" type="password" placeholder="Confirm password" minlength="6" required autocomplete="new-password" /></div>
      </div>

      <div id="errorText" class="error" role="alert" aria-live="assertive"></div>

      <div class="actions">
        <button id="submitBtn" class="btn" type="submit" aria-live="polite">
          <span class="spinner" id="spinner"></span>
          <span id="btnText">Register</span>
        </button>
        <button type="button" id="signinBtn" class="btn secondary" onclick="location.href='login.html'">Sign in</button>
      </div>

      <div class="muted">By creating an account you agree to our <a href="terms.html" style="color:rgba(233,240,255,0.9)">terms</a>.</div>
    </form>
  </main>

  <script type="module">
    // Modular Firebase (v9 style - static imports)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, sendEmailVerification, fetchSignInMethodsForEmail, updateProfile } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, serverTimestamp, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    // Beni-Wealth Firebase config (your project)
    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    // init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM
    const form = document.getElementById('registerForm');
    const submitBtn = document.getElementById('submitBtn');
    const spinner = document.getElementById('spinner');
    const btnText = document.getElementById('btnText');
    const errorText = document.getElementById('errorText');

    function showError(msg){
      errorText.textContent = msg || '';
    }
    function setLoading(isLoading){
      submitBtn.disabled = isLoading;
      spinner.classList.toggle('show', isLoading);
      btnText.textContent = isLoading ? 'Please wait…' : 'Register';
    }

    // helper: check username uniqueness
    async function isUsernameTaken(name){
      try{
        const q = query(collection(db, 'users'), where('username', '==', name));
        const snap = await getDocs(q);
        return !snap.empty;
      }catch(e){
        console.error('username check failed', e);
        // if check fails, assume not taken to avoid blocking — but still log
        return false;
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      showError('');
      setLoading(true);

      const fullName = document.getElementById('fullName').value.trim();
      const username = document.getElementById('username').value.trim();
      const referral = document.getElementById('referral').value.trim() || null;
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const confirm = document.getElementById('confirmPassword').value;

      // simple client validation
      if(!fullName || !username || !email || !password || !confirm){
        showError('Please fill all required fields.');
        setLoading(false);
        return;
      }
      if(password !== confirm){
        showError('Passwords do not match.');
        setLoading(false);
        return;
      }
      if(password.length < 6){
        showError('Password must be at least 6 characters.');
        setLoading(false);
        return;
      }

      try{
        // check if email already used
        const methods = await fetchSignInMethodsForEmail(auth, email);
        if(methods && methods.length > 0){
          throw new Error('Email already in use.');
        }

        // check username
        const taken = await isUsernameTaken(username);
        if(taken){
          throw new Error('Username is already taken. Choose another.');
        }

        // create user
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        const user = cred.user;

        // update displayName (optional)
        try{
          await updateProfile(user, { displayName: username });
        }catch(upErr){
          console.warn('updateProfile failed', upErr);
        }

        // send email verification (non-blocking if it fails; but try)
        try{
          await sendEmailVerification(user);
        }catch(verr){
          console.warn('sendEmailVerification failed', verr);
        }

        // prepare doc payload (store username as authoritative field)
        const payload = {
          fullName: fullName || '',
          username: username,
          email: user.email || email,
          balance: 0,
          plan: 'basic',
          referralCode: referral || username,
          createdAt: serverTimestamp()
        };

        // write user doc users/{uid}
        await setDoc(doc(db, 'users', user.uid), payload);

        // success
        setLoading(false);
        alert('Account created — verification email sent (check your inbox). Redirecting to login.');
        window.location.href = 'login.html';
      }catch(err){
        console.error('Registration error', err);
        showError(err.message || 'Registration failed. Try again.');
        setLoading(false);
      }
    });
  </script>
</body>
</html>
