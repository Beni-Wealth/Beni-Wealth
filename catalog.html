<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth ‚Äî Plans Catalog</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet"/>
  <style>
    :root{ --bg:#0b0613; --panel:#0f0820; --muted:rgba(255,255,255,0.6); --accent1:#2fe0b8; --accent2:#7a5fff; --card:rgba(255,255,255,0.02); --text:#e9f0ff; }
    body{margin:0;font-family:'Poppins',system-ui,Arial;background:linear-gradient(180deg,var(--bg),var(--panel));color:var(--text);-webkit-font-smoothing:antialiased;padding:28px 18px 110px}
    .wrap{max-width:980px;margin:0 auto}
    h1{margin:0 0 12px}
    .intro{color:var(--muted);margin-bottom:18px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
    .plan{background:var(--card);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 18px 40px rgba(0,0,0,0.5)}
    .plan h3{margin:0 0 6px;color:var(--accent2)}
    .plan .price{font-weight:800;font-size:20px;margin-top:6px}
    .plan .earn{color:var(--muted);margin-top:6px}
    .plan .buy{margin-top:12px;display:flex;gap:8px;align-items:center}
    .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#041219}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--text)}
    .status{margin-top:18px;color:var(--muted)}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .user-info{color:var(--muted)}
    .toast{position:fixed;right:18px;bottom:18px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#041219;padding:10px 14px;border-radius:10px;font-weight:700;box-shadow:0 12px 40px rgba(0,0,0,0.6);z-index:9999}

    /* smaller bottom nav styles */
    .bottom-nav{
      position:fixed;
      left:18px;
      right:18px;
      bottom:16px;
      background:linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.03));
      padding:8px 12px; /* reduced padding */
      border-radius:34px; /* slightly smaller radius */
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 10px 28px rgba(2,6,23,0.5);
      backdrop-filter: blur(6px);
      opacity:0.98;
      z-index:998;
    }
    .nav-btn{
      width:56px; /* reduced width */
      text-align:center;
      color:var(--muted);
      font-size:11px; /* slightly smaller */
      display:flex;
      flex-direction:column;
      align-items:center;
      cursor:pointer;
    }
    .nav-btn .icon-wrap{
      display:block;
      margin-bottom:4px;
      width:36px; height:36px; /* reduced icon size */
      border-radius:8px;
      background:rgba(255,255,255,0.04);
      display:grid;
      place-items:center;
      font-size:16px;
    }
    .nav-center{flex:0 0 86px;display:flex;justify-content:center}
    .nav-center .center-btn{
      width:68px; height:68px; /* smaller center button */
      border-radius:50%;
      background:linear-gradient(135deg,var(--accent1),var(--accent2));
      display:grid; place-items:center;
      color:#041219; font-size:22px;
      box-shadow:0 10px 28px rgba(61,46,111,0.28);
      transform:translateY(-18px); /* slightly reduced lift */
    }

    @media(max-width:520px){
      body{padding:16px}
      .nav-btn{width:50px}
      .nav-center .center-btn{width:60px;height:60px;transform:translateY(-14px)}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Beni-Wealth Plans</h1>
        <div class="intro">Pick a plan to increase earnings. Purchase requires enough balance ‚Äî balance will be debited on purchase. Plans last 30 days and revert to Basic on expiry.</div>
      </div>
      <div class="user-info" id="userInfo">Not signed in</div>
    </div>

    <div class="grid" id="plansGrid"></div>

    <div class="status" id="status">Prices are one-time upgrades. Your balance will be debited immediately on a successful purchase.</div>
  </div>

  <!-- bottom nav (smaller) -->
  <div class="bottom-nav" role="navigation" aria-label="Main navigation">
    <div class="nav-btn" id="navHome"><div class="icon-wrap">üè†</div><span>Home</span></div>
    <div class="nav-btn" id="navConvert"><div class="icon-wrap">üîÅ</div><span>Convert</span></div>
    <div class="nav-center"><div class="center-btn" id="navCenter">‚öñÔ∏è</div></div>
    <div class="nav-btn" id="navNews"><div class="icon-wrap">üí¨</div><span>News</span></div>
    <div class="nav-btn" id="navAssets"><div class="icon-wrap">üë§</div><span>Assets</span></div>
  </div>

  <!-- Firebase (modular v9) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, runTransaction, collection, addDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // === Beni-Wealth Firebase config ===
    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Plan definitions
    const PLANS = [
      { id: 'Bronze', price: 3000, earning: 100 },
      { id: 'Silver', price: 5000, earning: 175 },
      { id: 'Gold', price: 8000, earning: 270 },
      { id: 'Platinum', price: 15000, earning: 500 }
    ];

    const plansGrid = document.getElementById('plansGrid');
    const userInfo = document.getElementById('userInfo');
    const statusEl = document.getElementById('status');

    let currentUser = null;
    let currentUid = null;

    function formatN(n){ return '‚Ç¶' + Number(n || 0).toLocaleString('en-NG'); }
    function toast(msg){ const t = document.createElement('div'); t.className='toast'; t.textContent = msg; document.body.appendChild(t); setTimeout(()=>{ t.style.transition='opacity .24s'; t.style.opacity='0'; setTimeout(()=>t.remove(),260); }, 3000); }
    function daysUntil(iso){ if(!iso) return null; const ms = new Date(iso).getTime() - Date.now(); return Math.ceil(ms / (1000*60*60*24)); }

    function renderPlans() {
      plansGrid.innerHTML = '';
      PLANS.forEach(p => {
        const div = document.createElement('div');
        div.className = 'plan';
        div.innerHTML = `
          <h3>${p.id}</h3>
          <div class="price">Price: <strong>${formatN(p.price)}</strong></div>
          <div class="earn">Earnings / shortlink: <strong>${formatN(p.earning)}</strong></div>
          <div class="buy">
            <button class="btn primary" data-plan="${p.id}" data-price="${p.price}">Activate ${p.id}</button>
            <button class="btn ghost" data-plan-info="${p.id}">Details</button>
          </div>
        `;
        plansGrid.appendChild(div);
      });

      document.querySelectorAll('.plan .buy .primary').forEach(b => b.addEventListener('click', onBuyClick));
      document.querySelectorAll('.plan .buy .ghost').forEach(b => {
        b.addEventListener('click', (e) => {
          const plan = e.currentTarget.getAttribute('data-plan-info');
          const p = PLANS.find(x=>x.id===plan);
          alert(`${p.id}\nPrice: ${formatN(p.price)}\nEarnings / shortlink: ${formatN(p.earning)}\nValid for: 30 days`);
        });
      });
    }

    async function onBuyClick(e){
      const plan = e.currentTarget.getAttribute('data-plan');
      const price = Number(e.currentTarget.getAttribute('data-price') || 0);
      if(!currentUid){
        const go = confirm('You are not signed in. Would you like to sign in now?');
        if(go) window.location.href = 'login.html';
        return;
      }

      const ok = confirm(`Buy ${plan} for ${formatN(price)}? This will debit your account immediately and activate ${plan} for 30 days.`);
      if(!ok) return;

      disablePlanButtons(true, plan);

      try{
        const userRef = doc(db, 'users', currentUid);
        const now = new Date();
        const expiry = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString();

        await runTransaction(db, async (tx) => {
          const snap = await tx.get(userRef);
          const data = snap.exists ? snap.data() : {};
          const bal = Number(data.balance || 0);

          if(bal < price) throw new Error(`Insufficient balance: ${formatN(bal)} available, ${formatN(price)} required.`);

          const newBal = bal - price;
          const updates = { balance: newBal, plan: plan, planPurchasedAt: now.toISOString(), planExpiryAt: expiry };
          tx.set(userRef, updates, { merge: true });
        });

        await addDoc(collection(db, 'users', currentUid, 'transactions'), {
          source: `Plan purchase ‚Äî ${plan}`,
          amount: -price,
          date: new Date().toISOString()
        });

        toast(`Plan ${plan} purchased ‚Äî ${formatN(price)} debited`);
        await refreshUserUI();
      }catch(err){
        console.error('Purchase failed', err);
        alert(err && err.message ? err.message : 'Purchase failed');
      }finally{
        disablePlanButtons(false);
      }
    }

    function disablePlanButtons(disable, exceptPlan){
      document.querySelectorAll('.plan .buy .primary').forEach(b => {
        if(exceptPlan && b.getAttribute('data-plan') === exceptPlan && disable===true){
          b.disabled = true; b.textContent = 'Processing...';
        } else {
          b.disabled = disable;
          const p = b.getAttribute('data-plan');
          b.textContent = disable ? 'Please wait...' : `Activate ${p}`;
        }
      });
    }

    async function enforcePlanExpiryIfNeeded(uid, userDocData){
      try{
        if(!uid) return false;
        const expiry = userDocData?.planExpiryAt || userDocData?.planExpiry || null;
        if(!expiry) return false;
        if(Date.now() <= new Date(expiry).getTime()) return false;

        const userRef = doc(db, 'users', uid);
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(userRef);
          if(!snap.exists) return;
          const data = snap.data() || {};
          const currentExpiry = data.planExpiryAt || data.planExpiry || null;
          if(!currentExpiry) return;
          if(Date.now() <= new Date(currentExpiry).getTime()) return;
          const updates = { plan: 'Basic', planExpiredAt: new Date().toISOString(), planExpiryAt: null, planPurchasedAt: null };
          tx.set(userRef, updates, { merge: true });
        });

        await addDoc(collection(db, 'users', uid, 'transactions'), {
          source: `Plan expired ‚Äî reverted to Basic`,
          amount: 0,
          date: new Date().toISOString()
        });

        toast('Your plan has expired and reverted to Basic');
        return true;
      }catch(err){ console.error('Failed to enforce plan expiry', err); return false; }
    }

    async function refreshUserUI(){
      if(!currentUid) {
        userInfo.textContent = 'Not signed in';
        statusEl.textContent = 'Prices are one-time upgrades. Sign in to purchase.';
        return;
      }
      try{
        const userRef = doc(db, 'users', currentUid);
        const snap = await getDoc(userRef);
        const data = snap.exists ? snap.data() : {};
        const didExpire = await enforcePlanExpiryIfNeeded(currentUid, data);
        let refreshedSnap = snap;
        if(didExpire) refreshedSnap = await getDoc(userRef);
        const finalData = refreshedSnap.exists ? refreshedSnap.data() : {};
        const bal = Number(finalData.balance || 0);
        const plan = finalData.plan || 'Basic';
        const expiry = finalData.planExpiryAt || finalData.planExpiry || null;
        const daysLeft = expiry ? daysUntil(expiry) : null;

        userInfo.textContent = userInfoText(finalData, currentUid);
        if(daysLeft === null){
          statusEl.textContent = `Plan: ${plan} ‚Äî Balance: ${formatN(bal)} (no active expiry)`;
        } else if(daysLeft > 0){
          statusEl.textContent = `Plan: ${plan} ‚Äî Balance: ${formatN(bal)} ‚Äî expires in ${daysLeft} day(s)`;
        } else {
          statusEl.textContent = `Plan: ${plan} ‚Äî Balance: ${formatN(bal)} ‚Äî expired`;
        }
      }catch(e){ console.warn('refreshUserUI failed', e); }
    }

    function userInfoText(data, uid){
      const name = data.displayName || data.username || (auth.currentUser && auth.currentUser.email) || (uid ? uid.slice(0,6)+'...' : 'Guest');
      const plan = data.plan || 'Basic';
      const bal = Number(data.balance || 0);
      return `${name} ‚Ä¢ Plan: ${plan} ‚Ä¢ ${formatN(bal)}`;
    }

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      currentUid = user ? user.uid : null;
      if(user) userInfo.textContent = 'Signed in ‚Äî loading...';
      else { userInfo.textContent = 'Not signed in'; statusEl.textContent = 'Prices are one-time upgrades. Sign in to purchase.'; }
      await refreshUserUI();
    });

    // bottom nav handlers
    document.getElementById('navHome').addEventListener('click', ()=> window.location.href='catalog.html');
    document.getElementById('navConvert').addEventListener('click', ()=> window.location.href='convert.html');
    document.getElementById('navCenter').addEventListener('click', ()=> window.location.href='center.html');
    document.getElementById('navNews').addEventListener('click', ()=> window.location.href='news.html');
    document.getElementById('navAssets').addEventListener('click', ()=> window.location.href='dashboard.html');

    // init
    renderPlans();
    refreshUserUI();

    window._bwCatalog = { PLANS, refreshUserUI, enforcePlanExpiryIfNeeded };
  </script>
</body>
  </html>
  
