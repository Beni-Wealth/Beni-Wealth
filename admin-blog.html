<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth — Admin Moderation (Debug)</title>

  <!-- Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <!-- favicon / logo -->
  <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <meta name="theme-color" content="#2fe0b8">

  <style>
    :root{ --bg-1:#0b0613; --bg-2:#0f0820; --text:#eaf2ff; --muted:rgba(255,255,255,0.62); }
    *{box-sizing:border-box}
    body{ margin:0; min-height:100vh; background: radial-gradient(1000px 600px at 10% 10%, rgba(123,61,255,0.10), transparent), radial-gradient(900px 500px at 90% 90%, rgba(47,224,184,0.06), transparent), linear-gradient(180deg,var(--bg-1),var(--bg-2)); color:var(--text); font-family:'Poppins',system-ui,-apple-system,'Segoe UI',Roboto,Arial; padding:28px; }
    .wrap{ max-width:1100px; margin:0 auto }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px }
    h1{ margin:0; font-size:20px }
    .status{ display:flex; gap:10px; align-items:center; font-size:13px }
    .status .item{ padding:8px 10px; border-radius:8px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); }
    .note{ color:var(--muted); font-size:13px }
    .list{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px }
    .card{ display:flex; gap:12px; padding:12px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03); }
    .thumb{ width:160px; height:110px; border-radius:8px; object-fit:cover }
    .meta{ flex:1 }
    .small{ font-size:12px; color:var(--muted) }
    pre{ white-space:pre-wrap; word-break:break-word; max-height:360px; overflow:auto; background:rgba(0,0,0,0.2); padding:12px; border-radius:8px }
    .controls{ display:flex; gap:8px; align-items:center }
    @media(max-width:760px){ .card{ flex-direction:column } .thumb{ width:100%; height:200px } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Admin — Blog moderation (Debug)</h1>
        <div class="note">This page shows connection & diagnostic info to help find why the list is empty.</div>
      </div>
      <div class="status">
        <div id="fbStatus" class="item">Firebase: —</div>
        <div id="userStatus" class="item">User: —</div>
        <div id="queryStatus" class="item">Query: —</div>
      </div>
    </header>

    <div class="controls" style="margin-bottom:8px">
      <button id="runDiag" class="btn ghost" style="padding:8px 12px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)">Run diagnostics</button>
      <button id="oneFetch" class="btn ghost" style="padding:8px 12px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)">One-time fetch</button>
      <button id="clearDebug" class="btn ghost" style="padding:8px 12px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)">Clear debug</button>
    </div>

    <div id="statusArea" aria-live="polite"></div>

    <div id="list" class="list" role="region" aria-label="Pending posts list"></div>

    <h3 style="margin-top:20px">Debug output</h3>
    <pre id="debugOut">Not run yet.</pre>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, collection, query, where, orderBy, onSnapshot, getDocs, doc, updateDoc, addDoc, serverTimestamp, increment, getDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // --- FIREBASE CONFIG (included) ---
    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    // initialize
    if(!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    // UI refs
    const fbStatus = document.getElementById('fbStatus');
    const userStatus = document.getElementById('userStatus');
    const queryStatus = document.getElementById('queryStatus');
    const debugOut = document.getElementById('debugOut');
    const listEl = document.getElementById('list');
    const runDiag = document.getElementById('runDiag');
    const oneFetchBtn = document.getElementById('oneFetch');
    const clearDebug = document.getElementById('clearDebug');

    function logDebug(obj){
      try{ debugOut.textContent = JSON.stringify(obj, null, 2); }catch(e){ debugOut.textContent = String(obj); }
      console.log('DEBUG:', obj);
    }

    fbStatus.textContent = `Firebase initialized (projectId: ${firebaseConfig.projectId})`;

    let currentUser = null;
    let isAdmin = false;
    let unsubscribe = null;

    function setQueryStatus(txt){ queryStatus.textContent = txt; }

    // render helper
    function renderList(docs){
      listEl.innerHTML = '';
      if(!docs || docs.length === 0){ listEl.innerHTML = '<div class="note">No pending posts (empty result).</div>'; return; }
      docs.forEach(snap => {
        const id = snap.id || snap.docId || 'unknown';
        const data = snap.data ? snap.data() : (snap.data || snap);
        const title = data.title || 'Untitled';
        const author = data.author || data.userId || 'Unknown';
        const createdAt = data.createdAt;
        const thumb = data.thumbnail || '';

        const card = document.createElement('div'); card.className = 'card';
        const img = document.createElement('img'); img.className = 'thumb'; img.alt = title; img.src = thumb || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="320" height="200"><rect width="100%" height="100%" fill="%230b0613"/><text x="50%" y="50%" fill="%23aaaaaa" font-size="16" dominant-baseline="middle" text-anchor="middle">No thumbnail</text></svg>';
        const meta = document.createElement('div'); meta.className = 'meta';
        meta.innerHTML = `<h3>${title}</h3><div class="small">by <strong>${author}</strong></div>`;
        card.appendChild(img); card.appendChild(meta);
        listEl.appendChild(card);
      });
    }

    // subscribe with onSnapshot (live)
    function subscribePending(){
      setQueryStatus('starting live subscription...');
      const col = collection(db, 'blogs');
      const q = query(col, where('status','==','pending'), orderBy('createdAt','desc'));
      if(unsubscribe) unsubscribe();
      unsubscribe = onSnapshot(q, (snap)=>{
        setQueryStatus(`live: returned ${snap.size} docs`);
        renderList(snap.docs);
        logDebug({ type: 'liveSnapshot', size: snap.size, docs: snap.docs.map(d=>({id:d.id, data:d.data()})) });
      }, (err)=>{
        setQueryStatus('live query error');
        logDebug({ type: 'liveError', error: err && err.message ? err.message : String(err) });
        renderList([]);
      });
    }

    // one-time fetch to help debug reads
    async function fetchPendingOnce(){
      setQueryStatus('running one-time fetch...');
      try{
        const col = collection(db, 'blogs');
        const q = query(col, where('status','==','pending'), orderBy('createdAt','desc'));
        const snap = await getDocs(q);
        setQueryStatus(`one-time fetch returned ${snap.size} docs`);
        renderList(snap.docs);
        logDebug({ type: 'oneTimeFetch', size: snap.size, docs: snap.docs.map(d=>({id:d.id, data:d.data()})) });
      }catch(err){
        setQueryStatus('one-time fetch error');
        logDebug({ type: 'oneTimeFetchError', error: err && err.message ? err.message : String(err) });
      }
    }

    // run a more comprehensive diagnostic: user doc, admin check, and one-time fetch
    async function runDiagnostics(){
      if(!currentUser){ logDebug({ message: 'Not signed in' }); userStatus.textContent = 'Not signed in'; return; }
      try{
        const uRef = doc(db, 'users', currentUser.uid);
        const snap = await getDoc(uRef);
        const userDoc = snap.exists() ? snap.data() : null;
        const adminEmails = ['owanaomubo76@gmail.com', 'beniwealth70@gmail.com'].map(e=>e.toLowerCase());
        isAdmin = adminEmails.includes((currentUser.email||'').toLowerCase()) || !!(userDoc && (userDoc.role === 'admin' || userDoc.isAdmin === true || (Array.isArray(userDoc.roles) && userDoc.roles.includes('admin'))));
        userStatus.textContent = `${currentUser.email} (admin: ${isAdmin})`;
        logDebug({ type: 'userDoc', uid: currentUser.uid, email: currentUser.email, userDoc, isAdmin });
        await fetchPendingOnce();
      }catch(err){
        logDebug({ type: 'diagnosticsError', error: err && err.message ? err.message : String(err) });
      }
    }

    // auth listener
    onAuthStateChanged(auth, (user)=>{
      currentUser = user;
      if(user){
        userStatus.textContent = `${user.email || user.uid}`;
        console.log('Signed in user:', user);
        // automatically run diagnostics and subscribe if admin
        runDiagnostics().then(()=>{ if(isAdmin) subscribePending(); });
      } else {
        userStatus.textContent = 'Signed out';
        renderList([]);
      }
    });

    // wire buttons
    runDiag.addEventListener('click', ()=> runDiagnostics());
    oneFetchBtn.addEventListener('click', ()=> fetchPendingOnce());
    clearDebug.addEventListener('click', ()=>{ debugOut.textContent = ''; });

    // expose quick test on global so you can run from console
    window.__bw_debug = { subscribePending, fetchPendingOnce, runDiagnostics };

    // initial attempt to subscribe (will fail silently until auth completes)
    try{ subscribePending(); }catch(e){ console.warn('initial subscribe failed', e); }

  </script>
</body>
</html>
