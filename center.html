<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advertise Task ‚Äî Beni-Wealth</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300,400,600,700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#0b0613;
      --bg2:#120521;
      --glass: rgba(255,255,255,0.03);
      --muted: rgba(255,255,255,0.6);
      --text: #eaf2ff;
      --accent-start:#2fe0b8;
      --accent-end:#7a5fff;

      /* bottom nav sizing */
      --bw-bottom-nav-height: 72px;
      --bw-nav-gap: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0}
    body{
      font-family:'Poppins',system-ui,-apple-system,'Segoe UI',Roboto,Arial;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Shell: we add a bottom padding so content isn't hidden by the fixed nav */
    .shell {
      max-width:980px;
      margin:0 auto;
      padding:36px 20px calc(var(--bw-bottom-nav-height) + env(safe-area-inset-bottom, 32px));
    }

    header.appbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{width:54px;height:54px;border-radius:12px;object-fit:cover;box-shadow:0 6px 18px rgba(0,0,0,0.5)}
    .brand .title{font-weight:700;font-size:18px}
    .muted{color:var(--muted);font-size:13px}

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:14px;
      padding:18px;
      border:1px solid rgba(255,255,255,0.04);
      box-shadow: 0 18px 60px rgba(0,0,0,0.6);
    }

    .grid { display:grid; grid-template-columns: 1fr 360px; gap:18px; align-items:start; }
    @media(max-width:980px){ .grid { grid-template-columns: 1fr } }

    label{display:block;margin-top:12px;font-weight:600;color:var(--text);font-size:13px}
    input[type="text"], input[type="url"], input[type="number"], select, textarea {
      width:100%; padding:12px; margin-top:8px; border-radius:8px;
      background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.04); color:var(--text); font-size:14px;
    }
    textarea { min-height:120px; resize:vertical; }

    .row{display:flex;gap:12px;align-items:center}
    .row > *{flex:1}

    .price-box{background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);color:var(--muted)}
    .total { font-weight:800; color:var(--accent-start); margin-top:12px; font-size:16px; }

    .btn {
      display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:12px 16px;border-radius:10px;border:none;cursor:pointer;
      background: linear-gradient(90deg,var(--accent-start),var(--accent-end)); color:#041219; font-weight:700;
    }
    .btn.ghost { background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); }

    /* right column */
    .right .card { margin-bottom:16px }

    /* modal */
    .modal-backdrop { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:140; }
    .modal { width:100%; max-width:560px; background:linear-gradient(180deg,#0f1220,#0b0f18); border-radius:12px; padding:18px; border:1px solid rgba(255,255,255,0.03); }
    .line { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed rgba(255,255,255,0.02); color:var(--muted); }

    /* bottom nav */
    .bw-bottom-nav {
      position: fixed;
      left: var(--bw-nav-gap);
      right: var(--bw-nav-gap);
      bottom: calc(16px + env(safe-area-inset-bottom, 0px));
      height: var(--bw-bottom-nav-height);
      display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;
      background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04));
      border-radius: 40px; box-shadow: 0 14px 40px rgba(2,6,23,0.6); backdrop-filter: blur(6px); z-index:120;
      color:var(--text);
    }
    .bw-bottom-nav a{ text-decoration:none; color:inherit; display:flex; flex-direction:column; align-items:center; gap:6px; width:64px; font-size:12px; text-align:center; user-select:none }
    .bw-bottom-nav .icon-wrap{ width:44px; height:44px; border-radius:10px; background: rgba(255,255,255,0.04); display:grid;place-items:center; font-size:18px }
    .bw-bottom-nav .center-btn{ width:82px; height:82px; border-radius:50%; background: linear-gradient(135deg,var(--accent-start),var(--accent-end)); display:grid;place-items:center; color:#041219; font-size:26px; box-shadow: 0 12px 36px rgba(61,46,111,0.35); transform:translateY(-22px) }

    .bw-bottom-nav a.active .icon-wrap{ background: linear-gradient(90deg,var(--accent-start),var(--accent-end)); color:#041219 }
    @media(max-width:420px){ .bw-bottom-nav a{ width:52px; font-size:11px } .bw-bottom-nav .center-btn{ width:70px; height:70px; transform:translateY(-18px) }

  </style>
</head>
<body>
  <main class="shell">
    <header class="appbar">
      <div class="brand">
        <img src="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png" alt="Beni-Wealth logo">
        <div>
          <div class="title">Beni-Wealth ‚Äî Advertise Task</div>
          <div class="muted">Create and fund a new advertising task</div>
        </div>
      </div>
      <div id="acctArea" class="muted">Checking sign-in‚Ä¶</div>
    </header>

    <div class="grid">
      <!-- left: main form -->
      <section class="card left" aria-labelledby="pageTitle">
        <h2 id="pageTitle">Advertise Task</h2>
        <p class="muted">Fill out details and preview before posting. Funds will be debited when the task is posted.</p>

        <label for="taskTitle">Task Title</label>
        <input id="taskTitle" type="text" placeholder="Short title for the task" />

        <label for="platform">Platform</label>
        <select id="platform">
          <option value="">Select Platform</option>
          <option>WhatsApp</option>
          <option>Facebook</option>
          <option>Instagram</option>
          <option>Telegram</option>
          <option>TikTok</option>
          <option>Website</option>
          <option>App</option>
          <option>Twitter</option>
          <option>YouTube</option>
        </select>

        <label for="subcategory">Subcategory (minimum price shown)</label>
        <select id="subcategory"><option value="">Select Subcategory</option></select>

        <div class="row" style="margin-top:10px;">
          <div>
            <label>Fixed minimum price</label>
            <div id="fixedPriceDisplay" class="price-box">‚Ç¶0</div>
          </div>

          <div>
            <label>Unit price (‚Ç¶) <span class="muted" style="font-weight:400;font-size:12px;">(must be ‚â• minimum)</span></label>
            <input id="unitPrice" type="number" value="0" min="0" step="1" />
          </div>
        </div>

        <label for="workers">Number of Workers</label>
        <input id="workers" type="number" min="1" value="1" />

        <div id="totalCost" class="total">Total Cost: ‚Ç¶0</div>

        <label for="description">Task Description</label>
        <textarea id="description" placeholder="Describe the task and proof requirements"></textarea>

        <label for="taskLink">Task Link</label>
        <input id="taskLink" type="url" placeholder="https://example.com/..." />

        <div style="margin-top:18px; display:flex; gap:12px;">
          <button id="submitBtn" class="btn">Preview & Confirm</button>
          <button id="clearBtn" class="btn ghost">Clear</button>
        </div>
      </section>

      <!-- right: account & tips -->
      <aside class="right">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <div>
              <div style="font-weight:700">Balance</div>
              <div id="balanceDisplay" class="muted">‚Äî</div>
            </div>
            <div style="text-align:right;">
              <div class="muted">Account</div>
              <div id="userName" style="font-weight:700;color:var(--text)">‚Äî</div>
            </div>
          </div>

          <div style="height:14px"></div>

          <div>
            <div style="font-weight:700;margin-bottom:6px;">Quick Tips</div>
            <div class="muted" style="font-size:13px;line-height:1.4;">
              ‚Ä¢ Unit price must be at least the subcategory minimum.<br>
              ‚Ä¢ Provide a reachable link and clear proof instructions.<br>
              ‚Ä¢ Tasks are reviewed by moderators before publishing.
            </div>
          </div>
        </div>
      </aside>
    </div>

    <!-- confirmation modal -->
    <div id="confirmModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="modal card" role="document" aria-labelledby="confirmTitle">
        <h3 id="confirmTitle">Confirm Task Details</h3>

        <div class="line"><div>Title</div><div id="c_title">‚Äî</div></div>
        <div class="line"><div>Platform</div><div id="c_platform">‚Äî</div></div>
        <div class="line"><div>Subcategory</div><div id="c_subcategory">‚Äî</div></div>
        <div class="line"><div>Fixed min price</div><div id="c_min">‚Ç¶0</div></div>
        <div class="line"><div>Unit price</div><div id="c_unit">‚Ç¶0</div></div>
        <div class="line"><div>Workers</div><div id="c_workers">0</div></div>
        <div class="line"><div>Total cost</div><div id="c_total">‚Ç¶0</div></div>
        <div class="line"><div>Your balance</div><div id="c_balance">‚Ç¶0</div></div>

        <div class="total" id="c_sum">Total: ‚Ç¶0</div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px;">
          <button id="cancelConfirm" class="btn ghost">Cancel</button>
          <button id="confirmPost" class="btn">Confirm & Post</button>
        </div>
      </div>
    </div>

  </main>

  <!-- bottom nav (correct, matches dashboard style) -->
  <nav class="bw-bottom-nav" role="navigation" aria-label="Main navigation">
    <a href="/dashboard.html" data-key="home" title="Home">
      <div class="icon-wrap">üè†</div>
      <div>Home</div>
    </a>

    <a href="/shortlinks.html" data-key="shortlinks" title="Shortlinks">
      <div class="icon-wrap">üîó</div>
      <div>Shortlinks</div>
    </a>

    <div class="nav-center">
      <a href="/center.html" class="center-btn" aria-label="Create">‚ûï</a>
    </div>

    <a href="/news.html" data-key="news" title="News">
      <div class="icon-wrap">üí¨</div>
      <div>News</div>
    </a>

    <a href="/dashboard.html" data-key="assets" title="Assets">
      <div class="icon-wrap">üë§</div>
      <div>Assets</div>
    </a>
  </nav>

  <!-- Firebase compat SDKs (easy to drop into a static page) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ------------------------
    // Beni-Wealth Firebase config (client config only)
    // ------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    // initialize firebase (compat)
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM refs
    const platformSelect = document.getElementById('platform');
    const subcategorySelect = document.getElementById('subcategory');
    const fixedPriceDisplay = document.getElementById('fixedPriceDisplay');
    const unitPriceInput = document.getElementById('unitPrice');
    const workersInput = document.getElementById('workers');
    const totalCostDiv = document.getElementById('totalCost');
    const submitBtn = document.getElementById('submitBtn');
    const clearBtn = document.getElementById('clearBtn');

    const balanceDisplay = document.getElementById('balanceDisplay');
    const userNameEl = document.getElementById('userName');
    const acctArea = document.getElementById('acctArea');

    const confirmModal = document.getElementById('confirmModal');
    const cancelConfirm = document.getElementById('cancelConfirm');
    const confirmPost = document.getElementById('confirmPost');

    const c_title = document.getElementById('c_title');
    const c_platform = document.getElementById('c_platform');
    const c_subcategory = document.getElementById('c_subcategory');
    const c_min = document.getElementById('c_min');
    const c_unit = document.getElementById('c_unit');
    const c_workers = document.getElementById('c_workers');
    const c_total = document.getElementById('c_total');
    const c_balance = document.getElementById('c_balance');
    const c_sum = document.getElementById('c_sum');

    // subcategory pricing map (kept from previous)
    const subcategoryData = {
      "WhatsApp": { "WhatsApp Group Join": 15, "WhatsApp channel follow": 20, "WhatsApp Community Join": 35, "WhatsApp status post": 30, "Contact add": 10, "WhatsApp connect": 150 },
      "Facebook": { "Facebook add friend": 9, "Facebook comment": 9, "Facebook follow": 5, "Facebook like": 5, "Facebook Group Join": 15, "Share a post": 20 },
      "Instagram": { "Comment": 9, "Follow": 5, "Like": 5 },
      "Telegram": { "Telegram Group Join": 25, "Telegram bot": 25, "Telegram web app": 65 },
      "TikTok": { "Follow": 12, "Like": 7, "TikTok post": 20, "TikTok repost": 15 },
      "Website": { "Simple sign up": 25, "Complex sign up": 60, "Online voting": 20 },
      "App": { "Download and register": 50, "Complex download": 85 },
      "Twitter": { "Comment": 9, "Like": 5, "Follow": 5, "Retweet": 20, "Quote": 15 },
      "YouTube": { "Subscribe": 20, "View": 3, "Like": 4 }
    };

    // state
    let currentFixedPrice = 0;
    let currentUser = null;
    let currentBalance = 0;
    let currentTaskId = null;

    // helpers
    function formatN(n){ const num = Number(n || 0); return '‚Ç¶' + num.toLocaleString('en-NG', {minimumFractionDigits:2, maximumFractionDigits:2}); }
    function updateCost(){ 
      const workers = Math.max(0, parseInt(workersInput.value, 10) || 0);
      const unit = Math.max(0, Number(unitPriceInput.value) || 0);
      const total = unit * workers;
      totalCostDiv.textContent = 'Total Cost: ' + ('‚Ç¶' + total.toLocaleString());
      return total;
    }

    // populate subcategories when platform changes
    platformSelect.addEventListener('change', () => {
      const selected = platformSelect.value;
      subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
      currentFixedPrice = 0;
      fixedPriceDisplay.textContent = '‚Ç¶0';
      unitPriceInput.value = 0;
      unitPriceInput.min = 0;

      if (subcategoryData[selected]) {
        Object.entries(subcategoryData[selected]).forEach(([name, price]) => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name + ' (‚Ç¶' + price + ')';
          opt.dataset.price = price;
          subcategorySelect.appendChild(opt);
        });
      }
      updateCost();
    });

    subcategorySelect.addEventListener('change', () => {
      const selectedOpt = subcategorySelect.options[subcategorySelect.selectedIndex];
      currentFixedPrice = selectedOpt ? Number(selectedOpt.dataset.price || 0) : 0;
      fixedPriceDisplay.textContent = '‚Ç¶' + currentFixedPrice;
      unitPriceInput.min = currentFixedPrice;
      if (Number(unitPriceInput.value) < currentFixedPrice) unitPriceInput.value = currentFixedPrice;
      updateCost();
    });

    unitPriceInput.addEventListener('input', () => {
      const val = Number(unitPriceInput.value || 0);
      if (currentFixedPrice && val < currentFixedPrice) {
        unitPriceInput.value = currentFixedPrice;
      }
      updateCost();
    });

    workersInput.addEventListener('input', updateCost);

    // clear form
    clearBtn.addEventListener('click', () => {
      document.getElementById('taskTitle').value = '';
      platformSelect.value = '';
      subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
      fixedPriceDisplay.textContent = '‚Ç¶0';
      unitPriceInput.value = 0;
      unitPriceInput.min = 0;
      workersInput.value = 1;
      document.getElementById('description').value = '';
      document.getElementById('taskLink').value = '';
      totalCostDiv.textContent = 'Total Cost: ‚Ç¶0';
    });

    // show confirmation modal
    submitBtn.addEventListener('click', async () => {
      const title = (document.getElementById('taskTitle').value || '').trim();
      const platform = platformSelect.value;
      const subcategory = subcategorySelect.value;
      const workers = Math.max(0, parseInt(workersInput.value, 10) || 0);
      const description = (document.getElementById('description').value || '').trim();
      const taskLink = (document.getElementById('taskLink').value || '').trim();
      const chosenUnitPrice = Math.max(0, Number(unitPriceInput.value) || 0);
      const totalCost = chosenUnitPrice * workers;

      if (!title || !platform || !subcategory || !taskLink) {
        return alert('Please fill all required fields (title, platform, subcategory, link).');
      }
      if (chosenUnitPrice < currentFixedPrice) {
        return alert('Unit price must be at least ‚Ç¶' + currentFixedPrice);
      }

      // ensure signed in
      const user = auth.currentUser;
      if (!user) return alert('Please sign in first.');
      currentUser = user;

      // fetch balance
      try {
        const uDoc = await db.collection('users').doc(user.uid).get();
        currentBalance = uDoc.exists ? (uDoc.data().balance || 0) : 0;
      } catch (err) {
        console.error('Error fetching balance', err);
        currentBalance = 0;
      }

      // populate modal
      c_title.textContent = title;
      c_platform.textContent = platform;
      c_subcategory.textContent = subcategory;
      c_min.textContent = '‚Ç¶' + currentFixedPrice;
      c_unit.textContent = '‚Ç¶' + chosenUnitPrice;
      c_workers.textContent = workers;
      c_total.textContent = '‚Ç¶' + totalCost.toLocaleString();
      c_balance.textContent = '‚Ç¶' + Number(currentBalance).toLocaleString();
      c_sum.textContent = 'Total: ‚Ç¶' + totalCost.toLocaleString();

      if (currentBalance < totalCost) {
        c_sum.style.color = 'crimson';
        c_sum.textContent = 'Insufficient balance ‚Äî need ‚Ç¶' + totalCost.toLocaleString();
        confirmPost.disabled = true;
      } else {
        c_sum.style.color = getComputedStyle(document.documentElement).getPropertyValue('--accent-start') || '#2fe0b8';
        confirmPost.disabled = false;
      }

      // show modal
      confirmModal.style.display = 'flex';
      confirmModal.setAttribute('aria-hidden', 'false');
      currentTaskId = null;
    });

    // cancel modal
    cancelConfirm.addEventListener('click', () => {
      confirmModal.style.display = 'none';
      confirmModal.setAttribute('aria-hidden','true');
    });

    // confirm & post
    confirmPost.addEventListener('click', async () => {
      confirmPost.disabled = true;
      confirmPost.textContent = 'Posting...';

      try {
        if (!currentUser) throw new Error('Not signed in');

        const title = (document.getElementById('taskTitle').value || '').trim();
        const platform = platformSelect.value;
        const subcategory = subcategorySelect.value;
        const workers = Math.max(0, parseInt(workersInput.value, 10) || 0);
        const description = (document.getElementById('description').value || '').trim();
        const taskLink = (document.getElementById('taskLink').value || '').trim();
        const chosenUnitPrice = Math.max(0, Number(unitPriceInput.value) || 0);
        const totalCost = chosenUnitPrice * workers;

        // re-fetch balance server-side check
        const userRef = db.collection('users').doc(currentUser.uid);
        const userDoc = await userRef.get();
        const balance = userDoc.exists ? (userDoc.data().balance || 0) : 0;
        if (balance < totalCost) {
          alert('Insufficient balance to post this task.');
          confirmModal.style.display = 'none';
          return;
        }

        const taskId = Date.now().toString() + '-' + currentUser.uid;
        const now = firebase.firestore.FieldValue.serverTimestamp();

        await db.collection('tasks').doc(taskId).set({
          taskTitle: title,
          category: platform,
          subCategory: subcategory,
          subCategoryMinPrice: currentFixedPrice,
          subCategoryPrice: chosenUnitPrice,
          workersNeeded: workers,
          totalBudget: totalCost,
          description: description,
          link: taskLink,
          createdBy: currentUser.uid,
          createdAt: now,
          status: 'pending',
          taskId: taskId
        });

        // debit advertiser (consider Cloud Function transaction for production)
        await userRef.update({ balance: balance - totalCost });

        // record transaction
        await db.collection('transactions').add({
          userId: currentUser.uid,
          type: 'debit',
          source: 'Task Post',
          amount: totalCost,
          date: now
        });

        currentTaskId = taskId;
        alert('Task submitted for approval!');
        confirmModal.style.display = 'none';
      } catch (err) {
        console.error('Error posting task:', err);
        alert('Error posting task: ' + (err.message || err));
      } finally {
        confirmPost.disabled = false;
        confirmPost.textContent = 'Confirm & Post';
      }
    });

    // auth state handling: show username (displayName || users/{uid}.username || local-part) and balance
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        acctArea.textContent = 'Not signed in ‚Äî please sign in to continue';
        userNameEl.textContent = '‚Äî';
        balanceDisplay.textContent = '‚Äî';
        currentUser = null;
        currentBalance = 0;
        return;
      }

      currentUser = user;
      // try to get username & balance from users collection
      try {
        const uDoc = await db.collection('users').doc(user.uid).get();
        let username = user.displayName || '';
        if (!username && uDoc.exists) {
          const data = uDoc.data();
          username = data.username || data.name || '';
        }
        if (!username && user.email) username = user.email.split('@')[0];
        acctArea.textContent = username || 'User';
        userNameEl.textContent = username || 'User';

        const bal = uDoc.exists ? Number(uDoc.data().balance || 0) : 0;
        currentBalance = bal;
        balanceDisplay.textContent = '‚Ç¶' + Number(bal).toLocaleString();
      } catch (err) {
        console.error('Error reading user data', err);
        acctArea.textContent = user.displayName || (user.email ? user.email.split('@')[0] : 'User');
        userNameEl.textContent = acctArea.textContent;
        balanceDisplay.textContent = '‚Äî';
      }
    });

    // bottom nav: mark active and ensure shell padding (safety)
    (function initBottomNav(){
      const nav = document.querySelector('.bw-bottom-nav');
      if(nav){
        const navHeight = parseInt(getComputedStyle(nav).height) || 72;
        const shell = document.querySelector('.shell') || document.body;
        const currentBottomPadding = parseInt(getComputedStyle(shell).paddingBottom) || 0;
        const needed = navHeight + 28;
        if(currentBottomPadding < needed) shell.style.paddingBottom = needed + 'px';
      }
      // active link logic
      const path = location.pathname.split('/').pop() || 'index.html';
      const map = {
        'dashboard.html':'home','index.html':'home','shortlinks.html':'shortlinks','convert.html':'shortlinks',
        'center.html':'center','news.html':'news','dasboard.html':'assets','advertise.html':'center'
      };
      const key = map[path] || map[location.pathname] || 'home';
      document.querySelectorAll('.bw-bottom-nav a[data-key]').forEach(a=>{
        if(a.dataset.key === key) a.classList.add('active');
        a.addEventListener('click', ()=>{ document.querySelectorAll('.bw-bottom-nav a.active').forEach(n=>n.classList.remove('active')); a.classList.add('active'); });
      });
    })();
  </script>
</body>
</html>
