<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth — Withdrawal Records</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{font-family:'Poppins',sans-serif} .glass{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));backdrop-filter:blur(6px)}</style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-900 via-slate-800 to-gray-900 text-slate-100 p-6">
  <main class="max-w-4xl mx-auto">
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <button id="backBtn" aria-label="Back to dashboard" class="p-2 rounded-lg bg-white/6 hover:bg-white/8">← Back</button>
        <h1 class="text-2xl font-semibold">Withdrawal Records</h1>
      </div>
      <div class="flex items-center gap-3">
        <!-- intentionally compact header: removed refresh/new-request buttons -->
      </div>
    </div>

    <section class="glass border border-white/6 rounded-2xl p-6 shadow-2xl">
      <div id="statusLine" class="text-sm text-slate-400 mb-4">Showing your withdrawal requests (live).</div>

      <div id="emptyState" class="text-center py-20 text-slate-400">
        <div class="text-xl font-medium">No withdrawal requests yet</div>
        <div class="mt-2">When you submit a withdrawal, it will appear here.</div>
        <div class="mt-4"><a id="emptyNew" href="withdraw.html" class="inline-block px-4 py-2 bg-green-600 rounded-lg text-white">Request withdrawal</a></div>
      </div>

      <div id="records" class="space-y-4 hidden">
        <!-- records will be injected here -->
      </div>
    </section>

    <footer class="mt-6 text-center text-slate-400 text-xs">© Beni-Wealth</footer>
  </main>

  <script type="module">
    // repo helper (keeps links repo-aware)
    const REPO_BASE = '/Beni-Wealth';
    function withRepoPath(target){
      if(!target) return location.href;
      try {
        const maybe = new URL(target, location.href);
        if (maybe.origin === location.origin) {
          const pathname = maybe.pathname.replace(/\/+/g,'/');
          if (pathname.indexOf(REPO_BASE) === 0) return maybe.origin + pathname + maybe.search + maybe.hash;
        }
        return maybe.href;
      } catch(e){}
      const clean = String(target).replace(/^\/+/,'');
      const repoClean = REPO_BASE.replace(/^\/+/,'');
      if (clean.indexOf(repoClean) === 0) return location.origin + '/' + clean;
      return location.origin + REPO_BASE + (clean ? '/' + clean : '');
    }

    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import {
      getFirestore, collection, query, where, orderBy,
      onSnapshot, getDocs
    } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

    // your firebase config (keep in sync with other pages)
    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    if (!getApps().length) initializeApp(firebaseConfig);
    const db = getFirestore();
    const auth = getAuth();

    const backBtn = document.getElementById('backBtn');
    const recordsEl = document.getElementById('records');
    const emptyState = document.getElementById('emptyState');
    const statusLine = document.getElementById('statusLine');
    const emptyNew = document.getElementById('emptyNew');

    let unsubscribe = null;
    let currentUser = null;

    backBtn.addEventListener('click', (e) => { e.preventDefault(); location.assign(withRepoPath('dashboard.html')); });

    function fmtDate(ts){
      try {
        if(!ts) return '-';
        if(ts.toDate) return ts.toDate().toLocaleString();
        if(typeof ts === 'number') return new Date(ts).toLocaleString();
        if(ts.seconds) return new Date(ts.seconds * 1000).toLocaleString();
      } catch(e){}
      return '-';
    }

    function renderRecord(doc){
      const d = doc.data();
      const id = doc.id;
      // normalize status to lower-case for matching (handles 'approved', 'Approved', etc.)
      const statusRaw = (d.status || 'pending');
      const status = String(statusRaw).toLowerCase();

      // map statuses to badge styles
      const badge = status === 'pending' ? 'bg-yellow-500 text-black'
        : (status === 'paid' || status === 'approved' || status === 'completed') ? 'bg-green-600'
        : (status === 'rejected' || status === 'cancelled' || status === 'declined') ? 'bg-red-600'
        : 'bg-gray-500';

      const created = fmtDate(d.createdAt);

      const el = document.createElement('div');
      el.className = 'p-4 bg-white/3 border border-white/6 rounded-lg flex items-center justify-between';
      el.innerHTML = `
        <div>
          <div class="flex items-center gap-3">
            <div class="text-lg font-semibold">₦${Number(d.amount || 0).toLocaleString()}</div>
            <div class="text-sm text-slate-300">•</div>
            <div class="text-sm text-slate-300">${d.bank || '-'} — ${d.accountName || '-'}</div>
          </div>
          <div class="text-xs text-slate-400 mt-1">Acct: ${d.accountNumber || '-'} • ${created}</div>
        </div>
        <div class="flex flex-col items-end gap-2">
          <div class="px-3 py-1 rounded-full text-xs ${badge}">${String(statusRaw).toUpperCase()}</div>
          <div class="text-xs text-slate-400">Ref: ${id.slice(0,8)}</div>
        </div>
      `;
      return el;
    }

    async function attachListener(user){
      // teardown existing listener if any
      if(unsubscribe) { try { unsubscribe(); } catch(e){}; unsubscribe = null; }
      recordsEl.innerHTML = '';
      recordsEl.classList.add('hidden');
      emptyState.classList.remove('hidden');

      if(!user){
        statusLine.textContent = 'Sign in to view your records.';
        return;
      }

      currentUser = user;
      statusLine.textContent = 'Listening for your withdrawal requests...';

      try {
        const q = query(collection(db, 'withdrawal'), where('requestedBy','==', user.uid), orderBy('createdAt', 'desc'));

        // primary: realtime listener
        unsubscribe = onSnapshot(q, (snap) => {
          if(!snap || snap.empty){
            recordsEl.innerHTML = '';
            recordsEl.classList.add('hidden');
            emptyState.classList.remove('hidden');
            statusLine.textContent = 'You have no withdrawal requests yet.';
            return;
          }

          emptyState.classList.add('hidden');
          recordsEl.classList.remove('hidden');
          recordsEl.innerHTML = '';

          snap.forEach(doc => {
            const row = renderRecord(doc);
            recordsEl.appendChild(row);
          });

          statusLine.textContent = `Showing ${snap.size} request${snap.size===1 ? '' : 's'}.`;
        }, (err) => {
          console.error('snapshot err', err);
          statusLine.textContent = 'Unable to read records (listener). Falling back to one-time load.';
          // fallback to one-time fetch
          fallbackFetch(user);
        });
      } catch (err) {
        console.error('attachListener error', err);
        statusLine.textContent = 'Unable to read records — check console.';
        // fallback
        fallbackFetch(user);
      }
    }

    async function fallbackFetch(user){
      try{
        const q = query(collection(db, 'withdrawal'), where('requestedBy','==', user.uid), orderBy('createdAt', 'desc'));
        const snap = await getDocs(q);
        if(!snap || snap.empty){
          recordsEl.innerHTML = '';
          recordsEl.classList.add('hidden');
          emptyState.classList.remove('hidden');
          statusLine.textContent = 'You have no withdrawal requests yet.';
          return;
        }
        emptyState.classList.add('hidden');
        recordsEl.classList.remove('hidden');
        recordsEl.innerHTML = '';
        snap.forEach(doc => recordsEl.appendChild(renderRecord(doc)));
        statusLine.textContent = `Showing ${snap.size} request${snap.size===1 ? '' : 's'} (loaded).`;
      }catch(e){
        console.error('fallbackFetch err', e);
        statusLine.textContent = 'Unable to fetch records.';
      }
    }

    // auth tracking
    onAuthStateChanged(auth, (user) => {
      if(user) attachListener(user); else attachListener(null);
    });

    // expose for debugging in console
    window._bw_debug = { attachListener };
  </script>
</body>
</html>
