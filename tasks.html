<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tasks — Beni-Wealth</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" sizes="32x32"
      href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
<meta name="theme-color" content="#2fe0b8">

<style>
:root {
  --bg-1: #0b0613; --bg-2: #0f0820; --text: #eaf2ff; --muted: rgba(255,255,255,0.62);
  --accent-a:#8446ff; --accent-b:#6ce2c8; --container-w:420px;
  font-family:'Poppins',system-ui,-apple-system,"Segoe UI",Roboto,Arial;
}
*{box-sizing:border-box;}
body{margin:0;min-height:100vh;
  background:radial-gradient(1000px 600px at 10% 10%,rgba(123,61,255,0.10),transparent),
             radial-gradient(900px 500px at 90% 90%,rgba(47,224,184,0.06),transparent),
             linear-gradient(180deg,var(--bg-1),var(--bg-2));
  color:var(--text);padding:20px;display:flex;justify-content:center;align-items:flex-start;
}
.phone{width:100%;max-width:var(--container-w);min-height:740px;
  background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
  border-radius:28px;padding:18px 18px 120px;box-shadow:0 18px 60px rgba(0,0,0,0.6);position:relative;}

.top{display:flex;gap:12px;align-items:center;margin-bottom:12px;}
.back{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;
  background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
  border-radius:12px;color:var(--text);border:1px solid rgba(255,255,255,0.03);text-decoration:none;}
.title{font-size:17px;font-weight:800;}
.sub{color:var(--muted);font-size:12px;}
.controls{display:flex;gap:10px;align-items:center;margin:12px 0 18px;}
.search{flex:1;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
  background:rgba(255,255,255,0.01);color:var(--text);font-size:13px;}
.btn{padding:10px 12px;border-radius:12px;border:none;
  background:linear-gradient(90deg,var(--accent-b),var(--accent-a));color:#041219;
  font-weight:700;cursor:pointer;font-size:13px;box-shadow:0 8px 30px rgba(87,52,164,0.12);}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);box-shadow:none;}
.grid{display:grid;grid-template-columns:1fr;gap:12px;}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.015),rgba(255,255,255,0.01));
  border-radius:14px;padding:12px;display:flex;gap:12px;align-items:flex-start;
  box-shadow:0 18px 50px rgba(0,0,0,0.45);}
.thumb{width:84px;height:84px;border-radius:10px;object-fit:cover;flex:0 0 84px;
  background:rgba(255,255,255,0.02);cursor:pointer;border:1px solid rgba(255,255,255,0.02);}
.card-body{flex:1;min-width:0;}
.card h3{margin:0 0 6px 0;font-size:15px;font-weight:700;color:#eaf2ff;}
.meta{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px;margin-bottom:8px;}
.price{font-weight:800;color:var(--accent-b);font-size:14px;}
.small{font-size:12px;color:var(--muted);}
.empty{text-align:center;color:var(--muted);padding:40px;}

#taskViewer{position:fixed;inset:0;background:var(--bg-2);z-index:3000;overflow:auto;
  padding:20px;display:none;max-width:800px;margin:auto;left:0;right:0;}
#viewerBack{margin-bottom:14px;}
#viewerThumbSmall{width:120px;height:120px;object-fit:cover;border-radius:8px;margin-top:12px;cursor:pointer;border:1px solid rgba(255,255,255,0.15);}
#largeImgOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
  background:rgba(2,6,23,0.95);z-index:4000;padding:18px;}
#largeImgOverlay img{max-width:90%;max-height:80%;border-radius:10px;}
</style>
</head>
<body>

<div class="phone">
  <div class="top">
    <a class="back" href="dashboard.html">← Dashboard</a>
    <div style="flex:1;text-align:right">
      <div class="title">Available Tasks</div>
      <div class="sub">Complete quick micro‑tasks and earn.</div>
    </div>
  </div>

  <div class="controls">
    <input id="search" class="search" placeholder="Search tasks…">
    <button id="refresh" class="btn ghost">Refresh</button>
  </div>

  <div id="grid" class="grid" aria-live="polite">
    <div class="empty">Loading tasks…</div>
  </div>
</div>

<div id="taskViewer">
  <button id="viewerBack" class="btn ghost">← Back</button>
  <h2 id="viewerTitle"></h2>
  <div id="viewerPlatform" class="small"></div>
  <div id="viewerPrice" class="price"></div>

  <img id="viewerThumbSmall" style="display:none"/>

  <p id="viewerDesc" class="small" style="margin-top:12px;"></p>
  <div class="small">Task Link:</div>
  <a id="viewerLink" target="_blank" class="small"></a>

  <hr style="margin:18px 0;border-color:rgba(255,255,255,0.04)">

  <label class="small">Text proof</label>
  <textarea id="viewerProofText" rows="4" placeholder="Text proof"></textarea>

  <label class="small" style="margin-top:6px">Image proof</label>
  <input id="viewerProofImage" type="file" accept="image/*">

  <button id="viewerSubmitProofBtn" class="btn" style="margin-top:10px">Submit Proof</button>
  <div id="viewerProofStatus" class="small"></div>
</div>

<div id="largeImgOverlay">
  <img id="largeImgView" src="">
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
import {
  getFirestore, collection, query, where,
  onSnapshot, addDoc, serverTimestamp, doc, getDocs
} from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

const firebaseConfig = {
  apiKey: "...",
  authDomain: "...",
  projectId: "...",
  storageBucket: "...",
  messagingSenderId: "...",
  appId: "...",
  measurementId: "..."
};

const IMGUR_CLIENT_ID = 'fb533db21a59486';
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const grid = document.getElementById('grid');
const search = document.getElementById('search');
const refresh = document.getElementById('refresh');
const taskViewer = document.getElementById('taskViewer');

let currentUser = null;
let advertsCache = new Map();
let userSubmissionIds = new Set();
let activeTaskId = null;

// upload to Imgur
async function uploadImgur(file){
  const form = new FormData();
  form.append('image', file);
  const res = await fetch('https://api.imgur.com/3/image',{
    method:'POST',
    headers:{Authorization:'Client-ID '+IMGUR_CLIENT_ID},
    body:form
  });
  const j = await res.json(); return j.success?j.data.link:null;
}

// get user submissions
async function fetchUserSubs(uid){
  userSubmissionIds.clear();
  const subQ = query(collection(db,'advert_submissions'),where('userId','==',uid));
  const snap = await getDocs(subQ);
  snap.forEach(s=>{ const d=s.data();
    if(['pending','approved'].includes((d.status||'').toLowerCase())){
      userSubmissionIds.add(d.advertId);
    }
  });
}

// listen tasks
function startAdvertsListener(){
  grid.innerHTML = '<div class="empty">Loading tasks…</div>';

  const taskQ = query(collection(db,'advertise_tasks'),
                      where('status','==','approved'));
  onSnapshot(taskQ,snap=>{
    advertsCache.clear();
    snap.forEach(docSnap=>{
      const d=docSnap.data(); const id=docSnap.id;
      advertsCache.set(id,{id,data:d});
    });
    displayTasks();
  },err=>{
    grid.innerHTML='<div class="empty">Failed to load tasks</div>';
  });
}

// render
function displayTasks(){
  const q=search.value.toLowerCase();
  grid.innerHTML='';
  let any=false;
  advertsCache.forEach(ad=>{
    const workerCount = Number(ad.data.workers||0);
    const approvedCount = Number(ad.data.approvedCount||0);
    if(approvedCount>=workerCount) return;
    if(userSubmissionIds.has(ad.id)) return;
    const hay=((ad.data.title||'')+' '+(ad.data.platform||'')).toLowerCase();
    if(q && !hay.includes(q)) return;

    const card=document.createElement('div'); card.className='card';
    const thumb=document.createElement('img'); thumb.className='thumb';
    thumb.src=ad.data.thumbnail||''; if(!ad.data.thumbnail) thumb.style.display='none';
    const body=document.createElement('div'); body.className='card-body';
    const h3=document.createElement('h3'); h3.textContent=ad.data.title||'';
    const meta=document.createElement('div'); meta.className='meta';
    meta.innerHTML=`<div>${ad.data.platform||''}</div><div>${Number(ad.data.workers||0)}</div>`;
    const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Open Task';
    btn.addEventListener('click',()=>openFullPageTask(ad.id));
    body.append(h3,meta,btn); card.append(thumb,body); grid.append(card);
    any=true;
  });
  if(!any) grid.innerHTML='<div class="empty">No tasks available</div>';
}

// open task
async function openFullPageTask(id){
  activeTaskId=id;
  const s=await getDoc(doc(db,'advertise_tasks',id));
  if(!s.exists()) return;
  const d=s.data();
  document.getElementById('viewerTitle').textContent=d.title||'';
  document.getElementById('viewerPlatform').textContent=d.platform||'';
  document.getElementById('viewerPrice').textContent=d.price||'';
  document.getElementById('viewerDesc').textContent=d.description||'';
  const thumbEl=document.getElementById('viewerThumbSmall');
  if(d.thumbnail){thumbEl.src=d.thumbnail;thumbEl.style.display='block';}else thumbEl.style.display='none';
  document.getElementById('viewerLink').href=d.taskLink||'#';
  taskViewer.style.display='block';
  history.pushState({task:true,id},'',location.pathname+'?id='+id);
}

// submit proof
document.getElementById('viewerSubmitProofBtn').addEventListener('click',async()=>{
  if(!currentUser){document.getElementById('viewerProofStatus').textContent='Sign‑in required';return;}
  const text = document.getElementById('viewerProofText').value.trim();
  const file = document.getElementById('viewerProofImage').files[0];
  if(!text||!file){document.getElementById('viewerProofStatus').textContent='Both text and image proof are required';return;}
  const imgUrl = await uploadImgur(file);
  await addDoc(collection(db,'advert_submissions'),
               {advertId:activeTaskId,userId:currentUser.uid,textProof:text,imageUrl:imgUrl,status:'pending',createdAt:serverTimestamp()});
  window.location.href='tasks.html';
});

// auth
onAuthStateChanged(auth,user=>{
  currentUser=user;
  if(user) fetchUserSubs(user.uid).then(startAdvertsListener);
  else startAdvertsListener();
});

refresh.addEventListener('click',()=>{if(currentUser)fetchUserSubs(currentUser.uid).then(startAdvertsListener);});

search.addEventListener('input',displayTasks);

window.addEventListener('load',()=>{
  const id=new URL(location.href).searchParams.get('id');
  if(id) openFullPageTask(id);
});
</script>

</body>
</html>
