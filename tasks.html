<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tasks — Beni-Wealth</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#060511; --bg2:#0f0920;
      --muted: rgba(255,255,255,0.65);
      --text: #eaf2ff;
      --accent-start:#2fe0b8; --accent-end:#7a5fff;
      --card: rgba(255,255,255,0.02);
      --glass: rgba(255,255,255,0.03);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; font-family:'Poppins',sans-serif;
      background: linear-gradient(180deg,var(--bg1),var(--bg2));
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }

    .wrap{max-width:1100px;margin:22px auto;padding:20px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .back{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(255,255,255,0.03);border-radius:10px;text-decoration:none;color:var(--text)}
    .title{font-size:20px;font-weight:700}
    .sub{color:var(--muted);font-size:13px}

    .controls{display:flex;gap:12px;align-items:center;margin-bottom:14px}
    .search{flex:1;min-width:180px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
    .btn{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:#041219;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 20px 60px rgba(0,0,0,0.6)}
    .thumb{width:100%;height:150px;object-fit:cover;border-radius:8px;cursor:pointer}
    .card h3{margin:10px 0 6px 0;font-size:16px}
    .meta{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px;margin-bottom:8px}

    .price{font-weight:800;color:var(--accent-start);font-size:18px}
    .progressWrap{margin-top:10px}
    .progressBar{height:10px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden}
    .progressFill{height:100%;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));width:0%}
    .progressText{font-size:12px;color:var(--muted);margin-top:6px}

    .actions{display:flex;gap:8px;margin-top:12px}
    .small{font-size:13px;color:var(--muted)}
    .empty{padding:40px;text-align:center;color:var(--muted)}

    /* overlays */
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.65);z-index:999;padding:18px}
    /* PANEL: now has a solid, opaque background for better legibility */
    .panel{width:100%;max-width:920px;background:#071022;border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.06);box-shadow:0 30px 120px rgba(2,6,23,0.9);overflow:auto;max-height:90vh;color:var(--text)}
    .panel .closeX{float:right;background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
    .panel h2{margin:6px 0 12px 0}
    .detailRow{display:flex;gap:12px;align-items:center;margin:8px 0}
    .detailCol{flex:1}
    textarea, input[type="file"], input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
    .submitProof{display:flex;gap:8px;align-items:center;margin-top:12px}
    /* thumbnail preview inside the panel: intentionally smaller / cropped (not full-size) */
    .thumbLarge{
      display:block;
      width:40%;              /* show as a preview, not full image */
      max-width:420px;
      height:220px;           /* fixed height to crop */
      border-radius:8px;
      margin:12px 18px 12px 0;
      object-fit:cover;
      float:left;             /* text flows around it */
      cursor:pointer;
      box-shadow: 0 8px 20px rgba(0,0,0,0.6);
      transition: transform .18s ease;
    }
    .thumbLarge:hover{ transform: translateY(-4px); } /* subtle lift */

    @media (max-width:820px){
      .thumbLarge{ width:60%; height:180px; margin:12px auto; float:none; display:block }
    }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <a class="back" href="dashboard.html" id="backBtn">← Back to dashboard</a>
      <div style="text-align:right">
        <div class="title">Available Tasks</div>
        <div class="sub">Tasks you can perform — pay attention to proof rules.</div>
      </div>
    </div>

    <div class="controls">
      <input id="search" class="search" placeholder="Search by title, platform or subcategory" />
      <button id="refresh" class="btn ghost">Refresh</button>
    </div>

    <div id="grid" class="grid" aria-live="polite">
      <div class="empty">Loading tasks…</div>
    </div>
  </div>

  <!-- details + submit overlay -->
  <div id="overlay" class="overlay" aria-hidden="true" role="dialog">
    <div class="panel" role="document" aria-modal="true">
      <button id="closeOverlay" class="closeX" aria-label="Close overlay">✕</button>
      <div id="detailContent">
        <h2 id="d_title">Title</h2>
        <div class="meta"><div id="d_platform" class="small">Platform</div><div id="d_price" class="price">₦0</div></div>

        <!-- smaller, cropped preview (not full display) -->
        <img id="d_thumb" class="thumbLarge" src="" alt="thumbnail" style="display:none" />
        <div id="d_desc" class="small" style="white-space:pre-wrap"></div>

        <div style="margin-top:12px; overflow:auto">
          <div class="small">Task link</div>
          <div style="margin-top:6px"><a id="d_link" href="#" target="_blank" rel="noopener" class="small" style="color:var(--accent-start)"></a></div>
        </div>

        <div style="margin-top:12px; clear:both">
          <div class="small">Progress</div>
          <div class="progressWrap">
            <div class="progressBar"><div id="d_progress" class="progressFill" style="width:0%"></div></div>
            <div id="d_progressText" class="progressText">0/0</div>
          </div>
        </div>

        <hr style="margin:14px 0;border-color:rgba(255,255,255,0.03)" />

        <div>
          <div style="font-weight:700;margin-bottom:8px">Submit proof</div>
          <label class="small">Text proof (describe what you did)</label>
          <textarea id="proofText" placeholder="Paste link, paste screenshot text or short explanation"></textarea>

          <label class="small" style="margin-top:8px">Image proof (optional) — will be uploaded to Imgur</label>
          <input id="proofImage" type="file" accept="image/*" />
          <div style="margin-top:8px">
            <button id="submitProofBtn" class="btn">Submit Proof</button>
            <button id="closeOverlayBtn" class="btn ghost">Close</button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- thumbnail viewer overlay (full image) -->
  <div id="imgOverlay" class="overlay" aria-hidden="true">
    <div class="panel" style="max-width:900px; max-height:90vh;">
      <button id="closeImgOverlay" class="closeX">✕</button>
      <img id="imgView" src="" alt="thumbnail" style="max-width:100%;display:block;margin-top:8px;border-radius:8px" />
    </div>
  </div>

  <script type="module">
    // ---------- CONFIG ----------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getFirestore, collection, query, where, onSnapshot, addDoc, serverTimestamp, runTransaction, doc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    const IMGUR_CLIENT_ID = 'fb533db21a59486'; // use your Imgur client id

    // ---------- INIT ----------
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ---------- DOM ----------
    const grid = document.getElementById('grid');
    const search = document.getElementById('search');
    const refresh = document.getElementById('refresh');

    // overlay elems
    const overlay = document.getElementById('overlay');
    const closeOverlay = document.getElementById('closeOverlay');
    const closeOverlayBtn = document.getElementById('closeOverlayBtn');
    const d_title = document.getElementById('d_title');
    const d_platform = document.getElementById('d_platform');
    const d_price = document.getElementById('d_price');
    const d_desc = document.getElementById('d_desc');
    const d_link = document.getElementById('d_link');
    const d_thumb = document.getElementById('d_thumb');
    const d_progress = document.getElementById('d_progress');
    const d_progressText = document.getElementById('d_progressText');
    const proofText = document.getElementById('proofText');
    const proofImage = document.getElementById('proofImage');
    const submitProofBtn = document.getElementById('submitProofBtn');

    // thumbnail viewer
    const imgOverlay = document.getElementById('imgOverlay');
    const imgView = document.getElementById('imgView');
    const closeImgOverlay = document.getElementById('closeImgOverlay');

    let currentUser = null;
    let advertsListenerUnsub = null;
    const submissionsListeners = new Map(); // advertId -> unsubscribe
    const advertsCache = new Map(); // advertId -> doc data

    let activeAdvertId = null; // which advert is open in overlay

    // ---------- helpers ----------
    function el(tag, attrs = {}, ...children) {
      const e = document.createElement(tag);
      for (const k in attrs) {
        if (k === 'class') e.className = attrs[k];
        else if (k === 'dataset') Object.assign(e.dataset, attrs[k]);
        else e.setAttribute(k, attrs[k]);
      }
      children.forEach(c => { if (typeof c === 'string') e.appendChild(document.createTextNode(c)); else if (c) e.appendChild(c); });
      return e;
    }

    function formatNGN(n){ try { return '₦' + (Math.round(n).toLocaleString('en-NG')); } catch(e) { return '₦' + n; } }
    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // compute unit price fallback: prefer unitPrice fields or fallback to totalCost/workers
    function deriveUnitPrice(adData) {
      const maybe = Number(adData?.unitPrice ?? adData?.unit_price ?? adData?.unit ?? NaN);
      if (!isNaN(maybe) && maybe > 0) return maybe;
      const total = Number(adData?.totalCost ?? adData?.total_cost ?? adData?.total ?? 0) || 0;
      const workers = Number(adData?.workers || adData?.worker_count || 0) || 0;
      if (workers > 0) return total / workers;
      return 0;
    }

    function showOverlayForAdvert(ad) {
      // ad: { id, data }
      activeAdvertId = ad.id;
      d_title.textContent = ad.title || ad.data?.title || 'Untitled';
      d_platform.textContent = ad.data?.platform || '';
      // show 70% of unit price
      const unitPrice = deriveUnitPrice(ad.data);
      const displayPrice = Math.round(unitPrice * 0.7);
      d_price.textContent = formatNGN(displayPrice);
      d_desc.textContent = ad.data?.description || '';
      d_link.href = ad.data?.taskLink || ad.data?.task_link || '#';
      d_link.textContent = ad.data?.taskLink || ad.data?.task_link || '';

      if (ad.data?.thumbnail) {
        d_thumb.src = ad.data.thumbnail;
        d_thumb.style.display = 'block';
      } else {
        d_thumb.style.display = 'none';
      }
      // progress
      const workersRequested = Number(ad.data?.workers || ad.data?.worker_count || 0) || 0;
      const approvedCount = ad._approvedCount || 0;
      const pct = workersRequested === 0 ? 0 : Math.min(100, Math.round((approvedCount / workersRequested) * 100));
      d_progress.style.width = pct + '%';
      d_progressText.textContent = `${approvedCount}/${workersRequested}`;
      // reset form fields
      proofText.value = '';
      proofImage.value = '';
      overlay.style.display = 'flex';
      overlay.setAttribute('aria-hidden', 'false');
    }

    function closeDetailsOverlay() {
      overlay.style.display = 'none';
      overlay.setAttribute('aria-hidden', 'true');
      activeAdvertId = null;
    }

    function openImageOverlay(src){
      imgView.src = src;
      imgOverlay.style.display = 'flex';
      imgOverlay.setAttribute('aria-hidden','false');
    }
    function closeImageOverlay(){
      imgOverlay.style.display = 'none';
      imgOverlay.setAttribute('aria-hidden','true');
      imgView.src = '';
    }

    // Imgur upload
    async function uploadImgur(file){
      if (!file) return null;
      const form = new FormData();
      form.append('image', file);
      const res = await fetch('https://api.imgur.com/3/image', {
        method: 'POST',
        headers: { Authorization: 'Client-ID ' + IMGUR_CLIENT_ID },
        body: form
      });
      const j = await res.json();
      if (j && j.success && j.data && j.data.link) return j.data.link;
      throw new Error('Imgur upload failed');
    }

    // Create submission document
    async function submitProof(advertId, text, imageUrl){
      if (!currentUser) throw new Error('Not signed in');
      const payload = {
        advertId,
        userId: currentUser.uid,
        textProof: text || '',
        imageUrl: imageUrl || null,
        status: 'pending',
        createdAt: serverTimestamp()
      };
      await addDoc(collection(db, 'advert_submissions'), payload);
    }

    // ---------- listeners & rendering ----------
    function renderAdvertCard(ad) {
      const id = ad.id;
      const data = ad.data;
      const workersRequested = Number(data.workers || data.worker_count || 0) || 0;
      const approvedCount = Number(ad._approvedCount || 0);
      const userHasActive = !!ad._userHasActiveSubmission;
      if (data.status !== 'approved') return null;
      if (userHasActive) return null; // hide for this user

      // now use 70% of unit price (not totalCost)
      const unit = deriveUnitPrice(data);
      const price = Math.round(unit * 0.7);

      const card = el('div', { class: 'card', dataset: { id } });
      const thumb = el('img', { class: 'thumb', src: data.thumbnail || '', alt: data.title || '' });
      if (!data.thumbnail) thumb.style.display = 'none';
      thumb.addEventListener('click', () => {
        if (data.thumbnail) openImageOverlay(data.thumbnail);
      });

      const h3 = el('h3', {}, data.title || '(no title)');
      const meta = el('div', { class: 'meta' }, el('div', {}, data.platform || data.subcategory || ''), el('div', {}, formatNGN(price)));
      const desc = el('div', { class: 'small' }, (data.description || '').slice(0, 140) + ((data.description || '').length > 140 ? '…' : ''));

      const progressWrap = el('div', { class: 'progressWrap' },
        el('div', { class: 'progressBar' }, el('div', { class: 'progressFill', style: `width:${workersRequested?Math.round((approvedCount/workersRequested)*100):0}%` })),
        el('div', { class: 'progressText' }, `${approvedCount}/${workersRequested}`)
      );

      const actions = el('div', { class: 'actions' });
      const startBtn = el('button', { class: 'btn' }, 'Start Task');
      const detailsBtn = el('button', { class: 'btn ghost' }, 'Details');
      actions.appendChild(startBtn);
      actions.appendChild(detailsBtn);

      startBtn.addEventListener('click', () => showOverlayForAdvert({ id, data, _approvedCount: approvedCount }));
      detailsBtn.addEventListener('click', () => showOverlayForAdvert({ id, data, _approvedCount: approvedCount }));

      card.appendChild(thumb);
      card.appendChild(h3);
      card.appendChild(meta);
      card.appendChild(desc);
      card.appendChild(progressWrap);
      card.appendChild(actions);

      return card;
    }

    function rebuildGrid() {
      const q = (search.value || '').trim().toLowerCase();
      grid.innerHTML = '';
      let any = false;
      for (const [id, ad] of advertsCache) {
        if (!ad.data) continue;
        if (ad.data.status !== 'approved') continue;
        if (ad._userHasActiveSubmission) continue;
        if (q) {
          const hay = ((ad.data.title || '') + ' ' + (ad.data.platform || '') + ' ' + (ad.data.subcategory || '')).toLowerCase();
          if (!hay.includes(q)) continue;
        }
        const node = renderAdvertCard(ad);
        if (node) { grid.appendChild(node); any = true; }
      }
      if (!any) grid.innerHTML = `<div class="empty">No tasks available.</div>`;
    }

    function attachSubmissionsListener(advertId) {
      if (submissionsListeners.has(advertId)) return;
      const subQ = query(collection(db, 'advert_submissions'), where('advertId', '==', advertId));
      const unsub = onSnapshot(subQ, snap => {
        let approvedCount = 0;
        let userHasActive = false;
        snap.forEach(snapDoc => {
          const d = snapDoc.data();
          const st = (d.status||'').toLowerCase();
          if (st === 'approved') approvedCount++;
          if (currentUser && d.userId === currentUser.uid && st !== 'rejected') {
            userHasActive = true;
          }
        });
        const ad = advertsCache.get(advertId) || {};
        ad._approvedCount = approvedCount;
        ad._userHasActiveSubmission = userHasActive;
        advertsCache.set(advertId, ad);
        rebuildGrid();

        const workersRequested = Number(ad.data?.workers || ad.data?.worker_count || 0) || 0;
        if (workersRequested > 0 && approvedCount >= workersRequested) {
          (async () => {
            try {
              const advertRef = doc(db, 'advertise_tasks', advertId);
              await runTransaction(db, async (tx) => {
                const snap = await tx.get(advertRef);
                if (!snap.exists()) return;
                const cur = snap.data();
                if (cur.status !== 'completed') {
                  tx.update(advertRef, { status: 'completed', completedAt: serverTimestamp() });
                }
              });
            } catch (e) {
              console.warn('Failed to set advert completed', e);
            }
          })();
        }
      }, err => { console.error('submissions listener err', err); });

      submissionsListeners.set(advertId, unsub);
    }

    function detachAllSubmissionListeners() {
      for (const unsub of submissionsListeners.values()) {
        try { unsub(); } catch (e) {}
      }
      submissionsListeners.clear();
    }

    function startAdvertsListener() {
      if (advertsListenerUnsub) { try { advertsListenerUnsub(); } catch(e){}; advertsListenerUnsub=null; }
      detachAllSubmissionListeners();
      grid.innerHTML = `<div class="empty">Loading tasks…</div>`;

      const advertsQ = query(collection(db, 'advertise_tasks'), where('status','==','approved'));
      advertsListenerUnsub = onSnapshot(advertsQ, (snap) => {
        advertsCache.clear();
        snap.forEach(docSnap => {
          const data = docSnap.data();
          const id = docSnap.id;
          advertsCache.set(id, { id, data, _approvedCount: 0, _userHasActiveSubmission: false });
          attachSubmissionsListener(id);
        });
        rebuildGrid();
      }, err => {
        console.error('adverts listener err', err);
        grid.innerHTML = `<div class="empty">Failed to load tasks</div>`;
      });
    }

    // ---------- auth handling ----------
    onAuthStateChanged(auth, user => {
      currentUser = user;
      startAdvertsListener();
    });

    // ---------- overlay controls ----------
    closeOverlay.addEventListener('click', closeDetailsOverlay);
    closeOverlayBtn.addEventListener('click', closeDetailsOverlay);
    d_thumb.addEventListener('click', () => { if (d_thumb.src) openImageOverlay(d_thumb.src); });

    closeImgOverlay.addEventListener('click', closeImageOverlay);
    imgOverlay.addEventListener('click', (e) => { if (e.target === imgOverlay) closeImageOverlay(); });

    overlay.addEventListener('click', (e) => { if (e.target === overlay) closeDetailsOverlay(); });

    // Submit proof flow
    submitProofBtn.addEventListener('click', async () => {
      if (!currentUser) return alert('Please sign in to submit proof.');
      if (!activeAdvertId) return alert('No advert selected.');
      const text = proofText.value.trim();
      const file = proofImage.files && proofImage.files[0];
      if (!text && !file) return alert('Please provide text proof or an image proof.');
      submitProofBtn.disabled = true;
      submitProofBtn.textContent = 'Submitting...';
      try {
        let imageUrl = null;
        if (file) {
          try {
            imageUrl = await uploadImgur(file);
          } catch (e) {
            console.warn('Imgur upload failed', e);
            const cont = confirm('Image upload failed. Continue and submit proof without image?');
            if (!cont) throw e;
          }
        }
        await submitProof(activeAdvertId, text, imageUrl);
        alert('Proof submitted — status is pending review. You will not be able to perform this task again while it is pending/approved.');
        closeDetailsOverlay();
      } catch (e) {
        console.error('submit proof failed', e);
        alert('Failed to submit proof: ' + (e.message || e));
      } finally {
        submitProofBtn.disabled = false;
        submitProofBtn.textContent = 'Submit Proof';
      }
    });

    // refresh & search
    refresh.addEventListener('click', () => startAdvertsListener());
    search.addEventListener('input', () => rebuildGrid());

    // initialize UI
    grid.innerHTML = `<div class="empty">No tasks yet — check back soon.</div>`;

  </script>
</body>
</html>
