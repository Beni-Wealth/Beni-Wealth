<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tasks — Beni-Wealth</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <meta name="theme-color" content="#2fe0b8">
  <style>
    /* your exact original styling (unchanged) */
    :root{
      --bg-1: #0b0613;
      --bg-2: #0f0820;
      --panel: rgba(255,255,255,0.03);
      --muted: rgba(255,255,255,0.62);
      --text: #eaf2ff;
      --accent-a: #8446ff;
      --accent-b: #6ce2c8;
      --accent-grad: linear-gradient(135deg, var(--accent-a), #5b3bff 45%, var(--accent-b) 100%);
      --glass: rgba(255,255,255,0.03);
      --radius: 16px;
      --container-w: 420px;
      font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      min-height:100%;
      background: radial-gradient(1000px 600px at 10% 10%, rgba(123,61,255,0.10), transparent),
                  radial-gradient(900px 500px at 90% 90%, rgba(47,224,184,0.06), transparent),
                  linear-gradient(180deg,var(--bg-1),var(--bg-2));
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:20px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    /* rest of your original CSS: phone, controls, cards, buttons, etc. */
    .phone { width:100%; max-width:var(--container-w); min-height:740px; border-radius:28px; padding:18px 18px 120px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow: 0 18px 60px rgba(0,0,0,0.6); overflow:auto; position:relative; }
    .top { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
    .back { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; text-decoration:none; color:var(--text); border:1px solid rgba(255,255,255,0.03); font-weight:600; font-size:13px; }
    .title { font-size:17px; font-weight:800; letter-spacing:0.2px; }
    .sub { color:var(--muted); font-size:12px; }
    .controls { display:flex; gap:10px; align-items:center; margin:12px 0 18px; }
    .search { flex:1; min-width:120px; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); background:rgba(255,255,255,0.01); color:var(--text); font-size:13px; }
    .btn { padding:10px 12px; border-radius:12px; border:none; background: linear-gradient(90deg, var(--accent-b), var(--accent-a)); color:#041219; font-weight:700; cursor:pointer; font-size:13px; box-shadow: 0 8px 30px rgba(87,52,164,0.12); }
    .btn.ghost { background: transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); box-shadow:none; }
    .grid { display:grid; grid-template-columns: 1fr; gap:12px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01)); border-radius:14px; padding:12px; border:1px solid rgba(255,255,255,0.03); display:flex; gap:12px; align-items:flex-start; box-shadow: 0 18px 50px rgba(0,0,0,0.45); }
    .thumb { width:84px; height:84px; border-radius:10px; object-fit:cover; flex:0 0 84px; background: rgba(255,255,255,0.02); cursor:pointer; border:1px solid rgba(255,255,255,0.02); }
    .card-body { flex:1; min-width:0; }
    .card h3 { margin:0 0 6px 0; font-size:15px; font-weight:700; color:#eaf2ff; }
    .meta { display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:12px; margin-bottom:8px; }
    .price { font-weight:800; color:var(--accent-b); font-size:14px; }
    .small { font-size:12px; color:var(--muted); }
    .empty { padding:40px; text-align:center; color:var(--muted) }

    /* full page viewer */
    #taskViewer {
      position:fixed;
      inset:0;
      background: var(--bg-2);
      z-index:3000;
      overflow:auto;
      padding:18px;
      display:none;
    }
    #viewerBack { margin-bottom:12px; }
    #viewerBack.btn.ghost { color:var(--muted); border-color:rgba(255,255,255,0.04); }
    #viewerProofStatus { margin-top:8px; color:var(--muted); font-size:12px; }
    #viewerProofText { width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); background:rgba(255,255,255,0.01); color:var(--text); resize:none; margin-top:6px; }
  </style>
</head>
<body>

  <div class="phone">
    <div class="top">
      <a class="back" href="dashboard.html">← Dashboard</a>
      <div style="text-align:right;flex:1">
        <div class="title">Available Tasks</div>
        <div class="sub">Complete quick micro‑tasks and earn. Follow proof rules carefully.</div>
      </div>
    </div>

    <div class="controls">
      <input id="search" class="search" placeholder="Search by title or platform" />
      <button id="refresh" class="btn ghost">Refresh</button>
    </div>

    <div id="grid" class="grid" aria-live="polite">
      <div class="empty">Loading tasks…</div>
    </div>
  </div>

  <!-- Full page task viewer -->
  <div id="taskViewer">
    <button id="viewerBack" class="btn ghost">← Back</button>
    <h2 id="viewerTitle"></h2>
    <div id="viewerPlatform" class="small"></div>
    <div id="viewerPrice" class="price"></div>
    <img id="viewerThumb" style="max-width:100%;display:none;margin-top:12px;" />
    <p id="viewerDesc" class="small" style="margin-top:12px;"></p>
    <div class="small">Task Link:</div>
    <a id="viewerLink" target="_blank" class="small"></a>

    <hr style="margin:18px 0;border-color:rgba(255,255,255,0.04)" />

    <div>
      <div class="small" style="font-weight:700;margin-bottom:6px">Submit Proof</div>
      <textarea id="viewerProofText" rows="4" placeholder="Paste link, screenshot text or explanation"></textarea>
      <input id="viewerProofImage" type="file" accept="image/*" style="margin-top:6px" />
      <button id="viewerSubmitProofBtn" class="btn" style="margin-top:10px">Submit Proof</button>
      <div id="viewerProofStatus"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getFirestore, collection, query, where, onSnapshot, addDoc, serverTimestamp, doc, getDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    const IMGUR_CLIENT_ID = 'fb533db21a59486';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const grid = document.getElementById('grid');
    const search = document.getElementById('search');
    const refresh = document.getElementById('refresh');

    const taskViewer = document.getElementById('taskViewer');
    const viewerBack = document.getElementById('viewerBack');
    const viewerTitle = document.getElementById('viewerTitle');
    const viewerPlatform = document.getElementById('viewerPlatform');
    const viewerPrice = document.getElementById('viewerPrice');
    const viewerThumb = document.getElementById('viewerThumb');
    const viewerDesc = document.getElementById('viewerDesc');
    const viewerLink = document.getElementById('viewerLink');
    const viewerProofText = document.getElementById('viewerProofText');
    const viewerProofImage = document.getElementById('viewerProofImage');
    const viewerSubmitProofBtn = document.getElementById('viewerSubmitProofBtn');
    const viewerProofStatus = document.getElementById('viewerProofStatus');

    let currentUser = null;
    let advertsListenerUnsub = null;
    const submissionsListeners = new Map();
    const advertsCache = new Map();
    let activeTaskId = null;

    function formatNGN(n){ try { return '₦' + Math.round(n).toLocaleString('en-NG'); } catch { return '₦'+n; } }
    function deriveUnitPrice(adData){ const maybe=Number(adData?.unitPrice ?? adData?.unit ?? NaN); if(!isNaN(maybe)&&maybe>0) return maybe; const tot=Number(adData?.totalCost||0), w=Number(adData?.workers||0); return w>0?tot/w:0; }

    async function uploadImgur(file){ 
      const form=new FormData(); form.append('image',file);
      const res=await fetch('https://api.imgur.com/3/image',{method:'POST',headers:{Authorization:'Client-ID '+IMGUR_CLIENT_ID},body:form});
      const j=await res.json(); return j.success?j.data.link:null;
    }

    async function submitProof(advertId,text,imageUrl){
      if(!currentUser) throw new Error('Not signed in');
      await addDoc(collection(db,'advert_submissions'),{advertId,userId:currentUser.uid,textProof:text,imageUrl:imageUrl,status:'pending',createdAt:serverTimestamp()});
    }

    function renderAdvertCard(ad){
      const id = ad.id; const data = ad.data;
      if(data.status!=='approved') return null;
      const card = document.createElement('div'); card.className='card';
      const thumb=document.createElement('img'); thumb.className='thumb'; thumb.src=data.thumbnail||''; if(!data.thumbnail) thumb.style.display='none';
      const body=document.createElement('div'); body.className='card-body';
      const h3=document.createElement('h3'); h3.textContent=data.title||'';
      const meta=document.createElement('div'); meta.className='meta'; meta.innerHTML=`<div>${data.platform||''}</div><div class="price">${formatNGN(Math.round(deriveUnitPrice(data)*0.7))}</div>`;
      const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Open Task'; btn.addEventListener('click',()=>openFullPageTask(id));
      body.append(h3,meta,btn); card.append(thumb,body); return card;
    }

    function rebuildGrid(){
      const q=(search.value||'').toLowerCase(); grid.innerHTML='';
      let any=false;
      advertsCache.forEach(ad=>{
        const hay=((ad.data.title||'')+' '+(ad.data.platform||'')).toLowerCase();
        if(q && !hay.includes(q)) return;
        const node=renderAdvertCard(ad); if(node){grid.appendChild(node);any=true;}
      });
      if(!any) grid.innerHTML='<div class="empty">No tasks available.</div>';
    }

    function startAdvertsListener(){
      if(advertsListenerUnsub) advertsListenerUnsub();
      advertsCache.clear(); grid.innerHTML='<div class="empty">Loading tasks…</div>';
      const q = query(collection(db,'advertise_tasks'),where('status','==','approved'));
      advertsListenerUnsub=onSnapshot(q,snap=>{advertsCache.clear();snap.forEach(d=>advertsCache.set(d.id,{id:d.id,data:d.data()})); rebuildGrid();},()=>grid.innerHTML='<div class="empty">Failed to load tasks</div>');
    }

    onAuthStateChanged(auth,user=>{currentUser=user;startAdvertsListener();});
    refresh.addEventListener('click',startAdvertsListener);
    search.addEventListener('input',rebuildGrid);

    async function openFullPageTask(id){
      activeTaskId=id;
      const s=await getDoc(doc(db,'advertise_tasks',id)); if(!s.exists()) return;
      const data=s.data();
      viewerTitle.textContent=data.title||'';
      viewerPlatform.textContent=data.platform||'';
      viewerPrice.textContent=formatNGN(Math.round(deriveUnitPrice(data)*0.7));
      viewerDesc.textContent=data.description||'';
      viewerLink.href=data.taskLink||data.task_link||'#'; viewerLink.textContent=viewerLink.href;
      if(data.thumbnail){viewerThumb.src=data.thumbnail;viewerThumb.style.display='block';}else viewerThumb.style.display='none';
      taskViewer.style.display='block';
      history.pushState({task:true,id},'',new URL(window.location.href).pathname+'?id='+id);
    }

    viewerBack.addEventListener('click',()=>{
      taskViewer.style.display='none';
      const u=new URL(window.location.href);u.searchParams.delete('id');history.replaceState({},'',u);
    });

    viewerSubmitProofBtn.addEventListener('click',async()=>{
      if(!currentUser){viewerProofStatus.textContent='Sign in required.';return;}
      const text=viewerProofText.value.trim(),file=viewerProofImage.files[0];
      if(!text && !file){viewerProofStatus.textContent='Provide text or image.';return;}
      viewerSubmitProofBtn.disabled=true;viewerProofStatus.textContent='Submitting…';
      try{let imgUrl=null;if(file) imgUrl=await uploadImgur(file);await submitProof(activeTaskId,text,imgUrl);viewerProofStatus.textContent='Submitted (pending review).';}catch(e){viewerProofStatus.textContent='Submit failed.';}finally{viewerSubmitProofBtn.disabled=false;}
    });

    window.addEventListener('popstate',(ev)=>{if(!ev.state?.task) taskViewer.style.display='none';});

    window.addEventListener('load',()=>{
      startAdvertsListener();
      const id=new URL(window.location.href).searchParams.get('id');
      if(id) openFullPageTask(id);
    });
  </script>

</body>
</html>
