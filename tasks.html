<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tasks — Beni-Wealth</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#2fe0b8">

  <style>
    /* ================== BASE STYLES (unchanged) ================== */
    :root{
      --bg-1:#0b0613; --bg-2:#0f0820;
      --text:#eaf2ff; --muted:rgba(255,255,255,0.62);
      --accent-a:#8446ff; --accent-b:#6ce2c8;
      --container-w:420px;
      font-family:'Poppins',system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; min-height:100%; background:radial-gradient(1000px 600px at 10% 10%,rgba(123,61,255,0.10),transparent),
               radial-gradient(900px 500px at 90% 90%,rgba(47,224,184,0.06),transparent),
               linear-gradient(180deg,var(--bg-1),var(--bg-2));
      color:var(--text); padding:20px; display:flex; justify-content:center; align-items:flex-start;
    }
    .phone{
      width:100%; max-width:var(--container-w); min-height:740px;
      padding:18px 18px 120px; background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
      border-radius:28px; box-shadow:0 18px 60px rgba(0,0,0,0.6); overflow:auto; position:relative;
    }
    .top{display:flex;gap:12px;align-items:center;margin-bottom:12px;}
    .back{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;
          background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
          border-radius:12px;color:var(--text);border:1px solid rgba(255,255,255,0.03);text-decoration:none;}
    .title{font-size:17px;font-weight:800;}
    .sub{color:var(--muted);font-size:12px;}
    .controls{display:flex;gap:10px;align-items:center;margin:12px 0 18px;}
    .search{flex:1;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
            background:rgba(255,255,255,0.01);color:var(--text);font-size:13px;}
    .btn{padding:10px 12px;border-radius:12px;border:none;
         background:linear-gradient(90deg,var(--accent-b),var(--accent-a));color:#041219;
         font-weight:700;cursor:pointer;font-size:13px;box-shadow:0 8px 30px rgba(87,52,164,0.12);}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);box-shadow:none;}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.015),rgba(255,255,255,0.01));
         border-radius:14px;padding:12px;display:flex;gap:12px;align-items:flex-start;box-shadow:0 18px 50px rgba(0,0,0,0.45);}
    .thumb{width:84px;height:84px;border-radius:10px;object-fit:cover;flex:0 0 84px;
          background:rgba(255,255,255,0.02);cursor:pointer;border:1px solid rgba(255,255,255,0.02);}
    .card-body{flex:1;min-width:0;}
    .card h3{margin:0 0 6px 0;font-size:15px;font-weight:700;color:#eaf2ff;}
    .meta{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px;margin-bottom:8px;}
    .price{font-weight:800;color:var(--accent-b);font-size:14px;}
    .small{font-size:12px;color:var(--muted);}
    .empty{text-align:center;color:var(--muted);padding:40px;}

    /* ================== FULL PAGE VIEWER ================== */
    #taskViewer{
      position:fixed;inset:0;background:var(--bg-2);z-index:3000;
      overflow:auto;padding:20px;display:none;
      /* larger container on desktop */
      max-width:800px; margin:auto; left:0; right:0;
    }
    #viewerBack{margin-bottom:14px;}
    #viewerThumbSmall{
      width:120px;height:120px;object-fit:cover;border-radius:8px;margin-top:12px;cursor:pointer;border:1px solid rgba(255,255,255,0.15);
    }
    #largeImgOverlay{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(2,6,23,0.95);z-index:4000;padding:18px;
    }
    #largeImgOverlay img{
      max-width:90%;max-height:80%;border-radius:10px;
    }
    #viewerProofText{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);
                     background:rgba(255,255,255,0.01);color:var(--text);resize:none;margin-top:6px;}
    #viewerProofStatus{margin-top:8px;color:var(--muted);font-size:12px;}

    @media(min-width:900px){
      body{padding:30px;}
    }
  </style>

</head>
<body>

  <!-- main tasks UI -->
  <div class="phone">
    <div class="top">
      <a class="back" href="dashboard.html">← Dashboard</a>
      <div style="flex:1;text-align:right">
        <div class="title">Available Tasks</div>
        <div class="sub">Complete quick micro‑tasks and earn.</div>
      </div>
    </div>

    <div class="controls">
      <input id="search" class="search" placeholder="Search by title or platform">
      <button id="refresh" class="btn ghost">Refresh</button>
    </div>

    <div id="grid" class="grid" aria-live="polite">
      <div class="empty">Loading tasks…</div>
    </div>
  </div>

  <!-- full page task viewer -->
  <div id="taskViewer">
    <button id="viewerBack" class="btn ghost">← Back</button>
    <h2 id="viewerTitle"></h2>
    <div id="viewerPlatform" class="small"></div>
    <div id="viewerPrice" class="price"></div>

    <!-- small clickable thumbnail -->
    <img id="viewerThumbSmall" style="display:none" />

    <p id="viewerDesc" class="small" style="margin-top:12px;"></p>
    <div class="small">Task Link:</div>
    <a id="viewerLink" target="_blank" class="small"></a>

    <hr style="margin:18px 0;border-color:rgba(255,255,255,0.04)">

    <div>
      <div class="small" style="font-weight:700;margin-bottom:6px">Submit Proof</div>
      <textarea id="viewerProofText" rows="4" placeholder="Text proof (link, screenshot text, explanation)"></textarea>
      <input id="viewerProofImage" type="file" accept="image/*" style="margin-top:6px">
      <button id="viewerSubmitProofBtn" class="btn" style="margin-top:10px">Submit Proof</button>
      <div id="viewerProofStatus"></div>
    </div>
  </div>

  <!-- enlarged image overlay -->
  <div id="largeImgOverlay">
    <img id="largeImgView" src="">
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getFirestore, collection, query, where, onSnapshot, addDoc, serverTimestamp, doc, getDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    const IMGUR_CLIENT_ID = 'fb533db21a59486';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const grid = document.getElementById('grid');
    const search = document.getElementById('search');
    const refresh = document.getElementById('refresh');

    const taskViewer = document.getElementById('taskViewer');
    const viewerBack = document.getElementById('viewerBack');
    const viewerTitle = document.getElementById('viewerTitle');
    const viewerPlatform = document.getElementById('viewerPlatform');
    const viewerPrice = document.getElementById('viewerPrice');
    const viewerThumbSmall = document.getElementById('viewerThumbSmall');
    const viewerDesc = document.getElementById('viewerDesc');
    const viewerLink = document.getElementById('viewerLink');

    const viewerProofText = document.getElementById('viewerProofText');
    const viewerProofImage = document.getElementById('viewerProofImage');
    const viewerSubmitProofBtn = document.getElementById('viewerSubmitProofBtn');
    const viewerProofStatus = document.getElementById('viewerProofStatus');

    const largeImgOverlay = document.getElementById('largeImgOverlay');
    const largeImgView = document.getElementById('largeImgView');

    let currentUser = null;
    let advertsListenerUnsub = null;
    const advertsCache = new Map();

    let activeTaskId = null;

    function formatNGN(n){ try { return '₦'+Math.round(n).toLocaleString('en-NG'); } catch { return '₦'+n; }}

    function deriveUnitPrice(ad){ const m=Number(ad?.unitPrice ?? ad?.unit ?? NaN); if(!isNaN(m)&&m>0) return m; const tot=Number(ad?.totalCost||0), w=Number(ad?.workers||0); return w>0?tot/w:0; }

    async function uploadImgur(file){ 
      const form=new FormData(); form.append('image',file);
      const res=await fetch('https://api.imgur.com/3/image',{ method:'POST', headers:{ Authorization:'Client-ID '+IMGUR_CLIENT_ID }, body:form });
      const j=await res.json(); return j.success?j.data.link:null;
    }

    async function submitProof(advertId,text,imageUrl){
      await addDoc(collection(db,'advert_submissions'),{advertId,userId:currentUser.uid,textProof:text,imageUrl:imageUrl,status:'pending',createdAt:serverTimestamp()});
    }

    function renderAdvertCard(ad){
      const card=document.createElement('div'); card.className='card';
      const thumb=document.createElement('img'); thumb.className='thumb'; thumb.src=ad.data.thumbnail||''; if(!ad.data.thumbnail) thumb.style.display='none';
      const body=document.createElement('div'); body.className='card-body';
      const h3=document.createElement('h3'); h3.textContent=ad.data.title||'';
      const meta=document.createElement('div'); meta.className='meta'; meta.innerHTML=`<div>${ad.data.platform||''}</div><div class="price">${formatNGN(Math.round(deriveUnitPrice(ad.data)*0.7))}</div>`;
      const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Open Task'; btn.addEventListener('click',()=>openFullPageTask(ad.id));
      body.append(h3,meta,btn); card.append(thumb,body); return card;
    }

    function rebuildGrid(){ const q=(search.value||'').toLowerCase(); grid.innerHTML=''; let any=false;
      advertsCache.forEach(ad=>{
        const hay=((ad.data.title||'')+' '+(ad.data.platform||'')).toLowerCase();
        if(q && !hay.includes(q)) return;
        const node=renderAdvertCard(ad); if(node){grid.append(node);any=true;}
      });
      if(!any) grid.innerHTML='<div class="empty">No tasks found</div>';
    }

    function startAdvertsListener(){
      if(advertsListenerUnsub) advertsListenerUnsub();
      advertsCache.clear(); grid.innerHTML='<div class="empty">Loading tasks…</div>';
      const q= query(collection(db,'advertise_tasks'),where('status','==','approved'));
      advertsListenerUnsub=onSnapshot(q,snap=>{advertsCache.clear(); snap.forEach(d=>advertsCache.set(d.id,{id:d.id,data:d.data()})); rebuildGrid();},()=>grid.innerHTML='<div class="empty">Failed to load</div>');
    }

    onAuthStateChanged(auth,u=>{currentUser=u; startAdvertsListener();});
    refresh.addEventListener('click',startAdvertsListener);
    search.addEventListener('input',rebuildGrid);

    async function openFullPageTask(id){
      activeTaskId=id;
      const s=await getDoc(doc(db,'advertise_tasks',id)); if(!s.exists()) return;
      const data=s.data();
      viewerTitle.textContent=data.title||''; viewerPlatform.textContent=data.platform||''; viewerPrice.textContent=formatNGN(Math.round(deriveUnitPrice(data)*0.7));
      viewerDesc.textContent=data.description||'';
      viewerLink.href=data.taskLink||data.task_link||'#'; viewerLink.textContent=viewerLink.href;

      if(data.thumbnail){ viewerThumbSmall.src=data.thumbnail; viewerThumbSmall.style.display='block'; }
      else viewerThumbSmall.style.display='none';

      taskViewer.style.display='block';
      history.pushState({task:true,id},'',location.pathname+'?id='+id);
    }

    viewerBack.addEventListener('click',()=>{
      taskViewer.style.display='none';
      const u=new URL(location.href); u.searchParams.delete('id'); history.replaceState({},'',u);
    });

    viewerThumbSmall.addEventListener('click',()=>{
      if(viewerThumbSmall.src){ largeImgView.src=viewerThumbSmall.src; largeImgOverlay.style.display='flex'; }
    });

    largeImgOverlay.addEventListener('click',()=>{ largeImgOverlay.style.display='none'; });

    viewerSubmitProofBtn.addEventListener('click',async()=>{
      if(!currentUser){ viewerProofStatus.textContent='Sign in required'; return; }
      const t=viewerProofText.value.trim(), f=viewerProofImage.files[0];
      if(!t && !f){ viewerProofStatus.textContent='Provide text or image'; return; }
      viewerSubmitProofBtn.disabled=true; viewerProofStatus.textContent='Submitting…';
      try{ let img=null; if(f) img=await uploadImgur(f); await submitProof(activeTaskId,t,img); viewerProofStatus.textContent='Submitted (pending review)'; }
      catch{ viewerProofStatus.textContent='Failed to submit'; }
      viewerSubmitProofBtn.disabled=false;
    });

    window.addEventListener('popstate',e=>{ if(!e.state?.task) taskViewer.style.display='none'; });

    window.addEventListener('load',()=>{
      startAdvertsListener();
      const id=new URL(location.href).searchParams.get('id');
      if(id) openFullPageTask(id);
    });

  </script>
</body>
</html>
