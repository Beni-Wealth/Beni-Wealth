<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tasks — Beni-Wealth</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Favicons & Social preview -->
  <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <meta name="theme-color" content="#2fe0b8">

  <style>
    /* your existing styles here… (exactly the same as your original page) */
    :root{
      --bg-1: #0b0613;
      --bg-2: #0f0820;
      --panel: rgba(255,255,255,0.03);
      --muted: rgba(255,255,255,0.62);
      --text: #eaf2ff;
      --accent-a: #8446ff;
      --accent-b: #6ce2c8;
      --accent-grad: linear-gradient(135deg, var(--accent-a), #5b3bff 45%, var(--accent-b) 100%);
      --glass: rgba(255,255,255,0.03);
      --radius: 16px;
      --container-w: 420px;
      font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      min-height:100%;
      background: radial-gradient(1000px 600px at 10% 10%, rgba(123,61,255,0.10), transparent),
                  radial-gradient(900px 500px at 90% 90%, rgba(47,224,184,0.06), transparent),
                  linear-gradient(180deg,var(--bg-1),var(--bg-2));
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:20px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    /* … rest of your existing CSS from the original page … */

    /* Full Page Viewer Styles */
    .viewer-page {
      position: fixed;
      inset: 0;
      background: #071022;
      z-index: 9999;
      overflow:auto;
      padding: 24px;
      display: none;
    }
    .viewer-header {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
    }
    .viewer-back {
      padding: 8px 12px;
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 8px;
      cursor: pointer;
      color: var(--muted);
      background: transparent;
    }
    .viewer-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
    }
    .viewer-content img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 12px;
    }
    .viewer-content a {
      color: var(--accent-b);
      text-decoration: underline;
    }
    .viewer-content .small {
      color: var(--text);
      margin-top: 8px;
    }
  </style>
</head>
<body>

  <!-- main tasks UI -->
  <div class="phone" role="main">
    <div class="top">
      <a class="back" href="dashboard.html">← Dashboard</a>
      <div style="text-align:right;flex:1">
        <div class="title">Available Tasks</div>
        <div class="sub">Complete quick micro‑tasks and earn. Follow proof rules carefully.</div>
      </div>
    </div>

    <div class="controls">
      <input id="search" class="search" placeholder="Search by title or platform" />
      <button id="refresh" class="btn ghost">Refresh</button>
    </div>

    <div id="grid" class="grid">
      <div class="empty">Loading tasks…</div>
    </div>
  </div>

  <!-- full page task viewer -->
  <div id="taskViewer" class="viewer-page" aria-hidden="true">
    <div class="viewer-header">
      <button id="taskBackBtn" class="viewer-back">← Back</button>
      <div class="viewer-title" id="v_title">Task Title</div>
    </div>
    <div class="viewer-content">
      <div id="v_platform" class="small"></div>
      <div id="v_price" class="small"></div>
      <img id="v_thumb" style="display:none" />
      <p id="v_desc" class="small"></p>
      <div class="small">Task Link:</div>
      <a id="v_link" href="#" target="_blank"></a>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getFirestore, collection, query, where, onSnapshot, doc, getDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const grid = document.getElementById('grid');
    const search = document.getElementById('search');
    const refresh = document.getElementById('refresh');

    let advertsCache = new Map();

    function formatNGN(n){
      try { return '₦' + Math.round(n).toLocaleString('en‑NG'); }
      catch { return '₦' + n; }
    }
    function deriveUnitPrice(adData) {
      const maybe = Number(adData?.unitPrice ?? adData?.unit_price ?? adData?.unit ?? NaN);
      if (!isNaN(maybe) && maybe > 0) return maybe;
      const total = Number(adData?.totalCost ?? adData?.total_cost ?? adData?.total ?? 0) || 0;
      const workers = Number(adData?.workers || adData?.worker_count || 0) || 0;
      if (workers > 0) return total / workers;
      return 0;
    }

    function renderAdvertCard(ad) {
      const id = ad.id;
      const data = ad.data;
      if (data.status !== 'approved') return null;

      const unit = deriveUnitPrice(data);
      const price = Math.round(unit * 0.7);

      const card = document.createElement('div');
      card.className = 'card';

      const thumb = document.createElement('img');
      thumb.className = 'thumb';
      thumb.src = data.thumbnail || '';
      if (!data.thumbnail) thumb.style.display = 'none';

      const body = document.createElement('div');
      body.className = 'card-body';

      const title = document.createElement('h3');
      title.textContent = data.title;

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `<div>${data.platform}</div><div>${formatNGN(price)}</div>`;

      const openBtn = document.createElement('button');
      openBtn.className = 'btn';
      openBtn.textContent = 'Open Task';
      openBtn.addEventListener('click', () => openFullPageTask(id));

      body.append(title, meta, openBtn);
      card.append(thumb, body);
      return card;
    }

    function rebuildGrid(){
      const q = (search.value || '').trim().toLowerCase();
      grid.innerHTML = '';
      let any = false;
      advertsCache.forEach(ad => {
        if (q) {
          const hay = ((ad.data.title || '') + ' ' + (ad.data.platform || '')).toLowerCase();
          if (!hay.includes(q)) return;
        }
        const node = renderAdvertCard(ad);
        if (node) { grid.appendChild(node); any = true; }
      });
      if (!any) grid.innerHTML = `<div class="empty">No tasks available.</div>`;
    }

    function startAdvertsListener(){
      advertsCache.clear();
      grid.innerHTML = `<div class="empty">Loading tasks…</div>`;
      const advertsQ = query(collection(db, 'advertise_tasks'), where('status','==','approved'));
      onSnapshot(advertsQ, snap => {
        advertsCache.clear();
        snap.forEach(docSnap => advertsCache.set(docSnap.id, { id: docSnap.id, data: docSnap.data() }));
        rebuildGrid();
      }, () => grid.innerHTML = `<div class="empty">Failed to load tasks</div>`);
    }

    onAuthStateChanged(auth, () => startAdvertsListener());
    refresh.addEventListener('click', startAdvertsListener);
    search.addEventListener('input', rebuildGrid);

    // ---- Full Page Viewer Logic ----
    const taskViewer = document.getElementById('taskViewer');
    const taskBackBtn = document.getElementById('taskBackBtn');
    const v_title = document.getElementById('v_title');
    const v_platform = document.getElementById('v_platform');
    const v_price = document.getElementById('v_price');
    const v_thumb = document.getElementById('v_thumb');
    const v_desc = document.getElementById('v_desc');
    const v_link = document.getElementById('v_link');

    async function openFullPageTask(id) {
      try {
        const newUrl = new URL(window.location.href);
        newUrl.searchParams.set('id', id);
        history.pushState({ taskViewer: true, id }, '', newUrl.toString());

        taskViewer.style.display = 'block';
        taskViewer.setAttribute('aria-hidden','false');

        const snap = await getDoc(doc(db,'advertise_tasks',id));
        if (!snap.exists()) return;

        const data = snap.data();
        v_title.textContent = data.title;
        v_platform.textContent = data.platform;
        v_price.textContent = formatNGN(Math.round(deriveUnitPrice(data)*0.7));
        v_desc.textContent = data.description;
        v_link.href = data.taskLink || data.task_link || '#';
        v_link.textContent = data.taskLink || data.task_link || '';

        if (data.thumbnail) {
          v_thumb.src = data.thumbnail;
          v_thumb.style.display = 'block';
        } else {
          v_thumb.style.display = 'none';
        }
      } catch {}
    }

    function hideTaskViewer(){
      taskViewer.style.display = 'none';
      taskViewer.setAttribute('aria-hidden','true');
      const u = new URL(window.location.href);
      u.searchParams.delete('id');
      history.replaceState({}, '', u.toString());
    }

    taskBackBtn.addEventListener('click', () => {
      if (history.state?.taskViewer) history.back();
      else hideTaskViewer();
    });

    window.addEventListener('popstate', ev => {
      if (!ev.state?.taskViewer) hideTaskViewer();
    });

    window.addEventListener('load', () => {
      const id = new URL(window.location.href).searchParams.get('id');
      if (id) openFullPageTask(id);
    });

  </script>
</body>
</html>
