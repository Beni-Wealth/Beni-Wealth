<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Beni-Wealth â€” Memory Flip</title>

  <!-- Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300,400,600,700&display=swap" rel="stylesheet"/>

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">

  <style>
    :root{
      --bg1:#071021; --bg2:#0d1224; --text:#eaf2ff; --muted:rgba(255,255,255,0.66);
      --accent:#7a5fff; --success:#10b981; --danger:#ef4444;
      font-family:"Poppins",system-ui,Roboto,Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:radial-gradient(800px 400px at 10% 10%, rgba(122,95,255,0.04), transparent), linear-gradient(180deg,var(--bg1),var(--bg2)); color:var(--text);}
    .wrap{max-width:980px;margin:18px auto;padding:14px}
    .controls, .hud{display:flex;gap:10px;align-items:center}
    .btn{background:linear-gradient(90deg,var(--accent),#35d6b1);border:0;padding:10px 14px;border-radius:10px;color:#041219;font-weight:800;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
    .board{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}
    .tile{aspect-ratio:1/1;border-radius:10px;background:rgba(255,255,255,0.02);display:grid;place-items:center;font-size:clamp(14px,3.8vw,22px);cursor:pointer;border:2px solid rgba(255,255,255,0.03)}
    .tile.flipped{background:rgba(255,255,255,0.15);color:#041219}
    .tile.matched{background:rgba(16,185,129,0.2);border-color:rgba(16,185,129,0.6);color:#041219;cursor:default}
    .log{margin-top:12px;max-height:260px;overflow:auto;padding:10px;border-radius:8px;background:rgba(255,255,255,0.01);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Memory Flip â€” You vs Bot</h2>

    <div class="controls">
      <div>Balance: <span id="balance">â‚¦0.00</span></div>
      <button id="playBtn" class="btn">Play (â‚¦20)</button>
    </div>

    <div class="board" id="board"></div>

    <div class="hud">
      <div>You: <span id="playerScore">0</span></div>
      <div>Bot: <span id="botScore">0</span></div>
      <div>MMR: <span id="playerMMR">1000</span></div>
      <div>Win streak: <span id="winStreak">0</span></div>
    </div>

    <div class="log" id="gamelog"><div style="color:var(--muted)">No activity yet</div></div>
  </div>

  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, runTransaction, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web=e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const boardEl = document.getElementById('board');
    const playBtn = document.getElementById('playBtn');
    const balanceEl = document.getElementById('balance');
    const playerScoreEl = document.getElementById('playerScore');
    const botScoreEl = document.getElementById('botScore');
    const gamelog = document.getElementById('gamelog');
    const playerMMREl = document.getElementById('playerMMR');
    const winStreakEl = document.getElementById('winStreak');

    const ENTRY_FEE = 20, WIN_REWARD = 50;
    const fruits = ['ðŸŽ','ðŸŒ','ðŸ‡','ðŸ“','ðŸ‰','ðŸ¥­','ðŸ','ðŸ‘'];

    let currentUser = null, userBalance = 0;
    let tiles = [], firstFlip = null, secondFlip = null;
    let lockBoard = true, playerScore = 0, botScore = 0, remainingPairs = 0;
    let turn = 'none';
    let playerMMR = 1000, winStreak = 0, maxWinStreak = 0;

    function formatN(n){ return 'â‚¦'+Number(n||0).toLocaleString('en-NG',{minimumFractionDigits:2,maximumFractionDigits:2}); }
    function log(msg){
      const div=document.createElement('div'); div.textContent=msg;
      if(gamelog.firstChild?.style?.color==='var(--muted)') gamelog.innerHTML='';
      gamelog.prepend(div);
    }
    async function refreshBalance(){
      if(!currentUser){ balanceEl.textContent=formatN(0); return; }
      try{
        const uRef=doc(db,'users',currentUser.uid),snap=await getDoc(uRef);
        userBalance = snap.exists()?Number(snap.data().balance||0):0;
      } catch{}
      balanceEl.textContent=formatN(userBalance);
    }

    async function fetchStats(){
      if(!currentUser) return;
      const sRef=doc(db,'memoryGames',currentUser.uid),snap=await getDoc(sRef);
      if(snap.exists()){ const d=snap.data();
        playerMMR=d.mmr||1000; winStreak=d.currentWinStreak||0; maxWinStreak=d.maxWinStreak||0;
      }
      playerMMREl.textContent=playerMMR; winStreakEl.textContent=winStreak;
    }

    function createBoard(){
      boardEl.innerHTML=''; tiles=[];
      firstFlip=secondFlip=null; lockBoard=true;
      playerScore=0; botScore=0; playerScoreEl.textContent='0'; botScoreEl.textContent='0';
      const vals=[...Array(8).keys()].flatMap(i=>[i,i]).sort(()=>Math.random()-0.5);
      remainingPairs=vals.length/2;
      vals.forEach(v=>{
        const tile=document.createElement('div');
        tile.className='tile'; tile.dataset.value=v; tile.dataset.emoji=fruits[v];
        tile.addEventListener('click',()=>{ if(turn==='player') flipCard(tile); });
        boardEl.appendChild(tile); tiles.push(tile);
      });
      lockBoard=false; turn='player';
      log('Game started â€” Your turn');
    }

    function flipCard(tile){
      if(lockBoard||tile.classList.contains('flipped')||tile.classList.contains('matched')) return;
      tile.classList.add('flipped'); tile.textContent=tile.dataset.emoji;
      if(!firstFlip){ firstFlip=tile; return; }
      secondFlip=tile; lockBoard=true; setTimeout(checkMatch,300);
    }

    function nextTurn(){ turn = turn==='player'?'bot':'player'; log(turn==='player'?"Your turn":"Bot's turn"); }

    function checkMatch(){
      const match = firstFlip.dataset.value===secondFlip.dataset.value;
      if(match){
        firstFlip.classList.add('matched'); secondFlip.classList.add('matched');
        if(turn==='player'){ playerScore++; playerScoreEl.textContent=playerScore; log('You matched!'); }
        else { botScore++; botScoreEl.textContent=botScore; log('Bot matched!'); }
        remainingPairs--;
        firstFlip=secondFlip=null; lockBoard=false;
        if(remainingPairs===0) return finishGame();
        if(turn==='bot') setTimeout(botPlay,500);
      } else {
        setTimeout(()=>{
          firstFlip.classList.remove('flipped'); firstFlip.textContent='';
          secondFlip.classList.remove('flipped'); secondFlip.textContent='';
          firstFlip=secondFlip=null; lockBoard=false; nextTurn();
          if(turn==='bot') setTimeout(botPlay,600);
        },600);
      }
    }

    function botPlay(){
      if(turn!=='bot'||lockBoard) return;
      lockBoard=true;
      const unseen=tiles.filter(t=>!t.classList.contains('flipped')&&!t.classList.contains('matched'));
      if(unseen.length===0) return;
      const pick1=unseen[Math.floor(Math.random()*unseen.length)];
      flipCard(pick1);
      setTimeout(()=>{
        const unseen2=tiles.filter(t=>!t.classList.contains('flipped')&&!t.classList.contains('matched'));
        if(unseen2.length){
          const pick2=unseen2[Math.floor(Math.random()*unseen2.length)];
          flipCard(pick2);
        }
      },500);
    }

    async function finishGame(){
      const didWin = playerScore>botScore;
      log(didWin?'You won!':'Bot won!');
      updateStats(didWin);
    }

    async function updateStats(didWin){
      if(!currentUser) return;
      if(didWin) winStreak++; else winStreak=0;
      playerMMR += didWin?20:-15; maxWinStreak=Math.max(maxWinStreak,winStreak);
      await setDoc(doc(db,'memoryGames',currentUser.uid),{ mmr:playerMMR,currentWinStreak:winStreak,maxWinStreak,updatedAt:serverTimestamp() },{merge:true});
      playerMMREl.textContent=playerMMR; winStreakEl.textContent=winStreak;
    }

    playBtn.addEventListener('click',async()=>{
      if(!currentUser){ alert('Sign in'); return; }
      if(userBalance<ENTRY_FEE){ alert('Insufficient funds'); return; }
      await runTransaction(db,async t=>{
        const uRef=doc(db,'users',currentUser.uid),us=await t.get(uRef);
        const bal=us.exists()?Number(us.data().balance||0):0;
        if(bal<ENTRY_FEE) throw 'nf';
        t.update(uRef,{ balance:bal-ENTRY_FEE }); userBalance=bal-ENTRY_FEE;
      });
      refreshBalance(); createBoard();
    });

    onAuthStateChanged(auth,async user=>{ currentUser=user; refreshBalance(); fetchStats(); });
  </script>
</body>
</html>
