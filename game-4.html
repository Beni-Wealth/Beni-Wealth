<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Beni-Wealth ‚Äî Raffle Draw</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

<style>
  body {
    font-family:'Poppins',system-ui,Arial;
    background:#0e0b22;
    color:#eaf2ff;
    margin:0;padding:0;
  }

  .page {
    max-width:700px; margin: auto; padding:20px;
  }
  header {
    text-align:center;
    margin-bottom:24px;
  }
  header h1 {
    font-size:2rem;
    color:#35d6b1;
    margin:0;
  }
  header p {
    color:rgba(255,255,255,0.7);
    font-size:14px;
  }

  .card {
    background:#131120;
    padding:18px;
    border-radius:12px;
    box-shadow:0 4px 16px rgba(0,0,0,0.4);
    margin-bottom:24px;
    text-align:center;
  }

  .timer {
    font-size:22px; font-weight:700;
    color:#7a5fff; margin-bottom:16px;
  }

  .controls {
    display:flex; justify-content:center; gap:12px;
    margin-bottom:12px;
  }
  .controls input {
    width:100px; padding:10px;
    border-radius:8px; border:1px solid rgba(255,255,255,0.2);
    text-align:center; font-size:16px;
  }
  .controls button {
    padding:10px 18px;
    border:none;border-radius:8px;
    background:#35d6b1;color:#041219;
    font-weight:700;cursor:pointer;
    transition:0.2s ease;
  }
  .controls button:hover {
    background:#2bb39d;
  }

  #msg {
    text-align:center;
    font-size:15px;
    margin-top:12px;
    color:#ffd700;
  }

  #luckyNumbers {
    font-size:18px; font-weight:700;
    text-align:center;
    color:#35d6b1;
    margin-top:20px;
  }

  /* Modal overlay */
  .modal {
    display:none; position:fixed;
    top:0;left:0; width:100%;height:100%;
    background:rgba(0,0,0,0.8);
    justify-content:center;align-items:center;
    padding:20px;z-index:10;
  }

  .modal-content {
    background:#0f0c24;
    padding:18px; border-radius:10px;
    width:100%; max-width:380px;
    box-shadow:0 6px 24px rgba(0,0,0,0.5);
    text-align:center;
  }

  .modal-content h2 {
    margin-top:0; color:#35d6b1;
  }
  .modal-content ul {
    list-style:none; padding:0; margin:12px 0;
  }
  .modal-content li {
    background:#131026; padding:8px;
    border-radius:6px; margin:6px 0;
    font-size:16px;
  }

  .close-btn {
    display:block;
    margin-top:14px;
    padding:8px 12px;
    background:#7a5fff; color:#041219;
    border:none; border-radius:6px;
    font-weight:700; cursor:pointer;
  }

  /* Confirmation overlay */
  .confirm-box {
    background:#1c1935;
    border-radius:12px;
    padding:18px;
  }
  .confirm-btns {
    display:flex; gap:10px;
    justify-content: center; margin-top:14px;
  }
  .confirm-btn {
    padding:10px 20px;
    border:none;border-radius:8px;
    font-weight:700;cursor:pointer;
  }
  .confirm-confirm { background:#35d6b1; color:#041219; }
  .confirm-cancel { background:#7a5fff; color:#041219; }
</style>
</head>

<body>
<div class="page">

  <header>
    <h1>üéüÔ∏è Raffle Draw</h1>
    <p>Select your lucky numbers! Each ticket costs ‚Ç¶50.</p>
  </header>

  <div class="card">
    <div id="timer" class="timer">Initializing raffle timer‚Ä¶</div>

    <div class="controls">
      <input id="pickInput" type="number" min="1" max="100" placeholder="1‚Äì100"/>
      <button id="pickBtn">Pick Ticket</button>
      <button id="viewHistoryBtn">My Picks</button>
    </div>

    <div id="msg"></div>
    <div id="luckyNumbers"></div>
  </div>

</div>

<!-- History Modal -->
<div id="historyModal" class="modal">
  <div class="modal-content">
    <h2>Your Picks</h2>
    <ul id="picksList"></ul>
    <button id="closeModal" class="close-btn">Close</button>
  </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal">
  <div class="modal-content confirm-box">
    <h2>Confirm Ticket Pick</h2>
    <p>Are you sure you want to buy ticket number <span id="confirmNum"></span> for ‚Ç¶50?</p>
    <div class="confirm-btns">
      <button id="confirmYes" class="confirm-btn confirm-confirm">Yes</button>
      <button id="confirmNo" class="confirm-btn confirm-cancel">No</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, query, where,
  addDoc, getDocs, updateDoc, doc,
  serverTimestamp, Timestamp, limit
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

// Firebase init
const firebaseConfig = {
  apiKey:"AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
  authDomain:"beni-wealths.firebaseapp.com",
  projectId:"beni-wealths",
  storageBucket:"beni-wealths.appspot.com",
  messagingSenderId:"807950483822",
  appId:"1:807950483822:web=e10fa87307e041c4d8417f",
  measurementId:"G-Z2XP3YN6NS"
};
if(!getApps().length) initializeApp(firebaseConfig);
const db = getFirestore();
const auth = getAuth();

let currentUser = null;
let activeCycle = null;
let pendingPick = null;

// Elements
const timerEl = document.getElementById("timer");
const pickInput = document.getElementById("pickInput");
const pickBtn = document.getElementById("pickBtn");
const msgEl = document.getElementById("msg");
const luckyEl = document.getElementById("luckyNumbers");
const viewHistoryBtn = document.getElementById("viewHistoryBtn");

// History modal
const historyModal = document.getElementById("historyModal");
const closeModal = document.getElementById("closeModal");
const picksListEl = document.getElementById("picksList");

// Confirm modal
const confirmModal = document.getElementById("confirmModal");
const confirmNum = document.getElementById("confirmNum");
const confirmYes = document.getElementById("confirmYes");
const confirmNo = document.getElementById("confirmNo");

// Auth
onAuthStateChanged(auth, user => {
  currentUser = user;
  if(!user){
    msgEl.textContent = "Sign in to participate!";
    pickBtn.disabled=true;
    viewHistoryBtn.disabled=true;
  }
});

// get active cycle
async function initCycle(){
  const now=Timestamp.now();
  const snap=await getDocs(query(collection(db,"raffleCycles"),
    where("endAt",">",now),
    where("completed","==",false),
    limit(1)
  ));
  if(!snap.empty){
    activeCycle = snap.docs[0];
  } else {
    const start = Timestamp.now();
    const end = Timestamp.fromMillis(start.toMillis()+48*60*60*1000);
    const ref = await addDoc(collection(db,"raffleCycles"),{
      startAt:start, endAt:end, luckyNumbers:[], completed:false
    });
    activeCycle = (await getDocs(query(collection(db,"raffleCycles"),
      where("__name__", "==", ref.id)
    ))).docs[0];
  }
  startTimer();
  showLucky();
}
function startTimer(){
  const end = activeCycle.data().endAt.toMillis();
  const interval = setInterval(async ()=>{
    const diff=end-Date.now();
    if(diff<=0){
      clearInterval(interval);
      timerEl.textContent="Drawing lucky numbers now‚Ä¶";
      await drawLucky();
    } else {
      const hrs=Math.floor(diff/3600000);
      const mins=Math.floor((diff%3600000)/60000);
      const secs=Math.floor((diff%60000)/1000);
      timerEl.textContent=`${hrs}h ${mins}m ${secs}s left`;
    }
  },1000);
}

// Show history
viewHistoryBtn.addEventListener("click", async ()=>{
  picksListEl.innerHTML="Loading your picks‚Ä¶";
  historyModal.style.display="flex";
  const q = query(collection(db,"rafflePicks"),
    where("userUid","==",currentUser.uid),
    where("cycleId","==",activeCycle.id)
  );
  const s = await getDocs(q);
  picksListEl.innerHTML="";
  if(s.empty) {
    picksListEl.innerHTML="<li>No picks yet</li>";
  }
  s.forEach(d=>{
    const li = document.createElement("li");
    li.textContent = "#"+d.data().pickNumber;
    picksListEl.appendChild(li);
  });
});
closeModal.onclick = ()=> historyModal.style.display="none";

// Ticket pick with confirmation
pickBtn.onclick = ()=>{
  const num=parseInt(pickInput.value);
  if(!num||num<1||num>100){ msgEl.textContent="Pick 1‚Äì100"; return;}
  pendingPick=num;
  confirmNum.textContent=num;
  confirmModal.style.display="flex";
};
confirmNo.onclick = ()=> confirmModal.style.display="none";

confirmYes.onclick = async ()=>{
  confirmModal.style.display="none";
  if(!currentUser) return;
  const pickNum = pendingPick;
  pendingPick = null;
  const q = query(collection(db,"rafflePicks"),
    where("userUid","==",currentUser.uid),
    where("cycleId","==",activeCycle.id)
  );
  const snap=await getDocs(q);
  if(snap.size>=100){ msgEl.textContent="Max 100 tickets"; return;}
  await addDoc(collection(db,"rafflePicks"),{
    userUid:currentUser.uid,
    pickNumber:pickNum,
    cycleId:activeCycle.id,
    createdAt:serverTimestamp()
  });
  msgEl.textContent=`Picked #${pickNum} ‚Äî Good luck!`;
};

// Draw and credit function same as before (omitted for brevity)
// Make sure to include your raffle credit logic here

function showLucky(){
  const d=activeCycle.data();
  if(d.luckyNumbers?.length){
    luckyEl.textContent="Lucky: "+d.luckyNumbers.join(", ");
  }
}

initCycle();

</script>
</body>
</html>
