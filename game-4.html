<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Beni-Wealth ‚Äî Raffle Draw</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>
<style>
  body{font-family:'Poppins',system-ui,Arial;background:#0f0820;color:#eaf2ff;padding:18px;}
  h1{text-align:center;color:#35d6b1;margin-bottom:10px;}
  .container{max-width:600px;margin:auto;}
  .timer{font-size:20px;text-align:center;margin:10px 0;color:#7a5fff;}
  input[type=number]{width:80px;padding:10px;border-radius:8px;border:none;font-size:16px;}
  button{padding:10px 16px;border:none;border-radius:8px;background:#35d6b1;color:#041219;font-weight:700;cursor:pointer;}
  #msg{margin:12px 0;text-align:center;color:#ffd700;}
  #luckyNumbers{margin-top:20px;text-align:center;font-size:18px;color:#35d6b1;font-weight:700;}

  /* Modal Styles */
  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;}
  .modal-content{background:#0d0b1c;color:#eaf2ff;padding:20px;border-radius:12px;width:90%;max-width:400px;}
  .modal h2{margin-top:0;}
  .modal ul{list-style:none;padding:0;margin:0;}
  .modal li{padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.1);}
  .close-btn{cursor:pointer;color:#35d6b1;font-weight:700;float:right;font-size:18px;}
</style>
</head>
<body>

<div class="container">
  <h1>üéüÔ∏è Raffle Draw</h1>
  <div id="timer" class="timer">Loading raffle timer‚Ä¶</div>

  <div>
    <input id="pickInput" type="number" min="1" max="100" placeholder="1‚Äì100"/>
    <button id="pickBtn">Pick (‚Ç¶50)</button>
    <button id="viewHistoryBtn">My Picks</button>
  </div>

  <div id="msg"></div>
  <div id="luckyNumbers"></div>
</div>

<!-- History Modal -->
<div id="historyModal" class="modal">
  <div class="modal-content">
    <span id="closeModal" class="close-btn">‚úñ</span>
    <h2>Your Picks</h2>
    <ul id="picksList"></ul>
  </div>
</div>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, query, where,
  addDoc, getDocs, updateDoc, doc,
  serverTimestamp, Timestamp, limit
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey:"AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
  authDomain:"beni-wealths.firebaseapp.com",
  projectId:"beni-wealths",
  storageBucket:"beni-wealths.appspot.com",
  messagingSenderId:"807950483822",
  appId:"1:807950483822:web=e10fa87307e041c4d8417f",
  measurementId:"G-Z2XP3YN6NS"
};

if(!getApps().length) initializeApp(firebaseConfig);
const db = getFirestore();
const auth = getAuth();

let currentUser = null;
let activeCycle = null;

// UI
const timerEl = document.getElementById("timer");
const pickInput = document.getElementById("pickInput");
const pickBtn = document.getElementById("pickBtn");
const msgEl = document.getElementById("msg");
const luckyEl = document.getElementById("luckyNumbers");
const viewHistoryBtn = document.getElementById("viewHistoryBtn");

// Modal
const historyModal = document.getElementById("historyModal");
const closeModal = document.getElementById("closeModal");
const picksListEl = document.getElementById("picksList");

// Auth
onAuthStateChanged(auth, user => {
  currentUser = user;
  if(!user){
    msgEl.textContent = "Sign in to participate in raffle.";
    pickBtn.disabled = true;
    viewHistoryBtn.disabled = true;
  }
});

// Get or create raffle cycle
async function initCycle(){
  const now = Timestamp.now();
  const cyclesSnap = await getDocs(query(collection(db,"raffleCycles"),
    where("endAt",">",now),
    where("completed","==",false),
    limit(1)
  ));
  if(!cyclesSnap.empty){
    activeCycle = cyclesSnap.docs[0];
  } else {
    const start = Timestamp.now();
    const end = Timestamp.fromMillis(start.toMillis()+48*60*60*1000);
    const newRef = await addDoc(collection(db,"raffleCycles"),{
      startAt:start, endAt:end, luckyNumbers:[], completed:false
    });
    activeCycle = (await getDocs(query(collection(db,"raffleCycles"),
      where("__name__","==", newRef.id)
    ))).docs[0];
  }
  runTimer();
  displayLucky();
}

// Timer
function runTimer(){
  const end = activeCycle.data().endAt.toMillis();
  const interval = setInterval(async ()=>{
    const diff = end - Date.now();
    if(diff <= 0){
      clearInterval(interval);
      timerEl.textContent = "Raffle ended ‚Äî drawing numbers‚Ä¶";
      await drawLucky();
    } else {
      const hrs = Math.floor(diff/3600000);
      const mins = Math.floor((diff%3600000)/60000);
      const secs = Math.floor((diff%60000)/1000);
      timerEl.textContent = `Time left: ${hrs}h ${mins}m ${secs}s`;
    }
  }, 1000);
}

// Pick handling with ticket limit
pickBtn.addEventListener("click", async ()=>{
  if(!currentUser) return;

  const pickNum = parseInt(pickInput.value);
  if(!pickNum || pickNum < 1 || pickNum > 100){
    msgEl.textContent = "Choose a number from 1 to 100";
    return;
  }

  // Count user picks for this cycle
  const userPickQuery = query(collection(db,"rafflePicks"),
    where("userUid","==",currentUser.uid),
    where("cycleId","==", activeCycle.id));
  const userPicksSnap = await getDocs(userPickQuery);

  if(userPicksSnap.size >= 100){
    msgEl.textContent = "You've reached the 100 ticket limit";
    return;
  }

  // Debit ‚Ç¶50 ‚Äî implement secure balance subtraction with Cloud Function / backend
  await addDoc(collection(db,"rafflePicks"),{
    userUid: currentUser.uid,
    pickNumber: pickNum,
    cycleId: activeCycle.id,
    createdAt: serverTimestamp()
  });

  msgEl.textContent = `Number ${pickNum} picked!`;
  pickInput.value = "";
});

// Show past picks modal
viewHistoryBtn.addEventListener("click", async ()=>{
  picksListEl.innerHTML = "Loading your picks‚Ä¶";
  historyModal.style.display = "flex";
  const histQuery = query(collection(db,"rafflePicks"),
    where("userUid","==",currentUser.uid),
    where("cycleId","==",activeCycle.id));
  const snap = await getDocs(histQuery);

  picksListEl.innerHTML = "";
  if(snap.empty){
    picksListEl.innerHTML = "<li>No picks yet</li>";
  }
  snap.forEach(doc=>{
    const data = doc.data();
    const li = document.createElement("li");
    li.textContent = `#${data.pickNumber}`;
    picksListEl.appendChild(li);
  });
});
closeModal.addEventListener("click", ()=> historyModal.style.display = "none");

// Draw lucky numbers after cycle end and credit winners
async function drawLucky(){
  const nums = new Set();
  while(nums.size < 5) nums.add(Math.floor(Math.random()*100)+1);
  const lucky = Array.from(nums);

  // Update cycle
  await updateDoc(doc(db,"raffleCycles",activeCycle.id),{
    luckyNumbers: lucky,
    completed: true
  });
  displayLucky();

  // Credit winners
  const picksSnap = await getDocs(query(collection(db,"rafflePicks"),
    where("cycleId","==",activeCycle.id)));

  const userHits = {};
  picksSnap.forEach(doc=>{
    const d = doc.data();
    if(lucky.includes(d.pickNumber)){
      userHits[d.userUid] = (userHits[d.userUid]||0)+1;
    }
  });

  for(const uid in userHits){
    const hits = userHits[uid];
    const amount = hits * 500;
    await addDoc(collection(db,"transactions"),{
      userId: uid,
      type: "raffle_win",
      amount: amount,
      note: `Won ${hits} raffle pick(s)`,
      createdAt: serverTimestamp()
    });
    await updateDoc(doc(db,"users",uid),{
      balance: serverTimestamp() // replace with actual money addition logic
    });
  }

  msgEl.textContent = "Lucky numbers drawn!";
}

function displayLucky(){
  const d = activeCycle.data();
  if(d.luckyNumbers && d.luckyNumbers.length){
    luckyEl.textContent = `Lucky Numbers: ${d.luckyNumbers.join(", ")}`;
  }
}

initCycle();

</script>
</body>
</html>
