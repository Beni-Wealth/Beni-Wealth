<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beni-Wealth — PTC Catalog</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <meta name="theme-color" content="#7a5fff" />
  <style>
    :root{
      --bg:#0b0613; --panel:#0f0820; --muted:rgba(255,255,255,0.62); --card:#0f1120;
      --accent1:#7a5fff; --accent2:#35d6b1; --text:#eaf2ff; --gap:14px; --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Arial;}
    body{background:linear-gradient(180deg,var(--bg),var(--panel)); color:var(--text); padding:18px;}
    .wrap{max-width:1100px;margin:0 auto;}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:18px;}
    .search{padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);min-width:200px;}
    .filter{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);}
    .signinBtn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#041219;}
    .grid{display:grid;grid-template-columns:1fr;gap:var(--gap);}
    @media(min-width:600px){ .grid{grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); } }
    .card{background:var(--card);padding:14px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:10px;}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);color:var(--muted);}
    .btn{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:800;font-size:14px;}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#041219;flex:1;}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);}
    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:rgba(0,0,0,0.7);color:#fff;padding:10px 14px;border-radius:8px;font-size:14px;display:none;}
    .toast.show{display:block;}
  </style>
</head>
<body>

<div class="wrap">
  <header>
    <div>
      <h1 style="margin:0;font-size:20px;">PTC Catalog</h1>
      <div style="color:var(--muted);font-size:13px;">Tap a card to open the PTC</div>
    </div>
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
      <input id="searchInput" class="search" placeholder="Search PTC…">
      <select id="filterSelect" class="filter">
        <option value="all">All</option>
        <option value="fresh">Unvisited</option>
        <option value="visited">Visited</option>
      </select>
      <button id="signinBtn" class="signinBtn">Sign in</button>
    </div>
  </header>

  <div id="grid" class="grid"></div>
</div>

<div id="toast" class="toast"></div>

<!-- IFRAME VIEWER OVERLAY -->
<div id="ptcViewerOverlay" style="display:none;position:fixed;inset:0;background:#000000cc;z-index:9999;align-items:center;justify-content:center;flex-direction:column;">
  <div style="position:absolute;top:12px;left:12px;display:flex;gap:10px;align-items:center;color:#fff;font-size:16px;font-weight:700;">
    <div id="viewerTimer">Wait: 10s</div>
    <button id="viewerCloseBtn" style="padding:6px 10px;border:none;border-radius:6px;background:#ff4455;color:#fff;cursor:pointer;">Close</button>
  </div>
  <iframe id="ptcIframe" style="width:100%;height:100%;border:none;" sandbox="allow-scripts allow-forms allow-popups allow-same-origin"></iframe>
</div>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  addDoc, collection, serverTimestamp, increment
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
  authDomain: "beni-wealths.firebaseapp.com",
  projectId: "beni-wealths",
  storageBucket: "beni-wealths.appspot.com",
  messagingSenderId: "807950483822",
  appId: "1:807950483822:web=e10fa87307e041c4d8417f",
  measurementId: "G-Z2XP3YN6NS"
};

if(!getApps().length) initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

const GRID = document.getElementById('grid');
const searchInput = document.getElementById('searchInput');
const filterSelect = document.getElementById('filterSelect');
const signinBtn = document.getElementById('signinBtn');
const toast = document.getElementById('toast');

const REWARD = 0.40;
const COOLDOWN_MS = 1 * 60 * 60 * 1000;

// ADD URLs for the 5 initial PTCs
const PTCs = [
  { id:1,title:"AFCON Camp Update",description:"Tap to read",reward:"0.40",url:"https://www.dirtynaija.ng/articles/afcon-2025-nigeria-relocates-training-camp-to-morocco-ahead-of-december-kickoff" },
  { id:2,title:"The Missing Necklace",description:"Tap to read",reward:"0.40",url:"https://www.dirtynaija.ng/articles/the-case-of-the-missing-necklace" },
  { id:3,title:"The Call That Mattered",description:"Tap to read",reward:"0.40",url:"https://www.dirtynaija.ng/articles/the-call-that-mattered" },
  { id:4,title:"Charger Hunters Story",description:"Tap to read",reward:"0.40",url:"https://www.dirtynaija.ng/articles/how-1-battery-turns-siblings-into-expert-charger-hunters" },
  { id:5,title:"Bench Under The Tree",description:"Tap to read",reward:"0.40",url:"https://www.dirtynaija.ng/articles/the-bench-under-the-tree" }
];

function showToast(msg,ms=3000){
  toast.textContent = msg; toast.classList.add('show');
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>toast.classList.remove('show'),ms);
}

let currentUser = null;
const provider = new GoogleAuthProvider();
signinBtn.addEventListener('click',async ()=>{ try{ await signInWithPopup(auth,provider);}catch{showToast('Sign in failed');} });
onAuthStateChanged(auth,user=>{
  currentUser=user;
  signinBtn.textContent=user?'Signed in':'Sign in';
  signinBtn.disabled=!!user;
  filterAndRender();
});

// check cooldown
async function isVisited(ptc){
  if(!currentUser) return false;
  try{
    const snap = await getDoc(doc(db,'ptcClicks',`${ptc.id}_${currentUser.uid}`));
    if(!snap.exists() || !snap.data().lastClickedAt) return false;
    const last = snap.data().lastClickedAt.toDate().getTime();
    return (Date.now()-last)<COOLDOWN_MS;
  }catch{return false;}
}

async function incrementViewCount(ptcId){
  const ref = doc(db,'ptcViews',String(ptcId));
  try{ await updateDoc(ref,{count:increment(1),updatedAt:serverTimestamp()}); }
  catch{ await setDoc(ref,{count:1,updatedAt:serverTimestamp()});}
}

// CREDIT only after iframe timer ends
async function creditPTC(ptc){
  const uid = currentUser.uid;
  const clickRef = doc(db,'ptcClicks',`${ptc.id}_${uid}`);
  const snap = await getDoc(clickRef);

  const now = serverTimestamp();
  if(snap.exists()){
    await updateDoc(clickRef,{lastClickedAt:now,count:increment(1)});
  }else{
    await setDoc(clickRef,{ptcId:ptc.id,viewerUid:uid,lastClickedAt:now,count:1});
  }

  await addDoc(collection(db,'transactions'),{userId:uid,type:'ptc_click',source:`ptc_${ptc.id}`,amount:REWARD,note:`PTC click reward`,createdAt:now});
  await updateDoc(doc(db,'users',uid),{balance:increment(REWARD)});
  await incrementViewCount(ptc.id);

  showToast(`Credited ₦${REWARD.toFixed(2)}`);
}

let viewerTimerInterval = null;
function handleOpen(ptc){
  if(!currentUser){ showToast('Sign in to earn'); return; }

  const overlay = document.getElementById('ptcViewerOverlay');
  const iframe = document.getElementById('ptcIframe');
  const timerEl = document.getElementById('viewerTimer');

  iframe.src = ptc.url;
  overlay.style.display = 'flex';

  let secondsLeft = 10;
  timerEl.textContent = `Wait: ${secondsLeft}s`;
  clearInterval(viewerTimerInterval);

  viewerTimerInterval = setInterval(async ()=>{
    secondsLeft--;
    timerEl.textContent = `Wait: ${secondsLeft}s`;

    if(secondsLeft<=0){
      clearInterval(viewerTimerInterval);
      timerEl.textContent = `Done! Crediting...`;
      await creditPTC(ptc);
    }
  },1000);
}

document.getElementById('viewerCloseBtn').addEventListener('click',()=>{
  clearInterval(viewerTimerInterval);
  document.getElementById('ptcViewerOverlay').style.display='none';
  document.getElementById('ptcIframe').src='';
});

function makeCard(ptc,visited){
  const item=document.createElement('div'); item.className='card';
  item.innerHTML=`
    <h3 style="margin:0;color:var(--accent1)">${ptc.title}</h3>
    <div style="color:var(--muted);font-size:13px">${ptc.description}</div>
    <div style="font-weight:800;font-size:16px;color:var(--text)">Reward: ₦${ptc.reward}</div>
    <div class="views-count" style="font-size:13px;color:var(--muted)">Views: …</div>
  `;

  if(visited){ const b=document.createElement('div'); b.className='badge';b.textContent='Visited';item.appendChild(b);}

  const actions=document.createElement('div');actions.style.display='flex';actions.style.gap='8px';actions.style.marginTop='auto';

  const openBtn=document.createElement('button');openBtn.className='btn primary';openBtn.textContent='Open';
  openBtn.onclick=()=>handleOpen(ptc);

  const detailBtn=document.createElement('button');detailBtn.className='btn ghost';detailBtn.textContent='Details';
  detailBtn.onclick=()=>alert(`${ptc.title}\nReward: ₦${ptc.reward}`);

  actions.append(openBtn,detailBtn);
  item.appendChild(actions);

  (async()=>{
    try{
      const vdoc = await getDoc(doc(db,'ptcViews',String(ptc.id)));
      const cc = vdoc.exists()?vdoc.data().count||0:0;
      item.querySelector('.views-count').textContent='Views: '+cc;
    }catch{ item.querySelector('.views-count').textContent='Views: 0'; }
  })();

  return item;
}

async function filterAndRender(){
  const q = searchInput.value.trim().toLowerCase();
  const f = filterSelect.value;
  GRID.innerHTML='';

  for(const ptc of PTCs){
    const txt=(ptc.title+' '+ptc.description).toLowerCase();
    if(q && !txt.includes(q)) continue;

    const visited = await isVisited(ptc);
    if(f==='fresh' && visited) continue;
    if(f==='visited' && !visited) continue;

    GRID.appendChild(makeCard(ptc,visited));
  }
}

searchInput.addEventListener('input',filterAndRender);
filterSelect.addEventListener('change',filterAndRender);
filterAndRender();
</script>

</body>
</html>
