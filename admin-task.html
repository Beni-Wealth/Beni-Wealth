<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Advert Submissions</title>

  <!-- Poppins + Favicons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300,400,600,700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <meta name="theme-color" content="#2fe0b8">
  <style>
    :root{
      --bg1:#0b0613; --bg2:#0f0820;
      --muted: rgba(255,255,255,0.64);
      --text: #eaf2ff;
      --accent-start:#2fe0b8; --accent-end:#7a5fff;
      --card: rgba(255,255,255,0.02);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);-webkit-font-smoothing:antialiased}
    .wrap{max-width:1100px;margin:20px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .title{font-weight:800}
    .muted{color:var(--muted);font-size:13px}
    .card{background:var(--card);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03)}
    .controls{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    .search{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));color:var(--text)}
    .btn{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:#041219}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    table{width:100%;border-collapse:collapse;min-width:900px}
    thead th{position:sticky;top:0;background:rgba(255,255,255,0.08);padding:12px;text-align:left;font-weight:700}
    tbody td{padding:12px;border-bottom:1px solid rgba(255,255,255,0.02)}
    .pill{padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
    .pill.pending{background:#fff7d9;color:#6a4f00}
    .pill.approved{background:#bff0d9;color:#043f20}
    .pill.rejected{background:#ffdede;color:#6b0b0b}

    /* group header row */
    .group-header td{
      background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      font-weight:800;
      border-bottom:1px solid rgba(255,255,255,0.04);
    }
    .group-meta { font-weight:600; color:var(--muted); font-size:13px; margin-left:8px; }

    /* overlay viewer */
    .viewer-backdrop{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.7);
      z-index:9999;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .viewer{
      max-width:980px;
      width:90%;
      background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
      border-radius:12px;
      padding:18px;
      position:relative;
    }

    /* image proof size */
    #vProofImg{
      max-width: 100%;
      max-height: 300px;     /* limit height */
      object-fit: contain;
      display:block;
      margin-top:12px;
      border-radius:8px;
    }
  </style>
</head>
<body>
  <main class="wrap">
    <header>
      <div class="title">Beni-Wealth — Admin: Advert Submissions</div>
      <div class="muted" id="authInfo">Checking auth…</div>
    </header>

    <section class="card">
      <div class="controls">
        <input id="q" class="search" placeholder="Filter advert id / advert title / userId" />
        <button id="refreshBtn" class="btn ghost">Refresh</button>
        <div style="margin-left:auto" id="count" class="muted">—</div>
      </div>

      <div class="card">
        <table>
          <thead>
            <tr><th>Advert / Submission</th><th>UserId</th><th>Amount</th><th>Created</th><th>Approved</th><th>Proof</th><th>Text</th><th>Status</th><th></th></tr>
          </thead>
          <tbody id="tbody"><tr><td colspan="9" class="muted">Loading submissions…</td></tr></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- viewer -->
  <div id="viewerBackdrop" class="viewer-backdrop">
    <div class="viewer">
      <button id="vClose" class="btn ghost" style="position:absolute;top:12px;right:12px;">Close</button>
      <div><strong>User:</strong> <span id="vUser"></span></div>
      <div><strong>UID:</strong> <span id="vUid"></span></div>
      <div><strong>Amount:</strong> <span id="vAmount"></span></div>
      <div><strong>Created:</strong> <span id="vCreated"></span></div>
      <div><strong>Approved at:</strong> <span id="vApproved"></span></div>
      <div><strong>Status:</strong> <span id="vStatus"></span></div>
      <img id="vProofImg" src="" alt="Proof"/>
      <div><strong>Text proof:</strong> <span id="vTextProof"></span></div>
      <div id="vNoteWrapper" style="margin-top:8px"><strong>Note:</strong> <span id="vNoteText" class="muted"></span></div>
      <div style="margin-top:12px">
        <button id="approveBtn" class="btn">Approve</button>
        <button id="rejectBtn" class="btn ghost">Reject</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, collection, query, orderBy, onSnapshot, runTransaction, doc, serverTimestamp, getDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
    };
    if (!getApps().length) initializeApp(firebaseConfig);

    const auth = getAuth();
    const db = getFirestore();

    const authInfo = document.getElementById('authInfo');
    const tbody = document.getElementById('tbody');
    const qInput = document.getElementById('q');
    const refreshBtn = document.getElementById('refreshBtn');
    const countEl = document.getElementById('count');

    const viewerBackdrop = document.getElementById('viewerBackdrop');
    const vClose = document.getElementById('vClose');
    const vUser = document.getElementById('vUser');
    const vUid = document.getElementById('vUid');
    const vAmount = document.getElementById('vAmount');
    const vCreated = document.getElementById('vCreated');
    const vApproved = document.getElementById('vApproved');
    const vStatus = document.getElementById('vStatus');
    const vProofImg = document.getElementById('vProofImg');
    const vTextProof = document.getElementById('vTextProof');
    const vNoteText = document.getElementById('vNoteText');
    const approveBtn = document.getElementById('approveBtn');
    const rejectBtn = document.getElementById('rejectBtn');

    // Data structures:
    // submissionsList = array of { id, data }
    // advertsInfo = Map advertId -> { id, title, unitPrice, status } (fetched from advertise_tasks)
    // submissionsByAdvert = Map advertId -> [{ id, data }, ...]
    let submissionsList = [];
    let advertsInfo = new Map();
    let submissionsByAdvert = new Map();

    function fmtDate(v){
      try{ if(!v) return '-'; if(typeof v.toDate==='function') return v.toDate().toLocaleString(); return new Date(v).toLocaleString(); }
      catch{return '-';}
    }

    // Rebuild advertsInfo for all advertIds found in submissions
    async function loadAdvertsFor(submissions){
      advertsInfo.clear();
      const ids = Array.from(new Set(submissions.map(s => s.data?.advertId).filter(Boolean)));
      // fetch each advert doc (advertise_tasks collection)
      await Promise.all(ids.map(async (aid) => {
        try{
          const adDoc = await getDoc(doc(db,'advertise_tasks',aid));
          if(adDoc.exists()){
            const d = adDoc.data()||{};
            advertsInfo.set(aid, { id: adDoc.id, title: d.title || ('Advert '+aid), unitPrice: Number(d.unitPrice || 0), status: d.status || 'pending' });
          } else {
            advertsInfo.set(aid, { id: aid, title: `Advert (${aid.slice(0,8)})`, unitPrice: 0, status: 'missing' });
          }
        }catch(err){
          console.error('failed to fetch advert', aid, err);
          advertsInfo.set(aid, { id: aid, title: `Advert (${aid.slice(0,8)})`, unitPrice: 0, status: 'error' });
        }
      }));
    }

    // Build submissionsByAdvert map from submissionsList and advertsInfo
    function groupSubmissions(){
      submissionsByAdvert.clear();
      submissionsList.forEach(s => {
        const aid = s.data?.advertId || '__noAdvert';
        if(!submissionsByAdvert.has(aid)) submissionsByAdvert.set(aid, []);
        submissionsByAdvert.get(aid).push(s);
      });
    }

    // Render grouped table rows into tbody.
    // Filter text applies to advert id/title/userId/submission id
    function renderTable(){
      const filter = (qInput.value||'').trim().toLowerCase();
      let total = 0;
      let rows = '';

      // iterate advertsInfo keys; also include any advert ids present in submissions but missing from advertsInfo
      const advertIds = Array.from(new Set([...advertsInfo.keys(), ...submissionsByAdvert.keys()]));
      if(advertIds.length === 0){
        tbody.innerHTML = '<tr><td colspan="9" class="muted">No submissions</td></tr>';
        countEl.textContent = '0 submissions';
        return;
      }

      advertIds.forEach(aid => {
        const advert = advertsInfo.get(aid) || { id: aid, title: `Advert (${aid.slice(0,8)})`, unitPrice: 0 };
        const subs = submissionsByAdvert.get(aid) || [];
        // apply filter: show advert group if advert id/title matches OR any submission in it matches userId/sub id
        const advertMatches = aid.toLowerCase().includes(filter) || (advert.title||'').toLowerCase().includes(filter);
        const filteredSubs = subs.filter(s=>{
          if(!filter) return true;
          const d = s.data || {};
          return s.id.toLowerCase().includes(filter) ||
                 (d.userId||'').toLowerCase().includes(filter) ||
                 (d.textProof||'').toLowerCase().includes(filter) ||
                 advertMatches;
        });
        if(filteredSubs.length === 0) return;

        total += filteredSubs.length;
        // group header row (spans entire table)
        rows += `<tr class="group-header"><td colspan="9">
          ${advert.title} <span class="group-meta">(${aid})</span>
          <span class="group-meta"> • Unit Price: ₦${Number(advert.unitPrice||0).toLocaleString()}</span>
          <span class="group-meta"> • ${filteredSubs.length} submission${filteredSubs.length===1?'':'s'}</span>
        </td></tr>`;

        // submission rows
        filteredSubs.forEach(s=>{
          const d = s.data || {};
          const status = (d.status||'pending').toLowerCase();
          rows += `<tr data-id="${s.id}" data-advert="${aid}">
            <td>${s.id}</td>
            <td>${d.userId||''}</td>
            <td>₦${Number(d.paidAmount||0).toLocaleString()}</td>
            <td>${fmtDate(d.createdAt)}</td>
            <td>${fmtDate(d.approvedAt)}</td>
            <td>${d.imageUrl? 'Yes':''}</td>
            <td>${(d.textProof||'-')}</td>
            <td><span class="pill ${status}">${status.toUpperCase()}</span></td>
            <td><button class="btn ghost viewBtn">Details</button></td>
          </tr>`;
        });
      });

      if(total === 0){
        tbody.innerHTML = '<tr><td colspan="9" class="muted">No submissions</td></tr>';
      } else {
        tbody.innerHTML = rows;
      }
      countEl.textContent = `${total} submission${total===1?'':'s'}`;

      // attach detail button handlers
      document.querySelectorAll('.viewBtn').forEach(b=>b.addEventListener('click', e=>{
        const tr = e.target.closest('tr');
        if(!tr) return;
        openViewer(tr.dataset.id);
      }));
    }

    // Open viewer for a submission id (find in submissionsList)
    function openViewer(id){
      const sel = submissionsList.find(x=>x.id===id);
      if(!sel) return;
      const d=sel.data||{};
      vUser.textContent = d.userId||'-';
      vUid.textContent = d.userId||'-';
      vAmount.textContent = "₦"+Number(d.paidAmount||0).toLocaleString();
      vCreated.textContent = fmtDate(d.createdAt);
      vApproved.textContent = fmtDate(d.approvedAt);
      vStatus.textContent = (d.status||'PENDING').toUpperCase();
      vProofImg.src = d.imageUrl||'';
      vTextProof.textContent = d.textProof||'-';
      vNoteText.textContent = d.rejectedNote || d.note || '-';
      viewerBackdrop.style.display = "flex";
      viewerBackdrop.dataset.selId = id;
    }

    // close on clicking outside viewer
    viewerBackdrop.addEventListener('click', e=>{
      if(e.target===viewerBackdrop){
        viewerBackdrop.style.display="none";
      }
    });
    vClose.addEventListener('click', ()=>{ viewerBackdrop.style.display="none"; });

    // Approve / reject logic (kept similar to previous robust logic)
    approveBtn.addEventListener('click', async ()=>{
      const selId = viewerBackdrop.dataset.selId;
      if(!selId) return;
      if(!confirm("Approve and credit user?")) return;
      approveBtn.disabled=true;

      try{
        const subRef = doc(db,'advert_submissions',selId);

        await runTransaction(db, async tx=>{
          const subSnap = await tx.get(subRef);
          if(!subSnap.exists()) throw new Error("Submission missing");
          const data = subSnap.data()||{};
          const oldStatus = (data.status||'').toLowerCase();
          let unitPrice = Number(data.unitPrice || 0);

          // attempt to derive unitPrice from advert if missing
          const advertId = data.advertId || '';
          if((!unitPrice || unitPrice <= 0) && advertId){
            const adInfo = advertsInfo.get(advertId);
            if(adInfo) unitPrice = Number(adInfo.unitPrice || 0);
          }

          const userId = data.userId || "";

          console.log('approve: sub', selId, 'unitPrice=', unitPrice, 'status=', oldStatus, 'userId=', userId);

          if(oldStatus === 'approved'){
            throw new Error("Submission already approved");
          }

          // if unitPrice missing or zero, prompt admin to enter it
          if(!unitPrice || unitPrice <= 0){
            throw { code: 'MISSING_UNITPRICE', message: 'unitPrice missing' };
          }

          const payout = Math.round(unitPrice * 0.7);
          if(payout <= 0) throw new Error("Computed payout is 0 — check unitPrice on submission");

          // update submission: approved, paidAmount set to payout, clear any previous rejected note fields
          tx.update(subRef, {
            status: 'approved',
            approvedAt: serverTimestamp(),
            paidAmount: payout,
            unitPrice: unitPrice,
            rejectedNote: null,
            rejectedBy: null,
            rejectedAt: null
          });

          // credit the user's balance by payout (create user doc if missing)
          if(userId){
            const userRef = doc(db,'users',userId);
            const userSnap = await tx.get(userRef);
            if(userSnap.exists()){
              const oldBal = Number(userSnap.data()?.balance || 0);
              console.log('approve: oldBalance=', oldBal, ' newBalance=', oldBal + payout);
              tx.update(userRef, { balance: oldBal + payout });
            } else {
              console.log('approve: user doc missing — creating with balance =', payout);
              tx.set(userRef, { balance: payout }, { merge: true });
            }
          }
        }).catch(async err=>{
          // handle special missing unitPrice case by prompting admin and re-running transaction
          if(err && err.code === 'MISSING_UNITPRICE'){
            // prompt admin for unitPrice (outside transaction)
            const manual = prompt("This submission has no unitPrice. Enter unitPrice (NGN) to compute payout, or Cancel to abort:", "");
            if(manual === null) {
              throw new Error("Approval cancelled — unitPrice not provided");
            }
            const parsed = Number(manual.toString().replace(/[, ]+/g,''));
            if(!parsed || parsed <= 0) throw new Error("Invalid unitPrice entered");
            // re-run transaction with provided unitPrice
            await runTransaction(db, async tx2=>{
              const subSnap2 = await tx2.get(subRef);
              if(!subSnap2.exists()) throw new Error("Submission missing (2nd check)");
              const data2 = subSnap2.data()||{};
              const oldStatus2 = (data2.status||'').toLowerCase();
              if(oldStatus2 === 'approved') throw new Error("Submission already approved");
              const payout2 = Math.round(parsed * 0.7);
              if(payout2 <= 0) throw new Error("Computed payout is 0 — check unitPrice value provided");

              tx2.update(subRef, {
                status: 'approved',
                approvedAt: serverTimestamp(),
                paidAmount: payout2,
                unitPrice: parsed, // save unitPrice so future ops don't prompt again
                rejectedNote: null,
                rejectedBy: null,
                rejectedAt: null
              });

              const userId2 = data2.userId || "";
              if(userId2){
                const userRef2 = doc(db,'users',userId2);
                const userSnap2 = await tx2.get(userRef2);
                if(userSnap2.exists()){
                  const oldBal2 = Number(userSnap2.data()?.balance || 0);
                  tx2.update(userRef2, { balance: oldBal2 + payout2 });
                } else {
                  tx2.set(userRef2, { balance: payout2 }, { merge: true });
                }
              }
            });
          } else {
            // other transaction errors should bubble up
            throw err;
          }
        });

        // after successful approval, update local lists and UI
        await refreshLocalSnapshot(); // refresh local caches
        renderTable();
        viewerBackdrop.style.display = "none";
        alert('Approved and credited user successfully.');
      }catch(e){
        console.error('Approve failed:', e);
        alert("Approve failed: "+(e.message || e));
      }finally{
        approveBtn.disabled=false;
      }
    });

    // reject handler (stores rejectedNote, rejectedBy, rejectedAt; reverses previous approved paidAmount)
    rejectBtn.addEventListener('click', async ()=>{
      const selId = viewerBackdrop.dataset.selId;
      if(!selId) return;
      const note = prompt("Rejection note (optional):", "");
      if(note === null) return; // cancelled
      if(!confirm("Reject this submission?")) return;
      rejectBtn.disabled=true;
      try{
        const subRef = doc(db,'advert_submissions',selId);
        await runTransaction(db, async tx=>{
          const subSnap = await tx.get(subRef);
          if(!subSnap.exists()) throw new Error("Submission missing");
          const data=subSnap.data()||{};
          const oldStatus=(data.status||"").toLowerCase();
          const oldPaid=Number(data.paidAmount||0);
          const userId=data.userId||"";
          const adminId = (auth.currentUser && (auth.currentUser.email || auth.currentUser.uid)) || 'admin';

          // set the submission to rejected, clear approvedAt, set paidAmount to 0 and add rejection metadata
          tx.update(subRef, {
            status: 'rejected',
            approvedAt: null,
            paidAmount: 0,
            rejectedNote: note || null,
            rejectedBy: adminId,
            rejectedAt: serverTimestamp()
          });

          // if it was previously approved and had a paid amount, remove that credited amount
          if(userId && oldStatus === 'approved' && oldPaid > 0){
            const userRef = doc(db,'users',userId);
            const userSnap = await tx.get(userRef);
            if(!userSnap.exists()){
              // create user with zero balance to keep ledger consistent
              tx.set(userRef, { balance: 0 }, { merge: true });
            } else {
              const oldBal = Number(userSnap.data()?.balance || 0);
              tx.update(userRef, { balance: oldBal - oldPaid });
            }
          }
        });

        // refresh local snapshot and UI
        await refreshLocalSnapshot();
        renderTable();
        viewerBackdrop.style.display = "none";
        alert('Rejected submission.');
      }catch(e){ console.error(e); alert("Reject failed: "+(e.message||e)); }
      finally{ rejectBtn.disabled=false; }
    });

    // refresh button simply re-renders current list
    refreshBtn.addEventListener('click', async ()=>{ await refreshLocalSnapshot(); renderTable(); });

    // Keep the local state fresh by fetching advert_submissions snapshot and loading advert docs
    async function refreshLocalSnapshot(){
      try{
        const q = query(collection(db,'advert_submissions'), orderBy('createdAt','desc'));
        // use onSnapshot for live UI; but for explicit refresh we use get via onSnapshot replacement pattern:
        // We'll fetch current snapshot by attaching a temporary onSnapshot and immediately removing it.
        // Simpler: reuse onSnapshot listener below which keeps submissionsList up-to-date.
        // This helper will trigger rebuild from current submissionsList and adverts
        await loadAdvertsFor(submissionsList);
        groupSubmissions();
      }catch(err){
        console.error('refreshLocalSnapshot error', err);
      }
    }

    // snapshot listener for advert_submissions -> keep submissionsList up-to-date
    onAuthStateChanged(auth, user=>{
      authInfo.textContent = user? (user.email || user.uid) : "Not signed in";
      const q = query(collection(db,'advert_submissions'), orderBy('createdAt','desc'));
      onSnapshot(q, async snap=>{
        submissionsList = [];
        snap.forEach(d=>submissionsList.push({id:d.id,data:d.data()}));
        // load adverts for current submissions then group and render
        await loadAdvertsFor(submissionsList);
        groupSubmissions();
        renderTable();
      }, err => {
        console.error("Snapshot error:", err);
        tbody.innerHTML = `<tr><td colspan="9" class="muted">Failed to load submissions: ${err.message||err}</td></tr>`;
      });
    });

    // quick search filtering as user types
    qInput.addEventListener('input', ()=> renderTable());
  </script>
</body>
</html>
