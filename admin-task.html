<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Advert Submissions</title>

  <!-- Poppins + Favicons & Social preview -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300,400,600,700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png">
  <meta name="theme-color" content="#2fe0b8">

  <style>
    :root{
      --bg1:#0b0613; --bg2:#0f0820;
      --muted: rgba(255,255,255,0.64);
      --text: #eaf2ff;
      --accent-start:#2fe0b8; --accent-end:#7a5fff;
      --card: rgba(255,255,255,0.02);
      --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);-webkit-font-smoothing:antialiased}
    .wrap{max-width:1100px;margin:20px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{width:56px;height:56px;border-radius:12px}
    .title{font-weight:800}
    .muted{color:var(--muted);font-size:13px}
    .card{background:var(--card);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 20px 60px rgba(0,0,0,0.6)}
    .controls{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    .search{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));color:var(--text)}
    .btn{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:#041219}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .table-wrap{margin-top:10px;overflow:auto;border-radius:10px}
    table{width:100%;border-collapse:collapse;min-width:900px}
    thead th{position:sticky;top:0;background:linear-gradient(90deg, rgba(47,224,184,0.08), rgba(122,95,255,0.06));padding:12px;text-align:left;font-weight:700}
    tbody td{padding:12px;border-bottom:1px solid rgba(255,255,255,0.02);vertical-align:middle}
    .small{font-size:13px;color:var(--muted)}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
    .pill.pending{background:#fff7d9;color:#6a4f00}
    .pill.approved{background:#bff0d9;color:#043f20}
    .pill.rejected{background:#ffdede;color:#6b0b0b}
    .viewer-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center;padding:20px}
    .viewer{width:980px;max-width:calc(100% - 40px);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:16px;box-shadow:0 30px 120px rgba(0,0,0,0.8);color:var(--text)}
    .viewer .grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
    .viewer img{max-width:100%;border-radius:8px;display:block}
    .meta-row{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .note{margin-top:8px;color:var(--muted)}
    @media(max-width:900px){ .viewer{width:100%} .viewer .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <main class="wrap">
    <header>
      <div class="brand">
        <img src="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png" alt="logo">
        <div>
          <div class="title">Beni-Wealth — Admin: Advert Submissions</div>
          <div class="muted">Owners only — review submissions and approve / reject</div>
        </div>
      </div>

      <div class="muted" id="authInfo">Checking auth…</div>
    </header>

    <section class="card">
      <div class="controls">
        <input id="q" class="search" placeholder="Search advert id or userId" />
        <button id="refreshBtn" class="btn ghost">Refresh</button>
        <div style="margin-left:auto" id="count" class="small">—</div>
      </div>

      <div class="table-wrap card">
        <table aria-live="polite">
          <thead>
            <tr>
              <th>Advert id</th><th>UserId</th><th>Amount (₦)</th><th>Created</th><th>Approved at</th><th>Proof</th><th>Text proof</th><th>Status</th><th></th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="9" class="small muted">Loading submissions…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <footer style="margin-top:18px" class="small muted">© <span id="year"></span> Beni-Wealth</footer>
  </main>

  <div id="viewerBackdrop" class="viewer-backdrop" role="dialog" aria-hidden="true">
    <div class="viewer" role="document" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div id="vTitle" style="font-weight:800">Submission</div>
        <button id="vClose" class="btn ghost">Close</button>
      </div>

      <div class="grid" style="margin-top:12px">
        <div>
          <div style="display:flex;gap:12px;align-items:center">
            <div id="vUser" style="font-weight:800">—</div>
            <div id="vUid" class="small muted">UID: —</div>
          </div>

          <div class="meta-row"><div class="small muted">Amount</div><div id="vAmount" style="font-weight:800">₦0</div></div>
          <div class="meta-row"><div class="small muted">Created</div><div id="vCreated" class="small muted">—</div></div>
          <div class="meta-row"><div class="small muted">Approved at</div><div id="vApproved" class="small muted">—</div></div>
          <div class="meta-row"><div class="small muted">Status</div><div id="vStatus" class="small muted">—</div></div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button id="approveBtn" class="btn">Approve</button>
            <button id="rejectBtn" class="btn ghost">Reject</button>
          </div>

          <div class="note" id="vNote"></div>
        </div>

        <div style="max-width:360px">
          <div style="font-weight:700;margin-bottom:8px">Proof image</div>
          <img id="vProofImg" src="" alt="proof" style="max-width:100%;border-radius:8px;"/>
          <div style="margin-top:12px"><div class="small muted">Text proof</div><div id="vTextProof" style="margin-top:6px">—</div></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, collection, query, orderBy, onSnapshot, runTransaction,
      doc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
    };

    if(!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    const authInfo = document.getElementById('authInfo');
    const tbody = document.getElementById('tbody');
    const qInput = document.getElementById('q');
    const refreshBtn = document.getElementById('refreshBtn');
    const countEl = document.getElementById('count');

    const viewerBackdrop = document.getElementById('viewerBackdrop');
    const vClose = document.getElementById('vClose');
    const vTitle = document.getElementById('vTitle');
    const vUser = document.getElementById('vUser');
    const vUid = document.getElementById('vUid');
    const vAmount = document.getElementById('vAmount');
    const vCreated = document.getElementById('vCreated');
    const vApproved = document.getElementById('vApproved');
    const vStatus = document.getElementById('vStatus');
    const vProofImg = document.getElementById('vProofImg');
    const vTextProof = document.getElementById('vTextProof');
    const vNote = document.getElementById('vNote');
    const approveBtn = document.getElementById('approveBtn');
    const rejectBtn = document.getElementById('rejectBtn');

    let submissions = [];
    let listenerUnsub = null;

    function fmtDate(v){ try{ if(!v) return '-'; if(typeof v.toDate==='function') return v.toDate().toLocaleString(); return new Date(v).toLocaleString(); }catch(e){return '-';} }

    function renderTable(){
      const q = (qInput.value||'').toLowerCase().trim();
      const list = submissions.filter(s=>{ const id=s.id.toLowerCase(); const uid=s.data.userId.toLowerCase(); return !q||id.includes(q)||uid.includes(q); });
      countEl.textContent = `${list.length} submission${list.length===1?'':'s'}`;

      if(!list.length){ tbody.innerHTML='<tr><td colspan="9" class="small muted">No submissions found</td></tr>'; return; }

      tbody.innerHTML = list.map(s=>{
        const d=s.data||{};
        const id=s.id;
        const userId=d.userId||'-';
        const amt=Number(d.paidAmount||0).toLocaleString('en-NG');
        const created=fmtDate(d.createdAt);
        const approved=fmtDate(d.approvedAt);
        const statusHtml=`<span class="pill ${d.status||'pending'}">${(d.status||'PENDING').toUpperCase()}</span>`;
        const imageLink = d.imageUrl ? `<a class="viewImageLink" data-url="${d.imageUrl}">View</a>` : '-';
        const textProof = d.textProof||'-';

        return `<tr data-id="${id}">
          <td>${id}</td>
          <td>${userId}</td>
          <td>₦${amt}</td>
          <td>${created}</td>
          <td>${approved}</td>
          <td>${imageLink}</td>
          <td>${textProof}</td>
          <td>${statusHtml}</td>
          <td><button class="btn ghost viewBtn">Details</button></td>
        </tr>`;
      }).join('');

      document.querySelectorAll('.viewBtn').forEach(b=>b.addEventListener('click',e=>{
        const id=e.target.closest('tr').dataset.id;
        openViewer(id);
      }));
      document.querySelectorAll('.viewImageLink').forEach(a=>a.addEventListener('click', e=>{
        e.preventDefault();
        openImageViewer(a.dataset.url);
      }));
    }

    function openViewer(id){
      const sel=submissions.find(x=>x.id===id);
      if(!sel) return;
      const d=sel.data||{};
      vTitle.textContent='Submission — '+id;
      vUser.textContent=d.userId||'-';
      vUid.textContent='UID: '+(d.userId||'-');
      vAmount.textContent='₦'+Number(d.paidAmount||0).toLocaleString('en-NG');
      vCreated.textContent=fmtDate(d.createdAt);
      vApproved.textContent=d.approvedAt?fmtDate(d.approvedAt):'-';
      vStatus.textContent=(d.status||'PENDING').toUpperCase();
      vProofImg.src=d.imageUrl||'';
      vTextProof.textContent=d.textProof||'-';
      vNote.textContent='';

      viewerBackdrop.style.display='flex';
      document.body.style.overflow='hidden';
      viewerBackdrop.dataset.selId=id;
    }

    vClose.addEventListener('click',()=>{ viewerBackdrop.style.display='none'; document.body.style.overflow=''; });

    approveBtn.addEventListener('click',async()=>{
      const selId=viewerBackdrop.dataset.selId; if(!selId) return;
      if(!confirm('Approve this submission and credit the user?')) return;
      approveBtn.disabled=true;
      try{
        const subRef=doc(db,'advert_submissions',selId);
        await runTransaction(db,async(tx)=>{
          const snap=await tx.get(subRef); if(!snap.exists()) throw new Error('Not found');
          const data=snap.data()||{};
          // payout and flip logic
          const amount=Number(data.paidAmount||0);
          const oldStatus=(data.status||'').toLowerCase();
          tx.update(subRef,{status:'approved',approvedAt:serverTimestamp()});
          if(data.userId){
            const userRef=doc(db,'users',data.userId);
            const uSnap=await tx.get(userRef);
            const oldBal=Number(uSnap.data().balance||0);
            let newBal=oldBal;
            if(oldStatus!=='approved') newBal=oldBal+amount;
            tx.update(userRef,{balance:newBal});
          }
        });
        alert('Approved & paid if not already');
        renderTable();
      }catch(err){ alert('Failed: '+err); }
      approveBtn.disabled=false;
    });

    rejectBtn.addEventListener('click',async()=>{
      const selId=viewerBackdrop.dataset.selId; if(!selId) return;
      if(!confirm('Reject this submission?')) return;
      rejectBtn.disabled=true;
      try{
        const subRef=doc(db,'advert_submissions',selId);
        await runTransaction(db,async(tx)=>{
          const snap=await tx.get(subRef); if(!snap.exists()) throw new Error('Not found');
          const data=snap.data()||{};
          const amount=Number(data.paidAmount||0);
          const oldStatus=(data.status||'').toLowerCase();
          tx.update(subRef,{status:'rejected',approvedAt:null});
          if(data.userId && oldStatus==='approved'){
            const userRef=doc(db,'users',data.userId);
            const uSnap=await tx.get(userRef);
            const oldBal=Number(uSnap.data().balance||0);
            tx.update(userRef,{balance:oldBal-amount});
          }
        });
        alert('Rejected & debit performed if necessary');
        renderTable();
      }catch(err){ alert('Fail: '+err); }
      rejectBtn.disabled=false;
    });

    onAuthStateChanged(auth,user=>{ 
      if(!user) authInfo.textContent='Not signed in'; 
      else authInfo.textContent=user.email||user.uid;
      const q=query(collection(db,'advert_submissions'),orderBy('createdAt','desc'));
      onSnapshot(q,snap=>{
        submissions=[];
        snap.forEach(d=>submissions.push({id:d.id,data:d.data()}));
        renderTable();
      });
    });

    document.getElementById('year').textContent=new Date().getFullYear();
  </script>
</body>
</html>
