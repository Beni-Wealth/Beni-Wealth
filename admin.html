<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Beni-Wealth Admin</title>
    <script type="module">
      // Import Firebase SDKs (v9 modular)
      import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
      import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

      // Your Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
        authDomain: "beni-wealths.firebaseapp.com",
        projectId: "beni-wealths",
        storageBucket: "beni-wealths.firebasestorage.app",
        messagingSenderId: "807950483822",
        appId: "1:807950483822:web:e10fa87307e041c4d8417f",
        measurementId: "G-Z2XP3YN6NS",
      };

      // Initialize Firebase safely
      function initFirebaseOnce() {
        if (!getApps().length) {
          initializeApp(firebaseConfig);
        }
        const auth = getAuth();
        const db = getFirestore();
        return { auth, db };
      }

      const { auth, db } = initFirebaseOnce();

      // Redirect unauthorized users
      onAuthStateChanged(auth, async (user) => {
        if (!user || user.email !== "beniwealth70@gmail.com") {
          document.body.innerHTML = `
            <div style="text-align:center; margin-top: 15%;">
              <h2 style="color:white;">Access Denied</h2>
              <p style="color:#bbb;">You must be logged in as <b>beniwealth70@gmail.com</b>.</p>
              <button id="loginBtn" style="padding:10px 20px;margin-top:15px;border:none;background:#2563eb;color:white;border-radius:8px;cursor:pointer;">Go to Login</button>
            </div>`;
          document.getElementById("loginBtn").addEventListener("click", () => {
            window.location.href = "/login";
          });
        } else {
          loadDashboard(user);
        }
      });

      async function loadDashboard(user) {
        const [usersSnap, depositsSnap, withdrawalsSnap, tasksSnap, advertsSnap] = await Promise.all([
          getDocs(collection(db, "users")),
          getDocs(collection(db, "deposits")),
          getDocs(collection(db, "withdrawals")),
          getDocs(collection(db, "tasks")),
          getDocs(collection(db, "adverts")),
        ]);

        document.getElementById("dashboard").innerHTML = `
          <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:40px;">
            <div style="display:flex;align-items:center;gap:10px;">
              <img src="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1752962852/file_00000000401861f8bf6acb6d55fcf2bf_g2fcrf.png" width="60" height="60" style="border-radius:12px;" alt="Beni-Wealth Logo">
              <h1 style="font-size:24px;font-weight:700;">Beni-Wealth Admin</h1>
            </div>
            <div>
              <span style="margin-right:10px;color:#cbd5e1;">${user.email}</span>
              <button id="logoutBtn" style="background:#2563eb;color:white;padding:8px 16px;border:none;border-radius:8px;cursor:pointer;">Logout</button>
            </div>
          </header>

          <section style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:20px;margin-bottom:40px;">
            ${[
              { title: "Users", count: usersSnap.size },
              { title: "Deposits", count: depositsSnap.size },
              { title: "Withdrawals", count: withdrawalsSnap.size },
              { title: "Tasks", count: tasksSnap.size },
              { title: "Adverts", count: advertsSnap.size },
            ]
              .map(
                (s) => `
              <div style="background:rgba(255,255,255,0.1);padding:20px;text-align:center;border-radius:15px;">
                <h3 style="color:#bbb;font-size:14px;">${s.title}</h3>
                <p style="color:white;font-size:22px;font-weight:700;">${s.count}</p>
              </div>`
              )
              .join("")}
          </section>

          <section>
            <h2 style="font-size:18px;margin-bottom:15px;">Quick Actions</h2>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:20px;">
              ${[
                { label: "Withdrawals", icon: "ðŸ’¸", path: "/admin/withdrawals" },
                { label: "Deposits", icon: "ðŸ’°", path: "/admin/deposits" },
                { label: "Tasks", icon: "ðŸ“‹", path: "/admin/tasks" },
                { label: "Adverts", icon: "ðŸ“¢", path: "/admin/adverts" },
                { label: "Users", icon: "ðŸ‘¥", path: "/admin/users" },
              ]
                .map(
                  (a) => `
                <a href="${a.path}" style="text-decoration:none;">
                  <div style="background:rgba(255,255,255,0.1);border-radius:15px;padding:25px;text-align:center;color:white;transition:background 0.3s;">
                    <div style="font-size:30px;margin-bottom:10px;">${a.icon}</div>
                    <div style="font-size:14px;">${a.label}</div>
                  </div>
                </a>`
                )
                .join("")}
            </div>
          </section>
        `;

        document.getElementById("logoutBtn").addEventListener("click", async () => {
          await signOut(auth);
          window.location.href = "/login";
        });
      }
    </script>
    <style>
      body {
        margin: 0;
        font-family: "Poppins", sans-serif;
        background: linear-gradient(to bottom, #0b0613, #120521);
        color: white;
        padding: 40px;
      }
    </style>
  </head>
  <body>
    <div id="dashboard" style="text-align:center;margin-top:20%;">
      <p>Loading Admin...</p>
    </div>
  </body>
</html>
